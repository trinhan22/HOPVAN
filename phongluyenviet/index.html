<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HOPVAN - AI Chat</title>
  <meta property="og:title" content="HOPVAN - Học văn thông minh" />
  <meta property="og:description" content="Nền tảng học tập Ngữ Văn tích hợp AI – hỗ trợ tự học thông minh, phân tích tác phẩm, luyện viết hiệu quả." />
  <link href="../LOGO.WEBP" rel="icon" type="logo-white.png"/>
  
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700;800&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/lucide@latest"></script> 
  
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Global Configuration and Variables */
    :root {
        --primary-color: #fca96a; /* Main orange color */
        --secondary-color: #fcd5b5; /* Light orange/cream */
        --dark-text: #1f2937;
        --bg-light: #f7f9fc; /* Light gray background */
        --border-color: #e5e7eb;
        --shadow-subtle: 0 10px 30px rgba(0, 0, 0, 0.08);
        --shadow-focus: 0 0 0 3px rgba(252, 169, 106, 0.4);
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Montserrat', sans-serif;
    }
    body {
        background-color: var(--bg-light);
        color: var(--dark-text);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 1rem;
    }
    
    /* Hiệu ứng xuất hiện cho toàn bộ container */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .main-container {
        animation: fadeIn 0.6s ease-out forwards;
    }

    /* Main Container */
    .main-container {
        display: flex;
        flex-direction: column; /* Stack vertically on mobile */
        width: 100%;
        max-width: 1200px;
        min-height: 90vh;
        background-color: #ffffff;
        border-radius: 16px;
        box-shadow: var(--shadow-subtle);
        overflow: hidden;
    }

    @media (min-width: 768px) {
        .main-container {
            flex-direction: row; /* Two columns on desktop/tablet */
        }
    }

    /* Left Panel (Controls/Input) */
    .left-panel {
        flex: 0 0 100%; /* Full width on mobile */
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        transition: all 0.3s ease;
    }
    @media (min-width: 768px) {
        .left-panel {
            flex: 0 0 350px; /* ~30% width on desktop */
            border-right: 1px solid var(--border-color);
            max-height: 90vh;
            overflow-y: auto;
        }
    }

    /* Right Panel (Output/Results) */
    .right-panel {
        flex: 1;
        padding: 1.5rem;
        max-height: 90vh;
        overflow-y: auto;
    }

    /* General Transition for Inputs */
    input, select, textarea {
        transition: all 0.2s ease-in-out;
    }
    input:focus, select:focus, textarea:focus {
        border-color: var(--primary-color) !important;
        outline: none;
        box-shadow: var(--shadow-focus) !important;
    }

    /* Disabled Mode Styling */
    .mode-disabled {
        color: #9ca3af !important;
        background-color: #f3f4f6 !important;
        cursor: not-allowed;
    }
    .mode-disabled:hover {
        background-color: #f3f4f6 !important;
    }

    /* === BUTTONS & CONTROLS === */
    .send-button {
        background-image: linear-gradient(to right, #fca96a 0%, #ff8c4a 100%); 
        border: none;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(252, 169, 106, 0.3);
    }
    .send-button:hover:not(:disabled) {
        background-image: linear-gradient(to right, #ff8c4a 0%, #fca96a 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(252, 169, 106, 0.5);
    }
    .send-button:disabled {
        background-image: linear-gradient(to right, #e4e4e4 0%, #cccccc 100%);
        box-shadow: none;
        transform: translateY(0);
        cursor: not-allowed;
    }

    .upload-button-label {
        background-color: #fff;
        color: var(--dark-text);
        transition: all 0.2s ease;
        border: 1px solid var(--border-color);
    }
    .upload-button-label:hover {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        transform: translateY(-1px);
    }

    /* === OUTPUT STYLING (For Marked.js) === */
    #chat-output {
      line-height: 1.7; /* Tăng khoảng cách dòng cho dễ đọc */
    }
    #chat-output h1, #chat-output h2, #chat-output h3 {
        color: var(--dark-text);
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
        font-weight: 700;
    }
    #chat-output h1 { font-size: 1.8rem; }
    #chat-output h2 { font-size: 1.5rem; border-bottom: 2px solid var(--secondary-color); padding-bottom: 5px; }
    #chat-output h3 { font-size: 1.25rem; }
    #chat-output p { margin-bottom: 1rem; }
    #chat-output strong { color: #2d3748; }
    #chat-output ul, #chat-output ol { margin-left: 1.5rem; margin-bottom: 1rem; }
    
    /* Typing Cursor Effect */
    @keyframes blink {
        50% { opacity: 0; }
    }
    .typing-cursor {
        display: inline-block;
        width: 8px;
        height: 1.2rem;
        background-color: var(--dark-text);
        animation: blink 1s step-end infinite;
        vertical-align: bottom;
    }
  </style>
</head>
<body>
    
    <main class="main-container">
        
        <div class="left-panel">
            <h2 class="text-xl font-extrabold text-[var(--dark-text)]">HOPVAN AI</h2>
            
            <div>
                <label for="ai-mode" class="block text-sm font-semibold mb-2 text-gray-700">Chọn Cấp độ Phản hồi:</label>
                <select 
                    id="ai-mode" 
                    class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-[var(--primary-color)] focus:border-[var(--primary-color)] shadow-sm"
                >
                    <option value="co_ban" class="text-green-600 font-bold">CƠ BẢN</option>
                    <option value="thong_thao" class="text-green-600 font-bold">THÔNG THẠO</option>
                    <option value="sang_tao" class="text-green-600 font-bold">SÁNG TẠO</option>
                    <option value="hoc_thuat" class="text-green-600 font-bold">HỌC THUẬT</option>
                </select>
                <p id="mode-info" class="text-xs mt-1 text-gray-500 italic">Cấp độ: Cung cấp kiến thức cốt lõi, dễ hiểu.</p>
            </div>

            <div class="border p-4 rounded-lg bg-gray-50 border-gray-200">
                <label class="block text-sm font-semibold mb-2 text-gray-700">Tải lên Tài liệu (Docs):</label>
                <input type="file" id="doc-upload" class="hidden" accept=".txt,.pdf,.doc,.docx">
                <div class="flex items-center gap-3">
                    <label for="doc-upload" class="upload-button-label font-semibold py-2 px-4 rounded-lg cursor-pointer flex items-center">
                        <i data-lucide="paperclip" class="h-4 w-4 mr-2"></i> Tải file
                    </label>
                    <p id="doc-status" class="text-xs text-gray-600 flex-1">Chưa có tài liệu.</p>
                </div>
            </div>

            <div class="flex flex-col flex-grow">
                <label for="prompt-input" class="block text-sm font-semibold mb-2 text-gray-700">Nhập Yêu cầu:</label>
                <textarea 
                    id="prompt-input" 
                    placeholder="Nhập yêu cầu của bạn (ví dụ: Phân tích nhân vật Chí Phèo)" 
                    class="w-full p-4 rounded-xl border border-gray-300 shadow-inner text-gray-800 flex-grow"
                    rows="5"
                ></textarea>
                
                <div class="mt-4 flex flex-col items-center">
                    <p id="error-message" class="text-red-500 text-sm hidden mb-2"></p>
                    <button 
                        id="send-button" 
                        class="send-button text-white font-semibold py-3 px-8 rounded-lg w-full flex items-center justify-center"
                    >
                        <i data-lucide="send" class="h-5 w-5 mr-2"></i>
                        <span>Gửi Yêu Cầu</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <h2 class="text-xl font-extrabold text-[var(--dark-text)] mb-4 border-b pb-2 border-gray-200">Kết Quả Phản Hồi</h2>
            
            <div id="chat-output" class="text-gray-700">
                <div class="text-center text-gray-500 italic p-10">
                    <svg class="mx-auto h-8 w-8 text-[var(--primary-color)] mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    Kết quả từ HOPVAN AI sẽ hiển thị ở đây. <br>Hãy bắt đầu bằng chế độ **CƠ BẢN**!
                </div>
            </div>
        </div>
    </main>
    
    
<script type="module">
    const MODES = {
        co_ban: { name: "Cơ bản", status: "available", info: "Cung cấp kiến thức cốt lõi, dễ hiểu. Phù hợp cho ôn tập cơ bản.", prompt: "Bạn là gia sư Văn học Tiếng Việt tập trung vào cung cấp các kiến thức cốt lõi, cơ bản và dễ hiểu nhất. Phản hồi phải có bố cục rõ ràng, sử dụng Markdown để định dạng (tiêu đề, danh sách, in đậm)."},
        thong_thao: { name: "Thông Thạo", status: "available", info: "Cung cấp phân tích chuyên sâu, phức tạp.", prompt: "Bạn là chuyên gia Văn học Việt Nam và Thế giới, tập trung vào phân tích chuyên sâu các yếu tố nghệ thuật, tư tưởng và phong cách sáng tác. Hãy trình bày logic, có dẫn chứng và phân tầng ý rõ ràng. Phản hồi cần có bố cục 3 phần (Mở – Thân – Kết), kết hợp lập luận, so sánh, và nhận định cá nhân thuyết phục. Sử dụng Markdown để làm nổi bật luận điểm và trích dẫn."},
        sang_tao: { name: "Sáng Tạo", status: "available", info: "Hỗ trợ luyện viết, tạo ý tưởng, chỉnh sửa bài viết.", prompt: "Bạn là người cố vấn sáng tạo trong lĩnh vực Văn học, chuyên giúp học sinh phát triển khả năng viết và tư duy hình tượng. Hãy đưa ra gợi ý ý tưởng, cảm hứng, hoặc chỉnh sửa bài viết theo hướng tự nhiên, giàu cảm xúc và cá tính. Có thể đề xuất cách mở bài – kết bài ấn tượng, hình ảnh ẩn dụ, hoặc giọng văn phù hợp với mục tiêu. Trình bày bằng Markdown, có thể chèn ví dụ minh họa."},
        hoc_thuat: { name: "Học thuật", status: "available", info: "Đánh giá, trích dẫn học thuật chuyên ngành.", prompt: "Bạn là nhà nghiên cứu Văn học với phong cách học thuật nghiêm túc. Hãy phân tích và đánh giá tác phẩm dựa trên lý thuyết văn học (ví dụ: chủ nghĩa hiện thực, biểu tượng, cấu trúc luận, phân tâm học, hậu hiện đại,...). Trích dẫn nguồn (nếu có) hoặc ghi chú theo dạng [Tên tác giả, Năm]. Viết theo phong cách học thuật, mạch lạc, có hệ thống luận điểm – luận cứ – dẫn chứng. Sử dụng Markdown cho định dạng khoa học."}
    };

    let isProcessing = false;
    let uploadedDoc = null; 
    let typingInterval = null; // Biến để kiểm soát hiệu ứng gõ chữ

    document.addEventListener('DOMContentLoaded', () => {
        const promptInput = document.getElementById('prompt-input');
        const sendButton = document.getElementById('send-button');
        const chatOutput = document.getElementById('chat-output');
        const errorMessage = document.getElementById('error-message');
        const modeSelector = document.getElementById('ai-mode');
        const modeInfo = document.getElementById('mode-info');
        const docUpload = document.getElementById('doc-upload');
        const docStatus = document.getElementById('doc-status');
        
        lucide.createIcons();

        modeInfo.textContent = MODES[modeSelector.value].info;
        modeSelector.addEventListener('change', () => {
            modeInfo.textContent = MODES[modeSelector.value].info;
        });
        
        docUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { // Limit to 5MB
                    docStatus.innerHTML = `<span class="text-red-500 font-bold">Lỗi:</span> File quá lớn (Max 5MB).`;
                    uploadedDoc = null;
                    e.target.value = null;
                    return;
                }
                uploadedDoc = { name: file.name, size: (file.size / 1024 / 1024).toFixed(2) };
                docStatus.innerHTML = `<span class="font-bold text-green-600">File đã tải:</span> ${uploadedDoc.name} (${uploadedDoc.size} MB).`;
                if (file.type === 'text/plain') {
                    const reader = new FileReader();
                    reader.onload = (e) => { uploadedDoc.content = e.target.result; };
                    reader.readAsText(file);
                } else {
                    docStatus.innerHTML += `<br><span class="text-yellow-600">Lưu ý: AI chỉ dùng tên file PDF/DOCX.</span>`;
                }
            } else {
                uploadedDoc = null;
                docStatus.innerHTML = `Chưa có tài liệu.`;
            }
        });

        sendButton.addEventListener('click', handleAIChat);
        promptInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                handleAIChat();
            }
        });

        function getSystemPrompt(modeKey) {
            return MODES[modeKey]?.prompt || MODES.co_ban.prompt;
        }
        
        // **Hàm mới: Tạo hiệu ứng gõ chữ**
        function typeWriter(element, text, onComplete) {
            let i = 0;
            element.innerHTML = ""; // Xóa nội dung cũ
            if (typingInterval) clearInterval(typingInterval);

            typingInterval = setInterval(() => {
                if (i < text.length) {
                    // Cập nhật nội dung (tự động cuộn chỉ khi nội dung lớn)
                    element.innerHTML = marked.parse(text.substring(0, i + 1) + '<span class="typing-cursor"></span>');
                    i++;
                    element.parentElement.scrollTop = element.parentElement.scrollHeight; // Tự động cuộn xuống (áp dụng cho right-panel)
                } else {
                    clearInterval(typingInterval);
                    element.innerHTML = marked.parse(text); // Hiển thị đầy đủ khi hoàn tất
                    if (onComplete) onComplete();
                }
            }, 10); // Tốc độ gõ chữ (ms)
        }

        async function handleAIChat() {
            const modeKey = modeSelector.value;
            const mode = MODES[modeKey];
            const rawInput = promptInput.value.trim();
            
            if (mode.status === 'disabled') {
                errorMessage.textContent = `❌ Chế độ ${mode.name} (PRO) chưa khả dụng trong bản dùng thử.`;
                errorMessage.classList.remove('hidden');
                return;
            }
            if (!rawInput) {
                errorMessage.textContent = "Vui lòng nhập nội dung yêu cầu.";
                errorMessage.classList.remove('hidden');
                return;
            }
            if (isProcessing) return;
            
            errorMessage.classList.add('hidden');
            isProcessing = true;
            sendButton.disabled = true;
            sendButton.innerHTML = `<svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span>Đang Xử Lý...</span>`;
            
            chatOutput.innerHTML = `<div class="p-4 text-center text-gray-500 italic">
                                        <p class="font-semibold text-[var(--primary-color)]">Đang kết nối tới HOPVAN AI...</p>
                                        <div class="mt-2 text-sm">Chế độ: <span class="font-bold">${mode.name}</span></div>
                                    </div>`;

            let userPrompt = rawInput;
            if (uploadedDoc) {
                userPrompt += uploadedDoc.content 
                    ? `\n\n[NGỮ CẢNH TỪ TÀI LIỆU (${uploadedDoc.name})]:\n${uploadedDoc.content}`
                    : `\n\n[NGỮ CẢNH TỪ TÀI LIỆU (Tên: ${uploadedDoc.name})]:\n[Không thể đọc nội dung. Vui lòng trả lời dựa trên tên tài liệu và kiến thức của bạn.]`;
            }

            const systemPrompt = getSystemPrompt(modeKey);

            try {
                // Sử dụng đường dẫn tương đối, sẽ hoạt động tốt trên Netlify
                const API_URL = "/.netlify/functions/deepseek"; 
                
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        messages: [
                            { role: "system", content: systemPrompt }, 
                            { role: "user", content: userPrompt }
                        ],
                        model: "deepseek/deepseek-chat-v3.1:free" 
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    // Xử lý lỗi từ Netlify Function (ví dụ: Lỗi Key API 500)
                    const errorMsg = data.error 
                        ? (typeof data.error === 'string' ? data.error : JSON.stringify(data.error)) 
                        : `Lỗi không xác định (${response.status} ${response.statusText}). Kiểm tra logs Netlify.`;
                    
                    chatOutput.innerHTML = `<div class="p-4 text-red-600 bg-red-50 rounded-lg">
                                                <p class="font-bold">❌ Lỗi Phản Hồi (${response.status}):</p>
                                                <p>${errorMsg}</p>
                                            </div>`;
                    resetUI();
                    return;
                }
                
                // === LOGIC THÀNH CÔNG ĐÃ SỬA ===
                const aiResponseContent = data.choices[0]?.message?.content || "Không nhận được phản hồi từ AI.";
                
                // Bắt đầu hiệu ứng gõ chữ
                typeWriter(chatOutput, aiResponseContent, () => {
                    // Gọi resetUI sau khi hiệu ứng gõ chữ hoàn tất
                    resetUI();
                });
                
            } catch (error) {
                console.error("Lỗi Fetch/Code: ", error);
                chatOutput.innerHTML = `<div class="p-4 text-red-600 bg-red-50 rounded-lg"><p class="font-bold">❌ Lỗi kết nối (Frontend):</p><p>${error.message}</p></div>`;
                resetUI(); 
            }
        }

        // Hàm riêng để reset UI
        function resetUI() {
            isProcessing = false;
            sendButton.disabled = false;
            sendButton.innerHTML = `<i data-lucide="send" class="h-5 w-5 mr-2"></i> <span>Gửi Yêu Cầu</span>`;
            lucide.createIcons();
        }
    });
</script>
</body>
</html>