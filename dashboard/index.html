<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hopvan - Bảng Điều Khiển</title>
    <meta property="og:title" content="HOPVAN - Nền Tảng Học & Luyện Thi Ngữ Văn" />
    <meta property="og:description" content="Nền tảng học tập Ngữ Văn tích hợp AI – hỗ trợ tự học thông minh, phân tích tác phẩm, luyện viết hiệu quả." />
    <meta property="og:image" content="https://hopvan.netlify.app/panel.webp" />
    <meta property="og:url" content="https://hopvan.netlify.app" />
    <meta property="og:type" content="article" />
    <link rel="icon" type="image/webp" href="../LOGO.WEBP" />
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --primary: #FF8F50;
            --primary-gradient: linear-gradient(135deg, #FF8F50, #FF5E62);
            --text-main: #2D3436;
            --text-light: #636E72;
            --glass-bg: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(255, 255, 255, 0.8);
            --blur: 25px;
            --sidebar-width: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; transition: all 0.3s ease; }

        body { background-color: #FFF5EC; height: 100vh; overflow: hidden; display: flex; }

        /* --- BACKGROUND BLOBS --- */
        .background-blobs { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6; animation: floatBlob 10s infinite alternate; }
        .blob-1 { width: 500px; height: 500px; background: #FCA96A; top: -100px; left: -100px; }
        .blob-2 { width: 400px; height: 400px; background: #FCD5B5; bottom: -50px; right: -50px; animation-delay: -5s; }
        @keyframes floatBlob { 0% { transform: translate(0, 0); } 100% { transform: translate(30px, 50px); } }

        /* --- MAIN CONTENT --- */
        .main-content {
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            height: 100%;
            background: var(--glass-bg);
            backdrop-filter: blur(var(--blur));
            border-left: 1px solid var(--glass-border);
            padding: 30px 40px;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.02);
            -webkit-overflow-scrolling: touch;
        }

        /* --- HOVER EFFECTS --- */
        .stat-card:hover { transform: translateY(-8px); border-color: var(--primary); box-shadow: 0 15px 35px rgba(255, 143, 80, 0.15); }
        .banner-cta:hover .banner-decor { transform: rotate(-35deg) translate(15px, -25px) scale(1.1); opacity: 0.4; }
        .activity-item:hover { transform: translateX(8px); background: #fafafa; border-radius: 12px; }

        /* Header */
        .user-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .welcome-text h2 { font-size: 2rem; color: var(--text-main); margin-bottom: 5px; font-weight: 800; }
        .user-avatar {
            width: 55px; height: 55px; background: var(--primary-gradient);
            border-radius: 18px; display: flex; justify-content: center; align-items: center;
            color: white; font-weight: 800; font-size: 1.4rem;
            box-shadow: 0 8px 20px rgba(255, 143, 80, 0.3);
            transform: rotate(-5deg);
        }

        .content-section { display: none; animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .content-section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background: white; padding: 25px; border-radius: 24px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.02); transition: 0.3s;
            border: 1px solid rgba(0,0,0,0.03); display: flex; flex-direction: column; justify-content: space-between;
        }
        .stat-card h3 { font-size: 0.95rem; color: var(--text-light); margin-bottom: 10px; display: flex; align-items: center; gap: 8px;}
        .stat-card .value { font-size: 2.2rem; font-weight: 800; color: var(--text-main); line-height: 1; }
        .stat-card .unit { font-size: 0.9rem; color: var(--primary); font-weight: 700; margin-top: 5px; }

        /* Banner */
        .banner-cta {
            background: var(--primary-gradient); padding: 40px; border-radius: 30px; color: white;
            text-align: center; position: relative; overflow: hidden; margin-bottom: 30px;
            box-shadow: 0 15px 30px rgba(255, 94, 98, 0.25);
        }
        .banner-decor { position: absolute; right: 20px; bottom: -20px; font-size: 8rem; opacity: 0.2; transform: rotate(-20deg); transition: all 0.5s ease; }

        /* Split Grid (Activity & Quote) */
        .split-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 30px; }
        .activity-box { background: white; padding: 25px; border-radius: 24px; border: 1px solid rgba(0,0,0,0.05); }
        .activity-item { display: flex; align-items: center; gap: 15px; padding: 15px 0; border-bottom: 1px solid #f0f0f0; }
        .act-icon.orange { background: #fff3e0; color: #ff9800; border-radius: 10px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }

        /* Quote Box */
        .quote-box {
            background: linear-gradient(135deg, #fff 0%, #fffbf5 100%);
            border: 1px solid rgba(0,0,0,0.05); border-left: 5px solid var(--primary);
            padding: 30px; border-radius: 24px; position: relative;
            display: flex; flex-direction: column; justify-content: center;
        }
        .quote-text { font-style: italic; font-size: 1.1rem; color: var(--text-main); margin-bottom: 20px; line-height: 1.6; z-index: 2; }
        .quote-author { font-weight: 800; color: var(--primary); text-align: right; z-index: 2; }
        .quote-bg-icon { position: absolute; top: 20px; left: 20px; font-size: 4rem; color: rgba(255, 143, 80, 0.1); z-index: 1; }

        /* --- SỬA LỖI BÍ KÍP ĐIỂM CAO (ĐÃ CẬP NHẬT THEO Ý BẠN) --- */
        .section-h3 { 
            font-size: 1.4rem; 
            font-weight: 900; /* In đậm cực mạnh */
            color: var(--text-main); 
            margin-top: 65px; /* Để xa card phía trên ra */
            margin-bottom: 25px; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding-left: 20px; /* Xích vô trong một chút */
        }
        .tips-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 25px; 
            padding: 0 20px; /* Xích toàn bộ grid vô trong cho cân với tiêu đề */
        }
        .tip-card {
            background: white; padding: 22px; border-radius: 22px; display: flex; align-items: center; gap: 18px;
            cursor: pointer; border: 1px solid rgba(0,0,0,0.05); transition: 0.4s;
        }
        .tip-card:hover { transform: translateY(-5px) translateX(10px); border-color: var(--primary); box-shadow: 0 10px 25px rgba(255, 143, 80, 0.12); }
        .tip-img { width: 70px; height: 70px; border-radius: 15px; object-fit: cover; flex-shrink: 0; }
        .tip-content h4 { font-weight: 800; font-size: 1.05rem; margin-bottom: 6px; color: var(--text-main); }
        .tip-content p { font-size: 0.85rem; color: var(--text-light); line-height: 1.4; }

        /* --- MODAL LỊCH SỬ --- */
        #activityFullModal.modal {
            display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            z-index: 9999999; background-color: rgba(255, 245, 236, 0.9); backdrop-filter: blur(15px);
            justify-content: center; align-items: center; padding: 0;
        }
        #activityFullModal .modal-content {
            background: white; padding: 40px; border-radius: 40px; width: 90%; max-width: 800px; 
            max-height: 75vh; position: relative; box-shadow: 0 40px 100px rgba(255, 143, 80, 0.15);
            display: flex; flex-direction: column; border: 1px solid rgba(255, 255, 255, 0.8); overflow: hidden;
            animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideIn { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-table-container { flex-grow: 1; overflow-y: auto; padding-right: 10px; margin-top: 10px; }
        .modal-table-container::-webkit-scrollbar { width: 4px; }
        .modal-table-container::-webkit-scrollbar-track { background: transparent; margin: 20px 0; }
        .modal-table-container::-webkit-scrollbar-thumb { background: #FF8F50; border-radius: 10px; }

        @media (max-width: 768px) { .main-content { margin-left: 0; width: 100%; padding: 20px 15px; } .stats-grid { grid-template-columns: 1fr; } .tips-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div class="background-blobs"><div class="blob blob-1"></div><div class="blob blob-2"></div></div>

    <div class="dashboard-container">
        
        <div id="menu-placeholder"></div>

        <main class="main-content">
            <div class="user-header">
                <div class="welcome-text">
                    <h2 id="welcome-name">Xin chào,</h2>
                    <p>Hãy cùng bắt đầu học tập cùng với Hopvan nhé.</p>
                </div>
                <div class="user-avatar" id="avatar-initial"></div>
            </div>

            <div id="overview" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card" id="level-card">
                        <h3><i class="fas fa-chart-line" style="color: #FF5E62;"></i> Trình độ</h3>
                        <div class="value">Level 0</div>
                        <div class="unit">Đang tải...</div>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-file-alt" style="color: #FF9966;"></i> Đã làm</h3>
                        <div class="value" id="total-exams">0</div> <div class="unit">đề thi</div>
                    </div>
                    <div class="stat-card">
                        <h3><i class="fas fa-fire" style="color: #e74c3c;"></i> Chuỗi</h3>
                        <div class="value" id="streak-value">0</div> <div class="unit">ngày liên tiếp</div>
                    </div>
                </div>
                
                <div class="banner-cta">
                    <div style="position: relative; z-index: 2;">
                        <h2 style="font-size: 1.8rem; margin-bottom: 10px; color: white; font-weight: 800;">Sẵn sàng bứt phá điểm số?</h2>
                        <p style="opacity: 0.9; margin-bottom: 20px;">Làm ngay một bài test để AI đánh giá năng lực của bạn.</p>
                        <a href="phongluyende.html" style="background: white; color: #FF5E62; padding: 12px 30px; border: none; border-radius: 50px; font-weight: 800; cursor: pointer; text-decoration: none; display: inline-block;">Vào phòng luyện</a>
                    </div>
                    <i class="fas fa-rocket banner-decor"></i>
                </div>

                <div class="split-grid">
                    <div class="activity-box">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-weight: 800; display: flex; align-items: center; color: var(--text-main); margin-bottom: 0;">
                                <i class="fas fa-history" style="margin-right: 10px; color: var(--primary);"></i> Hoạt động gần đây
                            </h3>
                            <button onclick="openActivityModal()" style="background: none; border: none; color: #FF8F50; font-weight: 700; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                Xem tất cả <i class="fas fa-chevron-right" style="font-size: 0.7rem;"></i>
                            </button>
                        </div>
                        <ul class="activity-list" id="activity-list">
                            <li style="text-align: center; color: #999; padding: 20px;">Đang tải dữ liệu...</li>
                        </ul>
                    </div>

                    <div class="quote-box">
                        <i class="fas fa-quote-left quote-bg-icon"></i>
                        <p class="quote-text">"Xét đến cùng, ý nghĩa thực sự của văn học là nhân đạo hóa con người."</p>
                        <p class="quote-author">— Maxim Gorky</p>
                    </div>
                </div>

                <h3 class="section-h3">
                    <i class="fas fa-lightbulb" style="color: #FF8F50;"></i> Bí kíp điểm cao
                </h3>
                <div class="tips-grid">
                    <div class="tip-card" onclick="window.location.href='bantinvanhoc.html'" style="cursor: pointer;">
                        <img src="https://img.freepik.com/free-vector/creative-writing-concept-illustration_114360-8139.jpg" class="tip-img" alt="Tip">
                        <div class="tip-content">
                            <h4>Cách viết mở bài hiệu quả</h4>
                            <p>3 công thức mở bài áp dụng cho mọi tác phẩm văn học hiện đại.</p>
                        </div>
                    </div>

                    <div class="tip-card" onclick="window.location.href='bantinvanhoc.html'" style="cursor: pointer;">
                        <img src="https://img.freepik.com/free-vector/writer-concept-illustration_114360-1490.jpg" class="tip-img" alt="Tip">
                        <div class="tip-content">
                            <h4>Dẫn chứng NLXH "đắt giá"</h4>
                            <p>Tổng hợp những dẫn chứng thực tế mới nhất năm 2026.</p>
                        </div>
                    </div>
                </div>
                </div>
        </main>
    </div>

    <div id="activityFullModal" class="modal">
        <div class="modal-content">
            <button onclick="closeActivityModal()" style="position: absolute; top: 20px; right: 25px; border: none; background: #fff1eb; width: 35px; height: 35px; border-radius: 50%; color: #FF8F50; cursor: pointer; transition: 0.3s; z-index: 10;" onmouseover="this.style.transform='rotate(90deg)'; this.style.background='#FF8F50'; this.style.color='#fff'" onmouseout="this.style.transform='rotate(0deg)'; this.style.background='#fff1eb'; this.style.color='#FF8F50'">
                <i class="fas fa-times"></i>
            </button>
            <div style="text-align: left; margin-bottom: 25px;">
                <h2 style="font-size: 2.2rem; font-weight: 900; color: var(--text-main); letter-spacing: -1px;">Nhật ký nỗ lực</h2>
                <p style="color: var(--text-light); font-size: 0.9rem;">Bạn đã hoàn thành <span id="modal-count-val" style="color: var(--primary); font-weight: 800;">0</span> hoạt động</p>
            </div>
            <div class="modal-table-container">
                <table style="width: 100%; border-collapse: separate; border-spacing: 0 10px;">
                    <thead>
                        <tr style="text-align: left; color: #bbb; font-size: 0.75rem; text-transform: uppercase;">
                            <th style="padding: 0 10px 15px;">Nội dung</th>
                            <th>Thời gian</th>
                            <th style="text-align: right; padding-right: 15px;">Kết quả</th>
                        </tr>
                    </thead>
                    <tbody id="full-activity-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAJ9C2biYeiLPmhakzLZ4mEqfO9_VgPSZE", authDomain: "hopvan-9a648.firebaseapp.com", projectId: "hopvan-9a648", storageBucket: "hopvan-9a648.appspot.com", messagingSenderId: "429347196227", appId: "1:429347196227:web:917b8d019f0efd0f7833f6", measurementId: "G-1BG8PSRG0R" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allActivities = [];

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const name = user.displayName || user.email.split('@')[0];
                document.getElementById('welcome-name').textContent = `Xin chào, ${name}`;
                document.getElementById('avatar-initial').textContent = name.charAt(0).toUpperCase();
                updateUserStreak(user);
                setupRealtimeStats(user);
            } else { window.location.href = "../log.html"; }
        });

        async function updateUserStreak(user) {
            const userRef = doc(db, "users", user.uid);
            const userSnap = await getDoc(userRef);
            const todayStr = new Date().toLocaleDateString('en-CA');
            const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toLocaleDateString('en-CA');
            if (userSnap.exists()) {
                const userData = userSnap.data();
                let currentStreak = userData.streak || 1;
                if (userData.lastLoginDate !== todayStr) {
                    currentStreak = (userData.lastLoginDate === yesterdayStr) ? currentStreak + 1 : 1;
                    await updateDoc(userRef, { lastLoginDate: todayStr, streak: currentStreak });
                }
                document.getElementById('streak-value').textContent = currentStreak;
            } else {
                await setDoc(userRef, { lastLoginDate: todayStr, streak: 1, email: user.email });
                document.getElementById('streak-value').textContent = 1;
            }
        }

        function setupRealtimeStats(user) {
            const q = query(collection(db, "activities"), where("uid", "==", user.uid), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                allActivities = snapshot.docs.map(doc => doc.data());
                const total = allActivities.length;
                document.getElementById('total-exams').textContent = total;

                let levelName = "Sơ cấp";
                const levelNum = Math.floor(total / 5) + 1;
                if (levelNum > 3) levelName = "Trung cấp";
                if (levelNum > 7) levelName = "Cao cấp";
                if (levelNum > 12) levelName = "Bậc thầy";

                const levelCard = document.getElementById('level-card');
                if (levelCard) {
                    levelCard.querySelector('.value').textContent = `Level ${levelNum}`;
                    levelCard.querySelector('.unit').textContent = levelName;
                }

                const listEl = document.getElementById('activity-list');
                if (total === 0) {
                    listEl.innerHTML = `<li style="text-align: center; color: #999; padding: 20px; font-weight: 700;">Hãy bắt đầu luyện tập!</li>`;
                } else {
                    listEl.innerHTML = allActivities.slice(0, 3).map(data => `
                        <li class="activity-item">
                            <div class="act-icon orange"><i class="fas fa-pen-nib"></i></div>
                            <div style="flex-grow: 1;"><h4 style="font-weight: 800; font-size: 0.9rem;">${data.action || 'Luyện tập'}</h4><p style="font-size: 0.75rem; color:#999;">${data.timestamp ? data.timestamp.toDate().toLocaleDateString('vi-VN') : 'Vừa xong'}</p></div>
                            <div style="color: #4caf50; font-weight: 900; font-size: 0.7rem;">XONG</div>
                        </li>`).join('');
                }
            });
        }

        window.openActivityModal = () => {
            const bodyEl = document.getElementById('full-activity-body');
            document.getElementById('modal-count-val').textContent = allActivities.length;
            if (allActivities.length === 0) {
                bodyEl.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:50px; color:#999; font-weight:800;">Chưa có lịch sử.</td></tr>`;
            } else {
                bodyEl.innerHTML = allActivities.map(data => {
                    const d = data.timestamp ? data.timestamp.toDate() : new Date();
                    return `
                        <tr style="background: #fafafa; border-radius: 15px;">
                            <td style="padding: 15px 10px; font-weight: 800; border-radius: 15px 0 0 15px;">${data.action || 'Luyện tập'}</td>
                            <td style="font-weight: 600; color: #636e72; font-size: 0.85rem;">${d.toLocaleDateString('vi-VN')} - ${d.toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'})}</td>
                            <td style="text-align: right; padding-right: 15px; border-radius: 0 15px 15px 0;"><span style="color: #2ecc71; font-weight: 900; font-size: 0.75rem;">● HOÀN TẤT</span></td>
                        </tr>`;
                }).join('');
            }
            document.getElementById('activityFullModal').style.display = "flex";
            document.body.style.overflow = "hidden"; 
        };

        window.closeActivityModal = () => {
            document.getElementById('activityFullModal').style.display = "none";
            document.body.style.overflow = "auto";
        };

fetch('menu.html')
    .then(res => res.text())
    .then(html => {
        const placeholder = document.getElementById('menu-placeholder');
        placeholder.innerHTML = html;
        
        // --- QUAN TRỌNG NHẤT: Ép trình duyệt chạy lại Script bên trong menu ---
        const scripts = placeholder.querySelectorAll('script');
        scripts.forEach(oldScript => {
            const newScript = document.createElement('script');
            newScript.text = oldScript.text; // Copy nội dung script
            document.body.appendChild(newScript); // Chèn vào body để thực thi
        });
    })
    .catch(err => console.error("Lỗi tải menu:", err));
    </script>
</body>
</html>