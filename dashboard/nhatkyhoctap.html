<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HopVan - Nhật Ký Học Tập</title>
    <link rel="icon" type="image/webp" href="../LOGO.WEBP" />
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --primary: #FF8F50;
            --primary-gradient: linear-gradient(135deg, #FF8F50, #FF5E62);
            --text-main: #2D3436;
            --text-light: #636E72;
            --glass-bg: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(255, 255, 255, 0.8);
            --blur: 25px;
            --sidebar-width: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; transition: all 0.3s ease; }
        body { background-color: #FFF5EC; height: 100vh; overflow: hidden; display: flex; }

        /* --- BACKGROUND --- */
        .background-blobs { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6; animation: floatBlob 10s infinite alternate; }
        .blob-1 { width: 500px; height: 500px; background: #FCA96A; top: -100px; left: -100px; }
        .blob-2 { width: 400px; height: 400px; background: #FCD5B5; bottom: -50px; right: -50px; animation-delay: -5s; }
        .blob-3 { width: 300px; height: 300px; background: #FFD1D1; top: 40%; left: 40%; animation-delay: -2s; }
        @keyframes floatBlob { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(30px, 50px) scale(1.1); } }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: rgba(255, 143, 80, 0.05); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background-color: rgba(255, 143, 80, 0.3); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
        ::-webkit-scrollbar-thumb:hover { background-color: #FF8F50; border: 1px solid transparent; }
        ::-webkit-scrollbar-button { display: none; }

        /* --- LAYOUT --- */
        .mobile-header { display: none; position: fixed; top: 0; left: 0; right: 0; height: 60px; background: white; z-index: 100; align-items: center; padding: 0 20px; border-bottom: 1px solid #eee; }
        #sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); z-index: 998; }
        #menu-placeholder { width: var(--sidebar-width); flex-shrink: 0; transition: 0.3s; }

        .main-content {
            flex-grow: 1; width: calc(100% - var(--sidebar-width)); height: 100%;
            background: var(--glass-bg); backdrop-filter: blur(var(--blur));
            border-left: 1px solid var(--glass-border);
            padding: 30px 40px; overflow-y: auto; position: relative;
        }

        .user-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .welcome-text h2 { font-size: 2.2rem; font-weight: 800; color: var(--text-main); }
        .user-avatar { width: 55px; height: 55px; background: var(--primary-gradient); border-radius: 18px; display: flex; justify-content: center; align-items: center; color: white; font-weight: 800; font-size: 1.3rem; box-shadow: 0 10px 25px rgba(255, 143, 80, 0.3); transform: rotate(-5deg); transition: 0.3s; cursor: pointer; }
        .user-avatar:hover { transform: rotate(0deg) scale(1.1); }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background: white; padding: 20px; border-radius: 24px; display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 5px 20px rgba(0,0,0,0.02); border: 1px solid rgba(0,0,0,0.03);
        }
        .stat-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 15px 35px rgba(255, 143, 80, 0.15); }
        .stat-card h3 { font-size: 0.9rem; color: var(--text-light); margin-bottom: 5px; display: flex; gap: 8px; align-items: center; }
        .stat-card .value { font-size: 2rem; font-weight: 800; color: var(--text-main); line-height: 1; }
        .stat-card .unit { font-size: 0.8rem; color: var(--primary); font-weight: 700; margin-top: 5px; }

        .section-title { font-size: 1.4rem; font-weight: 900; color: var(--text-main); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        
        /* SKILL TREE CARDS (CHECKLIST STYLE) */
        .skill-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px; }
        .skill-card {
            background: white; border-radius: 24px; padding: 25px 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.03); border: 1px solid white;
            transition: 0.3s; position: relative; overflow: hidden; cursor: pointer;
        }
        .skill-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(255, 143, 80, 0.15); border-color: #FF8F50; }
        .skill-icon { 
            width: 60px; height: 60px; background: #fff5ec; color: #FF8F50; border-radius: 18px;
            display: flex; align-items: center; justify-content: center; font-size: 1.8rem; margin-bottom: 15px;
        }
        .skill-title { font-size: 1.1rem; font-weight: 800; color: #2d3436; margin-bottom: 5px; }
        .skill-info { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 700; color: #b2bec3; margin-bottom: 10px; }
        .skill-progress-bg { height: 8px; background: #f1f2f6; border-radius: 10px; overflow: hidden; margin-bottom: 15px; }
        .skill-progress-bar { height: 100%; background: #FF8F50; width: 0%; border-radius: 10px; transition: width 1s ease; }
        .skill-list { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .skill-card.active .skill-list { max-height: 500px; transition: max-height 0.5s ease-in; border-top: 1px dashed #eee; margin-top: 10px; padding-top: 10px; }
        .skill-item { 
            display: flex; align-items: center; gap: 10px; padding: 10px 5px; 
            font-size: 0.9rem; color: #b2bec3; border-radius: 8px; user-select: none;
        }
        .skill-item.completed { color: #2d3436; font-weight: 700; }
        .skill-item.completed i { color: #2ecc71; }
        .skill-item i { font-size: 0.7rem; color: #dfe6e9; width: 15px; }
        .toggle-icon { position: absolute; top: 25px; right: 20px; color: #dfe6e9; transition: 0.3s; }
        .skill-card.active .toggle-icon { transform: rotate(180deg); color: #FF8F50; }

        /* HORIZONTAL MAP */
        .map-container {
            background: white; border-radius: 30px; padding: 30px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.02); position: relative; overflow: hidden;
        }
        .map-scroll-area {
            display: flex; align-items: center; gap: 30px; padding: 20px 40px;
            overflow-x: auto; scroll-behavior: smooth; position: relative; z-index: 10;
        }
        .map-line {
            position: absolute; top: 50%; left: 0; right: 0; height: 8px; background: #f1f2f6; 
            transform: translateY(-50%); z-index: 1; border-radius: 4px;
        }
        .map-line-progress {
            position: absolute; top: 50%; left: 0; height: 8px; background: var(--primary-gradient);
            transform: translateY(-50%); z-index: 1; border-radius: 4px; width: 0%; transition: width 1s;
        }
        .map-node {
            flex-shrink: 0; width: 140px; height: 160px; background: white; border-radius: 20px;
            border: 3px solid #f1f2f6; position: relative; z-index: 2;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s; box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }
        .map-node:hover { transform: translateY(-10px); }
        .map-node.active { border-color: #FF8F50; box-shadow: 0 15px 30px rgba(255, 143, 80, 0.3); animation: pulse 2s infinite; }
        .map-node.completed { border-color: #2ecc71; background: #f0fdf4; }
        .node-icon { font-size: 2.5rem; margin-bottom: 10px; color: #dfe6e9; }
        .map-node.active .node-icon { color: #FF8F50; }
        .map-node.completed .node-icon { color: #2ecc71; }
        .node-title { font-size: 0.8rem; font-weight: 800; color: #636e72; text-align: center; padding: 0 5px; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 143, 80, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(255, 143, 80, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 143, 80, 0); } }

        /* MODALS */
        .hv-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .hv-modal.show { display: flex; }
        .hv-modal-box { background: white; padding: 30px; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: slideUp 0.3s; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .hv-btn { width: 100%; padding: 12px; border-radius: 12px; font-weight: 700; border: none; margin-top: 10px; cursor: pointer; transition: 0.2s; }
        .hv-btn-primary { background: var(--primary-gradient); color: white; }
        .hv-btn-gray { background: #f1f2f6; color: #636e72; }

        @media (max-width: 768px) {
            .mobile-header { display: flex; }
            #sidebar-overlay.active { display: block; }
            #menu-placeholder { width: 0; }
            .main-content { margin-left: 0; width: 100%; padding: 80px 20px 40px; }
            aside { position: fixed !important; transform: translateX(-100%); z-index: 10002; width: 280px !important; }
            aside.open { transform: translateX(0) !important; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .skill-grid { grid-template-columns: 1fr; }
            .map-node { width: 120px; height: 140px; }
        }
    </style>
</head>
<body>

    <div class="background-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <div class="mobile-header lg:hidden">
        <button onclick="toggleSidebar()" class="text-orange-500 text-2xl mr-4"><i class="fas fa-bars"></i></button>
        <div class="flex items-center gap-2"><img src="../LOGO.WEBP" class="w-8 h-8"><span class="font-black text-orange-500 text-lg">HOPVAN</span></div>
    </div>
    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div id="menu-placeholder"></div>

    <main class="main-content">
        <div class="user-header">
            <div class="welcome-text">
                <h2 id="welcome-name">Xin chào,</h2>
                <p style="color: var(--text-light); margin-top: 5px;">Hãy cùng bắt đầu học tập cùng với HopVan nhé!</p>
            </div>
            <div class="user-avatar" id="avatar-initial"></div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3><i class="fas fa-crown text-yellow-500"></i> Rank</h3>
                <div class="value" id="rank-val" style="font-size: 1.5rem; color: #FF8F50;">Tân Binh</div>
                <div class="unit" id="next-rank-info">0 ngày:</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-fire" style="color: #FF5E62"></i> Chuỗi</h3>
                <div class="value" id="streak-val">0</div>
                <div class="unit">ngày liên tiếp</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-key text-yellow-500"></i> Keys</h3>
                <div class="value" id="keys-val">0</div>
                <div class="unit">hiện có</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-file-alt" style="color: #FF5E62;"></i> Đã làm</h3>
                <div class="value" id="total-exams">0</div>
                <div class="unit">đề thi</div>
            </div>
        </div>

        <h3 class="section-title"><i class="fas fa-brain" style="color: #FF8F50;"></i> Bối Cảnh Tri Thức</h3>
        <p class="text-gray-500 text-sm mb-4 italic">Tiến độ cập nhật dựa trên kết quả thực tế tại Phòng Luyện Đề.</p>
        
        <div class="skill-grid">
            
            <div class="skill-card" onclick="toggleCard(this)">
                <i class="fas fa-chevron-down toggle-icon"></i>
                <div class="skill-icon"><i class="fas fa-book-open"></i></div>
                <div class="skill-title">Đọc Hiểu</div>
                <div class="skill-info"><span id="lvl-reading">Lv.1</span><span id="pct-reading">0%</span></div>
                <div class="skill-progress-bg"><div class="skill-progress-bar" id="bar-reading"></div></div>
                
                <div class="skill-list" id="list-reading"></div>
            </div>

            <div class="skill-card" onclick="toggleCard(this)">
                <i class="fas fa-chevron-down toggle-icon"></i>
                <div class="skill-icon"><i class="fas fa-globe-asia"></i></div>
                <div class="skill-title">NLXH</div>
                <div class="skill-info"><span id="lvl-nlxh">Lv.1</span><span id="pct-nlxh">0%</span></div>
                <div class="skill-progress-bg"><div class="skill-progress-bar" id="bar-nlxh"></div></div>
                <div class="skill-list" id="list-nlxh"></div>
            </div>

            <div class="skill-card" onclick="toggleCard(this)">
                <i class="fas fa-chevron-down toggle-icon"></i>
                <div class="skill-icon"><i class="fas fa-feather-alt"></i></div>
                <div class="skill-title">NLVH</div>
                <div class="skill-info"><span id="lvl-nlvh">Lv.1</span><span id="pct-nlvh">0%</span></div>
                <div class="skill-progress-bg"><div class="skill-progress-bar" id="bar-nlvh"></div></div>
                <div class="skill-list" id="list-nlvh"></div>
            </div>

            <div class="skill-card" onclick="toggleCard(this)">
                <i class="fas fa-chevron-down toggle-icon"></i>
                <div class="skill-icon"><i class="fas fa-lightbulb"></i></div>
                <div class="skill-title">Ngôn Ngữ & Tư Duy</div>
                <div class="skill-info"><span id="lvl-lang">Lv.1</span><span id="pct-lang">0%</span></div>
                <div class="skill-progress-bg"><div class="skill-progress-bar" id="bar-lang"></div></div>
                <div class="skill-list" id="list-lang"></div>
            </div>
        </div>

        <h3 class="section-title"><i class="fas fa-map-marked-alt" style="color: #FF8F50;"></i> Hành Trình Văn Chương</h3>
        <div class="map-container">
            <div class="map-line"></div>
            <div class="map-line-progress" id="map-progress-bar"></div>
            <div class="map-scroll-area" id="journey-container">
                </div>
        </div>

    </main>

<div id="modal-unlock" class="hv-modal">
        <div class="hv-modal-box">
            <div class="w-20 h-20 mx-auto bg-orange-100 rounded-full flex items-center justify-center mb-5 shadow-sm">
                <i class="fas fa-lock-open text-4xl text-orange-500"></i>
            </div>
            
            <h3 class="text-xl font-black text-gray-800 mb-2">Mở khóa bài học?</h3>
            <p class="text-sm text-gray-500 mb-6 leading-relaxed">
                Sử dụng <b class="text-orange-500">5 Keys</b> để vào học.<br>
                Phần thưởng hoàn thành<b class="text-orange-500"> 10 Keys</b>
            </p>
            
            <div class="flex gap-3">
                <button class="hv-btn hv-btn-gray flex-1" onclick="closeModal()">Để sau</button>
                <button class="hv-btn hv-btn-primary flex-1 shadow-lg shadow-orange-200" id="btn-unlock-confirm">
                    Mở ngay
                </button>
            </div>
        </div>
    </div>
    
    <div id="modal-alert" class="hv-modal">
        <div class="hv-modal-box">
            <div class="w-20 h-20 mx-auto bg-red-100 rounded-full flex items-center justify-center mb-5 shadow-sm">
                <i class="fas fa-key text-4xl text-red-500"></i>
            </div>

            <h3 class="text-xl font-black text-gray-800 mb-2">Thiếu Keys rồi!</h3>
            <p class="text-sm text-gray-500 mb-6 leading-relaxed">
                Bạn không đủ Keys để mở bài này.<br>
                Hãy điểm danh hoặc làm bài tập khác để kiếm thêm nhé.
            </p>
            
            <button class="hv-btn hv-btn-primary w-full" onclick="closeModal()">Đã hiểu</button>
        </div>
    </div>

    <script type="module" src="gam.js"></script>
    <script src="../chatbot.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, increment, collection, query, where, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { initMenu } from "./menu.js";

    // --- CONFIG ---
    const firebaseConfig = { apiKey: "AIzaSyAJ9C2biYeiLPmhakzLZ4mEqfO9_VgPSZE", authDomain: "hopvan-9a648.firebaseapp.com", projectId: "hopvan-9a648", storageBucket: "hopvan-9a648.appspot.com", messagingSenderId: "429347196227", appId: "1:429347196227:web:917b8d019f0efd0f7833f6", measurementId: "G-1BG8PSRG0R" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- DỮ LIỆU CẤU HÌNH (HTML Cứng cho Hành Trình) ---
    // id: số level, file: tên file html trong thư mục nhatkyhoctap
    const JOURNEY_DATA = [
        { id: 1, file: '1.html', title: 'Bước vào chữ nghĩa', icon: 'fas fa-shoe-prints' },
        { id: 2, file: '2.html', title: 'Học cách đọc', icon: 'fas fa-book-reader' },
        { id: 3, file: '3.html', title: 'Học cách nghĩ', icon: 'fas fa-lightbulb' },
        { id: 4, file: '4.html', title: 'Học cách viết', icon: 'fas fa-pen-nib' },
        { id: 5, file: '5.html', title: 'Đi qua nỗi ngược', icon: 'fas fa-mountain' },
        { id: 6, file: '6.html', title: 'Tìm tiếng nói riêng', icon: 'fas fa-microphone-alt' },
        { id: 7, file: '7.html', title: 'Ở lại với văn chương', icon: 'fas fa-heart' },
        // Thêm các level khác nếu cần
    ];

    // Dữ liệu hiển thị cho Bối Cảnh Tri Thức (Chỉ text, ko link)
    const SKILL_STEPS = {
        reading: ["Làm quen văn bản", "Hiểu từ ngữ", "Phân tích câu", "Suy luận logic", "Tư duy phản biện", "Đánh giá nội dung", "Cảm thụ văn học"],
        nlxh: ["Xác định vấn đề", "Triển khai luận điểm", "Lấy dẫn chứng", "Phản biện vấn đề", "Liên hệ thực tế", "Sáng tạo bài viết", "Hoàn thiện tư duy"],
        nlvh: ["Nắm bắt tác phẩm", "Phân tích nhân vật", "Phân tích nghệ thuật", "So sánh văn học", "Lý luận văn học", "Phong cách tác giả", "Tư duy tổng hợp"],
        lang: ["Ngữ pháp cơ bản", "Biện pháp tu từ", "Phong cách ngôn ngữ", "Phương thức biểu đạt", "Thực hành tiếng Việt", "Sửa lỗi câu", "Vận dụng nâng cao"]
    };

    let userKeys = 0;
    let currentLevel = 1; // Level người dùng đã đạt được (hoàn thành bài học)
    let paidLevel = 0;    // Level cao nhất đã mua vé

    initMenu(app);

    // --- MAIN LOGIC ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // ... (Phần hiển thị tên giữ nguyên) ...
            const name = user.displayName || user.email.split('@')[0];
            document.getElementById('welcome-name').innerText = `Xin chào, ${name}`;
            document.getElementById('avatar-initial').innerText = name[0].toUpperCase();

            // 1. Tải Stats (Keys)
            const userSnap = await getDoc(doc(db, "users", user.uid));
            if (userSnap.exists()) {
                const d = userSnap.data();
                userKeys = d.keys || 0;
                document.getElementById('keys-val').innerText = userKeys;
                document.getElementById('streak-val').innerText = d.streak || 0;
                updateRank(d.streak || 0); // Hàm rank giữ nguyên
            }

            // 2. Tải Progress (Lấy Level hiện tại & Level đã mua)
            const progRef = doc(db, "users_progress", user.uid);
            const progSnap = await getDoc(progRef);
            if (progSnap.exists()) {
                const d = progSnap.data();
                currentLevel = d.currentLevel || 1; 
                paidLevel = d.paidLevel || 0;
            } else {
                // Nếu là user mới tinh, tạo data mặc định
                await setDoc(progRef, { currentLevel: 1, paidLevel: 0 });
            }

            // 3. Render
            renderSkillTree(user.uid); // Hàm này giữ nguyên
            renderMap(); // Hàm này sửa ở bước 3
        } else {
            window.location.href = "../log.html";
        }
    });

    
    function updateRank(streak) {
        let r = "Tân Binh";
        let next = "3 ngày: Chớm lửa";
        if (streak >= 3) { r = "Chớm Lửa"; next = "7 ngày: Giữ lửa"; }
        if (streak >= 7) { r = "Giữ Lửa"; next = "30 ngày: Bền lửa"; }
        if (streak >= 30) { r = "Bền Lửa"; next = "100 ngày: Người ở lại"; }
        if (streak >= 100) { r = "Người Ở Lại"; next = "Huyền thoại!"; }
        document.getElementById('rank-val').innerText = r;
        document.getElementById('next-rank-info').innerText = next;
    }

    // --- LOGIC 1: BỐI CẢNH TRI THỨC & THỐNG KÊ ---
    async function renderSkillTree(uid) {
        // Lấy dữ liệu từ Phòng Luyện Đề
        const q = query(collection(db, "activities"), where("uid", "==", uid));
        const snap = await getDocs(q);
        
        let scores = { reading: [], nlxh: [], nlvh: [], lang: [] };
        
        snap.forEach(doc => {
            const d = doc.data();
            // Lọc các bài có điểm số
            if (d.score !== undefined && d.score !== null) {
                let type = d.type; 
                // Map type về 4 nhóm chính
                if (['trac-nghiem','reading','doc_hieu'].includes(type)) type = 'reading';
                else if (type === 'nlxh') type = 'nlxh';
                else if (type === 'nlvh') type = 'nlvh';
                else if (['ngon-ngu','lang'].includes(type)) type = 'lang';
                
                if (scores[type]) scores[type].push(Number(d.score));
            }
        });

        // Cập nhật UI cho từng cột kỹ năng
        const updateUI = (key, arr, steps) => {
            let lvl = 1;
            if (arr && arr.length > 0) {
                const avg = arr.reduce((a,b)=>a+b,0) / arr.length;
                let base = 1;
                if (avg >= 8.0) base = 3; else if (avg >= 5.0) base = 2; 
                
                let bonus = Math.floor(arr.length / 5);
                lvl = Math.min(7, base + bonus);
            }

            document.getElementById(`lvl-${key}`).innerText = `Lv.${lvl}`;
            document.getElementById(`pct-${key}`).innerText = `${Math.round((lvl/7)*100)}%`;
            document.getElementById(`bar-${key}`).style.width = `${(lvl/7)*100}%`;

            // Render danh sách (không có thẻ a)
            const listEl = document.getElementById(`list-${key}`);
            listEl.innerHTML = steps.map((step, index) => {
                const isDone = index < lvl; 
                const statusClass = isDone ? "completed" : "";
                const icon = isDone ? "fa-check-circle" : "fa-circle"; 
                
                return `
                <div class="skill-item ${statusClass}">
                    <i class="fas ${icon}"></i> 
                    <span>${index+1}. ${step}</span>
                </div>`;
            }).join('');
        };

        updateUI('reading', scores.reading, SKILL_STEPS.reading);
        updateUI('nlxh', scores.nlxh, SKILL_STEPS.nlxh);
        updateUI('nlvh', scores.nlvh, SKILL_STEPS.nlvh);
        updateUI('lang', scores.lang, SKILL_STEPS.lang);
        
        // --- CẬP NHẬT TỔNG SỐ BÀI ĐÃ LÀM (FIX MỚI) ---
        const totalDone = scores.reading.length + scores.nlxh.length + scores.nlvh.length + scores.lang.length;
        const totalEl = document.getElementById('total-exams');
        if (totalEl) {
            totalEl.innerText = totalDone;
        }
    }

    window.toggleCard = (el) => {
        el.classList.toggle('active');
    };

    // --- LOGIC 2: HÀNH TRÌNH VĂN CHƯƠNG (Logic Vé + File Cứng) ---
    function renderMap() {
        const container = document.getElementById('journey-container');
        const progressBar = document.getElementById('map-progress-bar');
        container.innerHTML = "";

        let activeIndex = 0;

        JOURNEY_DATA.forEach((item, index) => {
            let statusClass = 'locked';
            let iconHtml = '<i class="fas fa-lock"></i>';
            
            // TRƯỜNG HỢP 1: Đã học xong (Level nhỏ hơn Level hiện tại của user)
            if (item.id < currentLevel) {
                statusClass = 'completed';
                iconHtml = `<i class="fas ${item.icon}"></i>`; // Hiện icon đẹp
                activeIndex = index + 1;
            } 
            // TRƯỜNG HỢP 2: Đang học (Level bằng Level hiện tại)
            else if (item.id === currentLevel) {
                statusClass = 'active';
                activeIndex = index;
                
                // Kiểm tra xem đã mua vé chưa
                if (item.id <= paidLevel) {
                    // Đã mua vé -> Hiện nút Play
                    iconHtml = '<i class="fas fa-play"></i>';
                } else {
                    // Chưa mua vé -> Hiện nút Chìa khóa (để mua)
                    iconHtml = '<i class="fas fa-key text-yellow-300 animate-pulse"></i>';
                }
            } 
            // TRƯỜNG HỢP 3: Tương lai (Chưa mở)
            else {
                statusClass = 'locked';
                iconHtml = '<i class="fas fa-lock"></i>';
            }

            const div = document.createElement('div');
            div.className = `map-node ${statusClass}`;
            div.innerHTML = `
                <div class="node-icon">${iconHtml}</div>
                <div class="node-title">${item.title}</div>
            `;
            
            // Gán sự kiện click
            div.onclick = () => handleMapClick(item);
            container.appendChild(div);
        });

        // Thanh tiến độ
        const pct = (activeIndex / JOURNEY_DATA.length) * 100;
        progressBar.style.width = `${pct}%`;
    }

    function handleMapClick(item) {
        // 1. Bài cũ (đã xong) -> Vào luôn
        if (item.id < currentLevel) {
            window.location.href = `../nhatkyhoctap/${item.file}`;
        }
        // 2. Bài hiện tại
        else if (item.id === currentLevel) {
            // Đã mua vé chưa?
            if (item.id <= paidLevel) {
                // Rồi -> Vào học
                window.location.href = `../nhatkyhoctap/${item.file}`;
            } else {
                // Chưa -> Hiện popup đòi tiền
                window.pendingLevelId = item.id; // Lưu lại ID để tí trừ tiền
                document.getElementById('modal-unlock').classList.add('show');
            }
        }
        // 3. Bài tương lai -> Không làm gì hoặc báo lỗi
        else {
            // alert("Bạn phải hoàn thành cấp độ trước đó!");
        }
    }

    // Xử lý nút MUA VÉ (-5 keys)
    document.getElementById('btn-unlock-confirm').onclick = async () => {
        if (userKeys >= 5) {
            const uid = auth.currentUser.uid;
            
            // 1. Trừ 5 Keys
            await updateDoc(doc(db, "users", uid), { keys: increment(-5) });
            
            // 2. Cập nhật paidLevel (Vé thông hành)
            // Lưu ý: Chỉ update paidLevel, KHÔNG update currentLevel
            const progRef = doc(db, "users_progress", uid);
            await updateDoc(progRef, { paidLevel: window.pendingLevelId });
            
            // 3. Cập nhật giao diện ngay lập tức
            userKeys -= 5;
            paidLevel = window.pendingLevelId; // Cập nhật biến local
            document.getElementById('keys-val').innerText = userKeys;
            
            closeModal();
            renderMap(); // Vẽ lại map để icon Key biến thành icon Play
        } else {
            closeModal();
            document.getElementById('modal-alert').classList.add('show');
        }
    };

    window.closeModal = () => document.querySelectorAll('.hv-modal').forEach(m => m.classList.remove('show'));
    window.toggleSidebar = () => {
        const sidebar = document.querySelector('aside');
        const overlay = document.getElementById('sidebar-overlay');
        if(sidebar) sidebar.classList.toggle('open');
        if(overlay) overlay.classList.toggle('active');
    };

</script>
</body>
</html>