<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HopVan - Nhật Ký Học Tập</title>
    <meta property="og:title" content="HOPVAN - Nền Tảng Học & Luyện Thi Ngữ Văn" />
    <meta property="og:description" content="Nền tảng học tập Ngữ Văn tích hợp AI – hỗ trợ tự học thông minh, phân tích tác phẩm, luyện viết hiệu quả." />
    <meta property="og:image" content="https://hopvan.netlify.app/panel.webp" />
    <meta property="og:url" content="https://hopvan.netlify.app" />
    <meta property="og:type" content="article" />
    <link rel="icon" type="image/webp" href="../LOGO.WEBP" />
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

<style>
        :root { --primary: #FF8F50; --primary-gradient: linear-gradient(135deg, #FF8F50, #FF5E62); --sidebar-width: 280px; }
        * { font-family: 'Plus Jakarta Sans', sans-serif; box-sizing: border-box; }
        
        body { background-color: #FFF5EC; min-height: 100vh; display: flex; overflow-x: hidden; }

        /* --- LAYOUT CƠ BẢN --- */
        #menu-placeholder { 
            width: var(--sidebar-width); 
            flex-shrink: 0; 
            z-index: 10001; 
            position: relative;
        }
        .main-content { flex-grow: 1; padding: 40px; position: relative; min-height: 100vh; transition: all 0.4s ease; }

        /* --- MOBILE HEADER & OVERLAY --- */
        .mobile-header {
            display: none; position: fixed; top: 0; left: 0; right: 0;
            height: 60px; background: white; 
            z-index: 1000; 
            align-items: center; padding: 0 20px; border-bottom: 1px solid #eee;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        #sidebar-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.5); 
            backdrop-filter: blur(4px);
            z-index: 9999; 
        }

        /* --- HEADER CARD --- */
        .welcome-card {
            background: linear-gradient(135deg, #FF9F68 0%, #FF5E62 100%);
            border-radius: 35px; padding: 40px; color: #ffffff;
            box-shadow: 0 20px 40px rgba(255, 94, 98, 0.3); 
            position: relative; overflow: hidden; margin-bottom: 80px; 
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideDown 0.8s ease;
        }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- PATH SYSTEM --- */
        .path-wrapper { 
            position: relative; width: 100%; max-width: 450px; margin: 0 auto; 
            padding-top: 20px; padding-bottom: 100px; min-height: 1500px; 
            display: flex; justify-content: center;
        }
        .path-container { 
            position: relative; display: flex; flex-direction: column; 
            align-items: center; gap: 140px; z-index: 10; width: 100%;
        }
        
        .level-node {
            width: 90px; height: 90px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 2rem; cursor: pointer; position: relative;
            background: white; z-index: 20;
            box-shadow: 0 10px 0 #eee, 0 15px 30px rgba(0,0,0,0.05);
            opacity: 0; transform: scale(0.3) translateY(50px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .node-left { transform: translateX(-80px); }
        .node-right { transform: translateX(80px); }

        .level-node.node-appear { opacity: 1; transform: scale(1) translateY(0); }
        .level-node.node-left.node-appear { transform: translateX(-80px) scale(1) translateY(0); }
        .level-node.node-right.node-appear { transform: translateX(80px) scale(1) translateY(0); }

        .level-node:hover { transform: translateY(-12px) scale(1.1); box-shadow: 0 15px 0 #eee, 0 25px 40px rgba(255, 143, 80, 0.2); }
        .level-node.node-left:hover { transform: translateX(-80px) translateY(-12px) scale(1.1); }
        .level-node.node-right:hover { transform: translateX(80px) translateY(-12px) scale(1.1); }

        .level-passed { background: linear-gradient(135deg, #58cc02, #46a302); color: white; border-bottom: 8px solid #3b8a02; box-shadow: 0 10px 20px rgba(88, 204, 2, 0.3); }
        .level-current { 
            background: white; color: var(--primary); border: 6px solid var(--primary); 
            animation: bounce 2s infinite; 
            box-shadow: 0 0 30px rgba(255, 143, 80, 0.5);
        }
        .level-locked { background: #e5e5e5; color: #afafaf; cursor: not-allowed; pointer-events: none; border-bottom: 8px solid #ccc; }
        
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        .node-left.level-current { animation: bounceLeft 2s infinite; }
        .node-right.level-current { animation: bounceRight 2s infinite; }
        @keyframes bounceLeft { 0%, 100% { transform: translateX(-80px) translateY(0); } 50% { transform: translateX(-80px) translateY(-15px); } }
        @keyframes bounceRight { 0%, 100% { transform: translateX(80px) translateY(0); } 50% { transform: translateX(80px) translateY(-15px); } }

        .completed-medal { font-size: 1.8rem; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2)); animation: medalPop 0.5s ease; }
        @keyframes medalPop { from { transform: scale(0) rotate(-45deg); } to { transform: scale(1) rotate(0); } }

        .node-label {
            position: absolute; top: 105px; left: 50%; transform: translateX(-50%); 
            background: white; padding: 8px 18px; border-radius: 14px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.06); font-size: 13px; font-weight: 800; color: #5d4037;
            white-space: nowrap; border: 2px solid #fff; pointer-events: none; z-index: 30;
        }
        .level-node:hover .node-label { background: var(--primary); color: white; transform: translate(-50%, 8px); }

        #path-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; }
        
        .path-line { stroke: #e5e7eb; stroke-width: 12; stroke-linecap: round; stroke-linejoin: round; fill: none; }

        .path-draw-anim {
            stroke: #FF8F50; stroke-width: 12; stroke-linecap: round; stroke-linejoin: round; fill: none;
            stroke-dasharray: 3000; stroke-dashoffset: 3000; animation: drawLine 2.5s ease-out forwards;
        }
        @keyframes drawLine { to { stroke-dashoffset: 0; } }

        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 768px) { 
            .mobile-header { display: flex; }
            #sidebar-overlay.active { display: block; }

            #menu-placeholder { 
                width: 0; display: block; 
                position: static; 
            }
            
            aside {
                position: fixed !important; 
                left: 0 !important; top: 0 !important; bottom: 0 !important;
                transform: translateX(-100%); 
                z-index: 10002 !important; 
                width: 280px !important; 
                background: white !important; 
                transition: transform 0.3s ease-in-out !important;
                box-shadow: 10px 0 50px rgba(0,0,0,0.2) !important;
                opacity: 1 !important; 
            }
            aside.open { transform: translateX(0) !important; }

            .main-content { padding: 90px 20px 40px !important; width: 100%; }

            /* MỚI THÊM: Ẩn Avatar ở Mobile */
            #avatar-initial { display: none !important; }

            .welcome-card { padding: 30px 20px; margin-bottom: 50px; }
            .node-label { font-size: 11px; padding: 6px 12px; }
            .path-wrapper { max-width: 100%; }
            
            .node-left { transform: translateX(-50px); }
            .node-right { transform: translateX(50px); }
            
            .level-node.node-left.node-appear { transform: translateX(-50px) scale(1) translateY(0); }
            .level-node.node-right.node-appear { transform: translateX(50px) scale(1) translateY(0); }
            
            @keyframes bounceLeft { 0%, 100% { transform: translateX(-50px) translateY(0); } 50% { transform: translateX(-50px) translateY(-15px); } }
            @keyframes bounceRight { 0%, 100% { transform: translateX(50px) translateY(0); } 50% { transform: translateX(50px) translateY(-15px); } }
        }

/* --- GLOBAL SCROLLBAR STYLE --- */

/* 1. Thiết lập độ rộng/cao của thanh trượt */
::-webkit-scrollbar {
    width: 10px;  /* Độ rộng cho thanh dọc */
    height: 10px; /* Độ cao cho thanh ngang */
}

/* 2. Thiết lập rãnh trượt (Track) - Nền chìm */
::-webkit-scrollbar-track {
    background: rgba(255, 143, 80, 0.05); /* Màu cam cực nhạt, gần như trong suốt */
    border-radius: 10px;
}

/* 3. Thiết lập tay nắm (Thumb) - Phần di chuyển */
::-webkit-scrollbar-thumb {
    background-color: rgba(255, 143, 80, 0.3); /* Mặc định là cam nhạt */
    border-radius: 10px; /* Bo tròn mềm mại */
    
    /* Mẹo: Tạo viền trong suốt để thanh trượt trông nhỏ hơn và "lơ lửng" */
    border: 2px solid transparent;
    background-clip: content-box;
    transition: background-color 0.3s ease;
}

/* 4. Hiệu ứng khi di chuột vào (Hover) */
::-webkit-scrollbar-thumb:hover {
    background-color: #FF8F50; /* Đổi sang màu cam chính thương hiệu */
    border: 1px solid transparent; /* Làm thanh trượt to ra một chút khi hover */
}

/* 5. (Tùy chọn) Ẩn nút mũi tên 2 đầu (nếu trình duyệt hiển thị) */
::-webkit-scrollbar-button {
    display: none;
}
    </style>
</head>
<body>

    <div class="mobile-header lg:hidden">
        <button onclick="toggleSidebar()" class="text-orange-500 text-2xl mr-4 focus:outline-none">
            <i class="fas fa-bars"></i>
        </button>
        <div class="flex items-center gap-2">
            <img src="../LOGO.WEBP" alt="Logo" class="w-8 h-8">
            <span class="font-black text-orange-500 text-lg">HOPVAN</span>
        </div>
    </div>

    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div id="menu-placeholder"></div>

    <main class="main-content">
        <div class="welcome-card">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                <div class="z-10">
                    <h1 class="text-4xl font-black mb-2 tracking-tight">Xin chào, <span id="user-display-name"></span></h1>
                    <p class="font-bold text-white/90 text-lg">Hãy cùng bắt đầu học tập cùng với HopVan nhé!</p>
                    
                    <div class="flex gap-4 mt-6">
                        <div class="bg-white/20 backdrop-blur-md px-5 py-3 rounded-[22px] flex items-center gap-3 font-black text-white border border-white/30 shadow-lg">
                            <i class="fas fa-fire text-yellow-300"></i> Chuỗi: <span id="streak-val">0</span>
                        </div>
                        <div class="bg-white/20 backdrop-blur-md px-5 py-3 rounded-2xl flex items-center gap-3 font-black text-white border border-white/30 shadow-lg">
                            <i class="fas fa-crown text-yellow-400"></i> Level: <span id="level-val">0</span>
                        </div>
                    </div>
                </div>
                <div id="avatar-initial" class="w-24 h-24 bg-white text-orange-500 rounded-[30px] flex items-center justify-center font-black text-4xl shadow-2xl transform rotate-6 border-4 border-white/50 z-10"></div>
            </div>
        </div>

        <div class="path-wrapper">
            <svg id="path-svg"></svg>
            <div id="path-render" class="path-container"></div>
        </div>
    </main>

<script src="../chatbot.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAJ9C2biYeiLPmhakzLZ4mEqfO9_VgPSZE", authDomain: "hopvan-9a648.firebaseapp.com", projectId: "hopvan-9a648", storageBucket: "hopvan-9a648.appspot.com", messagingSenderId: "429347196227", appId: "1:429347196227:web:917b8d019f0efd0f7833f6", measurementId: "G-1BG8PSRG0R" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const courseMap = [
        { id: 1, title: 'Trắc Nghiệm' }, { id: 2, title: 'Đọc Hiểu' },
        { id: 3, title: 'NLXH' }, { id: 4, title: 'NLVH' },
        { id: 5, title: 'Trắc Nghiệm' }, { id: 6, title: 'Đọc Hiểu' },
        { id: 7, title: 'NLXH' }, { id: 8   , title: 'NLVH' }
    ];

    // --- LOGIC SIDEBAR TOGGLE (MỚI) ---
    window.toggleSidebar = () => {
        const sidebar = document.querySelector('aside');
        const overlay = document.getElementById('sidebar-overlay');
        
        if (sidebar && overlay) {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
            
            if (sidebar.classList.contains('open')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = 'auto';
            }
        }
    };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const name = user.displayName || user.email.split('@')[0];
            document.getElementById('user-display-name').innerText = name;
            document.getElementById('avatar-initial').innerText = name[0].toUpperCase();

            try {
                // --- ĐỒNG BỘ STREAK ---
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                const todayStr = new Date().toLocaleDateString('en-CA');
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toLocaleDateString('en-CA');

                let streakValue = 0;
                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    streakValue = userData.streak || 1;
                    if (userData.lastLoginDate !== todayStr) {
                        streakValue = (userData.lastLoginDate === yesterdayStr) ? streakValue + 1 : 1;
                        await updateDoc(userRef, { lastLoginDate: todayStr, streak: streakValue });
                    }
                } else {
                    streakValue = 1;
                    await setDoc(userRef, { lastLoginDate: todayStr, streak: 1, email: user.email });
                }
                document.getElementById('streak-val').innerText = streakValue;

                // --- LẤY LEVEL ---
                const progressRef = doc(db, "users_progress", user.uid);
                const progressSnap = await getDoc(progressRef);
                let currentLevel = progressSnap.exists() ? progressSnap.data().currentLevel : 1;
                
                document.getElementById('level-val').innerText = currentLevel;
                renderJourney(currentLevel);

            } catch (error) { renderJourney(1); }
        } else { window.location.href = "../log.html"; }
    });

    function renderJourney(userLevel) {
        const container = document.getElementById('path-render');
        container.innerHTML = "";

        courseMap.forEach((lvl, index) => {
            const node = document.createElement('div');
            let status = 'level-locked';
            if (lvl.id < userLevel) status = 'level-passed';
            else if (lvl.id === userLevel) status = 'level-current';

            // Logic Zigzag: Giữa (0) -> Trái (1) -> Giữa (2) -> Phải (3)
            let posClass = '';
            const posIndex = index % 4;
            if (posIndex === 1) posClass = 'node-left';
            if (posIndex === 3) posClass = 'node-right';

            node.className = `level-node ${status} ${posClass}`;
            
            if (lvl.id < userLevel) {
                node.innerHTML = '<i class="fas fa-medal completed-medal"></i>';
            } else if (lvl.id === userLevel) {
                node.innerHTML = '<i class="fas fa-feather-pointed fa-shake"></i>';
            } else {
                node.innerHTML = '<i class="fas fa-lock text-sm opacity-30"></i>';
            }

            const label = document.createElement('div');
            label.className = "node-label";
            label.innerText = lvl.title;
            node.appendChild(label);

            if (lvl.id <= userLevel) {
                node.onclick = () => { window.location.href = `../nhatkyhoctap/${lvl.id}.html`; };
            }
            container.appendChild(node);
            setTimeout(() => node.classList.add('node-appear'), index * 150);
        });
        
        // Đợi 1 chút để DOM render xong rồi vẽ đường cong
        setTimeout(drawCurvedPath, 800);
    }

    function drawCurvedPath() {
        const nodes = document.querySelectorAll('.level-node');
        const svg = document.getElementById('path-svg');
        const wrapper = document.querySelector('.path-wrapper');
        if (!svg || nodes.length < 2) return;

        // Tăng chiều cao SVG để bao trọn do gap tăng lên
        svg.setAttribute('height', wrapper.scrollHeight);
        svg.setAttribute('width', wrapper.clientWidth);
        svg.innerHTML = "";

        let pathData = "";
        
        nodes.forEach((node, i) => {
            if (i === nodes.length - 1) return; 

            const rect1 = node.getBoundingClientRect();
            const rect2 = nodes[i+1].getBoundingClientRect();
            const wrapperRect = wrapper.getBoundingClientRect();

            // Tính tâm của nút (đã tính offset gap tự động nhờ vị trí DOM)
            const x1 = rect1.left + rect1.width / 2 - wrapperRect.left;
            const y1 = node.offsetTop + node.offsetHeight / 2;

            const x2 = rect2.left + rect2.width / 2 - wrapperRect.left;
            const y2 = nodes[i+1].offsetTop + nodes[i+1].offsetHeight / 2;

            if (i === 0) pathData += `M ${x1} ${y1}`;

            // Vẽ đường cong Bezier mềm mại hơn với khoảng cách dài hơn
            const cp1x = x1; 
            const cp1y = y1 + (y2 - y1) / 2;
            const cp2x = x2;
            const cp2y = y1 + (y2 - y1) / 2;

            pathData += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${x2} ${y2}`;
        });

        // Đường nền màu xám
        const pathLine = document.createElementNS("http://www.w3.org/2000/svg", "path");
        pathLine.setAttribute("d", pathData);
        pathLine.classList.add('path-line');
        svg.appendChild(pathLine);

        // Đường màu cam chạy đè lên
        const pathDraw = document.createElementNS("http://www.w3.org/2000/svg", "path");
        pathDraw.setAttribute("d", pathData);
        pathDraw.setAttribute("fill", "none");
        pathDraw.classList.add('path-draw-anim');
        svg.appendChild(pathDraw);
    }

    // Nạp Menu
    fetch('menu.html')
        .then(res => res.text())
        .then(html => {
            const placeholder = document.getElementById('menu-placeholder');
            placeholder.innerHTML = html;
            const scripts = placeholder.querySelectorAll('script');
            scripts.forEach(oldScript => {
                const newScript = document.createElement('script');
                newScript.text = oldScript.text; 
                document.body.appendChild(newScript); 
            });
            
            // Highlight menu item
            setTimeout(() => {
                const links = placeholder.querySelectorAll('.sb-link');
                links.forEach(l => {
                    if(l.getAttribute('href') && l.getAttribute('href').includes('nhatkyhoctap')) l.classList.add('active');
                    else l.classList.remove('active');
                });
            }, 100);
        })
        .catch(err => console.error("Lỗi tải menu:", err));

    window.addEventListener('resize', drawCurvedPath);
</script>

</body>
</html>