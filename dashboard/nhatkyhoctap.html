<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HopVan - Nhật Ký Học Tập</title>
    <meta property="og:title" content="HOPVAN - Nền Tảng Học & Luyện Thi Ngữ Văn" />
    <meta property="og:description" content="Nền tảng học tập Ngữ Văn tích hợp AI – hỗ trợ tự học thông minh, phân tích tác phẩm, luyện viết hiệu quả." />
    <meta property="og:image" content="https://hopvan.netlify.app/panel.webp" />
    <meta property="og:url" content="https://hopvan.netlify.app" />
    <meta property="og:type" content="article" />
    <link rel="icon" type="image/webp" href="../LOGO.WEBP" />
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #FF8F50;
            --primary-gradient: linear-gradient(135deg, #FF8F50, #FF5E62);
            --text-main: #2D3436;
            --text-light: #636E72;
            --glass-bg: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(255, 255, 255, 0.8);
            --blur: 25px;
            --sidebar-width: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; transition: all 0.3s ease; }
        body { background-color: #FFF5EC; height: 100vh; overflow: hidden; display: flex; }

        /* --- BACKGROUND --- */
        .background-blobs { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6; animation: floatBlob 10s infinite alternate; }
        .blob-1 { width: 500px; height: 500px; background: #FCA96A; top: -100px; left: -100px; }
        .blob-2 { width: 400px; height: 400px; background: #FCD5B5; bottom: -50px; right: -50px; animation-delay: -5s; }
        .blob-3 { width: 300px; height: 300px; background: #FFD1D1; top: 40%; left: 40%; animation-delay: -2s; }
        @keyframes floatBlob { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(30px, 50px) scale(1.1); } }

        /* --- GLOBAL SCROLLBAR STYLE --- */

        /* 1. Thiết lập độ rộng/cao của thanh trượt */
        ::-webkit-scrollbar {
            width: 10px;  /* Độ rộng cho thanh dọc */
            height: 10px; /* Độ cao cho thanh ngang */
        }

        /* 2. Thiết lập rãnh trượt (Track) - Nền chìm */
        ::-webkit-scrollbar-track {
            background: rgba(255, 143, 80, 0.05); /* Màu cam cực nhạt, gần như trong suốt */
            border-radius: 10px;
        }

        /* 3. Thiết lập tay nắm (Thumb) - Phần di chuyển */
        ::-webkit-scrollbar-thumb {
            background-color: rgba(255, 143, 80, 0.3); /* Mặc định là cam nhạt */
            border-radius: 10px; /* Bo tròn mềm mại */
            
            /* Mẹo: Tạo viền trong suốt để thanh trượt trông nhỏ hơn và "lơ lửng" */
            border: 2px solid transparent;
            background-clip: content-box;
            transition: background-color 0.3s ease;
        }

        /* 4. Hiệu ứng khi di chuột vào (Hover) */
        ::-webkit-scrollbar-thumb:hover {
            background-color: #FF8F50; /* Đổi sang màu cam chính thương hiệu */
            border: 1px solid transparent; /* Làm thanh trượt to ra một chút khi hover */
        }

        /* 5. (Tùy chọn) Ẩn nút mũi tên 2 đầu (nếu trình duyệt hiển thị) */
        ::-webkit-scrollbar-button {
            display: none;
        }

        /* --- LAYOUT --- */
        .mobile-header { display: none; position: fixed; top: 0; left: 0; right: 0; height: 60px; background: white; z-index: 100; align-items: center; padding: 0 20px; border-bottom: 1px solid #eee; }
        #sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); z-index: 998; }
        #menu-placeholder { width: var(--sidebar-width); flex-shrink: 0; transition: 0.3s; }

        .main-content {
            flex-grow: 1; width: calc(100% - var(--sidebar-width)); height: 100%;
            background: var(--glass-bg); backdrop-filter: blur(var(--blur));
            border-left: 1px solid var(--glass-border);
            padding: 30px 40px; overflow-y: auto; position: relative;
        }

        /* --- DASHBOARD ELEMENTS --- */
        .user-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .welcome-text h2 { font-size: 2.2rem; font-weight: 800; color: var(--text-main); }
        .user-avatar { width: 55px; height: 55px; background: var(--primary-gradient); border-radius: 18px; display: flex; justify-content: center; align-items: center; color: white; font-weight: 800; font-size: 1.3rem; box-shadow: 0 10px 25px rgba(255, 143, 80, 0.3); transform: rotate(-5deg); transition: 0.3s; cursor: pointer; }
        .user-avatar:hover { transform: rotate(0deg) scale(1.1); }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card {
            background: white; padding: 20px; border-radius: 24px; display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 5px 20px rgba(0,0,0,0.02); border: 1px solid rgba(0,0,0,0.03);
        }
        .stat-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 15px 35px rgba(255, 143, 80, 0.15); }
        .stat-card h3 { font-size: 0.9rem; color: var(--text-light); margin-bottom: 5px; display: flex; gap: 8px; align-items: center; }
        .stat-card .value { font-size: 2rem; font-weight: 800; color: var(--text-main); line-height: 1; }
        .stat-card .unit { font-size: 0.8rem; color: var(--primary); font-weight: 700; margin-top: 5px; }

        /* --- CONTENT SECTIONS --- */
        .section-title { font-size: 1.4rem; font-weight: 900; color: var(--text-main); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        
        /* 1. SKILL TREE CARDS (Style giống ảnh bạn gửi) */
        .skill-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px; }
        
        .skill-card {
            background: white; border-radius: 24px; padding: 25px 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.03); border: 1px solid white;
            transition: 0.3s; position: relative; overflow: hidden; cursor: pointer;
        }
        .skill-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(255, 143, 80, 0.15); border-color: #FF8F50; }

        .skill-icon { 
            width: 60px; height: 60px; background: #fff5ec; color: #FF8F50; border-radius: 18px;
            display: flex; align-items: center; justify-content: center; font-size: 1.8rem; margin-bottom: 15px;
        }
        .skill-title { font-size: 1.1rem; font-weight: 800; color: #2d3436; margin-bottom: 5px; }
        .skill-info { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 700; color: #b2bec3; margin-bottom: 10px; }
        
        .skill-progress-bg { height: 8px; background: #f1f2f6; border-radius: 10px; overflow: hidden; margin-bottom: 15px; }
        .skill-progress-bar { height: 100%; background: #FF8F50; width: 0%; border-radius: 10px; transition: width 1s ease; }

        /* Accordion List (Ẩn/Hiện) */
        .skill-list { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .skill-card.active .skill-list { max-height: 500px; transition: max-height 0.5s ease-in; border-top: 1px dashed #eee; margin-top: 10px; padding-top: 10px; }
        
        .skill-item-link { 
            display: flex; align-items: center; gap: 10px; padding: 10px 5px; 
            font-size: 0.9rem; color: #636e72; text-decoration: none; transition: 0.2s; border-radius: 8px;
        }
        .skill-item-link:hover { background: #fffbf0; color: #FF8F50; padding-left: 10px; }
        
        /* HIGHLIGHT COMPLETED ITEMS */
        .skill-item-link.completed { color: #2d3436; font-weight: 700; }
        .skill-item-link.completed i { color: #2ecc71; } /* Tick xanh */
        .skill-item-link i { font-size: 0.7rem; color: #dfe6e9; width: 15px; }

        .toggle-icon { position: absolute; top: 25px; right: 20px; color: #dfe6e9; transition: 0.3s; }
        .skill-card.active .toggle-icon { transform: rotate(180deg); color: #FF8F50; }

        /* 2. JOURNEY MAP (HORIZONTAL SCROLL - BLOOKET STYLE) */
        .map-container {
            background: white; border-radius: 30px; padding: 30px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.02); position: relative; overflow: hidden;
        }
        .map-scroll-area {
            display: flex; align-items: center; gap: 30px; padding: 20px 40px;
            overflow-x: auto; scroll-behavior: smooth; position: relative; z-index: 10;
        }
        /* Đường kẻ nối */
        .map-line {
            position: absolute; top: 50%; left: 0; right: 0; height: 8px; background: #f1f2f6; 
            transform: translateY(-50%); z-index: 1; border-radius: 4px;
        }
        .map-line-progress {
            position: absolute; top: 50%; left: 0; height: 8px; background: var(--primary-gradient);
            transform: translateY(-50%); z-index: 1; border-radius: 4px; width: 0%; transition: width 1s;
        }

        .map-node {
            flex-shrink: 0; width: 140px; height: 160px; background: white; border-radius: 20px;
            border: 3px solid #f1f2f6; position: relative; z-index: 2;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s; box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }
        .map-node:hover { transform: translateY(-10px); }
        
        .map-node.active { border-color: #FF8F50; box-shadow: 0 15px 30px rgba(255, 143, 80, 0.3); animation: pulse 2s infinite; }
        .map-node.completed { border-color: #2ecc71; background: #f0fdf4; }
        
        .node-icon { font-size: 2.5rem; margin-bottom: 10px; color: #dfe6e9; }
        .map-node.active .node-icon { color: #FF8F50; }
        .map-node.completed .node-icon { color: #2ecc71; }
        
        .node-title { font-size: 0.8rem; font-weight: 800; color: #636e72; text-align: center; padding: 0 5px; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 143, 80, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(255, 143, 80, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 143, 80, 0); } }

        /* MODALS */
        .hv-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .hv-modal.show { display: flex; }
        .hv-modal-box { background: white; padding: 30px; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: slideUp 0.3s; }
        .hv-btn { width: 100%; padding: 12px; border-radius: 12px; font-weight: 700; border: none; margin-top: 10px; cursor: pointer; transition: 0.2s; }
        .hv-btn-primary { background: var(--primary-gradient); color: white; }
        .hv-btn-gray { background: #f1f2f6; color: #636e72; }

        @media (max-width: 768px) {
            .mobile-header { display: flex; }
            #sidebar-overlay.active { display: block; }
            #menu-placeholder { width: 0; }
            .main-content { margin-left: 0; width: 100%; padding: 80px 20px 40px; }
            aside { position: fixed !important; transform: translateX(-100%); z-index: 10002; width: 280px !important; }
            aside.open { transform: translateX(0) !important; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .skill-grid { grid-template-columns: 1fr; }
            .map-node { width: 120px; height: 140px; }
        }
    </style>
</head>
<body>

    <div class="background-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <div class="mobile-header lg:hidden">
        <button onclick="toggleSidebar()" class="text-orange-500 text-2xl mr-4"><i class="fas fa-bars"></i></button>
        <div class="flex items-center gap-2"><img src="../LOGO.WEBP" class="w-8 h-8"><span class="font-black text-orange-500 text-lg">HOPVAN</span></div>
    </div>
    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div id="menu-placeholder"></div>

    <main class="main-content">
        <div class="user-header">
            <div class="welcome-text">
                <h2 id="welcome-name">Xin chào,</h2>
                <p style="color: var(--text-light); margin-top: 5px;">Hãy cùng bắt đầu học tập cùng với HopVan nhé!</p>
            </div>
            <div class="user-avatar" id="avatar-initial"></div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3><i class="fas fa-crown text-yellow-500"></i> Rank</h3>
                <div class="value" id="rank-val" style="font-size: 1.5rem; color: #FF8F50;"></div>
                <div class="unit" id="next-rank-info">0 ngày:</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-fire" style="color: #FF5E62"></i> Chuỗi</h3>
                <div class="value" id="streak-val">0</div>
                <div class="unit">ngày liên tiếp</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-key text-yellow-500"></i> Keys</h3>
                <div class="value" id="keys-val">0</div>
                <div class="unit">hiện có</div>
            </div>
            <div class="stat-card">
                <h3><i class="fas fa-star" style="color: #FF5E62"></i> Level Tổng</h3>
                <div class="value" id="total-lvl">1</div>
                <div class="unit">Trung bình</div>
            </div>
        </div>

        <h3 class="section-title"><i class="fas fa-brain" style="color: #FF8F50;"></i> Bối Cảnh Tri Thức</h3>
        <div class="skill-grid">
            
            <div class="skill-card" onclick="toggleCard(this)">
                <i class="fas fa-chevron-down toggle-icon"></i>
                <div class="skill-icon"><i class="fas fa-book-open"></i></div>
                <div class="skill-title">Đọc Hiểu</div>
                <div class="skill-info"><span id="lvl-reading">Lv.1</span><span id="pct-reading">0%</span></div>
                <div class="skill-progress-bg"><div class="skill-progress-bar" id="bar-reading"></div></div>
                
                <div class="skill-list" id="list-reading">
                    </div>
            </div>

            <div class="skill-card" onclick="toggleCard(this)">
                <i class="fas fa-chevron-down toggle-icon"></i>
                <div class="skill-icon"><i class="fas fa-globe-asia"></i></div>
                <div class="skill-title">NLXH</div>
                <div class="skill-info"><span id="lvl-nlxh">Lv.1</span><span id="pct-nlxh">0%</span></div>
                <div class="skill-progress-bg"><div class="skill-progress-bar" id="bar-nlxh"></div></div>
                <div class="skill-list" id="list-nlxh"></div>
            </div>

            <div class="skill-card" onclick="toggleCard(this)">
                <i class="fas fa-chevron-down toggle-icon"></i>
                <div class="skill-icon"><i class="fas fa-feather-alt"></i></div>
                <div class="skill-title">NLVH</div>
                <div class="skill-info"><span id="lvl-nlvh">Lv.1</span><span id="pct-nlvh">0%</span></div>
                <div class="skill-progress-bg"><div class="skill-progress-bar" id="bar-nlvh"></div></div>
                <div class="skill-list" id="list-nlvh"></div>
            </div>

            <div class="skill-card" onclick="toggleCard(this)">
                <i class="fas fa-chevron-down toggle-icon"></i>
                <div class="skill-icon"><i class="fas fa-lightbulb"></i></div>
                <div class="skill-title">Ngôn Ngữ & Tư Duy</div>
                <div class="skill-info"><span id="lvl-lang">Lv.1</span><span id="pct-lang">0%</span></div>
                <div class="skill-progress-bg"><div class="skill-progress-bar" id="bar-lang"></div></div>
                <div class="skill-list" id="list-lang"></div>
            </div>
        </div>

        <h3 class="section-title"><i class="fas fa-map-marked-alt" style="color: #FF8F50;"></i> Hành Trình Văn Chương</h3>
        <div class="map-container">
            <div class="map-line"></div>
            <div class="map-line-progress" id="map-progress-bar"></div>
            <div class="map-scroll-area" id="journey-container">
                </div>
        </div>

    </main>

    <div id="modal-unlock" class="hv-modal">
        <div class="hv-modal-box">
            <div class="text-5xl mb-4"></div>
            <h3 class="text-xl font-bold mb-2">Mở khóa bài học?</h3>
            <p class="text-sm text-gray-500 mb-6">Bạn cần <b>5 Keys</b>. Hoàn thành để nhận lại <b>10 Keys</b>!</p>
            <button class="hv-btn hv-btn-primary" id="btn-unlock-confirm">Mở ngay (-5 Keys)</button>
            <button class="hv-btn hv-btn-gray" onclick="closeModal()">Để sau</button>
        </div>
    </div>
    
    <div id="modal-alert" class="hv-modal">
        <div class="hv-modal-box">
            <div class="text-5xl mb-4"></div>
            <h3 class="text-xl font-bold mb-2">Thiếu Keys rồi!</h3>
            <p class="text-sm text-gray-500 mb-6">Hãy điểm danh hoặc làm bài tập khác để kiếm thêm nhé.</p>
            <button class="hv-btn hv-btn-primary" onclick="closeModal()">Đã hiểu</button>
        </div>
    </div>

    <script type="module" src="gam.js"></script>
    <script src="../chatbot.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, increment, collection, query, where, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { initMenu } from "./menu.js";

    // --- CONFIG ---
    const firebaseConfig = { apiKey: "AIzaSyAJ9C2biYeiLPmhakzLZ4mEqfO9_VgPSZE", authDomain: "hopvan-9a648.firebaseapp.com", projectId: "hopvan-9a648", storageBucket: "hopvan-9a648.appspot.com", messagingSenderId: "429347196227", appId: "1:429347196227:web:917b8d019f0efd0f7833f6", measurementId: "G-1BG8PSRG0R" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- DỮ LIỆU CẤU HÌNH ---
    
    // 1. Skill Tree (Danh sách các bài học trong từng kỹ năng)
    const SKILL_STEPS = {
        reading: [
            {l: "Chạm chữ", s: "cham-chu"}, {l: "Hiểu lời", s: "hieu-loi"}, {l: "Thấy hình trong chữ", s: "thay-hinh"}, 
            {l: "Nghe điều chưa nói", s: "nghe-dieu"}, {l: "Nghĩ cùng văn bản", s: "nghi-cung"}, {l: "Đối thoại với tác giả", s: "doi-thoai"}, {l: "Đọc như người viết", s: "doc-nhu-viet"}
        ],
        nlxh: [
            {l: "Gọi tên vấn đề", s: "goi-ten"}, {l: "Nói điều mình nghĩ", s: "noi-dieu"}, {l: "Lí lẽ thành hình", s: "li-le"}, 
            {l: "Nhìn nhiều phía", s: "nhin-nhieu-phia"}, {l: "Chạm tới con người", s: "cham-toi-con-nguoi"}, {l: "Viết bằng chính kiến", s: "chinh-kien"}, {l: "Kiến tạo tiếng nói", s: "tieng-noi"}
        ],
        nlvh: [
            {l: "Cảm được cái hay", s: "cam-hay"}, {l: "Hiểu mạch tác phẩm", s: "hieu-mach"}, {l: "Giải nghĩa nghệ thuật", s: "giai-nghia"}, 
            {l: "Đi vào tầng sâu", s: "tang-sau"}, {l: "Liên hệ miền văn", s: "lien-he"}, {l: "Viết giọng phê bình", s: "phe-binh"}, {l: "Phong cách học thuật", s: "hoc-thuat"}
        ],
        lang: [
            {l: "Nhận diện ngôn ngữ", s: "nhan-dien"}, {l: "Hiểu cấu trúc", s: "cau-truc"}, {l: "Tín hiệu nghệ thuật", s: "tin-hieu"}, 
            {l: "Suy luận nghĩa", s: "suy-luan"}, {l: "Phân tích quan điểm", s: "phan-tich"}, {l: "Đánh giá hiệu quả", s: "danh-gia"}, {l: "Tư duy học thuật", s: "tu-duy"}
        ]
    };

    // 2. Journey Map (Hành trình văn chương)
    const JOURNEY_DATA = [
        { id: 1, slug: 'buoc-vao-chu-nghia', title: 'Bước vào chữ nghĩa', icon: 'fas fa-shoe-prints' },
        { id: 2, slug: 'hoc-cach-doc', title: 'Học cách đọc', icon: 'fas fa-book-reader' },
        { id: 3, slug: 'hoc-cach-nghi', title: 'Học cách nghĩ', icon: 'fas fa-lightbulb' },
        { id: 4, slug: 'hoc-cach-viet', title: 'Học cách viết', icon: 'fas fa-pen-nib' },
        { id: 5, slug: 'di-qua-noi-nguoc', title: 'Đi qua nỗi ngược', icon: 'fas fa-mountain' },
        { id: 6, slug: 'tim-tieng-noi-rieng', title: 'Tìm tiếng nói riêng', icon: 'fas fa-microphone-alt' },
        { id: 7, slug: 'o-lai-voi-van-chuong', title: 'Ở lại với văn chương', icon: 'fas fa-heart' },
    ];

    let userKeys = 0;
    let unlockedSlugs = [];

    initMenu(app);

    // --- MAIN LOGIC ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const name = user.displayName || user.email.split('@')[0];
            document.getElementById('welcome-name').innerText = `Xin chào, ${name}`;
            document.getElementById('avatar-initial').innerText = name[0].toUpperCase();

            // 1. Tải Stats (Keys, Streak)
            const userSnap = await getDoc(doc(db, "users", user.uid));
            let streak = 0;
            if (userSnap.exists()) {
                const d = userSnap.data();
                userKeys = d.keys || 0;
                streak = d.streak || 0;
                document.getElementById('keys-val').innerText = userKeys;
                document.getElementById('streak-val').innerText = streak;
                updateRank(streak);
            }

            // 2. Tải Progress (Bài đã mở khoá)
            const progRef = doc(db, "users_progress", user.uid);
            const progSnap = await getDoc(progRef);
            if (progSnap.exists()) unlockedSlugs = progSnap.data().unlockedSlugs || [];
            else await setDoc(progRef, { unlockedSlugs: [] });

            // 3. Render Giao diện
            renderSkillTree(user.uid);
            renderMap();
        } else {
            window.location.href = "../log.html";
        }
    });

    function updateRank(streak) {
        let r = "Tân Binh";
        let next = "3 ngày: Chớm lửa";
        if (streak >= 3) { r = "Chớm Lửa"; next = "7 ngày: Giữ lửa"; }
        if (streak >= 7) { r = "Giữ Lửa"; next = "30 ngày: Bền lửa"; }
        if (streak >= 30) { r = "Bền Lửa"; next = "100 ngày: Người ở lại"; }
        if (streak >= 100) { r = "Người Ở Lại"; next = "Huyền thoại!"; }
        document.getElementById('rank-val').innerText = r;
        document.getElementById('next-rank-info').innerText = next;
    }

    // --- LOGIC 1: BỐI CẢNH TRI THỨC (Tính điểm TB từ Phòng Luyện Đề) ---
    async function renderSkillTree(uid) {
        // Lấy tất cả kết quả làm bài từ 'activities' của user
        const q = query(collection(db, "activities"), where("uid", "==", uid));
        const snap = await getDocs(q);
        
        // Tạo object chứa mảng điểm cho từng kỹ năng
        let scores = { reading: [], nlxh: [], nlvh: [], lang: [] };
        
        snap.forEach(doc => {
            const d = doc.data();
            // Chỉ lấy những bài có điểm số (score)
            if (d.score !== undefined && d.score !== null) {
                let type = d.type; // Loại bài (lưu trong DB khi làm bài)
                
                // Chuẩn hóa loại bài về 4 nhóm chính
                if (type === 'trac-nghiem' || type === 'reading' || type === 'doc_hieu') type = 'reading';
                else if (type === 'nlxh') type = 'nlxh';
                else if (type === 'nlvh') type = 'nlvh';
                else if (type === 'ngon-ngu' || type === 'lang') type = 'lang';
                
                // Đẩy điểm vào mảng tương ứng
                if (scores[type]) scores[type].push(Number(d.score));
            }
        });

        // Hàm cập nhật giao diện từng thẻ Card
        const updateUI = (key, arr, steps) => {
            let lvl = 1; // Mặc định Level 1
            
            if (arr && arr.length > 0) {
                // 1. Tính điểm trung bình cộng
                const avg = arr.reduce((a,b)=>a+b,0) / arr.length;
                
                // 2. Xác định Level cơ bản dựa trên điểm số
                let base = 1;
                if (avg >= 8.0) base = 3;      // Giỏi
                else if (avg >= 5.0) base = 2; // Khá
                
                // 3. Level cộng thêm dựa trên số lượng bài làm (Chăm chỉ)
                // Cứ 5 bài làm xong = +1 Level
                let bonus = Math.floor(arr.length / 5);
                
                // 4. Tổng Level (Max là 7 theo số lượng bài học hiển thị)
                lvl = Math.min(7, base + bonus);
            }

            // Cập nhật text và thanh tiến độ
            document.getElementById(`lvl-${key}`).innerText = `Lv.${lvl}`;
            document.getElementById(`pct-${key}`).innerText = `${Math.round((lvl/7)*100)}%`;
            document.getElementById(`bar-${key}`).style.width = `${(lvl/7)*100}%`;

            // Render danh sách bài học và đánh dấu hoàn thành
            const listEl = document.getElementById(`list-${key}`);
            listEl.innerHTML = steps.map((step, index) => {
                // Nếu index nhỏ hơn Level hiện tại -> Đã hoàn thành
                const isDone = index < lvl; 
                const statusClass = isDone ? "completed" : "";
                const icon = isDone ? "fa-check-circle" : "fa-circle"; 
                
                // Link tới trang làm bài (slug.html)
                return `
                <a href="../nhatkyhoctap/slug.html?id=${step.s}" class="skill-item-link ${statusClass}">
                    <i class="fas ${icon}"></i> 
                    <span>${index+1}. ${step.l}</span>
                </a>`;
            }).join('');
        };

        // Chạy cập nhật cho 4 cột
        updateUI('reading', scores.reading, SKILL_STEPS.reading);
        updateUI('nlxh', scores.nlxh, SKILL_STEPS.nlxh);
        updateUI('nlvh', scores.nlvh, SKILL_STEPS.nlvh);
        updateUI('lang', scores.lang, SKILL_STEPS.lang);
        
        // Tính Level Tổng (Trung bình cộng các Level con)
        let totalLvl = 0;
        let count = 0;
        // Tái tính toán nhanh để lấy tổng
        const calcLvl = (arr) => {
            if (!arr.length) return 1;
            const avg = arr.reduce((a,b)=>a+b,0)/arr.length;
            const base = avg >= 8 ? 3 : (avg >= 5 ? 2 : 1);
            return Math.min(7, base + Math.floor(arr.length / 5));
        };
        
        totalLvl += calcLvl(scores.reading);
        totalLvl += calcLvl(scores.nlxh);
        totalLvl += calcLvl(scores.nlvh);
        totalLvl += calcLvl(scores.lang);
        
        document.getElementById('total-lvl').innerText = Math.round(totalLvl / 4);
    }

    // Hiệu ứng đóng mở Accordion
    window.toggleCard = (el) => {
        // Ngăn sự kiện nếu bấm vào link
        if (event.target.closest('a')) return;
        el.classList.toggle('active');
    };

    // --- LOGIC 2: HÀNH TRÌNH VĂN CHƯƠNG (Map Ngang) ---
    function renderMap() {
        const container = document.getElementById('journey-container');
        const progressBar = document.getElementById('map-progress-bar');
        container.innerHTML = "";

        let lastUnlockedIndex = -1;

        JOURNEY_DATA.forEach((item, index) => {
            const isUnlocked = unlockedSlugs.includes(item.slug);
            // Logic: Bài đầu luôn mở, bài sau mở khi bài trước có trong unlockedSlugs
            const isNext = !isUnlocked && (index === 0 || unlockedSlugs.includes(JOURNEY_DATA[index-1].slug));
            
            let statusClass = 'locked';
            if (isUnlocked) { statusClass = 'completed'; lastUnlockedIndex = index; }
            else if (isNext) statusClass = 'active';

            const div = document.createElement('div');
            div.className = `map-node ${statusClass}`;
            div.innerHTML = `
                <div class="node-icon"><i class="${isUnlocked ? 'fas fa-check' : (isNext ? 'fas fa-play' : 'fas fa-lock')}"></i></div>
                <div class="node-title">${item.title}</div>
            `;
            div.onclick = () => handleMapClick(item, isUnlocked, isNext);
            container.appendChild(div);
        });

        // Cập nhật thanh tiến độ màu cam chạy ngang
        if (lastUnlockedIndex >= 0) {
            progressBar.style.width = `${((lastUnlockedIndex + 1) / JOURNEY_DATA.length) * 100}%`;
        }
    }

    function handleMapClick(item, isUnlocked, isNext) {
        if (isUnlocked) {
            // Đã mở -> Vào học
            window.location.href = `../nhatkyhoctap/slug.html?id=${item.slug}`;
        } 
        else if (isNext) {
            // Chưa mở nhưng đến lượt -> Hiện Popup hỏi Keys
            window.pendingItem = item;
            document.getElementById('modal-unlock').classList.add('show');
        }
        else {
            // Chưa đến lượt -> Rung lắc báo khóa
            // (Bạn có thể thêm hiệu ứng rung ở đây nếu muốn)
        }
    }

    // Xử lý nút "Mở ngay" trong Modal
    document.getElementById('btn-unlock-confirm').onclick = async () => {
        if (userKeys >= 5) {
            const uid = auth.currentUser.uid;
            
            // 1. Trừ Keys
            await updateDoc(doc(db, "users", uid), { keys: increment(-5) });
            
            // 2. Lưu trạng thái mở khoá
            const progRef = doc(db, "users_progress", uid);
            const newSlugs = [...unlockedSlugs, window.pendingItem.slug];
            await updateDoc(progRef, { unlockedSlugs: newSlugs });
            
            // 3. Cập nhật UI ngay lập tức
            userKeys -= 5; 
            unlockedSlugs = newSlugs;
            document.getElementById('keys-val').innerText = userKeys;
            
            closeModal(); 
            renderMap(); // Vẽ lại map
        } else { 
            closeModal(); 
            document.getElementById('modal-alert').classList.add('show'); 
        }
    };

    window.closeModal = () => document.querySelectorAll('.hv-modal').forEach(m => m.classList.remove('show'));
    window.toggleSidebar = () => {
        const sidebar = document.querySelector('aside');
        const overlay = document.getElementById('sidebar-overlay');
        if(sidebar) sidebar.classList.toggle('open');
        if(overlay) overlay.classList.toggle('active');
    };

</script>
</body>
</html>