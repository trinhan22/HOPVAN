<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HopVan - Nhật Ký Học Tập</title>
    <meta property="og:title" content="HOPVAN - Nền Tảng Học & Luyện Thi Ngữ Văn" />
    <meta property="og:description" content="Nền tảng học tập Ngữ Văn tích hợp AI – hỗ trợ tự học thông minh, phân tích tác phẩm, luyện viết hiệu quả." />
    <meta property="og:image" content="https://hopvan.netlify.app/panel.webp" />
    <meta property="og:url" content="https://hopvan.netlify.app" />
    <meta property="og:type" content="article" />
    <link rel="icon" type="image/webp" href="../LOGO.WEBP" />
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --primary: #FF8F50;
            --primary-gradient: linear-gradient(135deg, #FF8F50, #FF5E62);
            --text-main: #2D3436;
            --text-light: #636E72;
            --glass-bg: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(255, 255, 255, 0.8);
            --blur: 25px;
            --sidebar-width: 260px;
            --color-reading: #3b82f6; /* Xanh dương */
            --color-nlxh: #10b981;    /* Xanh lá */
            --color-nlvh: #f59e0b;    /* Vàng cam */
            --color-lang: #8b5cf6;    /* Tím */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; transition: all 0.3s ease; }
        body { background-color: #FFF5EC; height: 100vh; overflow: hidden; display: flex; }

        /* --- BACKGROUND --- */
        .background-blobs { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6; animation: floatBlob 10s infinite alternate; }
        .blob-1 { width: 500px; height: 500px; background: #FCA96A; top: -100px; left: -100px; }
        .blob-2 { width: 400px; height: 400px; background: #FCD5B5; bottom: -50px; right: -50px; animation-delay: -5s; }
        .blob-3 { width: 300px; height: 300px; background: #FFD1D1; top: 40%; left: 40%; animation-delay: -2s; }
        @keyframes floatBlob { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(30px, 50px) scale(1.1); } }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: rgba(255, 143, 80, 0.05); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background-color: rgba(255, 143, 80, 0.3); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
        ::-webkit-scrollbar-thumb:hover { background-color: #FF8F50; border: 1px solid transparent; }
        ::-webkit-scrollbar-button { display: none; }

        /* --- LAYOUT --- */
        .mobile-header { display: none; position: fixed; top: 0; left: 0; right: 0; height: 60px; background: white; z-index: 100; align-items: center; padding: 0 20px; border-bottom: 1px solid #eee; }
        #sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); z-index: 998; }
        #menu-placeholder { width: var(--sidebar-width); flex-shrink: 0; transition: 0.3s; }

        .main-content {
            flex-grow: 1; width: calc(100% - var(--sidebar-width)); height: 100%;
            background: var(--glass-bg); backdrop-filter: blur(var(--blur));
            border-left: 1px solid var(--glass-border);
            padding: 30px 40px; overflow-y: auto; position: relative;
        }

        .user-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .welcome-text h2 { font-size: 2.2rem; font-weight: 800; color: var(--text-main); }
        .user-avatar { width: 55px; height: 55px; background: var(--primary-gradient); border-radius: 18px; display: flex; justify-content: center; align-items: center; color: white; font-weight: 800; font-size: 1.3rem; box-shadow: 0 10px 25px rgba(255, 143, 80, 0.3); transform: rotate(-5deg); transition: 0.3s; cursor: pointer; }
        .user-avatar:hover { transform: rotate(0deg) scale(1.1); }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 40px; }
        .stat-card {
            background: rgba(255, 255, 255, 0.85); padding: 25px; border-radius: 28px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.02); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255, 255, 255, 1); display: flex; flex-direction: column; justify-content: space-between;
            position: relative; overflow: hidden; z-index: 1;
        }
        .stat-card:hover { 
            transform: translateY(-8px) scale(1.02); 
            background: white;
            box-shadow: 0 20px 40px rgba(255, 143, 80, 0.15); 
            border-color: var(--primary); 
            z-index: 10;
        }
        .stat-card h3 { font-size: 0.95rem; color: var(--text-light); margin-bottom: 5px; display: flex; gap: 8px; align-items: center; position: relative; z-index: 2; }
        .stat-card .value { font-size: 2.5rem; font-weight: 900; color: var(--text-main); line-height: 1; position: relative; z-index: 2; }
        .stat-card .unit { font-size: 0.85rem; color: var(--primary); font-weight: 700; margin-top: 8px; position: relative; z-index: 2; }

        .stat-watermark {
            position: absolute; right: -15px; bottom: -20px; font-size: 6rem;
            opacity: 0.05; transform: rotate(-15deg); transition: all 0.5s ease; z-index: 0;
        }
        .stat-card:hover .stat-watermark { transform: rotate(0deg) scale(1.2) translate(-5px, -5px); opacity: 0.1; color: var(--primary); }

        .section-title { font-size: 1.5rem; font-weight: 900; color: var(--text-main); margin-bottom: 25px; display: flex; align-items: center; gap: 12px; }

        /* SKILL TREE CARDS (CHECKLIST STYLE) */
        .skill-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 50px; }
        .skill-card {
            background: rgba(255, 255, 255, 0.9); border-radius: 28px; padding: 25px 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid white;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); position: relative; overflow: hidden; cursor: pointer; z-index: 1;
        }
        .skill-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(255, 143, 80, 0.15); border-color: #FF8F50; }
        .skill-icon { 
            width: 65px; height: 65px; border-radius: 20px; position: relative; z-index: 2;
            display: flex; align-items: center; justify-content: center; font-size: 2rem; margin-bottom: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.05); transition: transform 0.3s;
        }

        .skill-bg-icon {
            position: absolute; right: -20px; top: 10px; font-size: 8rem; opacity: 0.04;
            transform: rotate(15deg); transition: 0.5s; z-index: 0;
        }
        .skill-card:hover .skill-icon { transform: scale(1.1) rotate(-5deg); }

        /* Style màu riêng cho từng môn */
        .skill-reading:hover { border-color: var(--color-reading); box-shadow: 0 15px 40px rgba(59, 130, 246, 0.2); transform: translateY(-5px); }
        .skill-reading .skill-icon { color: var(--color-reading); background: #eff6ff; }
        .skill-reading .skill-progress-bar { background: linear-gradient(90deg, #60a5fa, var(--color-reading)); }
        
        .skill-nlxh:hover { border-color: var(--color-nlxh); box-shadow: 0 15px 40px rgba(16, 185, 129, 0.2); transform: translateY(-5px); }
        .skill-nlxh .skill-icon { color: var(--color-nlxh); background: #ecfdf5; }
        .skill-nlxh .skill-progress-bar { background: linear-gradient(90deg, #34d399, var(--color-nlxh)); }

        .skill-nlvh:hover { border-color: var(--color-nlvh); box-shadow: 0 15px 40px rgba(245, 158, 11, 0.2); transform: translateY(-5px); }
        .skill-nlvh .skill-icon { color: var(--color-nlvh); background: #fffbeb; }
        .skill-nlvh .skill-progress-bar { background: linear-gradient(90deg, #fbbf24, var(--color-nlvh)); }

        .skill-lang:hover { border-color: var(--color-lang); box-shadow: 0 15px 40px rgba(139, 92, 246, 0.2); transform: translateY(-5px); }
        .skill-lang .skill-icon { color: var(--color-lang); background: #f5f3ff; }
        .skill-lang .skill-progress-bar { background: linear-gradient(90deg, #a78bfa, var(--color-lang)); }

        .skill-title { font-size: 1.15rem; font-weight: 800; color: #2d3436; margin-bottom: 5px; position: relative; z-index: 2; }
        .skill-info { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 800; color: #94a3b8; margin-bottom: 12px; position: relative; z-index: 2; }
        .skill-progress-bg { height: 10px; background: #f1f5f9; border-radius: 10px; overflow: hidden; margin-bottom: 15px; position: relative; z-index: 2; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
        .skill-progress-bar { height: 100%; width: 0%; border-radius: 10px; transition: width 1s cubic-bezier(0.16, 1, 0.3, 1); }
        .skill-list { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; position: relative; z-index: 2; }
        .skill-card.active .skill-list { max-height: 600px; transition: max-height 0.5s ease-in; border-top: 1px dashed #e2e8f0; margin-top: 15px; padding-top: 15px; }
        .skill-item { 
            display: flex; align-items: center; gap: 12px; padding: 12px 10px; 
            font-size: 0.9rem; font-weight: 600; color: #94a3b8; border-radius: 12px; transition: 0.2s;
        }
        .skill-item:hover { background: #f8fafc; color: #475569; }
        .skill-item.completed { color: #334155; font-weight: 800; }
        .skill-item.completed i { color: #22c55e; filter: drop-shadow(0 2px 4px rgba(34, 197, 94, 0.3)); font-size: 1rem; }
        .skill-item i { font-size: 0.8rem; color: #cbd5e1; width: 16px; transition: 0.3s; }
        .toggle-icon { position: absolute; top: 30px; right: 25px; color: #cbd5e1; transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1); z-index: 2; font-size: 1.2rem; }
        .skill-card.active .toggle-icon { transform: rotate(180deg); color: var(--primary); }

        

        /* --- HORIZONTAL MAP (SÁNG VÀ NEON HƠN) --- */
        .map-container {
            background: rgba(255,255,255,0.8); border-radius: 40px; padding: 40px 0;
            box-shadow: 0 15px 40px rgba(0,0,0,0.03); position: relative; overflow: hidden; border: 1px solid white;
        }
        .map-scroll-area {
            display: flex; align-items: center; gap: 40px; padding: 20px 50px;
            overflow-x: auto; scroll-behavior: smooth; position: relative; z-index: 10;
        }
        .map-line {
            position: absolute; top: 50%; left: 0; right: 0; height: 12px; background: #f1f5f9; 
            transform: translateY(-50%); z-index: 1; border-radius: 10px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }
        .map-line-progress {
            position: absolute; top: 50%; left: 0; height: 12px; 
            background: linear-gradient(90deg, #FF8F50, #FF5E62);
            transform: translateY(-50%); z-index: 1; border-radius: 10px; width: 0%; transition: width 1.5s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 0 15px rgba(255, 94, 98, 0.5);
        }
        .map-node {
            flex-shrink: 0; width: 150px; height: 170px; background: white; border-radius: 28px;
            border: 4px solid #f1f5f9; position: relative; z-index: 2;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }
        .map-node:hover { transform: translateY(-15px) scale(1.05); }
        
        .map-node.active { 
            border-color: #FF8F50; 
            box-shadow: 0 20px 40px rgba(255, 143, 80, 0.3), inset 0 0 20px rgba(255, 143, 80, 0.1); 
            animation: nodePulse 2s infinite; 
            background: #fffaf6;
        }
        .map-node.completed { border-color: #22c55e; background: #f0fdf4; }
        
        .node-icon { font-size: 3rem; margin-bottom: 12px; color: #cbd5e1; transition: 0.3s; }
        .map-node:hover .node-icon { transform: scale(1.1); }
        .map-node.active .node-icon { color: #FF8F50; filter: drop-shadow(0 5px 10px rgba(255, 143, 80, 0.4)); }
        .map-node.completed .node-icon { color: #22c55e; }
        
        .node-title { font-size: 0.85rem; font-weight: 800; color: #64748b; text-align: center; padding: 0 10px; line-height: 1.4; }
        .map-node.active .node-title { color: #ea580c; }
        
        @keyframes nodePulse { 
            0% { box-shadow: 0 0 0 0 rgba(255, 143, 80, 0.4), 0 20px 40px rgba(255, 143, 80, 0.3); } 
            70% { box-shadow: 0 0 0 20px rgba(255, 143, 80, 0), 0 20px 40px rgba(255, 143, 80, 0.3); } 
            100% { box-shadow: 0 0 0 0 rgba(255, 143, 80, 0), 0 20px 40px rgba(255, 143, 80, 0.3); } 
        }

        /* MODALS */
        .hv-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 9999; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .hv-modal.show { display: flex; opacity: 1; }
        .hv-modal-box { background: white; padding: 40px; border-radius: 32px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 30px 60px rgba(0,0,0,0.25); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .hv-modal.show .hv-modal-box { transform: scale(1); }
        .hv-btn { width: 100%; padding: 15px; border-radius: 16px; font-weight: 800; font-size: 1rem; border: none; margin-top: 15px; cursor: pointer; transition: 0.2s; }
        .hv-btn-primary { background: var(--primary-gradient); color: white; box-shadow: 0 10px 20px rgba(255, 94, 98, 0.3); }
        .hv-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 15px 25px rgba(255, 94, 98, 0.4); }
        .hv-btn-gray { background: #f1f5f9; color: #64748b; }
        .hv-btn-gray:hover { background: #e2e8f0; color: #334155; }

        @media (max-width: 768px) {
            .mobile-header { display: flex; }
            #sidebar-overlay.active { display: block; }
            #menu-placeholder { width: 0; }
            .main-content { margin-left: 0; width: 100%; padding: 80px 20px 40px; }
            aside { position: fixed !important; transform: translateX(-100%); z-index: 10002; width: 280px !important; }
            aside.open { transform: translateX(0) !important; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .skill-grid { grid-template-columns: 1fr; }
            .map-node { width: 120px; height: 140px; }
        }
    </style>
</head>
<body>

    <div class="background-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <div class="mobile-header lg:hidden">
        <button onclick="toggleSidebar()" class="text-orange-500 text-2xl mr-4"><i class="fas fa-bars"></i></button>
        <div class="flex items-center gap-2"><img src="../LOGO.WEBP" class="w-8 h-8"><span class="font-black text-orange-500 text-lg">HOPVAN</span></div>
    </div>
    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div id="menu-placeholder"></div>

    <main class="main-content">
        <div class="user-header">
            <div class="welcome-text">
                <h2 id="welcome-name">Xin chào,</h2>
                <p style="color: var(--text-light); margin-top: 5px;">Hãy cùng bắt đầu học tập cùng với HopVan nhé!</p>
            </div>
            <div class="user-avatar overflow-hidden cursor-pointer" id="avatar-initial" onclick="window.location.href='account.html'" title="Đi đến trang cá nhân"></div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <i class="fas fa-crown stat-watermark text-yellow-500"></i>
                <h3><i class="fas fa-crown text-yellow-500"></i> Rank</h3>
                <div class="value" id="rank-val" style="color: #FF8F50;">Tân Binh</div>
                <div class="unit" id="next-rank-info">0 ngày:</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-fire stat-watermark text-red-500"></i>
                <h3><i class="fas fa-fire"style="color: #FF5E62;"></i> Chuỗi</h3>
                <div class="value" id="streak-val">0</div>
                <div class="unit">ngày liên tiếp</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-key stat-watermark text-yellow-400"></i>
                <h3><i class="fas fa-key text-yellow-500"></i> Keys</h3>
                <div class="value" id="keys-val">0</div>
                <div class="unit">hiện có</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-file-signature stat-watermark text-orange-500"></i>
                <h3><i class="fas fa-file-alt"style="color: #FF5E62;"></i> Đã làm</h3>
                <div class="value" id="total-exams">0</div>
                <div class="unit">đề thi</div>
            </div>
        </div>

        <h3 class="section-title"><i class="fas fa-brain" style="color: #FF8F50"></i> Bối Cảnh Tri Thức</h3>
        <p class="text-gray-500 font-medium mb-6 italic">Tiến độ được AI tự động cập nhật dựa trên kết quả thực tế tại Phòng Luyện Đề.</p>
        
        <div class="skill-grid">
            
            <div class="skill-card skill-reading" onclick="toggleCard(this)">
                <i class="fas fa-glasses skill-bg-icon text-blue-500"></i>
                <i class="fas fa-chevron-down toggle-icon"></i>
                <div class="skill-icon"><i class="fas fa-book-reader"></i></div>
                <div class="skill-title">Đọc Hiểu</div>
                <div class="skill-info"><span id="lvl-reading">Lv.1</span><span id="pct-reading">0%</span></div>
                <div class="skill-progress-bg"><div class="skill-progress-bar" id="bar-reading"></div></div>
                <div class="skill-list" id="list-reading"></div>
            </div>

            <div class="skill-card skill-nlxh" onclick="toggleCard(this)">
                <i class="fas fa-leaf skill-bg-icon text-green-500"></i>
                <i class="fas fa-chevron-down toggle-icon"></i>
                <div class="skill-icon"><i class="fas fa-globe-asia"></i></div>
                <div class="skill-title">Nghị Luận Xã Hội</div>
                <div class="skill-info"><span id="lvl-nlxh">Lv.1</span><span id="pct-nlxh">0%</span></div>
                <div class="skill-progress-bg"><div class="skill-progress-bar" id="bar-nlxh"></div></div>
                <div class="skill-list" id="list-nlxh"></div>
            </div>

            <div class="skill-card skill-nlvh" onclick="toggleCard(this)">
                <i class="fas fa-scroll skill-bg-icon text-yellow-500"></i>
                <i class="fas fa-chevron-down toggle-icon"></i>
                <div class="skill-icon"><i class="fas fa-feather-alt"></i></div>
                <div class="skill-title">Nghị Luận Văn Học</div>
                <div class="skill-info"><span id="lvl-nlvh">Lv.1</span><span id="pct-nlvh">0%</span></div>
                <div class="skill-progress-bg"><div class="skill-progress-bar" id="bar-nlvh"></div></div>
                <div class="skill-list" id="list-nlvh"></div>
            </div>

            <div class="skill-card skill-lang" onclick="toggleCard(this)">
                <i class="fas fa-comment-dots skill-bg-icon text-purple-500"></i>
                <i class="fas fa-chevron-down toggle-icon"></i>
                <div class="skill-icon"><i class="fas fa-lightbulb"></i></div>
                <div class="skill-title">Ngôn Ngữ & Tư Duy</div>
                <div class="skill-info"><span id="lvl-lang">Lv.1</span><span id="pct-lang">0%</span></div>
                <div class="skill-progress-bg"><div class="skill-progress-bar" id="bar-lang"></div></div>
                <div class="skill-list" id="list-lang"></div>
            </div>
        </div>

        <h3 class="section-title"><i class="fas fa-map-marked-alt" style="color: #FF8F50;"></i> Hành Trình Văn Chương</h3>
        <div class="map-container">
            <div class="map-line"></div>
            <div class="map-line-progress" id="map-progress-bar"></div>
            <div class="map-scroll-area" id="journey-container">
                </div>
        </div>

    </main>

<div id="modal-unlock" class="hv-modal">
        <div class="hv-modal-box">
            <div class="w-20 h-20 mx-auto bg-orange-100 rounded-full flex items-center justify-center mb-5 shadow-sm">
                <i class="fas fa-lock-open text-4xl text-orange-500"></i>
            </div>
            
            <h3 class="text-xl font-black text-gray-800 mb-2">Mở khóa bài học?</h3>
            <p class="text-sm text-gray-500 mb-6 leading-relaxed">
                Sử dụng <b class="text-orange-500">5 Keys</b> để vào học.<br>
                Phần thưởng hoàn thành<b class="text-orange-500"> 10 Keys</b>
            </p>
            
            <div class="flex gap-3">
                <button class="hv-btn hv-btn-gray flex-1" onclick="closeModal()">Để sau</button>
                <button class="hv-btn hv-btn-primary flex-1 shadow-lg shadow-orange-200" id="btn-unlock-confirm">
                    Mở ngay
                </button>
            </div>
        </div>
    </div>
    
    <div id="modal-alert" class="hv-modal">
        <div class="hv-modal-box">
            <div class="w-20 h-20 mx-auto bg-red-100 rounded-full flex items-center justify-center mb-5 shadow-sm">
                <i class="fas fa-key text-4xl text-red-500"></i>
            </div>

            <h3 class="text-xl font-black text-gray-800 mb-2">Thiếu Keys rồi!</h3>
            <p class="text-sm text-gray-500 mb-6 leading-relaxed">
                Bạn không đủ Keys để mở bài này.<br>
                Hãy điểm danh hoặc làm bài tập khác để kiếm thêm nhé.
            </p>
            
            <button class="hv-btn hv-btn-primary w-full" onclick="closeModal()">Đã hiểu</button>
        </div>
    </div>

    <script type="module" src="gam.js"></script>
    <script src="../chatbot.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, increment, collection, query, where, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { initMenu } from "./menu.js";

    // --- CONFIG ---
    const firebaseConfig = { apiKey: "AIzaSyAJ9C2biYeiLPmhakzLZ4mEqfO9_VgPSZE", authDomain: "hopvan-9a648.firebaseapp.com", projectId: "hopvan-9a648", storageBucket: "hopvan-9a648.appspot.com", messagingSenderId: "429347196227", appId: "1:429347196227:web:917b8d019f0efd0f7833f6", measurementId: "G-1BG8PSRG0R" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- DỮ LIỆU CẤU HÌNH ---
    const JOURNEY_DATA = [
        { id: 1, file: '1.html', title: 'Bước vào chữ nghĩa', icon: 'fas fa-shoe-prints' },
        { id: 2, file: '2.html', title: 'Học cách đọc', icon: 'fas fa-book-reader' },
        { id: 3, file: '3.html', title: 'Học cách nghĩ', icon: 'fas fa-lightbulb' },
        { id: 4, file: '4.html', title: 'Học cách viết', icon: 'fas fa-pen-nib' },
        { id: 5, file: '5.html', title: 'Đi qua nỗi ngược', icon: 'fas fa-mountain' },
        { id: 6, file: '6.html', title: 'Tìm tiếng nói riêng', icon: 'fas fa-microphone-alt' },
        { id: 7, file: '7.html', title: 'Ở lại với văn chương', icon: 'fas fa-heart' },
    ];

    const SKILL_STEPS = {
        reading: ["Làm quen văn bản", "Hiểu từ ngữ", "Phân tích câu", "Suy luận logic", "Tư duy phản biện", "Đánh giá nội dung", "Cảm thụ văn học"],
        nlxh: ["Xác định vấn đề", "Triển khai luận điểm", "Lấy dẫn chứng", "Phản biện vấn đề", "Liên hệ thực tế", "Sáng tạo bài viết", "Hoàn thiện tư duy"],
        nlvh: ["Nắm bắt tác phẩm", "Phân tích nhân vật", "Phân tích nghệ thuật", "So sánh văn học", "Lý luận văn học", "Phong cách tác giả", "Tư duy tổng hợp"],
        lang: ["Ngữ pháp cơ bản", "Biện pháp tu từ", "Phong cách ngôn ngữ", "Phương thức biểu đạt", "Thực hành tiếng Việt", "Sửa lỗi câu", "Vận dụng nâng cao"]
    };

    let userKeys = 0;
    let currentLevel = 1; 
    let paidLevel = 0; 

    initMenu(app);

    // --- MAIN LOGIC (CẬP NHẬT AVATAR) ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const name = user.displayName || user.email.split('@')[0];
            document.getElementById('welcome-name').innerText = `Xin chào, ${name}`;
            
            const avatarEl = document.getElementById('avatar-initial');

            // 1. Tải Thông tin User (Chứa Keys, Streak và Avatar)
            const userSnap = await getDoc(doc(db, "users", user.uid));
            
            if (userSnap.exists()) {
                const d = userSnap.data();
                userKeys = d.keys || 0;
                document.getElementById('keys-val').innerText = userKeys;
                document.getElementById('streak-val').innerText = d.streak || 0;
                updateRank(d.streak || 0);

                // LOGIC AVATAR ƯU TIÊN
                let hasAvatar = false;
                if (d.customAvatar) {
                    avatarEl.innerHTML = `<img src="${d.customAvatar}" alt="User" style="width: 100%; height: 100%; object-fit: cover;">`;
                    avatarEl.style.background = 'transparent';
                    hasAvatar = true;
                } else if (d.photoURL || user.photoURL) {
                    avatarEl.innerHTML = `<img src="${d.photoURL || user.photoURL}" alt="User" style="width: 100%; height: 100%; object-fit: cover;">`;
                    avatarEl.style.background = 'transparent';
                    hasAvatar = true;
                }

                if (!hasAvatar) {
                    avatarEl.innerHTML = "";
                    avatarEl.innerText = name.charAt(0).toUpperCase();
                    avatarEl.style.background = 'var(--primary-gradient)';
                }

            }

            // 2. Tải Progress
            const progRef = doc(db, "users_progress", user.uid);
            const progSnap = await getDoc(progRef);
            if (progSnap.exists()) {
                const d = progSnap.data();
                currentLevel = d.currentLevel || 1; 
                paidLevel = d.paidLevel || 0;
            } else {
                await setDoc(progRef, { currentLevel: 1, paidLevel: 0 });
            }

            // 3. Render Dashboard
            renderSkillTree(user.uid); 
            renderMap(); 
        } else {
            window.location.href = "../log.html";
        }
    });

    function updateRank(streak) {
        let r = "Tân Binh";
        let next = "3 ngày: Chớm lửa";
        if (streak >= 3) { r = "Chớm Lửa"; next = "7 ngày: Giữ lửa"; }
        if (streak >= 7) { r = "Giữ Lửa"; next = "30 ngày: Bền lửa"; }
        if (streak >= 30) { r = "Bền Lửa"; next = "100 ngày: Người ở lại"; }
        if (streak >= 100) { r = "Người Ở Lại"; next = "Huyền thoại!"; }
        document.getElementById('rank-val').innerText = r;
        document.getElementById('next-rank-info').innerText = next;
    }

    // --- LOGIC 1: BỐI CẢNH TRI THỨC ---
    async function renderSkillTree(uid) {
        const q = query(collection(db, "activities"), where("uid", "==", uid));
        const snap = await getDocs(q);
        
        let scores = { reading: [], nlxh: [], nlvh: [], lang: [] };
        
        snap.forEach(doc => {
            const d = doc.data();
            if (d.score !== undefined && d.score !== null) {
                let type = d.type; 
                if (['trac-nghiem','reading','doc_hieu'].includes(type)) type = 'reading';
                else if (type === 'nlxh') type = 'nlxh';
                else if (type === 'nlvh') type = 'nlvh';
                else if (['ngon-ngu','lang'].includes(type)) type = 'lang';
                
                if (scores[type]) scores[type].push(Number(d.score));
            }
        });

        const updateUI = (key, arr, steps) => {
            let lvl = 1;
            if (arr && arr.length > 0) {
                const avg = arr.reduce((a,b)=>a+b,0) / arr.length;
                let base = 1;
                if (avg >= 8.0) base = 3; else if (avg >= 5.0) base = 2; 
                let bonus = Math.floor(arr.length / 5);
                lvl = Math.min(7, base + bonus);
            }

            document.getElementById(`lvl-${key}`).innerText = `Lv.${lvl}`;
            document.getElementById(`pct-${key}`).innerText = `${Math.round((lvl/7)*100)}%`;
            document.getElementById(`bar-${key}`).style.width = `${(lvl/7)*100}%`;

            const listEl = document.getElementById(`list-${key}`);
            listEl.innerHTML = steps.map((step, index) => {
                const isDone = index < lvl; 
                const statusClass = isDone ? "completed" : "";
                const icon = isDone ? "fa-check-circle" : "fa-circle"; 
                return `<div class="skill-item ${statusClass}"><i class="fas ${icon}"></i> <span>${index+1}. ${step}</span></div>`;
            }).join('');
        };

        updateUI('reading', scores.reading, SKILL_STEPS.reading);
        updateUI('nlxh', scores.nlxh, SKILL_STEPS.nlxh);
        updateUI('nlvh', scores.nlvh, SKILL_STEPS.nlvh);
        updateUI('lang', scores.lang, SKILL_STEPS.lang);
        
        // TÍNH TỔNG SỐ BÀI ĐÃ LÀM
        const totalDone = scores.reading.length + scores.nlxh.length + scores.nlvh.length + scores.lang.length;
        const totalEl = document.getElementById('total-exams');
        if (totalEl) {
            totalEl.innerText = totalDone;
        }
    }

    window.toggleCard = (el) => {
        el.classList.toggle('active');
    };

    // --- LOGIC 2: HÀNH TRÌNH VĂN CHƯƠNG ---
    function renderMap() {
        const container = document.getElementById('journey-container');
        const progressBar = document.getElementById('map-progress-bar');
        container.innerHTML = "";

        let activeIndex = 0;

        JOURNEY_DATA.forEach((item, index) => {
            let statusClass = 'locked';
            let iconHtml = '<i class="fas fa-lock"></i>';
            
            if (item.id < currentLevel) {
                statusClass = 'completed';
                iconHtml = `<i class="fas ${item.icon}"></i>`;
                activeIndex = index + 1;
            } 
            else if (item.id === currentLevel) {
                statusClass = 'active';
                activeIndex = index;
                if (item.id <= paidLevel) {
                    iconHtml = '<i class="fas fa-play"></i>';
                } else {
                    iconHtml = '<i class="fas fa-key text-yellow-300 animate-pulse"></i>';
                }
            } 
            else {
                statusClass = 'locked';
                iconHtml = '<i class="fas fa-lock"></i>';
            }

            const div = document.createElement('div');
            div.className = `map-node ${statusClass}`;
            div.innerHTML = `<div class="node-icon">${iconHtml}</div><div class="node-title">${item.title}</div>`;
            div.onclick = () => handleMapClick(item);
            container.appendChild(div);
        });

        progressBar.style.width = `${(activeIndex / JOURNEY_DATA.length) * 100}%`;
    }

    function handleMapClick(item) {
        if (item.id < currentLevel) {
            window.location.href = `../nhatkyhoctap/${item.file}`;
        }
        else if (item.id === currentLevel) {
            if (item.id <= paidLevel) {
                window.location.href = `../nhatkyhoctap/${item.file}`;
            } else {
                window.pendingLevelId = item.id;
                document.getElementById('modal-unlock').classList.add('show');
            }
        }
    }

    document.getElementById('btn-unlock-confirm').onclick = async () => {
        if (userKeys >= 5) {
            const uid = auth.currentUser.uid;
            await updateDoc(doc(db, "users", uid), { keys: increment(-5) });
            
            const progRef = doc(db, "users_progress", uid);
            await updateDoc(progRef, { paidLevel: window.pendingLevelId });
            
            userKeys -= 5;
            paidLevel = window.pendingLevelId;
            document.getElementById('keys-val').innerText = userKeys;
            
            closeModal();
            renderMap();
        } else {
            closeModal();
            document.getElementById('modal-alert').classList.add('show');
        }
    };

    window.closeModal = () => document.querySelectorAll('.hv-modal').forEach(m => m.classList.remove('show'));
    
    window.toggleSidebar = () => {
        const sidebar = document.querySelector('aside');
        const overlay = document.getElementById('sidebar-overlay');
        if(sidebar) sidebar.classList.toggle('open');
        if(overlay) overlay.classList.toggle('active');
    };

</script>
</body>
</html>