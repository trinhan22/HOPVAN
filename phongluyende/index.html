<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HopVan - Luyện Đề Ngẫu Nhiên</title>
    
    <meta property="og:title" content="HOPVAN - Nền Tảng Học & Luyện Thi Ngữ Văn" />
    <meta property="og:description" content="Nền tảng học tập Ngữ Văn tích hợp AI – hỗ trợ tự học thông minh." />
    <meta property="og:image" content="https://hopvan.netlify.app/panel.webp" />
    <meta property="og:url" content="https://hopvan.netlify.app" />
    <meta property="og:type" content="article" />

    <link rel="icon" type="image/webp" href="../LOGO.WEBP" />
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FF8F50">

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <style>
        :root { --primary: #FF8F50; --glass-bg: rgba(255, 255, 255, 0.95); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #FFF5EC; height: 100vh; overflow: hidden; }
        #menu-placeholder { display: none !important; }
        .main-content { width: 100%; height: 100vh; background: var(--glass-bg); padding: 20px 40px; display: flex; flex-direction: column; }
        .header-bar { flex-shrink: 0; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .workspace-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; flex: 1; overflow: hidden; padding-bottom: 20px; }
        .column-card { background: white; border-radius: 24px; border: 1px solid rgba(255, 143, 80, 0.2); box-shadow: 0 10px 30px rgba(0,0,0,0.03); display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .card-header { padding: 16px 24px; background: #fff7ed; border-bottom: 1px solid #fed7aa; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .prompt-body { padding: 30px; overflow-y: auto; flex: 1; background-color: #fffcf8; transition: font-size 0.2s ease; }
        .passage-box { background: white; padding: 24px; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02); margin-bottom: 24px; position: relative; }
        .exam-content { font-family: 'Merriweather', serif; font-weight: 300; font-size: 1.1rem; line-height: 2.0; color: #1e293b; text-align: justify; white-space: pre-wrap; }
        .question-box { background: #f8fafc; padding: 16px; border-radius: 12px; border: 1px solid #f1f5f9; margin-bottom: 12px; font-weight: 300; }
        .type-badge { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; padding: 4px 12px; border-radius: 20px; }
        .badge-nlxh { background: #dcfce7; color: #166534; }
        .badge-nlvh { background: #fae8ff; color: #86198f; }
        .badge-dochieu { background: #dbeafe; color: #1e40af; }
        .writing-area { width: 100%; height: 100%; padding: 24px; border: none; outline: none; resize: none; font-size: 1.1rem; line-height: 2.0; color: #334155; background: transparent; font-family: 'Merriweather', serif; background-image: linear-gradient(#f1f5f9 1px, transparent 1px); background-size: 100% 2.2rem; background-attachment: local; font-weight: 300; }
        .footer-action { padding: 16px; border-top: 1px solid #f1f5f9; background: white; display: flex; justify-content: flex-end; flex-shrink: 0; }
        .submit-btn { background: linear-gradient(135deg, #FF8F50, #FF5E62); color: white; padding: 12px 32px; border-radius: 50px; font-weight: 800; box-shadow: 0 4px 15px rgba(255, 143, 80, 0.3); transition: 0.2s; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 143, 80, 0.4); }
        ::selection { background: #fed7aa; color: #431407; }
        .highlight-yellow { background-color: #fef08a; border-bottom: 2px solid #facc15; }
        .highlight-green { background-color: #bbf7d0; border-bottom: 2px solid #4ade80; }
        .highlight-pink { background-color: #fbcfe8; border-bottom: 2px solid #f472b6; }
        #highlight-menu { position: absolute; display: none; background: white; border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); padding: 6px 10px; z-index: 1000; gap: 8px; border: 1px solid #f3f4f6; animation: popIn 0.15s ease; }
        .hl-btn { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .hl-btn:hover { transform: scale(1.2); }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .loader-robot { font-size: 4rem; color: var(--primary); animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        .ai-result-view { padding: 24px; overflow-y: auto; height: 100%; background: #f8fafc; }
        .custom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 20000; justify-content: center; align-items: center; animation: fadeIn 0.2s; }
        .modal-box { background: white; padding: 30px; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); transform: scale(0.9); animation: zoomIn 0.2s forwards; }
        .modal-icon { font-size: 3rem; margin-bottom: 15px; }
        .modal-actions { margin-top: 25px; display: flex; gap: 10px; justify-content: center; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 12px; font-weight: 700; transition: 0.2s; }
        .popup-error .modal-icon { color: #ef4444; } .popup-error button { background: #ef4444; color: white; }
        .popup-warning .modal-icon { color: #f59e0b; } .popup-warning button { background: #f59e0b; color: white; }
        .popup-info .modal-icon { color: #3b82f6; } .popup-info button { background: #3b82f6; color: white; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.9); } to { transform: scale(1); } }
        .custom-select { padding: 8px 16px; border-radius: 12px; border: 1px solid #fed7aa; background: #fff7ed; color: #c2410c; font-weight: 700; font-size: 0.9rem; outline: none; cursor: pointer; }
        .mobile-header { display: none; position: fixed; top: 0; left: 0; right: 0; height: 70px; background: white; z-index: 100; align-items: center; padding: 0 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        @media (max-width: 1024px) { body { overflow: auto; height: auto; } .mobile-header { display: flex; } .header-bar { display: none; } .main-content { padding: 80px 16px 20px; height: auto; } .workspace-grid { display: flex; flex-direction: column; height: auto; } .column-card { height: 600px; } }
        #output-section { flex: 1; min-height: 0; display: none; }
        #ai-correction-box { height: 100%; overflow-y: auto; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: rgba(255, 143, 80, 0.05); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background-color: rgba(255, 143, 80, 0.3); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; transition: background-color 0.3s ease; }
        ::-webkit-scrollbar-thumb:hover { background-color: #FF8F50; border: 1px solid transparent; }
        ::-webkit-scrollbar-button { display: none; }

/* --- FULLSCREEN POPUP NEON SYNC --- */
        .fs-modal-box {
            background: white; 
            padding: 45px 35px; 
            border-radius: 32px; /* Bo góc cực đại như Stat Card */
            width: 90%; 
            max-width: 420px; 
            text-align: center;
            position: relative;
            /* Hiệu ứng viền Neon mờ */
            border: 2px solid rgba(255, 143, 80, 0.2);
            /* Đổ bóng Glow đặc trưng */
            box-shadow: 0 20px 60px rgba(255, 107, 107, 0.15), 0 0 30px rgba(255, 143, 80, 0.1);
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* Icon mở rộng với Gradient cam đào */
        .fs-icon-wrap {
            width: 80px; height: 80px;
            margin: 0 auto 25px;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem;
            background: linear-gradient(135deg, #FF8F50 0%, #FF6B6B 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 8px 15px rgba(255, 107, 107, 0.3));
        }

        /* Nút bấm đồng bộ với phong cách Dashboard */
        .btn-neon-fs {
            width: 100%;
            padding: 16px;
            border-radius: 18px;
            background: linear-gradient(135deg, #FF8F50 0%, #FF6B6B 100%);
            color: white;
            font-weight: 800;
            font-size: 1.1rem;
            text-transform: none; /* Giữ chữ thường như ảnh mẫu */
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.3);
            transition: 0.3s;
            border: none;
            cursor: pointer;
        }

        .btn-neon-fs:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(255, 107, 107, 0.5);
            filter: brightness(1.1);
        }

        @keyframes popIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>

    <div id="highlight-menu">
        <button class="hl-btn bg-yellow-200" onclick="applyHighlight('highlight-yellow')" title="Vàng"></button>
        <button class="hl-btn bg-green-200" onclick="applyHighlight('highlight-green')" title="Xanh"></button>
        <button class="hl-btn bg-pink-200" onclick="applyHighlight('highlight-pink')" title="Hồng"></button>
        <button class="hl-btn bg-gray-100 text-gray-500 flex items-center justify-center" onclick="removeHighlight()" title="Xóa"><i class="fas fa-eraser text-xs"></i></button>
    </div>

    <div class="loading-overlay" id="loading-overlay">
        <div class="loader-robot"><i class="fas fa-robot"></i></div>
    </div>

    <div id="generic-popup" class="custom-modal">
        <div class="modal-box">
            <div id="popup-icon" class="modal-icon"><i class="fas fa-info-circle"></i></div>
            <h3 id="popup-title" class="font-bold text-xl mb-2 text-gray-800">Thông báo</h3>
            <p id="popup-message" class="text-gray-600">Nội dung thông báo...</p>
            <div class="modal-actions"><button onclick="closePopup()" class="modal-btn hover:opacity-90">Đã hiểu</button></div>
        </div>
    </div>

    <div id="short-essay-popup" class="custom-modal">
        <div class="modal-box popup-warning">
            <div class="modal-icon"><i class="fas fa-pen-nib"></i></div>
            <h3 class="font-bold text-xl mb-2">Bài Quá Ngắn</h3>
            <p class="text-gray-600">Bài làm cần ít nhất <strong>50 từ</strong> để AI chấm chính xác. Hãy viết thêm chút nữa nhé!</p>
            <div class="modal-actions"><button onclick="document.getElementById('short-essay-popup').style.display='none'" class="modal-btn bg-orange-100 !text-white-600 hover:bg-orange-200">Viết tiếp</button></div>
        </div>
    </div>

<div id="fullscreen-popup" class="custom-modal" style="display: none; z-index: 40000; background: rgba(255, 245, 236, 0.7); backdrop-filter: blur(8px);">
        <div class="fs-modal-box">
            <div class="fs-icon-wrap">
                <i class="fas fa-expand-arrows-alt"></i>
            </div>
            
            <h3 class="text-2xl font-black text-gray-800 mb-2">Chế độ Làm bài thi</h3>
            <p class="text-gray-500 leading-relaxed mb-8 px-4">Để đảm bảo sự tập trung cao nhất, hệ thống sẽ chuyển sang <b>Toàn màn hình</b>.</p>
            
            <div class="modal-actions">
                <button onclick="enableFullscreen()" class="btn-neon-fs">Tiếp tục</button>
            </div>
        </div>
    </div>

    <div class="mobile-header lg:hidden">
        <div class="flex items-center gap-2"><img src="../LOGO.WEBP" class="w-8 h-8"><span class="font-black text-orange-500 text-lg">HOPVAN</span></div>
        <div class="ml-auto bg-gray-900 text-white px-3 py-1 rounded text-xs font-bold font-mono" id="timer-mobile">00:00</div>
    </div>

    <div class="dashboard-container">
        <div id="menu-placeholder"></div>
        <main class="main-content">
            <div class="header-bar hidden lg:flex">
                <div class="flex items-center gap-4">
                    <a href="../dashboard/phongluyende.html" class="w-10 h-10 rounded-xl bg-white border border-gray-200 flex items-center justify-center text-gray-500 hover:text-orange-500 transition shadow-sm"><i class="fas fa-arrow-left"></i></a>
                    <h2 class="text-2xl font-black text-gray-800 mr-2">Luyện Đề Ngẫu Nhiên</h2>
                    <select id="topic-select" class="custom-select" onchange="randomizeQuestion()">
                        <option value="random">Tất cả (Ngẫu nhiên)</option>
                        <option value="nlxh">Nghị Luận Xã Hội</option>
                        <option value="nlvh">Nghị Luận Văn Học</option>
                        <option value="dochieu">Đọc Hiểu</option>
                    </select>
                </div>
                <div class="flex items-center gap-4">
                    <div class="bg-white rounded-xl border border-gray-200 flex items-center p-1 shadow-sm">
                        <span class="text-xs font-bold text-gray-400 pl-3 pr-2 uppercase">Cỡ đề:</span>
                        <button onclick="adjustPromptSize(-1)" class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded text-gray-600"><i class="fas fa-minus text-xs"></i></button>
                        <span class="w-px h-4 bg-gray-200 mx-1"></span>
                        <button onclick="adjustPromptSize(1)" class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded text-gray-600"><i class="fas fa-plus text-xs"></i></button>
                    </div>
                    <button onclick="randomizeQuestion()" class="bg-white px-4 py-2 rounded-xl font-bold text-gray-600 hover:text-orange-600 border border-gray-200 text-sm shadow-sm flex gap-2 items-center"><i class="fas fa-dice"></i> Đổi đề</button>
                    <div class="bg-gray-900 text-white px-5 py-2 rounded-xl font-mono font-bold flex items-center gap-2 shadow-lg"><i class="fas fa-stopwatch text-green-400"></i> <span id="timer">00:00</span></div>
                </div>
            </div>

            <div class="workspace-grid">
                <div class="column-card">
                    <div class="card-header">
                        <div class="flex items-center gap-2"><span id="exam-type-badge" class="type-badge bg-gray-100 text-gray-500">ĐỀ BÀI</span><span class="text-[10px] text-gray-400 italic">(Bôi đen để Highlight)</span></div>
                        <span id="exam-code" class="text-xs font-bold text-gray-400">...</span>
                    </div>
                    <div class="scrollable-content prompt-body" id="prompt-content">
                        <div class="animate-pulse space-y-4 pt-10 text-center"><i class="fas fa-box-open text-4xl text-gray-300 mb-4"></i><p class="text-gray-400 font-bold">Nhấn "Đổi đề" để bắt đầu!</p></div>
                    </div>
                </div>

                <div class="column-card relative">
                    <div id="input-section" class="flex flex-col h-full">
                        <div class="card-header bg-white">
                            <span class="font-black text-xs text-gray-400 uppercase tracking-widest">BÀI LÀM CỦA BẠN</span>
                            <div class="flex gap-2">
                                <button onclick="document.getElementById('file-upload').click()" class="text-xs font-bold text-blue-500 bg-blue-50 px-3 py-1 rounded hover:bg-blue-100 transition"><i class="fas fa-paperclip mr-1"></i> Tải file</button>
                                <input type="file" id="file-upload" class="hidden" accept=".txt, .docx">
                                <span id="word-count" class="text-xs font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">0 TỪ</span>
                            </div>
                        </div>
                        <div class="flex-1 overflow-hidden relative">
                            <textarea id="student-essay" class="writing-area" placeholder="Bắt đầu làm bài tại đây..."></textarea>
                        </div>
                        <div class="footer-action"><button onclick="handleAISubmission()" class="submit-btn flex items-center gap-2"><span>NỘP BÀI</span> <i class="fas fa-paper-plane"></i></button></div>
                    </div>
                    <div id="output-section" class="hidden h-full flex-col">
                        <div class="card-header bg-gray-900 border-none text-white"><span class="font-bold text-sm uppercase"><i class="fas fa-robot mr-2 text-orange-400"></i>Kết quả từ AI</span><button onclick="resetExam()" class="text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded transition">Làm lại</button></div>
                        <div id="ai-correction-box" class="ai-result-view"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CONFIG FIREBASE ---
    const firebaseConfig = { apiKey: "AIzaSyAJ9C2biYeiLPmhakzLZ4mEqfO9_VgPSZE", authDomain: "hopvan-9a648.firebaseapp.com", projectId: "hopvan-9a648", storageBucket: "hopvan-9a648.appspot.com", messagingSenderId: "429347196227", appId: "1:429347196227:web:917b8d019f0efd0f7833f6", measurementId: "G-1BG8PSRG0R" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const API_URL = `/.netlify/functions/gemini-proxy`;
    let questionsData = []; 
    window.currentExamData = null;

    // --- HELPER FUNCTIONS ---
    window.showPopup = (title, message, type = 'info') => {
        const modal = document.getElementById('generic-popup');
        const box = modal.querySelector('.modal-box');
        const icon = document.getElementById('popup-icon');
        
        box.className = 'modal-box'; 
        if (type === 'error') { box.classList.add('popup-error'); icon.innerHTML = '<i class="fas fa-exclamation-circle"></i>'; } 
        else if (type === 'warning') { box.classList.add('popup-warning'); icon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>'; } 
        else { box.classList.add('popup-info'); icon.innerHTML = '<i class="fas fa-info-circle"></i>'; }
        
        document.getElementById('popup-title').innerText = title;
        document.getElementById('popup-message').innerText = message;
        
        const actions = modal.querySelector('.modal-actions');
        actions.innerHTML = '<button onclick="closePopup()" class="modal-btn hover:opacity-90">Đã hiểu</button>';
        
        modal.style.display = 'flex';
    };
    window.closePopup = () => document.getElementById('generic-popup').style.display = 'none';

    let promptFontSize = 17;
    window.adjustPromptSize = (amount) => {
        promptFontSize += amount;
        if(promptFontSize < 14) promptFontSize = 14;
        if(promptFontSize > 26) promptFontSize = 26;
        document.querySelector('.prompt-body').style.fontSize = `${promptFontSize}px`;
        document.querySelectorAll('.exam-content').forEach(el => el.style.fontSize = `${promptFontSize}px`);
    };

    // --- RANDOM LOGIC ---
    window.randomizeQuestion = async () => {
        const typeSelect = document.getElementById('topic-select').value;
        const loader = document.getElementById('loading-overlay');
        loader.style.display = 'flex';

        try {
            let colName;
            if (typeSelect === 'random') colName = Math.random() > 0.5 ? 'reading_bank' : 'essay_bank';
            else if (typeSelect === 'dochieu') colName = 'reading_bank';
            else colName = 'essay_bank';

            let qFunc;
            if (colName === 'reading_bank') qFunc = collection(db, "reading_bank");
            else {
                if (typeSelect === 'random') qFunc = collection(db, "essay_bank");
                else qFunc = query(collection(db, "essay_bank"), where("type", "==", typeSelect));
            }

            const snapshot = await getDocs(qFunc);
            if (snapshot.empty) {
                showPopup("Thông báo", "Kho đề này hiện đang trống!", "warning");
                loader.style.display = 'none';
                return;
            }

            const docs = snapshot.docs;
            const randomDoc = docs[Math.floor(Math.random() * docs.length)];
            const data = randomDoc.data();
            
            window.currentExamData = { 
                ...data, 
                id: randomDoc.id, 
                // Chuẩn hóa loại đề để dùng cho logic hiển thị sau này
                type: colName === 'reading_bank' ? 'dochieu' : data.type 
            };
            
            renderExam(window.currentExamData);
            startTimer();
        } catch (e) { 
            console.error(e);
            showPopup("Lỗi", "Không thể bốc đề, vui lòng thử lại.", "error"); 
        } finally { loader.style.display = 'none'; }
    };

    function renderExam(data) {
        const container = document.getElementById('prompt-content');
        const badge = document.getElementById('exam-type-badge');
        document.getElementById('exam-code').innerText = `MÃ: ${data.id.slice(0, 6).toUpperCase()}`;
        document.getElementById('student-essay').value = "";
        
        if (data.type === 'dochieu') {
            badge.innerText = "ĐỌC HIỂU"; badge.className = "type-badge badge-dochieu";
            container.innerHTML = `
                <div id="reading-passage">
                    <div class="passage-box">
                        <h3 class="font-bold text-lg mb-3 text-gray-800 border-b pb-2">${data.title || "Ngữ liệu"}</h3>
                        <div class="exam-content font-light" id="text-content">${data.text}</div>
                    </div>
                    <div class="space-y-3">
                        ${(data.questions || []).map((q, i) => `
                            <div class="question-box">
                                <span class="font-bold text-blue-600 block mb-1 text-sm uppercase">Câu ${i+1}</span>
                                <div class="text-gray-800 text-sm font-light leading-relaxed">${q.q}</div>
                            </div>`).join('')}
                    </div>
                </div>`;
        } else {
            const isNLXH = data.type === 'nlxh';
            badge.innerText = isNLXH ? "NL XÃ HỘI" : "NL VĂN HỌC"; 
            badge.className = `type-badge ${isNLXH ? 'badge-nlxh' : 'badge-nlvh'}`;
            container.innerHTML = `
                <div id="reading-passage">
                    <div class="passage-box">
                        <span class="text-xs font-bold text-gray-400 uppercase block mb-2">Yêu cầu đề bài</span>
                        <div class="exam-content font-light text-gray-800">${data.topic}</div>
                    </div>
                    ${data.text ? `<div class="passage-box"><span class="text-xs font-bold text-gray-400 uppercase block mb-2">Ngữ liệu</span><div class="exam-content font-light">${data.text}</div></div>` : ''}
                    ${data.hint ? `<div class="mt-4 bg-yellow-50 p-4 rounded-xl border border-yellow-100 text-sm text-gray-600 italic font-light">Gợi ý: ${data.hint}</div>` : ''}
                </div>`;
        }
        setupHighlightEvent();
    }

    // --- HIGHLIGHT ---
    function setupHighlightEvent() {
        const container = document.getElementById('reading-passage');
        const menu = document.getElementById('highlight-menu');
        if(!container || !menu) return;
        container.onmouseup = () => {
            setTimeout(() => {
                const sel = window.getSelection();
                if (sel.toString().trim().length > 0 && container.contains(sel.anchorNode)) {
                    const rect = sel.getRangeAt(0).getBoundingClientRect();
                    menu.style.top = `${rect.top + window.scrollY - 45}px`;
                    menu.style.left = `${rect.left + (rect.width / 2) - 60}px`;
                    menu.style.display = 'flex';
                } else { menu.style.display = 'none'; }
            }, 10);
        };
        document.onmousedown = (e) => { if(!menu.contains(e.target) && !container.contains(e.target)) menu.style.display = 'none'; };
    }
    window.applyHighlight = (cls) => {
        try {
            const sel = window.getSelection();
            if (!sel.rangeCount) return;
            const span = document.createElement('span');
            span.className = cls;
            sel.getRangeAt(0).surroundContents(span);
            sel.removeAllRanges();
            document.getElementById('highlight-menu').style.display = 'none';
        } catch(e) { showPopup("Chú ý", "Không thể tô đè hoặc kéo qua nhiều đoạn văn!", "warning"); }
    };
    window.removeHighlight = () => {
        const sel = window.getSelection();
        if (!sel.rangeCount) return;
        let node = sel.anchorNode;
        if (node.nodeType === 3) node = node.parentElement;
        if (node.tagName === 'SPAN' && node.className.includes('highlight-')) {
            node.replaceWith(document.createTextNode(node.innerText));
            document.getElementById('highlight-menu').style.display = 'none';
            sel.removeAllRanges();
        }
    };

    // --- 1. RENDER KẾT QUẢ (LINH HOẠT THEO DẠNG ĐỀ) ---
    function renderAIResult(result) {
        document.getElementById('input-section').classList.add('hidden');
        const out = document.getElementById('output-section');
        out.style.display = 'flex';
        out.classList.remove('hidden');
        out.classList.add('flex-col', 'h-full');

        const humanScore = parseInt(result.human_score) || 100;
        const barColor = humanScore > 75 ? '#22c55e' : (humanScore > 50 ? '#f59e0b' : '#ef4444');
        
        // Logic hiển thị điểm số:
        // Nếu là Đọc Hiểu -> Hiển thị trên thang 4.0
        // Nếu là NLXH/NLVH -> Hiển thị trên thang 10.0
        let scoreDisplay = result.score;
        let maxScore = 10;
        
        if (result.type_detected && result.type_detected.toLowerCase().includes('đọc hiểu')) {
            scoreDisplay = result.reading_score || (result.score * 0.4).toFixed(2); // Quy đổi ngược nếu cần
            maxScore = 4.0;
        }

        document.getElementById('ai-correction-box').innerHTML = `
            <div class="max-w-2xl mx-auto pb-10 custom-scrollbar" style="font-family: 'Merriweather', serif; font-weight: 300;">
                <div class="text-center mb-8">
                    <div class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Kết quả từ AI</div>
                    <div class="text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-600 mb-2">
                        ${scoreDisplay}<span class="text-2xl text-gray-300">/${maxScore}</span>
                    </div>
                    <div class="inline-block px-4 py-1.5 bg-orange-50 text-orange-600 rounded-full text-[10px] font-bold border border-orange-100 truncate max-w-full">
                        ${result.type_detected || "Bài làm"}
                    </div>
                    <p class="text-gray-600 italic px-6 mt-4 leading-relaxed">"${result.general_comment}"</p>
                </div>
                
                <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Độ chân thực (AI Check)</span>
                        <span class="font-bold text-sm" style="color:${barColor}">${humanScore}%</span>
                    </div>
                    <div class="h-1.5 bg-gray-100 rounded-full overflow-hidden">
                        <div style="width:${humanScore}%; background:${barColor}" class="h-full"></div>
                    </div>
                    <p class="text-[11px] text-gray-400 mt-2 italic font-light">${result.ai_comment || "Văn phong tự nhiên."}</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                    <div class="bg-green-50/50 p-5 rounded-2xl border border-green-100">
                        <h4 class="text-green-700 font-bold text-[10px] uppercase mb-3"><i class="fas fa-check-circle mr-1"></i> Điểm tốt</h4>
                        <ul class="text-xs text-green-800 space-y-2 font-medium">${(result.strengths || []).map(s => `<li>• ${s}</li>`).join('')}</ul>
                    </div>
                    <div class="bg-red-50/50 p-5 rounded-2xl border border-red-100">
                        <h4 class="text-red-700 font-bold text-[10px] uppercase mb-3"><i class="fas fa-exclamation-triangle mr-1"></i> Hạn chế</h4>
                        <ul class="text-xs text-red-800 space-y-2 font-medium">${(result.weaknesses || []).map(w => `<li>• ${w}</li>`).join('')}</ul>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-3xl border border-gray-100 shadow-sm mb-8">
                    <h4 class="font-black text-gray-800 border-b pb-4 mb-6 text-xs uppercase tracking-widest">Chi tiết đáp án & Sửa lỗi</h4>
                    <div class="leading-loose text-gray-700 font-light text-lg space-y-4 text-justify">
                        ${result.correction_html}
                    </div>
                </div>

                <div class="bg-gray-900 text-white p-6 rounded-2xl shadow-xl">
                    <div class="flex items-center gap-2 mb-2 text-orange-400"><i class="fas fa-lightbulb"></i><span class="text-[10px] font-black uppercase tracking-widest">Định hướng kĩ năng</span></div>
                    <p class="text-sm text-gray-300 leading-relaxed font-light italic">${result.orientation}</p>
                </div>
            </div>`;
    }

    // --- 2. HÀM NỘP BÀI (VỆ SINH DỮ LIỆU & JSON CLEANING) ---
    window.handleAISubmission = async () => {
        const content = document.getElementById('student-essay').value.trim();
        if(content.split(/\s+/).filter(x => x).length < 20) { 
            document.getElementById('short-essay-popup').style.display = 'flex'; return; 
        }

        const loading = document.getElementById('loading-overlay');
        loading.style.display = 'flex';
        
        const q = window.currentExamData;
        if (!q) {
            showPopup("Lỗi", "Dữ liệu đề bị trống. Hãy reload trang.", "error");
            loading.style.display = 'none';
            return;
        }
        
        // PROMPT THÔNG MINH CHO CẢ 3 DẠNG ĐỀ
        const systemPrompt = `
        BẠN LÀ: Giám khảo chấm thi THPT Quốc gia (Chuyên gia ngôn ngữ).
        NHIỆM VỤ: Chấm điểm bài làm dựa trên đề bài.

        THÔNG TIN ĐỀ:
        - Loại đề gốc: ${q.type} (Có thể là Đọc Hiểu, NLXH hoặc NLVH)
        - Yêu cầu: "${(q.topic || q.title || '').replace(/"/g, "'")}"
        - Ngữ liệu: "${(q.text || "Không có ngữ liệu").replace(/"/g, "'")}"
        - Câu hỏi (nếu Đọc hiểu): ${JSON.stringify(q.questions || [])}

        QUY TẮC CHẤM ĐIỂM:
        1. Nếu là Đọc Hiểu: Chấm thang điểm 4.0. Sai thuật ngữ = 0 điểm.
        2. Nếu là NLXH (Nghị luận xã hội): Chấm thang điểm 10.0 (Chú trọng lập luận).
        3. Nếu là NLVH (Nghị luận văn học): Chấm thang điểm 10.0 (Chú trọng cảm thụ).

        YÊU CẦU OUTPUT JSON DUY NHẤT (KHÔNG MARKDOWN):
        {
            "human_score": (int 0-100),
            "ai_comment": "Nhận xét ngắn.",
            "score": (số thực 0-10.0, dùng để lưu Database),
            "reading_score": (số thực 0-4.0, CHỈ DÙNG NẾU LÀ ĐỌC HIỂU, nếu không thì để null),
            "type_detected": "Tự điền: 'Đọc Hiểu' hoặc 'NLXH' hoặc 'NLVH'",
            "general_comment": "Lời phê tổng quát.",
            "strengths": ["Ưu điểm 1", "..."],
            "weaknesses": ["Lỗi sai 1", "..."],
            "correction_html": "Bài làm gốc kèm thẻ <span class='text-bad'>[Lỗi]</span> <span class='text-fix'>(Sửa)</span>.",
            "orientation": "Lời khuyên."
        }
        `;

        try {
            const res = await fetch(API_URL, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ 
                    systemPrompt: systemPrompt, 
                    messages: `BÀI LÀM CỦA HỌC SINH:\n${content}`
                }) 
            });

            if (!res.ok) throw new Error("SERVER_ERROR");

            const data = await res.json();
            
            if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                throw new Error("NO_CONTENT");
            }

            let rawText = data.choices[0].message.content;
            
            // JSON CLEANING (CỰC KỲ QUAN TRỌNG)
            // Lọc bỏ markdown, text thừa đầu đuôi để lấy đúng chuỗi JSON
            rawText = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
            const firstBrace = rawText.indexOf('{');
            const lastBrace = rawText.lastIndexOf('}');
            if (firstBrace !== -1 && lastBrace !== -1) {
                rawText = rawText.substring(firstBrace, lastBrace + 1);
            }
            
            const result = JSON.parse(rawText);

            // --- VỆ SINH DỮ LIỆU (DATA SANITIZATION) ---
            
            // 1. Ép kiểu score (Thang 10)
            let safeScore = parseFloat(result.score);
            if (isNaN(safeScore)) {
                // Nếu score bị lỗi, thử tính từ reading_score
                const rs = parseFloat(result.reading_score);
                safeScore = !isNaN(rs) ? rs * 2.5 : 0;
            }
            if (safeScore > 10) safeScore = 10;

            // 2. Ép kiểu reading_score (Nếu có)
            if (result.reading_score !== null && result.reading_score !== undefined) {
                result.reading_score = parseFloat(result.reading_score) || 0;
            }

            // 3. Các trường khác
            result.score = safeScore;
            result.human_score = parseInt(result.human_score) || 100;
            result.general_comment = result.general_comment || "Đã chấm xong.";
            result.correction_html = result.correction_html || content;

            renderAIResult(result);

            // Lưu vào Firebase
            if (auth.currentUser) {
                await addDoc(collection(db, "activities"), {
                    uid: auth.currentUser.uid,
                    type: q.type === 'dochieu' ? 'reading' : 'essay',
                    score: safeScore, // Luôn lưu thang 10
                    timestamp: serverTimestamp(),
                    examId: q.id
                });
            }
        } catch(e) { 
            console.error(e); 
            let msg = "Có lỗi xảy ra, vui lòng thử lại!";
            if (e.message === "SERVER_ERROR") msg = "Server đang bận. Bạn hãy bấm nộp lại nhé!";
            if (e.message === "NO_CONTENT") msg = "AI không phản hồi. Vui lòng bấm nộp lại!";
            if (e.name === "SyntaxError") msg = "Dữ liệu trả về bị lỗi định dạng. Thử lại ngay!";
            showPopup("Lỗi AI", msg, "error");
        } finally { 
            loading.style.display = 'none'; 
        }
    };

    window.resetExam = () => {
        document.getElementById('input-section').classList.remove('hidden');
        document.getElementById('output-section').classList.add('hidden');
        document.getElementById('output-section').style.display = 'none';
        randomizeQuestion(); // Tự động bốc đề mới khi bấm làm lại
    };

    let timerInterval;
    function startTimer() { 
        clearInterval(timerInterval);
        let secondsElapsed = 0;
        timerInterval = setInterval(() => { 
            secondsElapsed++;
            const m = Math.floor(secondsElapsed / 60).toString().padStart(2, '0');
            const s = (secondsElapsed % 60).toString().padStart(2, '0');
            const txt = `${m}:${s}`;
            if(document.getElementById('timer')) document.getElementById('timer').innerText = txt;
            if(document.getElementById('timer-mobile')) document.getElementById('timer-mobile').innerText = txt;
        }, 1000); 
    }

    onAuthStateChanged(auth, u => { if(u) { startTimer(); randomizeQuestion(); } else window.location.href="../log.html"; });
    document.getElementById('file-upload').addEventListener('change', (e) => { const f = e.target.files[0]; if(!f) return; const r = new FileReader(); if(f.name.endsWith('.docx')) { r.onload = (ev) => mammoth.extractRawText({arrayBuffer: ev.target.result}).then(res => document.getElementById('student-essay').value = res.value); r.readAsArrayBuffer(f); } else showPopup("Lỗi", "Chỉ nhận file .docx", "error"); });
    document.getElementById('student-essay').oninput = function() { document.getElementById('word-count').innerText = `${this.value.trim().split(/\s+/).filter(x => x).length} TỪ`; };

// --- FULLSCREEN LOGIC ---
    // Hàm kích hoạt toàn màn hình
    window.enableFullscreen = () => {
        const elem = document.documentElement;
        if (elem.requestFullscreen) {
            elem.requestFullscreen();
        } else if (elem.webkitRequestFullscreen) { /* Safari */
            elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) { /* IE11 */
            elem.msRequestFullscreen();
        }
        // Ẩn popup sau khi bật
        document.getElementById('fullscreen-popup').style.display = 'none';
    };

    // Tự động hiện popup khi tải trang
    window.addEventListener('load', () => {
        // Chỉ hiện nếu chưa ở chế độ fullscreen
        if (!document.fullscreenElement) {
            setTimeout(() => {
                document.getElementById('fullscreen-popup').style.display = 'flex';
            }, 500); // Delay nhẹ 0.5s để mượt hơn
        }
    });

    // Lắng nghe sự kiện thoát fullscreen (tùy chọn: hiện lại popup nếu thoát ra)
    document.addEventListener('fullscreenchange', () => {
        if (!document.fullscreenElement) {
            // Nếu người dùng thoát fullscreen, có thể hiện lại thông báo hoặc cảnh báo (tuỳ ý)
            // console.log("Đã thoát chế độ toàn màn hình");
        }
    });
</script>
</body>
</html>