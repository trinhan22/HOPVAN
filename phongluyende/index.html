<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hopvan - Luyện Đề Ngẫu Nhiên</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FF8F50">
    <link rel="apple-touch-icon" href="../LOGO.WEBP">

    <meta property="og:title" content="HOPVAN - Nền Tảng Học & Luyện Thi Ngữ Văn" />
    <meta property="og:description" content="Nền tảng học tập Ngữ Văn tích hợp AI – hỗ trợ tự học thông minh." />
    <meta property="og:image" content="https://hopvan.netlify.app/panel.webp" />
    <meta property="og:url" content="https://hopvan.netlify.app" />
    <meta property="og:type" content="article" />

    <link rel="icon" type="image/webp" href="../LOGO.WEBP" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <style>
        :root {
            --primary: #FF8F50;
            --primary-gradient: linear-gradient(135deg, #FF8F50, #FF5E62);
            --glass-bg: rgba(255, 255, 255, 0.85); 
            --sidebar-width: 280px;
        }

        * { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            background-color: #FFF5EC; 
            height: 100vh; 
            overflow: hidden; 
            position: relative;
        }

        /* --- BACKGROUND --- */
        .background-blobs { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
        .blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5; animation: floatBlob 10s infinite alternate; }
        .blob-1 { width: 600px; height: 600px; background: #FCA96A; top: -150px; left: -150px; }
        .blob-2 { width: 500px; height: 500px; background: #FCD5B5; bottom: -100px; right: -100px; }
        @keyframes floatBlob { 0% { transform: translate(0, 0); } 100% { transform: translate(40px, 60px); } }

        /* --- LAYOUT CHÍNH (Đã fix lỗi hở sườn PC) --- */
        .dashboard-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* PC: Menu cố định bên trái */
        #menu-placeholder {
            position: fixed;
            top: 0; left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            z-index: 50;
        }

        /* PC: Nội dung tràn màn hình nhưng padding trái để né menu */
        .main-content {
            width: 100%;
            height: 100vh;
            background: var(--glass-bg);
            backdrop-filter: blur(35px); -webkit-backdrop-filter: blur(35px);
            
            margin-left: 0;
            padding-top: 40px;
            padding-bottom: 40px;
            padding-right: 40px;
            padding-left: calc(var(--sidebar-width) + 40px);
            
            overflow-y: auto;
            position: relative;
            -webkit-overflow-scrolling: touch;
            border-left: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* --- MOBILE HEADER & OVERLAY --- */
        .mobile-header {
            display: none; position: fixed; top: 0; left: 0; right: 0;
            height: 70px; background: white; z-index: 100;
            align-items: center; padding: 0 20px; border-bottom: 1px solid #f0f0f0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.03);
        }
        #sidebar-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(4px);
            z-index: 998;
        }

        /* --- UI COMPONENTS --- */
        .prompt-card {
            background: white; border-radius: 30px; padding: 35px;
            border: 1px solid rgba(255, 143, 80, 0.2);
            box-shadow: 0 15px 35px rgba(255, 143, 80, 0.05);
            position: relative; overflow: hidden; margin-bottom: 30px;
        }
        .prompt-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 6px; height: 100%; background: var(--primary-gradient);
        }

        .workspace-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; min-height: 550px; }

        .editor-container {
            background: white; border-radius: 30px; border: 1px solid rgba(0,0,0,0.05);
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.02); transition: 0.3s;
            height: 100%;
        }
        .editor-container:focus-within { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 20px 50px rgba(255, 143, 80, 0.1); }

        .writing-area { 
            flex: 1; width: 100%; padding: 30px; border: none; outline: none; resize: none; 
            font-size: 1.1rem; line-height: 1.9; color: #2D3436; background: transparent;
            min-height: 400px;
        }

        .ai-result-view { padding: 30px; font-size: 1.1rem; line-height: 1.9; overflow-y: auto; background-color: #fafafa; height: 100%; }
        
        .text-good { color: #10B981; background: #ECFDF5; font-weight: 600; padding: 2px 4px; border-radius: 6px; text-decoration: none; }
        .text-bad { color: #EF4444; background: #FEF2F2; text-decoration: line-through; padding: 2px 4px; border-radius: 6px; }
        .text-fix { color: #3B82F6; font-weight: 700; font-style: italic; }

        .ai-meter-box {
            background: #fff; padding: 20px; border-radius: 20px; margin-bottom: 25px;
            border: 1px solid #f0f0f0; box-shadow: 0 5px 15px rgba(0,0,0,0.03);
            display: flex; align-items: center; justify-content: space-between;
        }
        .meter-label { font-weight: 800; color: #2d3436; font-size: 0.9rem; text-transform: uppercase; }
        .meter-score { font-weight: 900; font-size: 1.2rem; }

        /* --- LOADING --- */
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); z-index: 20000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .loader-robot { font-size: 4rem; color: var(--primary); animation: robotBounce 1s infinite alternate; }
        @keyframes robotBounce { from { transform: translateY(0); } to { transform: translateY(-20px); } }

        /* --- POPUP MODAL CHUNG --- */
        .custom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 20001; justify-content: center; align-items: center; animation: fadeIn 0.2s ease; }
        .modal-box { background: white; padding: 35px; border-radius: 30px; text-align: center; width: 90%; max-width: 400px; box-shadow: 0 25px 60px rgba(0,0,0,0.2); transform: scale(0.9); animation: zoomIn 0.2s ease forwards; border: 1px solid rgba(255,255,255,0.9); }
        .modal-icon { width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 20px; }
        
        .modal-box h3 { margin-bottom: 10px; font-weight: 800; font-size: 1.5rem; }
        .modal-box p { margin-bottom: 25px; font-size: 1rem; line-height: 1.6; color: #666; }
        .modal-actions { display: flex; gap: 12px; }
        .modal-btn { flex: 1; padding: 14px; border-radius: 15px; border: none; font-weight: 800; cursor: pointer; transition: 0.2s; font-size: 0.95rem; }
        
        /* Styles */
        .error-style .modal-icon { background: #FEF2F2; color: #EF4444; }
        .error-style h3 { color: #DC2626; }
        .btn-cancel { background: #F3F4F6; color: #4B5563; }
        .btn-action-red { background: #EF4444; color: white; box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3); }
        
        .warning-style .modal-icon { background: #FFFBEB; color: #F59E0B; }
        .warning-style h3 { color: #D97706; }
        .btn-action-yellow { background: #F59E0B; color: white; box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 1024px) {
            .mobile-header { display: flex; }
            #sidebar-overlay.active { display: block; }

            /* QUAN TRỌNG: Menu Mobile không ẩn mà thu nhỏ kích thước để load được */
            #menu-placeholder { 
                display: block !important; 
                width: 0; 
                height: 0; 
                overflow: visible; 
                z-index: 9999;
            }
            
            aside {
                position: fixed !important; 
                left: 0 !important; top: 0 !important; bottom: 0 !important;
                transform: translateX(-100%); 
                z-index: 9999 !important; 
                width: 280px !important; 
                background: white !important;
                transition: transform 0.3s ease-in-out !important;
                box-shadow: none;
                height: 100vh !important;
            }
            aside.open { 
                transform: translateX(0) !important;
                box-shadow: 10px 0 50px rgba(0,0,0,0.15) !important;
            }

            .main-content { 
                width: 100% !important; 
                padding: 90px 20px 40px !important; 
                padding-left: 20px !important;
                height: 100vh;
                border-left: none;
                margin-left: 0 !important;
            }
            
            .workspace-grid { grid-template-columns: 1fr; min-height: auto; gap: 40px; }
            .prompt-card { padding: 25px; }
            
            .user-avatar, #timer { display: none; } 
            
            .flex-wrap { flex-direction: column; gap: 12px; }
            #topic-select, button[onclick="randomizeQuestion()"] { width: 100%; }
        }
    </style>
</head>
<body>

    <div class="background-blobs"><div class="blob blob-1"></div><div class="blob blob-2"></div></div>

    <div class="mobile-header lg:hidden">
        <button onclick="toggleSidebar()" class="text-orange-500 text-2xl mr-4 focus:outline-none">
            <i class="fas fa-bars"></i>
        </button>
        <div class="flex items-center gap-2">
            <img src="../LOGO.WEBP" alt="Logo" class="w-8 h-8">
            <span class="font-black text-orange-500 text-lg">HOPVAN</span>
        </div>
        <div class="ml-auto bg-black text-white px-4 py-1.5 rounded-lg font-bold text-sm">
            <span id="timer-mobile">30:00</span>
        </div>
    </div>

    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="loading-overlay" id="loading-overlay">
        <div class="loader-robot"><i class="fas fa-robot"></i></div>
        <h3 class="text-2xl font-black mt-6 bg-gradient-to-r from-orange-500 to-red-600 bg-clip-text text-transparent">AI ĐANG CHẤM BÀI...</h3>
        <p class="text-gray-500 mt-2 font-medium">Chờ chút nhé, giáo viên AI đang đọc bài văn của bạn</p>
    </div>

    <div id="ai-error-popup" class="custom-modal">
        <div class="modal-box error-style">
            <div class="modal-icon"><i class="fas fa-exclamation-circle"></i></div>
            <h3>AI Hiện Đang Quá Tải</h3>
            <p>Hệ thống đang tiếp nhận quá nhiều yêu cầu cùng lúc. Vui lòng thử lại sau giây lát.</p>
            <div class="modal-actions">
                <button id="btn-ai-cancel" class="modal-btn btn-cancel">Hủy bỏ</button>
                <button id="btn-ai-retry" class="modal-btn btn-action-red">Thử lại ngay</button>
            </div>
        </div>
    </div>

    <div id="short-essay-popup" class="custom-modal">
        <div class="modal-box warning-style">
            <div class="modal-icon"><i class="fas fa-pen-nib"></i></div>
            <h3>Bài Viết Quá Ngắn</h3>
            <p>Bài làm cần ít nhất <strong>100 từ</strong> để AI có thể phân tích chính xác. Hãy viết thêm chút nữa nhé!</p>
            <div class="modal-actions">
                <button id="btn-short-close" class="modal-btn btn-action-yellow w-full">Đã hiểu, viết tiếp</button>
            </div>
        </div>
    </div>

    <div class="dashboard-container">
        <div id="menu-placeholder"></div>

        <main class="main-content">
            <div class="flex justify-between items-center mb-10 flex-wrap gap-4 hidden lg:flex">
                <div class="flex items-center gap-5">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-black text-gray-800 tracking-tight">Luyện Đề Ngẫu Nhiên</h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                            <p class="text-sm text-gray-500 font-bold uppercase tracking-widest">Trạng thái: Sẵn sàng</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-end">
                    <div class="bg-black text-white px-6 py-3 rounded-2xl font-black flex items-center gap-3 shadow-xl">
                        <i class="fas fa-clock text-orange-400"></i> <span id="timer" class="text-xl">30:00</span>
                    </div>
                    <div class="user-avatar" id="avatar-initial" style="width: 55px; height: 55px; background: var(--primary-gradient); border-radius: 18px; display: flex; justify-content: center; align-items: center; color: white; font-weight: 800; font-size: 1.4rem; box-shadow: 0 8px 20px rgba(255, 143, 80, 0.3); transform: rotate(-5deg);"></div>
                </div>
            </div>

            <div class="flex flex-wrap gap-4 mb-8">
                <select id="topic-select" class="px-8 py-4 rounded-2xl border-none font-bold text-gray-700 bg-white shadow-sm ring-1 ring-gray-100 outline-none focus:ring-2 focus:ring-orange-300 transition-all cursor-pointer w-full md:w-auto">
                    <option value="nlxh">Nghị luận xã hội</option>
                    <option value="nlvh">Nghị luận văn học</option>
                    <option value="dochieu">Đọc hiểu</option>
                </select>
                <button onclick="randomizeQuestion()" class="bg-white px-6 py-4 rounded-2xl font-bold text-gray-500 hover:text-orange-500 hover:bg-orange-50 transition-all shadow-sm w-full md:w-auto">
                    <i class="fas fa-random mr-2"></i> Đổi đề khác
                </button>
            </div>

            <div class="prompt-card" id="prompt-card">
                <div class="flex justify-between items-start mb-4">
                    <span id="prompt-type-label" class="bg-orange-50 text-orange-600 px-4 py-1.5 rounded-xl font-black text-xs uppercase tracking-widest">Đề bài</span>
                    <span id="prompt-title" class="text-gray-400 font-bold text-sm"></span>
                </div>
                
                <div id="passage-container" class="hidden">
                    <div class="text-xs font-black text-orange-400 mb-2 uppercase tracking-tighter">[ Văn bản trích dẫn ]</div>
                    <div id="prompt-passage" class="text-gray-700 leading-relaxed mb-6 p-6 bg-gray-50 rounded-2xl border-l-4 border-orange-300 italic max-height-[300px] overflow-y-auto shadow-inner">
                        </div>
                </div>

                <div id="requirement-container">
                    <h3 id="prompt-text" class="text-xl font-extrabold text-gray-800 leading-relaxed">Đang tải dữ liệu...</h3>
                </div>
                
                <div id="questions-list-container" class="hidden mt-6 space-y-4">
                    <h4 class="font-black text-gray-800 text-lg underline decoration-orange-400">Hệ thống câu hỏi:</h4>
                    <div id="questions-container" class="text-gray-800 font-bold space-y-2 text-sm">
                        </div>
                </div>

                <p id="prompt-hint" class="mt-6 text-gray-500 italic flex items-center gap-2 border-t pt-4 border-dashed">
                    <i class="fas fa-lightbulb text-orange-400"></i> <span>Gợi ý: Đang tải...</span>
                </p>
            </div>

            <div class="workspace-grid">
                <div class="editor-container">
                    <div class="px-6 py-4 bg-gray-50/50 border-b flex justify-between items-center flex-wrap gap-3">
                        <div class="flex items-center gap-3 w-full md:w-auto">
                            <span class="font-black text-xs text-gray-400 uppercase tracking-widest">Bài làm</span>
                            <button onclick="document.getElementById('file-upload').click()" class="flex items-center gap-2 px-3 py-1.5 bg-white border border-gray-200 rounded-lg text-xs font-bold text-gray-600 hover:text-orange-500 hover:border-orange-200 transition shadow-sm">
                                <i class="fas fa-paperclip"></i> Tải tệp (.docx)
                            </button>
                            <input type="file" id="file-upload" class="hidden" accept=".txt, .docx">
                        </div>
                        <span id="word-count" class="text-xs font-black bg-gray-200 text-gray-600 px-3 py-1 rounded-lg ml-auto">0 TỪ</span>
                    </div>
                    <textarea id="student-essay" class="writing-area" placeholder="Hãy bắt đầu bài viết của bạn tại đây..."></textarea>
                </div>

                <div class="editor-container">
                    <div class="px-8 py-5 bg-gray-50/50 border-b flex justify-between items-center">
                        <span class="font-black text-xs text-gray-400 uppercase tracking-widest">Phản hồi từ AI</span>
                        <button id="submit-btn" class="bg-gradient-to-r from-orange-500 to-red-600 text-white px-8 py-2.5 rounded-xl font-black text-sm hover:scale-105 transition shadow-lg active:scale-95">NỘP BÀI</button>
                    </div>
                    
                    <div id="ai-correction-box" class="ai-result-view text-gray-400 flex flex-col items-center justify-center text-center h-full">
                        <div>
                            <i class="fas fa-robot text-5xl mb-4 opacity-20"></i>
                            <p class="font-bold">Hoàn thành bài viết và nhấn "Nộp bài"<br>để AI chấm điểm</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="overall-feedback-box" class="mt-10 pb-20" style="display: none;">
                <h3 class="text-2xl font-black text-gray-800 mb-6 flex items-center gap-3"><i class="fas fa-star text-yellow-400"></i> Tổng kết đánh giá</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="p-8 bg-green-50 rounded-[40px] border border-green-100 shadow-sm relative overflow-hidden">
                        <i class="fas fa-check-circle absolute -right-4 -top-4 text-7xl text-green-100"></i>
                        <h4 class="text-green-700 font-black text-lg mb-4">Điểm sáng nội dung</h4>
                        <ul id="idea-list" class="space-y-3 text-green-800 font-medium leading-relaxed"></ul>
                    </div>
                    <div class="p-8 bg-red-50 rounded-[40px] border border-red-100 shadow-sm relative overflow-hidden">
                        <i class="fas fa-exclamation-triangle absolute -right-4 -top-4 text-7xl text-red-100"></i>
                        <h4 class="text-red-700 font-black text-lg mb-4">Hạn chế cần khắc phục</h4>
                        <ul id="missing-list" class="space-y-3 text-red-800 font-medium leading-relaxed"></ul>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAJ9C2biYeiLPmhakzLZ4mEqfO9_VgPSZE", authDomain: "hopvan-9a648.firebaseapp.com", projectId: "hopvan-9a648", storageBucket: "hopvan-9a648.appspot.com", messagingSenderId: "429347196227", appId: "1:429347196227:web:917b8d019f0efd0f7833f6", measurementId: "G-1BG8PSRG0R" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const API_URL = `/.netlify/functions/gemini-proxy`;
    let questionsData = {};
    window.currentExamData = null;

    // --- SIDEBAR TOGGLE ---
    window.toggleSidebar = () => {
        const sidebar = document.querySelector('aside') || document.getElementById('main-sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        
        if (sidebar && overlay) {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
            
            if (sidebar.classList.contains('open')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = 'auto';
            }
        }
    };

    // --- TIMER LOGIC ---
    let timeLeft = 1800; 
    const timerElement = document.getElementById('timer');
    const timerMobileElement = document.getElementById('timer-mobile');

    function startTimer() {
        const countdown = setInterval(() => {
            if (timeLeft <= 0) {
                clearInterval(countdown);
                if(timerElement) timerElement.innerText = "00:00";
                if(timerMobileElement) timerMobileElement.innerText = "00:00";
                alert("Hết thời gian làm bài! Hãy nộp bài ngay nhé.");
            } else {
                timeLeft--;
                let minutes = Math.floor(timeLeft / 60);
                let seconds = timeLeft % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if(timerElement) timerElement.innerText = timeString;
                if(timerMobileElement) timerMobileElement.innerText = timeString;
            }
        }, 1000);
    }

    onAuthStateChanged(auth, (u) => {
        if (u) {
            const n = u.displayName || u.email;
            const avatar = document.getElementById('avatar-initial');
            if(avatar) avatar.innerText = n.charAt(0).toUpperCase();
            startTimer();
        } else { window.location.href = "../log.html"; }
    });

    async function loadQuestions() {
        try {
            const r = await fetch('questions.json');
            questionsData = await r.json();
            randomizeQuestion();
        } catch (e) {
            document.getElementById('prompt-text').innerText = "Lỗi tải đề bài";
        }
    }

    window.randomizeQuestion = () => {
        const type = document.getElementById('topic-select').value;
        const list = questionsData[type];
        if (!list || list.length === 0) return;

        const q = list[Math.floor(Math.random() * list.length)];
        window.currentExamData = { ...q, type: type };

        const passageBox = document.getElementById('passage-container');
        const questionsBox = document.getElementById('questions-list-container');
        const hintBox = document.getElementById('prompt-hint');
        const textUI = document.getElementById('prompt-text');
        const labelUI = document.getElementById('prompt-type-label');
        const titleUI = document.getElementById('prompt-title');

        passageBox.classList.add('hidden');
        questionsBox.classList.add('hidden');
        hintBox.classList.add('hidden');

        if (type === 'dochieu') {
            labelUI.innerText = "Đọc hiểu";
            titleUI.innerText = q.title || "";
            textUI.innerText = "Dựa vào văn bản để trả lời các câu hỏi:";
            passageBox.classList.remove('hidden');
            questionsBox.classList.remove('hidden');
            document.getElementById('prompt-passage').innerText = q.text;
            document.getElementById('questions-container').innerHTML = q.questions.map(item => `
                <div class="p-3 bg-white border border-gray-100 rounded-xl shadow-sm mb-2"><p>${item.q}</p></div>
            `).join('');
        } else {
            labelUI.innerText = type === 'nlvh' ? "Nghị luận văn học" : "Nghị luận xã hội";
            titleUI.innerText = q.title || "";
            textUI.innerText = q.topic;
            if(q.text) { passageBox.classList.remove('hidden'); document.getElementById('prompt-passage').innerText = q.text; }
            hintBox.classList.remove('hidden');
            hintBox.querySelector('span').innerText = "Gợi ý: " + q.hint;
        }
        
        document.getElementById('student-essay').value = "";
        const aiBox = document.getElementById('ai-correction-box');
        aiBox.className = "ai-result-view h-full flex flex-col items-center justify-center text-center text-gray-400";
        aiBox.innerHTML = `<div><i class="fas fa-robot text-5xl mb-4 opacity-20"></i><p class="font-bold">Sẵn sàng chấm bài</p></div>`;
        document.getElementById('overall-feedback-box').style.display = 'none';
    };

    document.getElementById('topic-select').onchange = randomizeQuestion;
    loadQuestions();

    document.getElementById('file-upload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        const textarea = document.getElementById('student-essay');
        if (file.name.endsWith('.docx')) {
            reader.onload = function(event) {
                const arrayBuffer = event.target.result;
                mammoth.extractRawText({arrayBuffer: arrayBuffer})
                    .then(result => {
                        textarea.value = result.value;
                        textarea.dispatchEvent(new Event('input')); 
                    })
                    .catch(err => alert("Lỗi đọc file Word: " + err.message));
            };
            reader.readAsArrayBuffer(file);
        } else if (file.name.endsWith('.txt')) {
            reader.onload = function(event) {
                textarea.value = event.target.result;
                textarea.dispatchEvent(new Event('input'));
            };
            reader.readAsText(file);
        } else { alert("Vui lòng chọn file .docx hoặc .txt"); }
    });

    // --- POPUP HANDLERS ---
    const errorPopup = document.getElementById('ai-error-popup');
    const shortEssayPopup = document.getElementById('short-essay-popup');
    
    function showAiError() {
        document.getElementById('loading-overlay').style.display = 'none';
        errorPopup.style.display = 'flex';
    }
    function hideAiError() { errorPopup.style.display = 'none'; }

    function showShortEssay() { shortEssayPopup.style.display = 'flex'; }
    function hideShortEssay() { shortEssayPopup.style.display = 'none'; }

    document.getElementById('btn-ai-cancel').addEventListener('click', hideAiError);
    document.getElementById('btn-ai-retry').addEventListener('click', () => { hideAiError(); handleAISubmission(); });
    document.getElementById('btn-short-close').addEventListener('click', hideShortEssay);

    // --- MAIN AI LOGIC ---
    async function handleAISubmission() {
        const content = document.getElementById('student-essay').value.trim();
        // TRIGGER POPUP NẾU NGẮN
        if (content.split(/\s+/).length < 30) {
            showShortEssay();
            return;
        }

        const loading = document.getElementById('loading-overlay');
        loading.style.display = 'flex';

        const exam = window.currentExamData;
        const systemPrompt = `
            BẠN LÀ: Một giáo viên Ngữ văn lớp 12 uy tín, chuyên gia luyện thi Tốt nghiệp THPT theo chương trình GDPT 2018.
            THÁI ĐỘ: Nghiêm túc, tỉ mỉ, ngôn ngữ phê bình văn học mang tính học thuật cao (hàn lâm), khích lệ nhưng thẳng thắn chỉ ra lỗi sai.

            NHIỆM VỤ CỦA BẠN LÀ THỰC HIỆN ĐỒNG THỜI 4 BƯỚC SAU ĐÂY KHI NHẬN ĐƯỢC BÀI LÀM CỦA HỌC SINH:

            === BƯỚC 1: KIỂM TRA ĐỘ TRUNG THỰC (AI DETECTION) ===
            Phân tích văn phong để xác định xem học sinh có tự viết hay sử dụng AI (như ChatGPT, Gemini) để copy-paste.
            - Dấu hiệu AI: Cấu trúc câu quá hoàn hảo nhưng vô hồn, lặp từ nối "tóm lại/hơn nữa/bên cạnh đó" máy móc, liệt kê ý đều chằn chặn, thiếu cảm xúc cá nhân.
            - Dấu hiệu Con người: Có giọng văn riêng, có cảm xúc, có thể mắc lỗi diễn đạt nhỏ nhưng ý tứ sáng tạo, dùng từ ngữ đời thường hoặc so sánh độc đáo.
            => Đánh giá thang điểm human_score (0-100).

            === BƯỚC 2: CHẤM ĐIỂM CHUYÊN MÔN ===
            Chấm theo thang điểm 10. Đánh giá kỹ năng viết, bố cục, luận điểm và dẫn chứng.

            === BƯỚC 3: SỬA BÀI CHI TIẾT (CORRECTION) ===
            Tạo ra một phiên bản HTML của bài làm, trong đó:
            - Tô đỏ lỗi sai/diễn đạt kém: Dùng thẻ <span class="text-bad">nội dung lỗi</span>
            - Gợi ý sửa ngay bên cạnh: Dùng thẻ <span class="text-fix">nội dung đề xuất</span>
            - Tô xanh những ý hay/sáng tạo: Dùng thẻ <span class="text-good">ý hay</span>

            === BƯỚC 4: TỔNG HỢP VÀ TRẢ VỀ KẾT QUẢ (JSON) ===
            Tuyệt đối không trả lời bằng văn bản thường. Chỉ trả về 1 object JSON duy nhất với cấu trúc sau:
            {
              "human_score": (Số nguyên 0-100),
              "ai_comment": "Nhận xét ngắn về độ tự nhiên của văn phong.",
              "score": (Số điểm trên thang 10, ví dụ 8.5),
              "correction_html": "Chuỗi HTML bài làm đã được highlight lỗi (text-bad) và sửa lỗi (text-fix). Giữ nguyên các đoạn văn bản gốc của học sinh.",
              "idea_feedback": ["Điểm tích cực 1", "Điểm tích cực 2"],
              "missing_points": ["Hạn chế 1", "Hạn chế 2"]
            }

            --- THÔNG TIN ĐỀ BÀI ---
            LOẠI ĐỀ: ${exam.type === 'nlvh' ? 'Nghị luận Văn học' : (exam.type === 'dochieu' ? 'Đọc hiểu' : 'Nghị luận Xã hội')}
            YÊU CẦU ĐỀ: ${exam.topic || exam.title}
            VĂN BẢN TRÍCH DẪN (nếu có): ${exam.text || "Không có"}
            
            --- BÀI LÀM CỦA HỌC SINH ---
            ${content}
        `;
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message || "Lỗi từ phía Google AI");
            if (!data.candidates || data.candidates.length === 0) throw new Error("AI không trả về kết quả.");

            const rawText = data.candidates[0].content.parts[0].text;
            const res = JSON.parse(rawText.replace(/```json|```/g, "").trim());

            let barColor = res.human_score < 50 ? '#ef4444' : (res.human_score < 75 ? '#f59e0b' : '#22c55e');
            let verdictText = res.human_score < 50 ? "Nghi vấn văn AI" : (res.human_score < 75 ? "Hơi giống máy" : "Văn phong Tự nhiên");

            const aiMeterHTML = `<div class="ai-meter-box"><div><div class="meter-label">Độ Chân Thực</div><div style="font-size: 0.8rem; color: #888;">${res.ai_comment}</div></div><div style="text-align: right;"><div class="meter-score" style="color: ${barColor}">${res.human_score}%</div><div style="font-size: 0.7rem; font-weight: 700; color: ${barColor}">${verdictText}</div></div></div><div style="width: 100%; height: 6px; background: #eee; border-radius: 10px; margin-bottom: 20px; overflow: hidden;"><div style="width: ${res.human_score}%; height: 100%; background: ${barColor}; border-radius: 10px;"></div></div><div style="margin-bottom: 20px; font-weight: 800; font-size: 1.2rem; color: var(--primary);">ĐIỂM SỐ: ${res.score}/10</div>`;

            const box = document.getElementById('ai-correction-box');
            box.className = "ai-result-view h-full text-left text-gray-800 overflow-y-auto"; 
            box.innerHTML = aiMeterHTML + res.correction_html;

            document.getElementById('idea-list').innerHTML = res.idea_feedback.map(i => `<li>• ${i}</li>`).join('');
            document.getElementById('missing-list').innerHTML = res.missing_points.map(i => `<li>• ${i}</li>`).join('');
            document.getElementById('overall-feedback-box').style.display = 'block';

            if (auth.currentUser) {
                await addDoc(collection(db, "activities"), {
                    uid: auth.currentUser.uid,
                    action: `Hoàn thành đề: ${(exam.title || exam.topic).substring(0, 30)}... (${res.score} điểm)`,
                    type: "essay",
                    human_score: res.human_score,
                    score: res.score,
                    timestamp: serverTimestamp()
                });
            }
            loading.style.display = 'none';

        } catch (e) { 
            console.error(e);
            showAiError(); // TRIGGER POPUP LỖI
        } 
    }

    document.getElementById('submit-btn').onclick = handleAISubmission;

    document.getElementById('student-essay').oninput = function() {
        const c = this.value.trim().split(/\s+/).filter(x => x).length;
        document.getElementById('word-count').innerText = `${c} TỪ`;
    };

    fetch('menu.html').then(r => r.text()).then(h => {
        const p = document.getElementById('menu-placeholder');
        p.innerHTML = h;
        p.querySelectorAll('script').forEach(s => { const ns = document.createElement('script'); ns.text = s.text; document.body.appendChild(ns); });
    });
</script>
</body>
</html>