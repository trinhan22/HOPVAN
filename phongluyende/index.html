<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hopvan - Luyện Đề Ngẫu Nhiên</title>
    <meta property="og:title" content="HOPVAN - Nền Tảng Học & Luyện Thi Ngữ Văn" />
    <meta property="og:description" content="Nền tảng học tập Ngữ Văn tích hợp AI – hỗ trợ tự học thông minh, phân tích tác phẩm, luyện viết hiệu quả." />
    <meta property="og:image" content="https://hopvan.netlify.app/panel.webp" />
    <meta property="og:url" content="https://hopvan.netlify.app" />
    <meta property="og:type" content="article" />

    <link rel="icon" type="image/webp" href="../LOGO.WEBP" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <style>
        :root {
            --primary: #FF8F50;
            --primary-gradient: linear-gradient(135deg, #FF8F50, #FF5E62);
            --glass-bg: rgba(255, 255, 255, 0.75);
            --sidebar-width: 280px;
        }

        * { font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background-color: #FFF5EC; height: 100vh; overflow: hidden; display: flex; }

        /* --- BACKGROUND BLOBS --- */
        .background-blobs { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
        .blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5; animation: floatBlob 10s infinite alternate; }
        .blob-1 { width: 600px; height: 600px; background: #FCA96A; top: -150px; left: -150px; }
        .blob-2 { width: 500px; height: 500px; background: #FCD5B5; bottom: -100px; right: -100px; }
        @keyframes floatBlob { 0% { transform: translate(0, 0); } 100% { transform: translate(40px, 60px); } }

        /* --- MAIN LAYOUT --- */
        .main-content {
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            height: 100vh;
            background: var(--glass-bg);
            backdrop-filter: blur(35px); -webkit-backdrop-filter: blur(35px);
            border-left: 1px solid rgba(255, 255, 255, 0.5);
            padding: 40px;
            overflow-y: auto;
            position: relative;
        }

        /* --- EXAM ELEMENTS --- */
        .prompt-card {
            background: white; border-radius: 30px; padding: 35px;
            border: 1px solid rgba(255, 143, 80, 0.2);
            box-shadow: 0 15px 35px rgba(255, 143, 80, 0.05);
            position: relative; overflow: hidden;
        }
        .prompt-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 6px; height: 100%; background: var(--primary-gradient);
        }

        .workspace-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; min-height: 550px; }

        .editor-container {
            background: white; border-radius: 30px; border: 1px solid rgba(0,0,0,0.05);
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.02); transition: 0.3s;
        }
        .editor-container:focus-within { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 20px 50px rgba(255, 143, 80, 0.1); }

        .writing-area { 
            flex: 1; width: 100%; padding: 30px; border: none; outline: none; resize: none; 
            font-size: 1.1rem; line-height: 1.9; color: #2D3436; background: transparent;
        }

        /* AI CORRECTION STYLES */
        .ai-result-view { padding: 30px; font-size: 1.1rem; line-height: 1.9; overflow-y: auto; background-color: #fafafa; }
        
        .text-good { color: #10B981; background: #ECFDF5; font-weight: 600; padding: 2px 4px; border-radius: 6px; text-decoration: none; }
        .text-bad { color: #EF4444; background: #FEF2F2; text-decoration: line-through; padding: 2px 4px; border-radius: 6px; }
        .text-fix { color: #3B82F6; font-weight: 700; font-style: italic; }

        /* AI METER (Thanh đo độ chân thực) */
        .ai-meter-box {
            background: #fff; padding: 20px; border-radius: 20px; margin-bottom: 25px;
            border: 1px solid #f0f0f0; box-shadow: 0 5px 15px rgba(0,0,0,0.03);
            display: flex; align-items: center; justify-content: space-between;
        }
        .meter-label { font-weight: 800; color: #2d3436; font-size: 0.9rem; text-transform: uppercase; }
        .meter-score { font-weight: 900; font-size: 1.2rem; }

        /* Loading */
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .loader-robot { font-size: 4rem; color: var(--primary); animation: robotBounce 1s infinite alternate; }
        @keyframes robotBounce { from { transform: translateY(0); } to { transform: translateY(-20px); } }

        @media (max-width: 1024px) {
            .main-content { margin-left: 0; width: 100%; padding: 20px; }
            .workspace-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="background-blobs"><div class="blob blob-1"></div><div class="blob blob-2"></div></div>

    <div class="loading-overlay" id="loading-overlay">
        <div class="loader-robot"><i class="fas fa-robot"></i></div>
        <h3 class="text-2xl font-black mt-6 bg-gradient-to-r from-orange-500 to-red-600 bg-clip-text text-transparent">AI ĐANG CHẤM BÀI...</h3>
        <p class="text-gray-500 mt-2 font-medium">Chờ chút nhé, giáo viên AI đang đọc bài văn của bạn</p>
    </div>

    <div class="dashboard-container">
        <div id="menu-placeholder"></div>

        <main class="main-content">
            <div class="flex justify-between items-center mb-10">
                <div class="flex items-center gap-5">
                    <button class="md:hidden text-2xl" onclick="toggleSidebarGlobal()"><i class="fas fa-bars"></i></button>
                    <div>
                        <h2 class="text-3xl font-black text-gray-800 tracking-tight">Luyện Đề Ngẫu Nhiên</h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                            <p class="text-sm text-gray-500 font-bold uppercase tracking-widest">Trạng thái: Sẵn sàng</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="bg-black text-white px-6 py-3 rounded-2xl font-black flex items-center gap-3 shadow-xl">
                        <i class="fas fa-clock text-orange-400"></i> <span id="timer" class="text-xl">30:00</span>
                    </div>
                    <div class="user-avatar" id="avatar-initial" style="width: 55px; height: 55px; background: var(--primary-gradient); border-radius: 18px; display: flex; justify-content: center; align-items: center; color: white; font-weight: 800; font-size: 1.4rem; box-shadow: 0 8px 20px rgba(255, 143, 80, 0.3); transform: rotate(-5deg);"></div>
                </div>
            </div>

            <div class="flex flex-wrap gap-4 mb-8">
                <select id="topic-select" class="px-8 py-4 rounded-2xl border-none font-bold text-gray-700 bg-white shadow-sm ring-1 ring-gray-100 outline-none focus:ring-2 focus:ring-orange-300 transition-all cursor-pointer">
                    <option value="nlxh">Nghị luận xã hội</option>
                    <option value="nlvh">Nghị luận văn học</option>
                    <option value="dochieu">Đọc hiểu</option>
                </select>
                <button onclick="randomizeQuestion()" class="bg-white px-6 py-4 rounded-2xl font-bold text-gray-500 hover:text-orange-500 hover:bg-orange-50 transition-all shadow-sm">
                    <i class="fas fa-random mr-2"></i> Đổi đề khác
                </button>
            </div>

            <div class="prompt-card mb-10" id="prompt-card">
                <div class="flex justify-between items-start mb-4">
                    <span id="prompt-type-label" class="bg-orange-50 text-orange-600 px-4 py-1.5 rounded-xl font-black text-xs uppercase tracking-widest">Đề bài</span>
                    <span id="prompt-title" class="text-gray-400 font-bold text-sm"></span>
                </div>
                
                <div id="passage-container" class="hidden">
                    <div class="text-xs font-black text-orange-400 mb-2 uppercase tracking-tighter">[ Văn bản trích dẫn ]</div>
                    <div id="prompt-passage" class="text-gray-700 leading-relaxed mb-6 p-6 bg-gray-50 rounded-2xl border-l-4 border-orange-300 italic max-height-[300px] overflow-y-auto shadow-inner">
                        </div>
                </div>

                <div id="requirement-container">
                    <h3 id="prompt-text" class="text-xl font-extrabold text-gray-800 leading-relaxed">Đang tải dữ liệu...</h3>
                </div>
                
                <div id="questions-list-container" class="hidden mt-6 space-y-4">
                    <h4 class="font-black text-gray-800 text-lg underline decoration-orange-400">Hệ thống câu hỏi:</h4>
                    <div id="questions-container" class="text-gray-800 font-bold space-y-2 text-sm">
                        </div>
                </div>

                <p id="prompt-hint" class="mt-6 text-gray-500 italic flex items-center gap-2 border-t pt-4 border-dashed">
                    <i class="fas fa-lightbulb text-orange-400"></i> <span>Gợi ý: Đang tải...</span>
                </p>
            </div>

            <div class="workspace-grid">
                <div class="editor-container">
                    <div class="px-6 py-4 bg-gray-50/50 border-b flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="font-black text-xs text-gray-400 uppercase tracking-widest">Bài làm</span>
                            <button onclick="document.getElementById('file-upload').click()" class="flex items-center gap-2 px-3 py-1.5 bg-white border border-gray-200 rounded-lg text-xs font-bold text-gray-600 hover:text-orange-500 hover:border-orange-200 transition shadow-sm">
                                <i class="fas fa-paperclip"></i> Tải tệp (.docx)
                            </button>
                            <input type="file" id="file-upload" class="hidden" accept=".txt, .docx">
                        </div>
                        <span id="word-count" class="text-xs font-black bg-gray-200 text-gray-600 px-3 py-1 rounded-lg">0 TỪ</span>
                    </div>
                    <textarea id="student-essay" class="writing-area" placeholder="Hãy bắt đầu bài viết của bạn tại đây..."></textarea>
                </div>

                <div class="editor-container">
                    <div class="px-8 py-5 bg-gray-50/50 border-b flex justify-between items-center">
                        <span class="font-black text-xs text-gray-400 uppercase tracking-widest">Phản hồi từ giáo viên AI</span>
                        <button id="submit-btn" class="bg-gradient-to-r from-orange-500 to-red-600 text-white px-8 py-2.5 rounded-xl font-black text-sm hover:scale-105 transition shadow-lg active:scale-95">NỘP BÀI</button>
                    </div>
                    
                    <div id="ai-correction-box" class="ai-result-view text-gray-400 flex flex-col items-center justify-center text-center h-full">
                        <div>
                            <i class="fas fa-robot text-5xl mb-4 opacity-20"></i>
                            <p class="font-bold">Hoàn thành bài viết và nhấn "Nộp bài"<br>để AI chấm điểm</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="overall-feedback-box" class="mt-10 pb-20" style="display: none;">
                <h3 class="text-2xl font-black text-gray-800 mb-6 flex items-center gap-3"><i class="fas fa-star text-yellow-400"></i> Tổng kết đánh giá</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="p-8 bg-green-50 rounded-[40px] border border-green-100 shadow-sm relative overflow-hidden">
                        <i class="fas fa-check-circle absolute -right-4 -top-4 text-7xl text-green-100"></i>
                        <h4 class="text-green-700 font-black text-lg mb-4">Điểm sáng nội dung</h4>
                        <ul id="idea-list" class="space-y-3 text-green-800 font-medium leading-relaxed"></ul>
                    </div>
                    <div class="p-8 bg-red-50 rounded-[40px] border border-red-100 shadow-sm relative overflow-hidden">
                        <i class="fas fa-exclamation-triangle absolute -right-4 -top-4 text-7xl text-red-100"></i>
                        <h4 class="text-red-700 font-black text-lg mb-4">Hạn chế cần khắc phục</h4>
                        <ul id="missing-list" class="space-y-3 text-red-800 font-medium leading-relaxed"></ul>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAJ9C2biYeiLPmhakzLZ4mEqfO9_VgPSZE", authDomain: "hopvan-9a648.firebaseapp.com", projectId: "hopvan-9a648", storageBucket: "hopvan-9a648.appspot.com", messagingSenderId: "429347196227", appId: "1:429347196227:web:917b8d019f0efd0f7833f6", measurementId: "G-1BG8PSRG0R" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const API_URL = `/.netlify/functions/gemini-proxy`;
    let questionsData = {};
    window.currentExamData = null;

    // --- LOGIC ĐỒNG HỒ ĐẾM NGƯỢC ---
    let timeLeft = 1800; // 30 phút
    const timerElement = document.getElementById('timer');

    function startTimer() {
        const countdown = setInterval(() => {
            if (timeLeft <= 0) {
                clearInterval(countdown);
                timerElement.innerText = "00:00";
                alert("Hết thời gian làm bài! Hãy nộp bài ngay nhé.");
            } else {
                timeLeft--;
                let minutes = Math.floor(timeLeft / 60);
                let seconds = timeLeft % 60;
                timerElement.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }, 1000);
    }

    // 1. Auth check
    onAuthStateChanged(auth, (u) => {
        if (u) {
            const n = u.displayName || u.email;
            document.getElementById('avatar-initial').innerText = n.charAt(0).toUpperCase();
            startTimer();
        } else { window.location.href = "../log.html"; }
    });

    // 2. Tải dữ liệu từ questions.json
    async function loadQuestions() {
        try {
            const r = await fetch('questions.json');
            questionsData = await r.json();
            randomizeQuestion();
        } catch (e) {
            document.getElementById('prompt-text').innerText = "Lỗi tải đề bài";
        }
    }

    // 3. Hàm chọn đề ngẫu nhiên
    window.randomizeQuestion = () => {
        const type = document.getElementById('topic-select').value;
        const list = questionsData[type];
        if (!list || list.length === 0) return;

        const q = list[Math.floor(Math.random() * list.length)];
        window.currentExamData = { ...q, type: type };

        const passageBox = document.getElementById('passage-container');
        const questionsBox = document.getElementById('questions-list-container');
        const hintBox = document.getElementById('prompt-hint');
        const textUI = document.getElementById('prompt-text');
        const labelUI = document.getElementById('prompt-type-label');
        const titleUI = document.getElementById('prompt-title');

        passageBox.classList.add('hidden');
        questionsBox.classList.add('hidden');
        hintBox.classList.add('hidden');

        if (type === 'dochieu') {
            labelUI.innerText = "Đọc hiểu";
            titleUI.innerText = q.title || "";
            textUI.innerText = "Dựa vào văn bản để trả lời các câu hỏi:";
            passageBox.classList.remove('hidden');
            questionsBox.classList.remove('hidden');
            document.getElementById('prompt-passage').innerText = q.text;
            document.getElementById('questions-container').innerHTML = q.questions.map(item => `
                <div class="p-3 bg-white border border-gray-100 rounded-xl shadow-sm mb-2"><p>${item.q}</p></div>
            `).join('');
        } else {
            labelUI.innerText = type === 'nlvh' ? "Nghị luận văn học" : "Nghị luận xã hội";
            titleUI.innerText = q.title || "";
            textUI.innerText = q.topic;
            if(q.text) { passageBox.classList.remove('hidden'); document.getElementById('prompt-passage').innerText = q.text; }
            hintBox.classList.remove('hidden');
            hintBox.querySelector('span').innerText = "Gợi ý: " + q.hint;
        }
        
        // Reset kết quả
        document.getElementById('student-essay').value = "";
        
        // Căn giữa dòng chữ "Sẵn sàng chấm bài"
        const aiBox = document.getElementById('ai-correction-box');
        aiBox.className = "ai-result-view h-full flex flex-col items-center justify-center text-center text-gray-400";
        aiBox.innerHTML = `
            <div>
                <i class="fas fa-robot text-5xl mb-4 opacity-20"></i>
                <p class="font-bold">Sẵn sàng chấm bài</p>
            </div>
        `;
        document.getElementById('overall-feedback-box').style.display = 'none';
    };

    document.getElementById('topic-select').onchange = randomizeQuestion;
    loadQuestions();

    // --- LOGIC XỬ LÝ UPLOAD FILE (MAMMOTH) ---
    document.getElementById('file-upload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        const textarea = document.getElementById('student-essay');

        if (file.name.endsWith('.docx')) {
            reader.onload = function(event) {
                const arrayBuffer = event.target.result;
                mammoth.extractRawText({arrayBuffer: arrayBuffer})
                    .then(result => {
                        textarea.value = result.value;
                        textarea.dispatchEvent(new Event('input')); // Cập nhật bộ đếm từ
                    })
                    .catch(err => alert("Lỗi đọc file Word: " + err.message));
            };
            reader.readAsArrayBuffer(file);
        } else if (file.name.endsWith('.txt')) {
            reader.onload = function(event) {
                textarea.value = event.target.result;
                textarea.dispatchEvent(new Event('input'));
            };
            reader.readAsText(file);
        } else {
            alert("Vui lòng chọn file .docx hoặc .txt");
        }
    });

    // 4. AI GRADING LOGIC & CẬP NHẬT DATABASE
    document.getElementById('submit-btn').onclick = async () => {
        const content = document.getElementById('student-essay').value.trim();
        if (content.split(/\s+/).length < 30) return alert("Bài viết hơi ngắn!");

        const loading = document.getElementById('loading-overlay');
        loading.style.display = 'flex';

        const exam = window.currentExamData;
        
        // PROMPT MỚI: TÍCH HỢP CHẤM ĐIỂM + CHECK AI
        const systemPrompt = `
            BẠN LÀ: Một giáo viên Ngữ văn lớp 12 uy tín, chuyên gia luyện thi Tốt nghiệp THPT theo chương trình GDPT 2018.
            THÁI ĐỘ: Nghiêm túc, tỉ mỉ, ngôn ngữ phê bình văn học mang tính học thuật cao (hàn lâm), khích lệ nhưng thẳng thắn chỉ ra lỗi sai.

            NHIỆM VỤ CỦA BẠN LÀ THỰC HIỆN ĐỒNG THỜI 4 BƯỚC SAU ĐÂY KHI NHẬN ĐƯỢC BÀI LÀM CỦA HỌC SINH:

            === BƯỚC 1: KIỂM TRA ĐỘ TRUNG THỰC (AI DETECTION) ===
            Phân tích văn phong để xác định xem học sinh có tự viết hay sử dụng AI (như ChatGPT, Gemini) để copy-paste.
            - Dấu hiệu AI: Cấu trúc câu quá hoàn hảo nhưng vô hồn, lặp từ nối "tóm lại/hơn nữa/bên cạnh đó" máy móc, liệt kê ý đều chằn chặn, thiếu cảm xúc cá nhân.
            - Dấu hiệu Con người: Có giọng văn riêng, có cảm xúc, có thể mắc lỗi diễn đạt nhỏ nhưng ý tứ sáng tạo, dùng từ ngữ đời thường hoặc so sánh độc đáo.
            => Đánh giá thang điểm human_score (0-100).

            === BƯỚC 2: CHẤM ĐIỂM CHUYÊN MÔN ===
            Chấm theo thang điểm 10. Đánh giá kỹ năng viết, bố cục, luận điểm và dẫn chứng.

            === BƯỚC 3: SỬA BÀI CHI TIẾT (CORRECTION) ===
            Tạo ra một phiên bản HTML của bài làm, trong đó:
            - Tô đỏ lỗi sai/diễn đạt kém: Dùng thẻ <span class="text-bad">nội dung lỗi</span>
            - Gợi ý sửa ngay bên cạnh: Dùng thẻ <span class="text-fix">nội dung đề xuất</span>
            - Tô xanh những ý hay/sáng tạo: Dùng thẻ <span class="text-good">ý hay</span>

            === BƯỚC 4: TỔNG HỢP VÀ TRẢ VỀ KẾT QUẢ (JSON) ===
            Tuyệt đối không trả lời bằng văn bản thường. Chỉ trả về 1 object JSON duy nhất với cấu trúc sau:
            {
              "human_score": (Số nguyên 0-100),
              "ai_comment": "Nhận xét ngắn về độ tự nhiên của văn phong.",
              "score": (Số điểm trên thang 10, ví dụ 8.5),
              "correction_html": "Chuỗi HTML bài làm đã được highlight lỗi (text-bad) và sửa lỗi (text-fix). Giữ nguyên các đoạn văn bản gốc của học sinh.",
              "idea_feedback": ["Điểm tích cực 1", "Điểm tích cực 2"],
              "missing_points": ["Hạn chế 1", "Hạn chế 2"]
            }

            --- THÔNG TIN ĐỀ BÀI ---
            LOẠI ĐỀ: ${exam.type === 'nlvh' ? 'Nghị luận Văn học' : (exam.type === 'dochieu' ? 'Đọc hiểu' : 'Nghị luận Xã hội')}
            YÊU CẦU ĐỀ: ${exam.topic || exam.title}
            VĂN BẢN TRÍCH DẪN (nếu có): ${exam.text || "Không có"}
            
            --- BÀI LÀM CỦA HỌC SINH ---
            ${content}
        `;

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] })
            });

            const data = await response.json();
            const rawText = data.candidates[0].content.parts[0].text;
            const res = JSON.parse(rawText.replace(/```json|```/g, "").trim());

            // --- HIỂN THỊ KẾT QUẢ ---
            
            // 1. Màu sắc thanh đo AI
            let barColor = '#22c55e'; // Xanh
            let verdictText = "Văn phong Tự nhiên";
            if (res.human_score < 50) { barColor = '#ef4444'; verdictText = "Nghi vấn văn AI"; } // Đỏ
            else if (res.human_score < 75) { barColor = '#f59e0b'; verdictText = "Hơi giống máy"; } // Vàng

            const aiMeterHTML = `
                <div class="ai-meter-box">
                    <div>
                        <div class="meter-label">Độ Chân Thực</div>
                        <div style="font-size: 0.8rem; color: #888;">${res.ai_comment}</div>
                    </div>
                    <div style="text-align: right;">
                        <div class="meter-score" style="color: ${barColor}">${res.human_score}%</div>
                        <div style="font-size: 0.7rem; font-weight: 700; color: ${barColor}">${verdictText}</div>
                    </div>
                </div>
                <div style="width: 100%; height: 6px; background: #eee; border-radius: 10px; margin-bottom: 20px; overflow: hidden;">
                    <div style="width: ${res.human_score}%; height: 100%; background: ${barColor}; border-radius: 10px;"></div>
                </div>
                <div style="margin-bottom: 20px; font-weight: 800; font-size: 1.2rem; color: var(--primary);">
                    ĐIỂM SỐ: ${res.score}/10
                </div>
            `;

            // 2. Render vào box và thay đổi Class để căn trái
            const box = document.getElementById('ai-correction-box');
            
            // Reset class để bỏ căn giữa, chuyển sang căn trái và scroll
            box.className = "ai-result-view h-full text-left text-gray-800 overflow-y-auto"; 
            
            box.innerHTML = aiMeterHTML + res.correction_html;

            // 3. Render ý chính
            document.getElementById('idea-list').innerHTML = res.idea_feedback.map(i => `<li>• ${i}</li>`).join('');
            document.getElementById('missing-list').innerHTML = res.missing_points.map(i => `<li>• ${i}</li>`).join('');
            document.getElementById('overall-feedback-box').style.display = 'block';

            // 4. Lưu Firebase
            if (auth.currentUser) {
                await addDoc(collection(db, "activities"), {
                    uid: auth.currentUser.uid,
                    action: `Hoàn thành đề: ${(exam.title || exam.topic).substring(0, 30)}... (${res.score} điểm)`,
                    type: "essay",
                    human_score: res.human_score,
                    score: res.score,
                    timestamp: serverTimestamp()
                });
            }

        } catch (e) {
            alert("Lỗi xử lý AI, vui lòng thử lại.");
            console.error(e);
        } finally { loading.style.display = 'none'; }
    };

    // Word count
    document.getElementById('student-essay').oninput = function() {
        const c = this.value.trim().split(/\s+/).filter(x => x).length;
        document.getElementById('word-count').innerText = `${c} TỪ`;
    };

    // Menu load
    fetch('menu.html').then(r => r.text()).then(h => {
        const p = document.getElementById('menu-placeholder');
        p.innerHTML = h;
        p.querySelectorAll('script').forEach(s => {
            const ns = document.createElement('script');
            ns.text = s.text;
            document.body.appendChild(ns);
        });
    });
</script>
</body>
</html>