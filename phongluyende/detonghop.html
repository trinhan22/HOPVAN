<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HopVan - Luyện Đề Tổng Hợp</title>
    
    <meta property="og:title" content="HOPVAN - Nền Tảng Học & Luyện Thi Ngữ Văn" />
    <meta property="og:description" content="Nền tảng học tập Ngữ Văn tích hợp AI – hỗ trợ tự học thông minh." />
    <meta property="og:image" content="https://hopvan.netlify.app/panel.webp" />
    <meta property="og:url" content="https://hopvan.netlify.app" />
    <meta property="og:type" content="article" />

    <link rel="icon" type="image/webp" href="../LOGO.WEBP" />

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FF8F50">

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <style>
        :root {
            --primary: #FF8F50;
            --glass-bg: rgba(255, 255, 255, 0.95);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #FFF5EC; 
            height: 100vh; overflow: hidden; 
        }

        #menu-placeholder { display: none !important; }

        .main-content {
            width: 100%; height: 100vh;
            background: var(--glass-bg);
            padding: 20px 40px;
            display: flex; flex-direction: column;
        }

        .header-bar { flex-shrink: 0; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .workspace-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; flex: 1; overflow: hidden; padding-bottom: 20px; }

        /* --- CỘT TRÁI: ĐỀ BÀI --- */
        .column-card {
            background: white; border-radius: 24px; 
            border: 1px solid rgba(255, 143, 80, 0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.03);
            display: flex; flex-direction: column; 
            height: 100%; overflow: hidden;
        }
        .card-header {
            padding: 16px 24px; background: #fff7ed; border-bottom: 1px solid #fed7aa;
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .prompt-body { 
            padding: 30px; overflow-y: auto; flex: 1; 
            background-color: #fffcf8; 
            transition: font-size 0.2s ease;
        }

        /* KHUNG CHỨA NỘI DUNG (Passage Box) */
        .passage-box {
            background: white; padding: 24px; 
            border-radius: 16px; border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
            margin-bottom: 24px; position: relative;
        }
        
        .exam-content {
            font-family: 'Merriweather', serif;
            font-weight: 300; font-size: 1.1rem; line-height: 2.0;
            color: #1e293b; text-align: justify; white-space: pre-wrap;
        }
        
        .section-badge {
            display: inline-block; padding: 4px 12px; border-radius: 8px;
            font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .question-box {
            background: #f8fafc; padding: 16px; 
            border-radius: 12px; border: 1px solid #f1f5f9;
            margin-bottom: 12px;
        }

        /* --- CỘT PHẢI: BÀI LÀM --- */
        .writing-area { 
            width: 100%; height: 100%; padding: 24px; 
            border: none; outline: none; resize: none; 
            font-size: 1.1rem; line-height: 2.0; 
            color: #334155; background: transparent;
            font-family: 'Merriweather', serif;
            background-image: linear-gradient(#f1f5f9 1px, transparent 1px);
            background-size: 100% 2.2rem; background-attachment: local;
        }
        .footer-action {
            padding: 16px; border-top: 1px solid #f1f5f9; background: white; 
            display: flex; justify-content: flex-end; flex-shrink: 0;
        }
        .submit-btn {
            background: linear-gradient(135deg, #FF8F50, #FF5E62); color: white; 
            padding: 12px 32px; border-radius: 50px; font-weight: 800; 
            box-shadow: 0 4px 15px rgba(255, 143, 80, 0.3); transition: 0.2s;
        }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 143, 80, 0.4); }

        /* --- HIGHLIGHT TOOLTIP --- */
        ::selection { background: #fed7aa; color: #431407; }
        .highlight-yellow { background-color: #fef08a; border-bottom: 2px solid #facc15; }
        .highlight-green { background-color: #bbf7d0; border-bottom: 2px solid #4ade80; }
        .highlight-pink { background-color: #fbcfe8; border-bottom: 2px solid #f472b6; }
        #highlight-menu {
            position: absolute; display: none; background: white; 
            border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
            padding: 6px 10px; z-index: 1000; gap: 8px; border: 1px solid #f3f4f6;
            animation: popIn 0.15s ease;
        }
        .hl-btn { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .hl-btn:hover { transform: scale(1.2); }
        @keyframes popIn { from { transform: scale(0.5) translateY(10px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }

        /* --- LOADING & AI VIEW --- */
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .loader-robot { font-size: 4rem; color: var(--primary); animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        
        .ai-result-view { padding: 24px; overflow-y: auto; height: 100%; background: #f8fafc; }
        .text-good { background: #dcfce7; color: #166534; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .text-bad { text-decoration: line-through; color: #991b1b; background: #fee2e2; padding: 0 4px; border-radius: 4px; }

        /* --- POPUP STYLES --- */
        .custom-modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px); z-index: 20000;
            justify-content: center; align-items: center; animation: fadeIn 0.2s;
        }
        .modal-box {
            background: white; padding: 30px; border-radius: 24px;
            width: 90%; max-width: 400px; text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.9); animation: zoomIn 0.2s forwards;
        }
        .modal-icon { font-size: 3rem; margin-bottom: 15px; }
        .modal-actions { margin-top: 25px; display: flex; gap: 10px; justify-content: center; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 12px; font-weight: 700; transition: 0.2s; }
        
        /* Popup Themes */
        .popup-error .modal-icon { color: #ef4444; }
        .popup-error button { background: #ef4444; color: white; }
        .popup-warning .modal-icon { color: #f59e0b; }
        .popup-warning button { background: #f59e0b; color: white; }
        .popup-info .modal-icon { color: #3b82f6; }
        .popup-info button { background: #3b82f6; color: white; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.9); } to { transform: scale(1); } }

        /* --- MOBILE --- */
        .mobile-header { display: none; position: fixed; top: 0; left: 0; right: 0; height: 70px; background: white; z-index: 100; align-items: center; padding: 0 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        @media (max-width: 1024px) {
            body { overflow: auto; height: auto; }
            .mobile-header { display: flex; }
            .header-bar { display: none; }
            .main-content { padding: 80px 16px 20px; height: auto; }
            .workspace-grid { display: flex; flex-direction: column; height: auto; }
            .column-card { height: 600px; }
        }
    </style>
</head>
<body>

    <div id="highlight-menu">
        <button class="hl-btn bg-yellow-200" onclick="applyHighlight('highlight-yellow')" title="Vàng"></button>
        <button class="hl-btn bg-green-200" onclick="applyHighlight('highlight-green')" title="Xanh"></button>
        <button class="hl-btn bg-pink-200" onclick="applyHighlight('highlight-pink')" title="Hồng"></button>
        <button class="hl-btn bg-gray-100 text-gray-500 flex items-center justify-center" onclick="removeHighlight()" title="Xóa"><i class="fas fa-eraser text-xs"></i></button>
    </div>

    <div class="loading-overlay" id="loading-overlay">
        <div class="loader-robot"><i class="fas fa-robot"></i></div>
        <h3 class="mt-4 font-bold text-gray-800 text-lg">AI ĐANG CHẤM BÀI...</h3>
        <p class="text-sm text-gray-500">Đang phân tích theo cấu trúc 2025...</p>
    </div>

    <div id="generic-popup" class="custom-modal">
        <div class="modal-box">
            <div id="popup-icon" class="modal-icon"><i class="fas fa-info-circle"></i></div>
            <h3 id="popup-title" class="font-bold text-xl mb-2 text-gray-800">Thông báo</h3>
            <p id="popup-message" class="text-gray-600">Nội dung thông báo...</p>
            <div class="modal-actions">
                <button onclick="closePopup()" class="modal-btn hover:opacity-90">Đã hiểu</button>
            </div>
        </div>
    </div>

    <div id="short-essay-popup" class="custom-modal">
        <div class="modal-box popup-warning">
            <div class="modal-icon"><i class="fas fa-pen-nib"></i></div>
            <h3 class="font-bold text-xl mb-2">Bài Quá Ngắn</h3>
            <p class="text-gray-600">Bài làm cần ít nhất <strong>50 từ</strong> để AI chấm chính xác. Hãy viết thêm chút nữa nhé!</p>
            <div class="modal-actions">
                <button onclick="document.getElementById('short-essay-popup').style.display='none'" class="modal-btn bg-orange-100 !text-white-600 hover:bg-orange-200">Viết tiếp</button>
            </div>
        </div>
    </div>

    <div class="mobile-header lg:hidden">
        <div class="flex items-center gap-2">
            <img src="../LOGO.WEBP" class="w-8 h-8">
            <span class="font-black text-orange-500 text-lg">HOPVAN</span>
        </div>
        <div class="ml-auto bg-gray-900 text-white px-3 py-1 rounded text-xs font-bold font-mono" id="timer-mobile">120:00</div>
    </div>

    <div class="dashboard-container">
        <div id="menu-placeholder"></div>

        <main class="main-content">
            <div class="header-bar hidden lg:flex">
                <div class="flex items-center gap-4">
                    <a href="../dashboard/phongluyende.html" class="w-10 h-10 rounded-xl bg-white border border-gray-200 flex items-center justify-center text-gray-500 hover:text-orange-500 hover:bg-orange-50 transition shadow-sm">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <div>
                        <h2 class="text-2xl font-black text-gray-800">Luyện Đề Tổng Hợp</h2>
                        <div class="flex items-center gap-2">
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="bg-white rounded-xl border border-gray-200 flex items-center p-1 shadow-sm">
                        <span class="text-xs font-bold text-gray-400 pl-3 pr-2 uppercase">Cỡ đề:</span>
                        <button onclick="adjustPromptSize(-1)" class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded text-gray-600"><i class="fas fa-minus text-xs"></i></button>
                        <span class="w-px h-4 bg-gray-200 mx-1"></span>
                        <button onclick="adjustPromptSize(1)" class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded text-gray-600"><i class="fas fa-plus text-xs"></i></button>
                    </div>

                    <button onclick="randomizeQuestion()" class="bg-white px-4 py-2 rounded-xl font-bold text-gray-600 hover:text-orange-600 border border-gray-200 text-sm shadow-sm flex gap-2 items-center">
                        <i class="fas fa-sync-alt"></i> Đổi đề
                    </button>
                    
                    <div class="bg-gray-900 text-white px-5 py-2 rounded-xl font-mono font-bold flex items-center gap-2 shadow-lg">
                        <i class="fas fa-clock text-orange-400"></i> <span id="timer">120:00</span>
                    </div>
                </div>
            </div>

            <div class="workspace-grid">
                
                <div class="column-card">
                    <div class="card-header">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-orange-600 uppercase text-xs tracking-widest bg-white px-3 py-1 rounded-full border border-orange-100">
                                <i class="fas fa-file-alt mr-1"></i> Đề chính thức
                            </span>
                            <span class="text-[10px] text-gray-400 italic">(Bôi đen để Highlight)</span>
                        </div>
                        <span id="exam-code" class="text-xs font-bold text-gray-400">LOADING...</span>
                    </div>
                    
                    <div class="scrollable-content prompt-body" id="prompt-content">
                        <div class="animate-pulse space-y-4">
                            <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                            <div class="h-4 bg-gray-200 rounded w-full"></div>
                            <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                        </div>
                    </div>
                </div>

                <div class="column-card relative">
                    <div id="input-section" class="flex flex-col h-full">
                        <div class="card-header bg-white">
                            <span class="font-black text-xs text-gray-400 uppercase tracking-widest">BÀI LÀM CỦA BẠN</span>
                            <div class="flex gap-2">
                                <button onclick="document.getElementById('file-upload').click()" class="text-xs font-bold text-blue-500 bg-blue-50 px-3 py-1 rounded hover:bg-blue-100 transition">
                                    <i class="fas fa-paperclip mr-1"></i> File
                                </button>
                                <input type="file" id="file-upload" class="hidden" accept=".txt, .docx">
                                <span id="word-count" class="text-xs font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">0 TỪ</span>
                            </div>
                        </div>

                        <div class="flex-1 overflow-hidden relative">
                            <textarea id="student-essay" class="writing-area" 
                                placeholder="Viết bài làm của bạn tại đây..."></textarea>
                        </div>

                        <div class="footer-action">
                            <button onclick="handleAISubmission()" class="submit-btn flex items-center gap-2">
                                <span>NỘP BÀI</span> <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>

                    <div id="output-section" class="hidden h-full flex-col">
                        <div class="card-header bg-gray-900 border-none text-white">
                            <span class="font-bold text-sm uppercase"><i class="fas fa-robot mr-2 text-orange-400"></i>Kết quả chấm</span>
                            <button onclick="resetExam()" class="text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded transition">Làm lại</button>
                        </div>
                        <div id="ai-correction-box" class="ai-result-view"></div>
                    </div>
                </div>

            </div>
        </main>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CONFIG FIREBASE ---
    const firebaseConfig = { apiKey: "AIzaSyAJ9C2biYeiLPmhakzLZ4mEqfO9_VgPSZE", authDomain: "hopvan-9a648.firebaseapp.com", projectId: "hopvan-9a648", storageBucket: "hopvan-9a648.appspot.com", messagingSenderId: "429347196227", appId: "1:429347196227:web:917b8d019f0efd0f7833f6", measurementId: "G-1BG8PSRG0R" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const API_URL = `/.netlify/functions/gemini-proxy`;
    let questionsData = []; 
    window.currentExamData = null;

    // --- HÀM HIỂN THỊ POPUP ---
    window.showPopup = (title, message, type = 'info') => {
        const modal = document.getElementById('generic-popup');
        const box = modal.querySelector('.modal-box');
        const icon = document.getElementById('popup-icon');
        
        // Reset classes
        box.classList.remove('popup-error', 'popup-warning', 'popup-info');
        
        // Set content & theme
        document.getElementById('popup-title').innerText = title;
        document.getElementById('popup-message').innerText = message;
        
        if (type === 'error') {
            box.classList.add('popup-error');
            icon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
        } else if (type === 'warning') {
            box.classList.add('popup-warning');
            icon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
        } else {
            box.classList.add('popup-info');
            icon.innerHTML = '<i class="fas fa-info-circle"></i>';
        }
        
        modal.style.display = 'flex';
    };

    window.closePopup = () => {
        document.getElementById('generic-popup').style.display = 'none';
    };

    // --- 1. CHỈNH CỠ CHỮ ---
    let promptFontSize = 17;
    window.adjustPromptSize = (amount) => {
        promptFontSize += amount;
        if(promptFontSize < 14) promptFontSize = 14;
        if(promptFontSize > 26) promptFontSize = 26;
        
        document.querySelector('.prompt-body').style.fontSize = `${promptFontSize}px`;
        const contents = document.querySelectorAll('.exam-content');
        contents.forEach(el => el.style.fontSize = `${promptFontSize}px`);
    };

    // --- 2. TẢI ĐỀ TỪ FIREBASE (FULLTEST_BANK) ---
    async function loadQuestions() {
        try {
            const querySnapshot = await getDocs(collection(db, "fulltest_bank"));
            questionsData = [];
            querySnapshot.forEach((doc) => {
                questionsData.push({ id: doc.id, ...doc.data() });
            });

            if (questionsData.length === 0) {
                document.getElementById('prompt-content').innerHTML = `<div class="text-center py-10 text-gray-400">Kho đề trống.</div>`;
                return;
            }
            randomizeQuestion();
        } catch (e) {
            console.error("Lỗi:", e);
            showPopup("Lỗi Kết Nối", "Không thể tải đề thi: " + e.message, "error");
        }
    }

    // --- 3. HIỂN THỊ ĐỀ (GIAO DIỆN HỘP GIẤY) ---
    window.randomizeQuestion = () => {
        if (!questionsData || questionsData.length === 0) return;
        const q = questionsData[Math.floor(Math.random() * questionsData.length)];
        window.currentExamData = q;

        document.getElementById('exam-code').innerText = `MÃ: ${q.id.slice(0, 6).toUpperCase()}`;
        document.getElementById('student-essay').value = "";
        
        // Reset Highlight
        setupHighlightEvent();
        
        // Render nội dung trong các Hộp Giấy (Passage Box)
        const htmlContent = `
            <div id="reading-passage" class="relative pb-10">
                
                <div class="passage-box">
                    <span class="section-badge bg-blue-100 text-blue-700">I. ĐỌC HIỂU (4.0 điểm)</span>
                    
                    <div class="exam-content highlight-text mt-3" id="text-content">
                        ${q.reading_text || "Đang cập nhật..."}
                    </div>
                    
                    <div class="mt-6 space-y-3">
                        ${(q.reading_questions || []).map((txt, idx) => `
                            <div class="question-box">
                                <span class="font-bold text-blue-600 block mb-1 text-sm uppercase">
                                    Câu ${idx + 1} (${idx < 2 ? '0.5' : '1.0'}đ)
                                </span>
                                <div class="text-gray-800 text-sm font-medium leading-relaxed">${txt}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="mt-8">
                    <span class="section-badge bg-orange-100 text-orange-700 mb-4 block text-center">II. LÀM VĂN (6.0 điểm)</span>
                    
                    <div class="passage-box">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold uppercase">Câu 1 (2.0đ)</span>
                            <span class="text-xs font-bold text-gray-400 uppercase">Nghị luận xã hội</span>
                        </div>
                        <div class="exam-content font-bold text-gray-800">
                            "${q.nlxh_topic}"
                        </div>
                    </div>

                    <div class="passage-box">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs font-bold uppercase">Câu 2 (4.0đ)</span>
                            <span class="text-xs font-bold text-gray-400 uppercase">Nghị luận văn học</span>
                        </div>
                        <div class="exam-content">
                            ${q.nlvh_topic}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('prompt-content').innerHTML = htmlContent;
        
        // Đồng bộ cỡ chữ
        promptFontSize = 17;
        document.querySelector('.prompt-body').style.fontSize = `17px`;
        const contents = document.querySelectorAll('.exam-content');
        contents.forEach(el => el.style.fontSize = `17px`);
        
        setTimeout(setupHighlightEvent, 100);
    };

    // --- 4. TÍNH NĂNG HIGHLIGHT ---
    function setupHighlightEvent() {
        const container = document.getElementById('reading-passage');
        const menu = document.getElementById('highlight-menu');
        if(!container || !menu) return;

        container.onmouseup = () => {
            const selection = window.getSelection();
            if (selection.toString().trim().length > 0 && container.contains(selection.anchorNode)) {
                const rect = selection.getRangeAt(0).getBoundingClientRect();
                menu.style.top = `${rect.top - 50}px`;
                menu.style.left = `${rect.left + rect.width/2 - 60}px`;
                menu.style.display = 'flex';
            } else {
                menu.style.display = 'none';
            }
        };
        
        document.onmousedown = (e) => {
            if(!menu.contains(e.target) && !container.contains(e.target)) menu.style.display = 'none';
        };
    }

    window.applyHighlight = (cls) => {
        const sel = window.getSelection();
        if(!sel.rangeCount) return;
        try {
            const span = document.createElement('span');
            span.className = cls;
            sel.getRangeAt(0).surroundContents(span);
            sel.removeAllRanges();
            document.getElementById('highlight-menu').style.display = 'none';
        } catch(e) { showPopup("Chú ý", "Vui lòng không tô đè lên vùng đã tô!", "warning"); }
    };

    window.removeHighlight = () => {
        document.execCommand('removeFormat');
        document.getElementById('highlight-menu').style.display = 'none';
    };

    // --- 5. AI CHẤM ĐIỂM (THANG 4-6) ---
    window.handleAISubmission = async () => {
        const content = document.getElementById('student-essay').value.trim();
        if(content.length < 50) { 
            document.getElementById('short-essay-popup').style.display = 'flex'; 
            return; 
        }

        const loading = document.getElementById('loading-overlay');
        loading.style.display = 'flex';

        const q = window.currentExamData;
        
        const systemPrompt = `
        BẠN LÀ: Chuyên gia Ngữ văn K12 - Giám khảo chấm thi tốt nghiệp THPT cấp Quốc gia (Chương trình GDPT 2018).
        THÁI ĐỘ: Nghiêm túc, tỉ mỉ, ngôn ngữ phê bình sắc sảo, học thuật. Đánh giá thẳng thắn, không dùng từ ngữ suông.

        NHIỆM VỤ: Chấm bài thi Tổng hợp dựa trên cấu trúc điểm mới:
        1. PHẦN I: ĐỌC HIỂU (4.0 điểm)
        - Câu 1, 2: 0.5đ/câu (Nhận biết/Thông hiểu cơ bản).
        - Câu 3, 4, 5: 1.0đ/câu (Thông hiểu sâu/Vận dụng).
        2. PHẦN II: LÀM VĂN (6.0 điểm)
        - Câu 1: 2.0 điểm (Yêu cầu viết Đoạn văn hoặc Bài văn ngắn tùy theo đề).
        - Câu 2: 4.0 điểm (Yêu cầu viết Bài văn nghị luận tùy theo đề).
        *LƯU Ý: AI phải tự đọc yêu cầu đề bài để xác định NLXH hay NLVH là phần 2đ hay 4đ. Không mặc định dung lượng.*

        QUY TRÌNH CHẤM BẮT BUỘC:

        1. KIỂM TRA ĐỘ TRUNG THỰC (AI DETECTION):
        - Phân tích văn phong: Phát hiện các lỗi văn máy (dùng từ nối "tóm lại", "nhìn chung" quá nhiều, liệt kê ý khô khan, thiếu cá tính văn chương).
        - Đánh giá human_score (0-100): Điểm cao cho bài có tư duy độc lập, sáng tạo.

        2. CHẤM ĐIỂM CHUYÊN MÔN:
        - Đọc hiểu: Soi kỹ độ chính xác của các khái niệm nghệ thuật, kiến thức Tiếng Việt.
        - Làm văn: 
            + NLXH: Kiểm tra thao tác lập luận, tính thời sự của dẫn chứng và chiều sâu bài học.
            + NLVH: Kiểm tra việc khai thác đặc trưng thể loại (Thơ: vần nhịp, hình ảnh; Truyện: cốt truyện, nhân vật, điểm nhìn). 
            + Đáp ứng đúng yêu cầu về kiểu bài (đoạn văn hay bài văn).

        3. SỬA BÀI CHI TIẾT (HTML FORMAT):
        - Sử dụng <span class="text-bad"> cho lỗi sai/diễn đạt kém.
        - Sử dụng <span class="text-fix"> cho câu văn đề xuất chỉnh sửa ngay bên cạnh lỗi.
        - Sử dụng <span class="text-good"> cho ý văn hay, sáng tạo.

        YÊU CẦU TRẢ VỀ JSON DUY NHẤT (KHÔNG MARKDOWN):
        {
        "human_score": (int 0-100),
        "ai_comment": "Nhận xét về độ tự nhiên của văn phong.",
        "score": (float, thang 10, làm tròn đến 0.25),
        "detailed_scores": {
            "reading": "x/4.0 (Câu 1,2 mỗi câu 0.5; Câu 3,4,5 mỗi câu 1.0)",
            "writing_c1": "x/2.0 (Câu 1 phần Làm văn)",
            "writing_c2": "x/4.0 (Câu 2 phần Làm văn)"
        },
        "correction_html": "HTML bài làm đã highlight lỗi và ý hay. Xuống dòng dùng <br>.",
        "idea_feedback": ["Ưu điểm chuyên môn 1", "Ưu điểm chuyên môn 2"],
        "missing_points": ["Lỗi cần khắc phục 1", "Lỗi cần khắc phục 2"],
        "orientation": "Định hướng tư duy để học sinh tiến bộ ở các bài viết sau."
        }

        DỮ LIỆU ĐỀ BÀI:
        - Đọc hiểu: ${q.reading_text}
        - Câu hỏi Đọc hiểu: ${q.reading_questions}
        - Đề Làm văn Câu 1: ${q.nlxh_topic}
        - Đề Làm văn Câu 2: ${q.nlvh_topic}

        BÀI LÀM CỦA HỌC SINH:
        ${content}
        `;

        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] })
            });
            const data = await res.json();
            const text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
            const result = JSON.parse(text);

            // Render
            document.getElementById('input-section').classList.add('hidden');
            const out = document.getElementById('output-section');
            out.classList.remove('hidden', 'h-0', 'overflow-hidden', 'border-none');
            out.classList.add('h-full');

            const barColor = result.human_score > 75 ? '#22c55e' : (result.human_score > 50 ? '#f59e0b' : '#ef4444');

            document.getElementById('ai-correction-box').innerHTML = `
                <div class="max-w-3xl mx-auto pb-10">
                    <div class="text-center mb-6">
                        <div class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-2">TỔNG ĐIỂM</div>
                        <div class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-600 mb-2">${result.score}</div>
                    </div>

                    <div class="grid grid-cols-3 gap-3 mb-6 text-center">
                        <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                            <div class="text-[10px] text-blue-500 font-bold uppercase">Đọc hiểu</div>
                            <div class="text-xl font-black text-blue-700">${result.detailed_scores.reading}</div>
                        </div>
                        <div class="bg-green-50 p-3 rounded-xl border border-green-100">
                            <div class="text-[10px] text-green-500 font-bold uppercase">NLXH</div>
                            <div class="text-xl font-black text-green-700">${result.detailed_scores.nlxh}</div>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-xl border border-purple-100">
                            <div class="text-[10px] text-purple-500 font-bold uppercase">NLVH</div>
                            <div class="text-xl font-black text-purple-700">${result.detailed_scores.nlvh}</div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold uppercase text-gray-400">Độ chân thực</span>
                            <span class="font-bold text-lg" style="color:${barColor}">${result.human_score}%</span>
                        </div>
                        <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                            <div style="width:${result.human_score}%; background:${barColor}" class="h-full rounded-full"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 italic">"${result.ai_comment}"</p>
                    </div>

                    <div class="bg-white p-8 rounded-3xl border border-gray-100 shadow-sm">
                        <h4 class="font-black text-gray-800 border-b pb-4 mb-6 text-lg">CHI TIẾT BÀI SỬA</h4>
                        <div class="leading-loose text-gray-700 font-serif text-lg space-y-4 text-justify">
                            ${result.correction_html}
                        </div>
                        <div class="mt-6 pt-4 border-t text-sm italic text-gray-500 text-center">"${result.general_comment}"</div>
                    </div>
                </div>
            `;

            // Lưu Firebase
            if (auth.currentUser) {
                await addDoc(collection(db, "activities"), {
                    uid: auth.currentUser.uid,
                    type: "fulltest",
                    score: result.score,
                    timestamp: serverTimestamp(),
                    examId: window.currentExamData.id
                });
            }

        } catch(e) {
            console.error(e);
            showPopup("Lỗi Hệ Thống", "AI đang quá tải, vui lòng thử lại sau.", "error");
        } finally {
            loading.style.display = 'none';
        }
    }

    window.resetExam = () => {
        document.getElementById('input-section').classList.remove('hidden');
        document.getElementById('output-section').classList.add('hidden', 'h-0', 'overflow-hidden');
        document.getElementById('output-section').classList.remove('h-full');
    };

    // --- UPLOAD, TIMER ---
    let timeLeft = 7200; 
    function startTimer() {
        setInterval(() => {
            if(timeLeft > 0) {
                timeLeft--;
                const m = Math.floor(timeLeft / 60);
                const s = timeLeft % 60;
                const txt = `${Math.floor(m/60)}:${(m%60).toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                if(document.getElementById('timer')) document.getElementById('timer').innerText = txt;
                if(document.getElementById('timer-mobile')) document.getElementById('timer-mobile').innerText = txt;
            } else if (timeLeft === 0) {
                timeLeft = -1; // Stop repeating alert
                showPopup("Hết Giờ!", "Đã hết thời gian làm bài. Vui lòng nộp bài.", "warning");
            }
        }, 1000);
    }

    onAuthStateChanged(auth, u => {
        if(u) { startTimer(); loadQuestions(); } 
        else window.location.href="../log.html";
    });

    document.getElementById('file-upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        if(file.name.endsWith('.docx')) {
            reader.onload = (ev) => mammoth.extractRawText({arrayBuffer: ev.target.result}).then(r => document.getElementById('student-essay').value = r.value);
            reader.readAsArrayBuffer(file);
        } else {
            showPopup("Lỗi Định Dạng", "Chỉ hỗ trợ file Word (.docx)", "error");
        }
    });

    document.getElementById('student-essay').oninput = function() {
        const c = this.value.trim().split(/\s+/).filter(x => x).length;
        document.getElementById('word-count').innerText = `${c} TỪ`;
    };

</script>
</body>
</html>