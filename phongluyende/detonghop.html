<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HopVan - Luyện Đề Tổng Hợp</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FF8F50">
    <link rel="apple-touch-icon" href="../LOGO.WEBP">

    <meta property="og:title" content="HOPVAN - Nền Tảng Học & Luyện Thi Ngữ Văn" />
    <meta property="og:description" content="Nền tảng học tập Ngữ Văn tích hợp AI – hỗ trợ tự học thông minh." />
    <meta property="og:image" content="https://hopvan.netlify.app/panel.webp" />
    <meta property="og:url" content="https://hopvan.netlify.app" />
    <meta property="og:type" content="article" />

    <link rel="icon" type="image/webp" href="../LOGO.WEBP" />

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <style>
        :root {
            --primary: #FF8F50;
            --primary-gradient: linear-gradient(135deg, #FF8F50, #FF5E62);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --sidebar-width: 280px;
        }

        * { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            background-color: #FFF5EC; 
            height: 100vh; 
            overflow: hidden; 
            position: relative;
        }

        /* --- BACKGROUND --- */
        .background-blobs { position: fixed; inset: 0; z-index: -1; pointer-events: none; }
        .blob { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5; animation: floatBlob 10s infinite alternate; }
        .blob-1 { width: 600px; height: 600px; background: #FCA96A; top: -150px; left: -150px; }
        .blob-2 { width: 500px; height: 500px; background: #FCD5B5; bottom: -100px; right: -100px; }
        @keyframes floatBlob { 0% { transform: translate(0, 0); } 100% { transform: translate(40px, 60px); } }

        /* --- LAYOUT CHÍNH (Đã fix lỗi hở sườn PC) --- */
        .dashboard-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* PC: Menu cố định bên trái */
        #menu-placeholder {
            position: fixed;
            top: 0; left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            z-index: 50;
        }

        /* PC: Nội dung tràn màn hình nhưng padding trái để né menu */
        .main-content {
            width: 100%;
            height: 100vh;
            background: var(--glass-bg);
            backdrop-filter: blur(35px); -webkit-backdrop-filter: blur(35px);
            
            margin-left: 0;
            padding-top: 40px;
            padding-bottom: 40px;
            padding-right: 40px;
            /* Padding này giúp nội dung không bị menu che mất trên PC */
            padding-left: calc(var(--sidebar-width) + 40px);
            
            overflow-y: auto;
            position: relative;
            -webkit-overflow-scrolling: touch;
            border-left: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* --- MOBILE HEADER & OVERLAY --- */
        .mobile-header {
            display: none; position: fixed; top: 0; left: 0; right: 0;
            height: 70px; background: white; z-index: 100;
            align-items: center; padding: 0 20px; border-bottom: 1px solid #f0f0f0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.03);
        }
        #sidebar-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(4px);
            z-index: 998;
        }

        /* --- EXAM STYLES --- */
        .prompt-card {
            background: white; border-radius: 30px; padding: 0; 
            border: 1px solid rgba(255, 143, 80, 0.2);
            box-shadow: 0 15px 35px rgba(255, 143, 80, 0.05);
            position: relative; overflow: hidden;
            display: flex; flex-direction: column;
            height: 100%;
        }
        .prompt-header {
            background: var(--primary-gradient); color: white;
            padding: 15px 25px; display: flex; justify-content: space-between; align-items: center;
        }
        .prompt-body { padding: 25px; overflow-y: auto; flex: 1; }
        
        .exam-section { margin-bottom: 25px; border-bottom: 2px dashed #ffe4d6; padding-bottom: 20px; }
        .exam-section:last-child { border-bottom: none; }
        .section-label { font-weight: 900; color: #ea580c; text-transform: uppercase; margin-bottom: 10px; display: block; font-size: 1.1rem; }
        .question-text { color: #374151; line-height: 1.8; font-size: 0.95rem; }
        .highlight-text { background: #fff7ed; padding: 15px; border-left: 4px solid #FF8F50; border-radius: 8px; margin: 10px 0; font-style: italic; color: #431407; white-space: pre-wrap; line-height: 1.8;}

        .workspace-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; height: calc(100vh - 140px); margin-top: 20px; }

        .editor-container {
            background: white; border-radius: 30px; border: 1px solid rgba(0,0,0,0.05);
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.02); transition: 0.3s;
        }
        .editor-container:focus-within { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 20px 50px rgba(255, 143, 80, 0.15); }

        .writing-area { 
            flex: 1; width: 100%; padding: 30px; border: none; outline: none; resize: none; 
            font-size: 1.1rem; line-height: 1.9; color: #2D3436; background: transparent;
        }

        /* AI Result */
        .ai-result-view { padding: 30px; font-size: 1.1rem; line-height: 1.9; overflow-y: auto; background-color: #fafafa; }
        
        .ai-meter-box {
            background: #fff; padding: 20px; border-radius: 20px; margin-bottom: 25px;
            border: 1px solid #f0f0f0; box-shadow: 0 5px 15px rgba(0,0,0,0.03);
            display: flex; align-items: center; justify-content: space-between;
        }
        .meter-label { font-weight: 800; color: #2d3436; font-size: 0.9rem; text-transform: uppercase; }
        .meter-score { font-weight: 900; font-size: 1.2rem; }

        .text-good { color: #10B981; background: #ECFDF5; font-weight: 600; padding: 2px 4px; border-radius: 6px; }
        .text-bad { color: #EF4444; background: #FEF2F2; text-decoration: line-through; padding: 2px 4px; border-radius: 6px; }
        .text-fix { color: #3B82F6; font-weight: 700; font-style: italic; }

        /* Loading Overlay */
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); z-index: 20000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .loader-robot { font-size: 4rem; color: var(--primary); animation: robotBounce 1s infinite alternate; }
        @keyframes robotBounce { from { transform: translateY(0); } to { transform: translateY(-20px); } }

        /* --- POPUP MODAL CHUNG --- */
        .custom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 20001; justify-content: center; align-items: center; animation: fadeIn 0.2s ease; }
        .modal-box { background: white; padding: 35px; border-radius: 30px; text-align: center; width: 90%; max-width: 400px; box-shadow: 0 25px 60px rgba(0,0,0,0.2); transform: scale(0.9); animation: zoomIn 0.2s ease forwards; border: 1px solid rgba(255,255,255,0.9); }
        .modal-icon { width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 20px; }
        
        .modal-box h3 { margin-bottom: 10px; font-weight: 800; font-size: 1.5rem; }
        .modal-box p { margin-bottom: 25px; font-size: 1rem; line-height: 1.6; color: #666; }
        .modal-actions { display: flex; gap: 12px; }
        .modal-btn { flex: 1; padding: 14px; border-radius: 15px; border: none; font-weight: 800; cursor: pointer; transition: 0.2s; font-size: 0.95rem; }
        
        /* Styles */
        .error-style .modal-icon { background: #FEF2F2; color: #EF4444; }
        .error-style h3 { color: #DC2626; }
        .btn-cancel { background: #F3F4F6; color: #4B5563; }
        .btn-action-red { background: #EF4444; color: white; box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3); }
        
        .warning-style .modal-icon { background: #FFFBEB; color: #F59E0B; }
        .warning-style h3 { color: #D97706; }
        .btn-action-yellow { background: #F59E0B; color: white; box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- MOBILE RESPONSIVE (ĐÃ FIX LỖI MENU) --- */
        @media (max-width: 1024px) {
            .mobile-header { display: flex; }
            #sidebar-overlay.active { display: block; }

            /* QUAN TRỌNG: Không ẩn #menu-placeholder hoàn toàn */
            /* Ta dùng visibility hidden hoặc size 0 để nó vẫn render trong DOM */
            #menu-placeholder { 
                display: block !important; 
                position: absolute; /* Thoát khỏi dòng chảy layout */
                width: 0; 
                height: 0;
                overflow: visible; /* Để menu con trượt ra ngoài được */
                z-index: 9999;
            }
            
            /* Sidebar thật (được load vào placeholder) */
            /* Chúng ta cần CSS này để ghi đè style mặc định nếu cần */
            aside {
                position: fixed !important; 
                left: 0 !important; top: 0 !important; bottom: 0 !important;
                transform: translateX(-100%); 
                z-index: 9999 !important; 
                width: 280px !important; 
                background: white !important;
                transition: transform 0.3s ease-in-out !important;
                box-shadow: none;
                height: 100vh !important;
            }
            aside.open { 
                transform: translateX(0) !important;
                box-shadow: 10px 0 50px rgba(0,0,0,0.15) !important;
            }

            .main-content { 
                margin-left: 0 !important; 
                width: 100% !important; 
                padding: 90px 20px 40px !important; 
                padding-left: 20px !important; /* Reset padding trái về chuẩn mobile */
                height: auto; 
                border-left: none;
            }
            
            .workspace-grid { 
                grid-template-columns: 1fr; 
                height: auto; 
                display: flex;
                flex-direction: column;
                gap: 30px;
            }

            .prompt-card { height: 500px; min-height: 400px; }
            .editor-container { height: 500px; }
            #output-section { height: auto; }

            .user-avatar, #timer { display: none; }
        }
    </style>
</head>
<body>

    <div class="background-blobs"><div class="blob blob-1"></div><div class="blob blob-2"></div></div>

    <div class="mobile-header lg:hidden">
        <button onclick="toggleSidebar()" class="text-orange-500 text-2xl mr-4 focus:outline-none">
            <i class="fas fa-bars"></i>
        </button>
        <div class="flex items-center gap-2">
            <img src="../LOGO.WEBP" alt="Logo" class="w-8 h-8">
            <span class="font-black text-orange-500 text-lg">HOPVAN</span>
        </div>
        <div class="ml-auto bg-black text-white px-4 py-1.5 rounded-lg font-bold text-sm">
            <span id="timer-mobile">120:00</span>
        </div>
    </div>

    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="loading-overlay" id="loading-overlay">
        <div class="loader-robot"><i class="fas fa-robot"></i></div>
        <h3 class="text-2xl font-black mt-6 bg-gradient-to-r from-orange-500 to-red-600 bg-clip-text text-transparent">AI ĐANG CHẤM BÀI...</h3>
        <p class="text-gray-500 mt-2 font-medium">Chờ chút nhé, giáo viên AI đang đọc bài văn của bạn</p>
    </div>

    <div id="ai-error-popup" class="custom-modal">
        <div class="modal-box error-style">
            <div class="modal-icon"><i class="fas fa-exclamation-circle"></i></div>
            <h3>AI Hiện Đang Quá Tải</h3>
            <p>Hệ thống đang tiếp nhận quá nhiều yêu cầu cùng lúc. Vui lòng thử lại sau giây lát.</p>
            <div class="modal-actions">
                <button id="btn-ai-cancel" class="modal-btn btn-cancel">Hủy bỏ</button>
                <button id="btn-ai-retry" class="modal-btn btn-action-red">Thử lại ngay</button>
            </div>
        </div>
    </div>

    <div id="short-essay-popup" class="custom-modal">
        <div class="modal-box warning-style">
            <div class="modal-icon"><i class="fas fa-pen-nib"></i></div>
            <h3>Bài Viết Quá Ngắn</h3>
            <p>Bài thi tổng hợp cần ít nhất <strong>100 từ</strong> để AI có thể phân tích chính xác. Hãy viết thêm chút nữa nhé!</p>
            <div class="modal-actions">
                <button id="btn-short-close" class="modal-btn btn-action-yellow w-full">Đã hiểu, viết tiếp</button>
            </div>
        </div>
    </div>

    <div class="dashboard-container">
        <div id="menu-placeholder"></div>

        <main class="main-content">
            <div class="flex justify-between items-center mb-8 flex-wrap gap-4 hidden lg:flex">
                <div class="flex items-center gap-5">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-black text-gray-800 tracking-tight">Luyện Đề Tổng Hợp</h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                            <p class="text-sm text-gray-500 font-bold uppercase tracking-widest">Trạng thái: Sẵn sàng</p>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-end">
                    <button onclick="randomizeQuestion()" class="bg-white px-5 py-3 rounded-2xl font-bold text-gray-500 hover:text-orange-600 hover:bg-orange-50 transition-all shadow-sm border border-gray-100 flex items-center gap-2 text-sm md:text-base">
                        <i class="fas fa-sync-alt text-orange-400"></i> Đổi đề khác
                    </button>
                    <div class="bg-black text-white px-6 py-3 rounded-2xl font-black flex items-center gap-3 shadow-xl">
                        <i class="fas fa-clock text-orange-400"></i> <span id="timer" class="text-xl">120:00</span>
                    </div>
                    <div class="user-avatar" id="avatar-initial" style="width: 55px; height: 55px; background: var(--primary-gradient); border-radius: 18px; display: flex; justify-content: center; align-items: center; color: white; font-weight: 800; font-size: 1.4rem; box-shadow: 0 8px 20px rgba(255, 143, 80, 0.3); transform: rotate(-5deg);"></div>
                </div>
            </div>

            <div class="workspace-grid">
                <div class="prompt-card">
                    <div class="prompt-header">
                        <div class="font-bold uppercase tracking-widest text-sm"><i class="fas fa-file-alt mr-2"></i> Đề thi chính thức</div>
                        <span id="exam-code" class="bg-white/20 px-3 py-1 rounded text-xs font-bold">Mã đề: ...</span>
                    </div>
                    <div class="prompt-body" id="prompt-content">
                        <div class="animate-pulse space-y-4">
                            <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                            <div class="h-4 bg-gray-200 rounded"></div>
                            <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col h-full gap-4 relative">
                    <div id="input-section" class="editor-container h-full transition-all duration-500 min-h-[400px]">
                        <div class="px-6 py-4 bg-gray-50/50 border-b flex justify-between items-center flex-wrap gap-3">
                            <div class="flex items-center gap-3 w-full md:w-auto">
                                <span class="font-black text-xs text-gray-400 uppercase tracking-widest">Bài làm</span>
                                <button onclick="document.getElementById('file-upload').click()" class="flex items-center gap-2 px-3 py-1.5 bg-white border border-gray-200 rounded-lg text-xs font-bold text-gray-600 hover:text-orange-500 hover:border-orange-200 transition shadow-sm">
                                    <i class="fas fa-paperclip"></i> Tải tệp (.docx)
                                </button>
                                <input type="file" id="file-upload" class="hidden" accept=".txt, .docx">
                            </div>
                            <span id="word-count" class="text-xs font-black bg-gray-200 text-gray-600 px-3 py-1 rounded-lg ml-auto">0 TỪ</span>
                        </div>
                        <textarea id="student-essay" class="writing-area" placeholder="Hãy bắt đầu bài viết của bạn tại đây..."></textarea>
                    </div>

                    <div id="output-section" class="editor-container h-auto min-h-[100px] transition-all duration-500">
                        <div class="px-8 py-4 bg-gray-50/50 border-b flex justify-between items-center">
                            <span class="font-black text-xs text-gray-400 uppercase tracking-widest">Phản hồi từ AI</span>
                            <button id="submit-btn" class="bg-gradient-to-r from-orange-500 to-red-600 text-white px-8 py-2.5 rounded-xl font-black text-sm hover:scale-105 transition shadow-lg active:scale-95">NỘP BÀI</button>
                        </div>
                        
                        <div id="ai-correction-box" class="ai-result-view text-gray-400 flex flex-col items-center justify-center text-center p-6 h-full">
                            <div>
                                <i class="fas fa-robot text-5xl mb-4 opacity-20"></i>
                                <p class="font-bold">Sẵn sàng chấm bài</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="overall-feedback-box" class="mt-10 pb-20 hidden">
                <div class="bg-white rounded-3xl p-8 border border-orange-100 shadow-lg">
                    <h3 class="text-2xl font-black text-gray-800 mb-6 flex items-center gap-3">
                        <i class="fas fa-chart-pie text-orange-500"></i> Kết quả chi tiết
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <h4 class="font-bold text-green-600 uppercase text-sm border-b pb-2">Điểm mạnh</h4>
                            <ul id="idea-list" class="space-y-2 text-gray-700 text-sm list-disc pl-5"></ul>
                        </div>
                        <div class="space-y-4">
                            <h4 class="font-bold text-red-500 uppercase text-sm border-b pb-2">Cần cải thiện</h4>
                            <ul id="missing-list" class="space-y-2 text-gray-700 text-sm list-disc pl-5"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    // THÊM: getDocs, collection để lấy dữ liệu Full Test
    import { getFirestore, collection, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAJ9C2biYeiLPmhakzLZ4mEqfO9_VgPSZE", authDomain: "hopvan-9a648.firebaseapp.com", projectId: "hopvan-9a648", storageBucket: "hopvan-9a648.appspot.com", messagingSenderId: "429347196227", appId: "1:429347196227:web:917b8d019f0efd0f7833f6", measurementId: "G-1BG8PSRG0R" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const API_URL = `/.netlify/functions/gemini-proxy`;
    let questionsData = []; // Lưu danh sách các đề full
    window.currentExamData = null; // Đề đang làm

    // --- SIDEBAR TOGGLE (GIỮ NGUYÊN) ---
    window.toggleSidebar = () => {
        const sidebar = document.querySelector('aside') || document.getElementById('main-sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        if (sidebar && overlay) {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
            if (sidebar.classList.contains('open')) document.body.style.overflow = 'hidden';
            else document.body.style.overflow = 'auto';
        }
    };

    // --- TIMER 120 PHÚT (GIỮ NGUYÊN) ---
    let timeLeft = 7200; 
    const timerElement = document.getElementById('timer');
    const timerMobile = document.getElementById('timer-mobile');

    function startTimer() {
        const countdown = setInterval(() => {
            if (timeLeft <= 0) {
                clearInterval(countdown);
                if(timerElement) timerElement.innerText = "00:00:00";
                if(timerMobile) timerMobile.innerText = "00:00:00";
                alert("Hết giờ làm bài!");
            } else {
                timeLeft--;
                let h = Math.floor(timeLeft / 3600);
                let m = Math.floor((timeLeft % 3600) / 60);
                let s = timeLeft % 60;
                const timeString = `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                if(timerElement) timerElement.innerText = timeString;
                if(timerMobile) timerMobile.innerText = timeString;
            }
        }, 1000);
    }

    onAuthStateChanged(auth, (u) => {
        if (u) {
            const n = u.displayName || u.email;
            const avatar = document.getElementById('avatar-initial');
            if(avatar) avatar.innerText = n.charAt(0).toUpperCase();
            startTimer();
        } else { window.location.href = "../log.html"; }
    });

    // --- THAY ĐỔI: TẢI ĐỀ TỪ FIREBASE (FULLTEST_BANK) ---
    async function loadQuestions() {
        const promptBox = document.getElementById('prompt-content');
        try {
            // Trích xuất toàn bộ đề từ collection fulltest_bank
            const querySnapshot = await getDocs(collection(db, "fulltest_bank"));
            questionsData = [];
            querySnapshot.forEach((doc) => {
                questionsData.push({ id: doc.id, ...doc.data() });
            });

            if (questionsData.length === 0) {
                promptBox.innerHTML = `<p class="text-center py-10 text-gray-400">Kho đề trống. Vui lòng thêm đề ở trang Admin.</p>`;
                return;
            }
            randomizeQuestion(); // Hiển thị đề đầu tiên sau khi tải xong
        } catch (e) {
            console.error("Lỗi trích xuất Firebase:", e);
            promptBox.innerHTML = `<p class="text-red-500 text-center">Không thể kết nối kho đề: ${e.message}</p>`;
        }
    }

    window.randomizeQuestion = () => {
        if (!questionsData || questionsData.length === 0) return;
        
        // Lấy ngẫu nhiên 1 đề trong mảng đã tải về
        const q = questionsData[Math.floor(Math.random() * questionsData.length)];
        window.currentExamData = q;

        document.getElementById('exam-code').innerText = `Mã đề: ${q.id.slice(0, 6).toUpperCase()}`;
        
        // Xử lý mảng câu hỏi đọc hiểu
        const qArray = Array.isArray(q.reading_questions) ? q.reading_questions : (q.reading_questions ? q.reading_questions.split('\n') : []);

        const htmlContent = `
            <div class="exam-section animate-fade-in">
                <span class="section-label">I. ĐỌC HIỂU (3.0 điểm)</span>
                <div class="highlight-text text-sm whitespace-pre-wrap">${q.reading_text}</div>
                <ul class="list-decimal pl-5 space-y-2 mt-4 text-sm font-medium text-gray-700">
                    ${qArray.map(txt => `<li>${txt}</li>`).join('')}
                </ul>
            </div>
            <div class="exam-section">
                <span class="section-label">II. LÀM VĂN (7.0 điểm)</span>
                <div class="mb-6 p-4 bg-gray-50 rounded-2xl border-l-4 border-orange-400">
                    <p class="font-black text-gray-800 text-xs mb-2">CÂU 1 (2.0đ): NGHỊ LUẬN XÃ HỘI</p>
                    <p class="text-sm italic">"${q.nlxh_topic}"</p>
                </div>
                <div class="p-4 bg-gray-50 rounded-2xl border-l-4 border-red-400">
                    <p class="font-black text-gray-800 text-xs mb-2">CÂU 2 (5.0đ): NGHỊ LUẬN VĂN HỌC</p>
                    <p class="text-sm italic whitespace-pre-wrap">${q.nlvh_topic}</p>
                </div>
            </div>
        `;
        document.getElementById('prompt-content').innerHTML = htmlContent;
        document.getElementById('student-essay').value = ""; // Reset khung làm bài
    };

    // Tải đề ngay khi load trang
    loadQuestions();

    // --- UPLOAD FILE (GIỮ NGUYÊN) ---
    document.getElementById('file-upload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        const textarea = document.getElementById('student-essay');
        if (file.name.endsWith('.docx')) {
            reader.onload = function(event) {
                mammoth.extractRawText({arrayBuffer: event.target.result})
                    .then(result => { textarea.value = result.value; textarea.dispatchEvent(new Event('input')); })
                    .catch(err => alert("Lỗi đọc file: " + err.message));
            };
            reader.readAsArrayBuffer(file);
        } else if (file.name.endsWith('.txt')) {
            reader.onload = function(event) { textarea.value = event.target.result; textarea.dispatchEvent(new Event('input')); };
            reader.readAsText(file);
        }
    });

    // --- POPUP HANDLERS (GIỮ NGUYÊN) ---
    const errorPopup = document.getElementById('ai-error-popup');
    const shortEssayPopup = document.getElementById('short-essay-popup');
    
    function showAiError() {
        document.getElementById('loading-overlay').style.display = 'none';
        errorPopup.style.display = 'flex';
    }
    function hideAiError() { errorPopup.style.display = 'none'; }

    function showShortEssay() { shortEssayPopup.style.display = 'flex'; }
    function hideShortEssay() { shortEssayPopup.style.display = 'none'; }

    document.getElementById('btn-ai-cancel').addEventListener('click', hideAiError);
    document.getElementById('btn-ai-retry').addEventListener('click', () => { hideAiError(); handleAISubmission(); });
    document.getElementById('btn-short-close').addEventListener('click', hideShortEssay);

    // --- MAIN AI LOGIC (GIỮ NGUYÊN PROMPT & CẤU TRÚC) ---
    async function handleAISubmission() {
        const content = document.getElementById('student-essay').value.trim();
        // Kiểm tra bài ngắn (dưới 50 từ)
        if (content.split(/\s+/).length < 50) {
            showShortEssay();
            return;
        }

        const loading = document.getElementById('loading-overlay');
        loading.style.display = 'flex';

        const q = window.currentExamData;
        
        // Xử lý danh sách câu hỏi đọc hiểu cho Prompt
        const readingQsText = Array.isArray(q.reading_questions) ? q.reading_questions.join('; ') : q.reading_questions;

    const systemPrompt = `
            BẠN LÀ: Giám khảo chấm thi Tốt nghiệp THPT Quốc gia môn Ngữ Văn (có chuyên môn sâu về thẩm định văn phong).
            
            NHIỆM VỤ CỦA BẠN GỒM 2 BƯỚC:

            === BƯỚC 1: THẨM ĐỊNH ĐỘ TRUNG THỰC (AI DETECTION) ===
            Hãy phân tích kỹ văn phong của học sinh để phát hiện dấu hiệu của văn bản do AI tạo ra (như ChatGPT/Gemini):
            - Dấu hiệu AI: Cấu trúc câu quá hoàn hảo nhưng vô hồn, lặp lại các từ nối máy móc ("Tóm lại", "Hơn nữa", "Bên cạnh đó"), nội dung sáo rỗng, thiếu cảm xúc cá nhân và trải nghiệm thực tế.
            - Dấu hiệu Người thật: Có giọng văn riêng, có thể mắc lỗi diễn đạt nhỏ nhưng ý tứ sáng tạo, dẫn chứng đời sống phong phú, cảm xúc chân thật.
            => Đánh giá 'human_score' từ 0 (giống máy 100%) đến 100 (người thật 100%).

            === BƯỚC 2: CHẤM ĐIỂM CHUYÊN MÔN (THANG 10) ===
            Chấm chi tiết 3 phần dựa trên đề bài:
            1. Đọc hiểu (3.0đ): Kiểm tra độ chính xác của kiến thức tiếng Việt, khả năng thông hiểu văn bản.
            2. NLXH (2.0đ): Đánh giá lập luận, dẫn chứng thực tế và tư duy phản biện.
            3. NLVH (5.0đ): Đánh giá cảm thụ văn học, kỹ năng phân tích nghệ thuật và kiến thức tác phẩm.

            YÊU CẦU TRẢ VỀ JSON DUY NHẤT (Không thêm lời dẫn):
            {
              "human_score": (Số nguyên 0-100),
              "ai_comment": "Nhận xét ngắn gọn về độ tự nhiên của văn phong (VD: 'Văn phong quá máy móc, nghi vấn dùng AI' hoặc 'Giọng văn tự nhiên, giàu cảm xúc').",
              "score": (Tổng điểm trên thang 10, làm tròn 1 chữ số thập phân),
              "correction_html": "Tạo nội dung HTML sửa bài chi tiết. Sử dụng thẻ <span class='text-bad'>lỗi sai/diễn đạt kém</span> (kèm gợi ý sửa ngắn gọn trong ngoặc đơn), và thẻ <span class='text-good'>ý hay/sáng tạo</span> để làm nổi bật.",
              "idea_feedback": ["Điểm mạnh nổi bật 1", "Điểm mạnh nổi bật 2"],
              "missing_points": ["Hạn chế cần khắc phục 1", "Hạn chế cần khắc phục 2"]
            }

            --- THÔNG TIN ĐỀ BÀI ---
            1. Đọc hiểu: ${q.reading_text} - Câu hỏi: ${readingQsText}
            2. NLXH: ${q.nlxh_topic}
            3. NLVH: ${q.nlvh_topic}
            
            --- BÀI LÀM CỦA HỌC SINH ---
            ${content}
        `;

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] })
            });
            const data = await response.json();
            if (data.error) throw new Error(data.error.message || "Lỗi từ phía Google AI");
            if (!data.candidates || data.candidates.length === 0) throw new Error("AI không trả về kết quả.");

            const rawText = data.candidates[0].content.parts[0].text;
            const res = JSON.parse(rawText.replace(/```json|```/g, "").trim());

            // Ẩn Input, Hiện Output Full màn hình
            document.getElementById('input-section').classList.add('hidden');
            const outputSec = document.getElementById('output-section');
            outputSec.classList.remove('h-auto', 'min-h-[100px]');
            outputSec.classList.add('h-full');

            let barColor = res.human_score < 50 ? '#ef4444' : (res.human_score < 75 ? '#f59e0b' : '#22c55e');
            let verdictText = res.human_score < 50 ? "Nghi vấn AI" : (res.human_score < 75 ? "Hơi giống máy" : "Tự nhiên");

            const aiMeterHTML = `<div class="ai-meter-box"><div><div class="meter-label">Độ Chân Thực</div><div style="font-size: 0.8rem; color: #888;">${res.ai_comment}</div></div><div style="text-align: right;"><div class="meter-score" style="color: ${barColor}">${res.human_score}%</div><div style="font-size: 0.7rem; font-weight: 700; color: ${barColor}">${verdictText}</div></div></div><div style="width: 100%; height: 6px; background: #eee; border-radius: 10px; margin-bottom: 20px; overflow: hidden;"><div style="width: ${res.human_score}%; height: 100%; background: ${barColor}; border-radius: 10px;"></div></div><div style="margin-bottom: 20px; font-weight: 800; font-size: 1.2rem; color: var(--primary);">TỔNG ĐIỂM: ${res.score}/10</div>`;

            const box = document.getElementById('ai-correction-box');
            box.className = "ai-result-view h-full text-left text-gray-800 overflow-y-auto";
            box.innerHTML = aiMeterHTML + res.correction_html;

            document.getElementById('idea-list').innerHTML = res.idea_feedback.map(i => `<li>• ${i}</li>`).join('');
            document.getElementById('missing-list').innerHTML = res.missing_points.map(i => `<li>• ${i}</li>`).join('');
            document.getElementById('overall-feedback-box').classList.remove('hidden');

            if (auth.currentUser) {
                await addDoc(collection(db, "activities"), {
                    uid: auth.currentUser.uid,
                    action: `Hoàn thành Full Test (Mã ${q.id.slice(0,6)}) - ${res.score} điểm`,
                    type: "fulltest",
                    human_score: res.human_score,
                    score: res.score,
                    timestamp: serverTimestamp()
                });
            }
            loading.style.display = 'none';

        } catch (e) { 
            console.error("AI Error:", e); 
            showAiError(); // GỌI POPUP LỖI
        } 
    };

    document.getElementById('submit-btn').onclick = handleAISubmission;

    document.getElementById('student-essay').oninput = function() {
        const c = this.value.trim().split(/\s+/).filter(x => x).length;
        document.getElementById('word-count').innerText = `${c} TỪ`;
    };

    fetch('menu.html').then(r => r.text()).then(h => {
        const p = document.getElementById('menu-placeholder'); p.innerHTML = h;
        p.querySelectorAll('script').forEach(s => { const ns = document.createElement('script'); ns.text = s.text; document.body.appendChild(ns); });
    });
</script>
</body>
</html>