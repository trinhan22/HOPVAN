<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HopVan - Luyện Đề Đọc Hiểu</title>
    
    <meta property="og:title" content="HOPVAN - Nền Tảng Học & Luyện Thi Ngữ Văn" />
    <meta property="og:description" content="Nền tảng học tập Ngữ Văn tích hợp AI – hỗ trợ tự học thông minh." />
    <meta property="og:image" content="https://hopvan.netlify.app/panel.webp" />
    <meta property="og:url" content="https://hopvan.netlify.app" />
    <meta property="og:type" content="article" />

    <link rel="icon" type="image/webp" href="../LOGO.WEBP" />

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FF8F50">

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <style>
        :root {
            --primary: #FF8F50;
            --glass-bg: rgba(255, 255, 255, 0.95);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #FFF5EC; 
            height: 100vh; overflow: hidden; 
        }

        #menu-placeholder { display: none !important; }

        .main-content {
            width: 100%; height: 100vh;
            background: var(--glass-bg);
            padding: 20px 40px;
            display: flex; flex-direction: column;
        }

        .header-bar { flex-shrink: 0; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .workspace-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; flex: 1; overflow: hidden; padding-bottom: 20px; }

        /* --- CỘT TRÁI: ĐỀ BÀI (STYLE GIẤY THI) --- */
        .column-card {
            background: white; border-radius: 24px; 
            border: 1px solid rgba(255, 143, 80, 0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.03);
            display: flex; flex-direction: column; 
            height: 100%; overflow: hidden;
        }
        .card-header {
            padding: 16px 24px; background: #fff7ed; border-bottom: 1px solid #fed7aa;
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .prompt-body { 
            padding: 30px; overflow-y: auto; flex: 1; 
            background-color: #fffcf8; /* Nền giấy ngà */
            transition: font-size 0.2s ease;
        }

        /* KHUNG CHỨA NỘI DUNG (Passage Box) */
        .passage-box {
            background: white; padding: 24px; 
            border-radius: 16px; border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
            margin-bottom: 24px; position: relative;
        }
        
        /* TYPOGRAPHY CHUẨN VĂN HỌC (THIN) */
        .exam-content {
            font-family: 'Merriweather', serif;
            font-weight: 300; /* Chữ mảnh */
            font-size: 1.1rem; line-height: 2.0; /* Dãn dòng rộng */
            color: #1e293b; text-align: justify;
            white-space: pre-wrap;
        }

        .question-box {
            background: #f8fafc; padding: 16px; 
            border-radius: 12px; border: 1px solid #f1f5f9;
            margin-bottom: 12px;
        }

        /* --- CỘT PHẢI: BÀI LÀM --- */
        .writing-area { 
            width: 100%; height: 100%; padding: 24px; 
            border: none; outline: none; resize: none; 
            font-size: 1.1rem; line-height: 2.0; 
            color: #334155; background: transparent;
            font-family: 'Merriweather', serif;
            background-image: linear-gradient(#f1f5f9 1px, transparent 1px);
            background-size: 100% 2.2rem; background-attachment: local;
        }
        .footer-action {
            padding: 16px; border-top: 1px solid #f1f5f9; background: white; 
            display: flex; justify-content: flex-end; flex-shrink: 0;
        }
        .submit-btn {
            background: linear-gradient(135deg, #FF8F50, #FF5E62); color: white; 
            padding: 12px 32px; border-radius: 50px; font-weight: 800; 
            box-shadow: 0 4px 15px rgba(255, 143, 80, 0.3); transition: 0.2s;
        }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 143, 80, 0.4); }

        /* --- HIGHLIGHT TOOLTIP --- */
        ::selection { background: #fed7aa; color: #431407; }
        .highlight-yellow { background-color: #fef08a; border-bottom: 2px solid #facc15; }
        .highlight-green { background-color: #bbf7d0; border-bottom: 2px solid #4ade80; }
        .highlight-pink { background-color: #fbcfe8; border-bottom: 2px solid #f472b6; }
        #highlight-menu {
            position: absolute; display: none; background: white; 
            border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
            padding: 6px 10px; z-index: 1000; gap: 8px; border: 1px solid #f3f4f6;
            animation: popIn 0.15s ease;
        }
        .hl-btn { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .hl-btn:hover { transform: scale(1.2); }
        @keyframes popIn { from { transform: scale(0.5) translateY(10px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }

        /* --- POPUP STYLES (ĐỒNG BỘ) --- */
        .custom-modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4);
            backdrop-filter: blur(5px); z-index: 20000;
            justify-content: center; align-items: center; animation: fadeIn 0.2s;
        }
        .modal-box {
            background: white; padding: 30px; border-radius: 24px;
            width: 90%; max-width: 400px; text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.9); animation: zoomIn 0.2s forwards;
        }
        .modal-icon { font-size: 3rem; margin-bottom: 15px; }
        .modal-actions { margin-top: 25px; display: flex; gap: 10px; justify-content: center; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 12px; font-weight: 700; transition: 0.2s; }
        .popup-error .modal-icon { color: #ef4444; } .popup-error button { background: #ef4444; color: white; }
        .popup-warning .modal-icon { color: #f59e0b; } .popup-warning button { background: #f59e0b; color: white; }
        .popup-info .modal-icon { color: #3b82f6; } .popup-info button { background: #3b82f6; color: white; }

        /* --- LOADING --- */
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .loader-robot { font-size: 4rem; color: var(--primary); animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.9); } to { transform: scale(1); } }

        /* --- MOBILE --- */
        .mobile-header { display: none; position: fixed; top: 0; left: 0; right: 0; height: 70px; background: white; z-index: 100; align-items: center; padding: 0 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        @media (max-width: 1024px) {
            body { overflow: auto; height: auto; }
            .mobile-header { display: flex; }
            .header-bar { display: none; }
            .main-content { padding: 80px 16px 20px; height: auto; }
            .workspace-grid { display: flex; flex-direction: column; height: auto; }
            .column-card { height: 600px; }
        }

/* Tìm đoạn này hoặc thêm mới vào cuối thẻ <style> */
#output-section {
    flex: 1;
    min-height: 0; /* Quan trọng: Giúp flex child có thể cuộn */
    display: none; /* Mặc định ẩn */
}

#ai-correction-box {
    height: 100%;
    overflow-y: auto; /* Đảm bảo cho phép cuộn dọc */
}
    </style>
</head>
<body>

    <div id="highlight-menu">
        <button class="hl-btn bg-yellow-200" onclick="applyHighlight('highlight-yellow')" title="Vàng"></button>
        <button class="hl-btn bg-green-200" onclick="applyHighlight('highlight-green')" title="Xanh"></button>
        <button class="hl-btn bg-pink-200" onclick="applyHighlight('highlight-pink')" title="Hồng"></button>
        <button class="hl-btn bg-gray-100 text-gray-500 flex items-center justify-center" onclick="removeHighlight()" title="Xóa"><i class="fas fa-eraser text-xs"></i></button>
    </div>

    <div class="loading-overlay" id="loading-overlay">
        <div class="loader-robot"><i class="fas fa-robot"></i></div>
    </div>

    <div id="generic-popup" class="custom-modal">
        <div class="modal-box">
            <div id="popup-icon" class="modal-icon"><i class="fas fa-info-circle"></i></div>
            <h3 id="popup-title" class="font-bold text-xl mb-2 text-gray-800">Thông báo</h3>
            <p id="popup-message" class="text-gray-600">Nội dung thông báo...</p>
            <div class="modal-actions">
                <button onclick="closePopup()" class="modal-btn hover:opacity-90">Đã hiểu</button>
            </div>
        </div>
    </div>

    <div id="short-essay-popup" class="custom-modal">
        <div class="modal-box popup-warning">
            <div class="modal-icon"><i class="fas fa-pen-nib"></i></div>
            <h3 class="font-bold text-xl mb-2">Bài Quá Ngắn</h3>
            <p class="text-gray-600">Bài làm cần ít nhất <strong>50 từ</strong> để AI chấm chính xác. Hãy viết thêm chút nữa nhé!</p>
            <div class="modal-actions">
                <button onclick="document.getElementById('short-essay-popup').style.display='none'" class="modal-btn bg-orange-100 !text-white-600 hover:bg-orange-200">Viết tiếp</button>
            </div>
        </div>
    </div>

    <div class="mobile-header lg:hidden">
        <div class="flex items-center gap-2">
            <img src="../LOGO.WEBP" class="w-8 h-8">
            <span class="font-black text-orange-500 text-lg">HOPVAN</span>
        </div>
        <div class="ml-auto bg-gray-900 text-white px-3 py-1 rounded text-xs font-bold font-mono" id="timer-mobile">20:00</div>
    </div>

    <div class="dashboard-container">
        <div id="menu-placeholder"></div>

        <main class="main-content">
            <div class="header-bar hidden lg:flex">
                <div class="flex items-center gap-4">
                    <a href="../dashboard/phongluyende.html" class="w-10 h-10 rounded-xl bg-white border border-gray-200 flex items-center justify-center text-gray-500 hover:text-orange-500 transition shadow-sm">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <h2 class="text-2xl font-black text-gray-800">Luyện Đề Đọc Hiểu</h2>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="bg-white rounded-xl border border-gray-200 flex items-center p-1 shadow-sm">
                        <span class="text-xs font-bold text-gray-400 pl-3 pr-2 uppercase">Cỡ đề:</span>
                        <button onclick="adjustPromptSize(-1)" class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded text-gray-600"><i class="fas fa-minus text-xs"></i></button>
                        <span class="w-px h-4 bg-gray-200 mx-1"></span>
                        <button onclick="adjustPromptSize(1)" class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded text-gray-600"><i class="fas fa-plus text-xs"></i></button>
                    </div>

                    <button onclick="randomizeQuestion()" class="bg-white px-4 py-2 rounded-xl font-bold text-gray-600 hover:text-orange-600 border border-gray-200 text-sm shadow-sm flex gap-2 items-center">
                        <i class="fas fa-sync-alt"></i> Đổi đề
                    </button>
                    
                    <div class="bg-gray-900 text-white px-5 py-2 rounded-xl font-mono font-bold flex items-center gap-2 shadow-lg">
                        <i class="fas fa-clock text-orange-400"></i> <span id="timer">20:00</span>
                    </div>
                </div>
            </div>

            <div class="workspace-grid">
                
                <div class="column-card">
                    <div class="card-header">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-orange-600 uppercase text-xs tracking-widest bg-white px-3 py-1 rounded-full border border-orange-100">
                                <i class="fas fa-book-open mr-1"></i> Ngữ liệu đọc hiểu
                            </span>
                            <span class="text-[10px] text-gray-400 italic">(Bôi đen để Highlight)</span>
                        </div>
                        <span id="exam-code" class="text-xs font-bold text-gray-400">LOADING...</span>
                    </div>
                    
                    <div class="scrollable-content prompt-body" id="prompt-content">
                        <div class="animate-pulse space-y-4">
                            <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                            <div class="h-4 bg-gray-200 rounded w-full"></div>
                            <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                        </div>
                    </div>
                </div>

                <div class="column-card relative">
                    <div id="input-section" class="flex flex-col h-full">
                        <div class="card-header bg-white">
                            <span class="font-black text-xs text-gray-400 uppercase tracking-widest">BÀI LÀM CỦA BẠN</span>
                            <div class="flex gap-2">
                                <button onclick="document.getElementById('file-upload').click()" class="text-xs font-bold text-blue-500 bg-blue-50 px-3 py-1 rounded hover:bg-blue-100 transition">
                                    <i class="fas fa-paperclip mr-1"></i> File
                                </button>
                                <input type="file" id="file-upload" class="hidden" accept=".txt, .docx">
                                <span id="word-count" class="text-xs font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">0 TỪ</span>
                            </div>
                        </div>

                        <div class="flex-1 overflow-hidden relative">
                            <textarea id="student-essay" class="writing-area" 
                                placeholder="Trả lời các câu hỏi đọc hiểu tại đây..."></textarea>
                        </div>

                        <div class="footer-action">
                            <button onclick="handleAISubmission()" class="submit-btn flex items-center gap-2">
                                <span>NỘP BÀI</span> <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>

                    <div id="output-section" class="hidden h-full flex-col">
                        <div class="card-header bg-gray-900 border-none text-white">
                            <span class="font-bold text-sm uppercase"><i class="fas fa-robot mr-2 text-orange-400"></i>Kết quả chấm</span>
                            <button onclick="resetExam()" class="text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded transition">Làm lại</button>
                        </div>
                        <div id="ai-correction-box" class="ai-result-view"></div>
                    </div>
                </div>

            </div>
        </main>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CONFIG FIREBASE ---
    const firebaseConfig = { apiKey: "AIzaSyAJ9C2biYeiLPmhakzLZ4mEqfO9_VgPSZE", authDomain: "hopvan-9a648.firebaseapp.com", projectId: "hopvan-9a648", storageBucket: "hopvan-9a648.appspot.com", messagingSenderId: "429347196227", appId: "1:429347196227:web:917b8d019f0efd0f7833f6", measurementId: "G-1BG8PSRG0R" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const API_URL = `/.netlify/functions/gemini-proxy`;
    let questionsData = []; 
    window.currentExamData = null;

    // --- POPUP HANDLER ---
    window.showPopup = (title, message, type = 'info') => {
        const modal = document.getElementById('generic-popup');
        const box = modal.querySelector('.modal-box');
        const icon = document.getElementById('popup-icon');
        box.classList.remove('popup-error', 'popup-warning');
        document.getElementById('popup-title').innerText = title;
        document.getElementById('popup-message').innerText = message;
        if (type === 'error') { box.classList.add('popup-error'); icon.innerHTML = '<i class="fas fa-exclamation-circle"></i>'; }
        else if (type === 'warning') { box.classList.add('popup-warning'); icon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>'; }
        else { icon.innerHTML = '<i class="fas fa-info-circle"></i>'; }
        modal.style.display = 'flex';
    };
    window.closePopup = () => document.getElementById('generic-popup').style.display = 'none';

    // --- 1. CHỈNH CỠ CHỮ ---
    let promptFontSize = 17;
    window.adjustPromptSize = (amount) => {
        promptFontSize += amount;
        if(promptFontSize < 14) promptFontSize = 14;
        if(promptFontSize > 26) promptFontSize = 26;
        document.querySelector('.prompt-body').style.fontSize = `${promptFontSize}px`;
        const contents = document.querySelectorAll('.exam-content');
        contents.forEach(el => el.style.fontSize = `${promptFontSize}px`);
    };

    // --- 2. TẢI ĐỀ TỪ FIREBASE (READING_BANK) ---
    async function loadQuestions() {
        try {
            const querySnapshot = await getDocs(collection(db, "reading_bank"));
            questionsData = [];
            querySnapshot.forEach((doc) => {
                questionsData.push({ id: doc.id, ...doc.data() });
            });

            if (questionsData.length === 0) {
                document.getElementById('prompt-content').innerHTML = `<div class="text-center py-10 text-gray-400">Kho đề trống.</div>`;
                return;
            }
            randomizeQuestion();
        } catch (e) {
            console.error(e);
            showPopup("Lỗi", "Không thể kết nối dữ liệu!", "error");
        }
    }

    // --- 3. HIỂN THỊ ĐỀ ĐỌC HIỂU ---
    window.randomizeQuestion = () => {
        if (!questionsData || questionsData.length === 0) return;
        const q = questionsData[Math.floor(Math.random() * questionsData.length)];
        window.currentExamData = q;

        document.getElementById('exam-code').innerText = `MÃ: ${q.id.slice(0, 6).toUpperCase()}`;
        document.getElementById('student-essay').value = "";
        
        setupHighlightEvent();
        
        const htmlContent = `
            <div id="reading-passage" class="relative pb-10">
                <div class="mb-4">
                    <h3 class="font-bold text-lg text-gray-800 mb-2">${q.title || "Văn bản Đọc Hiểu"}</h3>
                    <div class="passage-box">
                        <div class="exam-content highlight-text" id="text-content">
                            ${q.text || "Đang cập nhật..."}
                        </div>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <h4 class="font-black text-gray-700 border-b pb-2 uppercase text-sm">Câu hỏi:</h4>
                    ${(q.questions || []).map((item, idx) => `
                        <div class="question-box">
                            <span class="font-black text-orange-500 block mb-2 text-sm uppercase">Câu ${idx + 1}</span>
                            <div class="text-gray-800 font-medium leading-relaxed">${item.q}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        document.getElementById('prompt-content').innerHTML = htmlContent;
        promptFontSize = 17;
        document.querySelector('.prompt-body').style.fontSize = `17px`;
        setTimeout(setupHighlightEvent, 100);
    };

    // --- 4. TÍNH NĂNG HIGHLIGHT ---
    function setupHighlightEvent() {
        const container = document.getElementById('reading-passage');
        const menu = document.getElementById('highlight-menu');
        if(!container || !menu) return;

        container.onmouseup = () => {
            const selection = window.getSelection();
            if (selection.toString().trim().length > 0 && container.contains(selection.anchorNode)) {
                const rect = selection.getRangeAt(0).getBoundingClientRect();
                menu.style.top = `${rect.top - 50}px`;
                menu.style.left = `${rect.left + rect.width/2 - 60}px`;
                menu.style.display = 'flex';
            } else { menu.style.display = 'none'; }
        };
        document.onmousedown = (e) => { if(!menu.contains(e.target) && !container.contains(e.target)) menu.style.display = 'none'; };
    }

    window.applyHighlight = (cls) => {
        const sel = window.getSelection();
        if(!sel.rangeCount) return;
        try {
            const color = cls === 'highlight-yellow' ? '#fef08a' : cls === 'highlight-green' ? '#bbf7d0' : '#fbcfe8';
            document.execCommand('backColor', false, color);
            sel.removeAllRanges();
            document.getElementById('highlight-menu').style.display = 'none';
        } catch(e) { showPopup("Chú ý", "Không thể tô đè vùng đã chọn!", "warning"); }
    };

    window.removeHighlight = () => { document.execCommand('removeFormat'); document.getElementById('highlight-menu').style.display = 'none'; };

// --- 5. AI CHẤM ĐIỂM (BẢN CHI TIẾT: CHECK AI + FIX FONT + NHẬN XÉT) ---
    window.handleAISubmission = async () => {
        const content = document.getElementById('student-essay').value.trim();
        if(content.length < 20) { 
            showPopup("Chú ý", "Câu trả lời quá ngắn, vui lòng viết chi tiết hơn để AI có thể chấm điểm chính xác!", "warning"); 
            return; 
        }

        const loading = document.getElementById('loading-overlay');
        loading.style.display = 'flex';

        const q = window.currentExamData;
        const qList = (q.questions || []).map(i => i.q).join("\n");
        
const systemPrompt = `
BẠN LÀ: Thành viên Hội đồng ra đề và chấm thi tốt nghiệp THPT Quốc gia - Chuyên gia cao cấp về kĩ năng giải mã ngữ liệu Đọc hiểu.
THÁI ĐỘ: Khắt khe, tỉ mỉ. Bạn coi trọng sự chính xác tuyệt đối trong thuật ngữ và kĩ năng suy luận logic.
NHIỆM VỤ: Chấm điểm ĐỌC HIỂU (Thang 4.0):
- Câu 1, 2 (0.5đ/câu): Sai thuật ngữ Tiếng Việt/Văn học = 0 điểm.
- Câu 3, 4, 5 (1.0đ/câu): Yêu cầu lí giải có chiều sâu, bám sát ngữ liệu, không diễn xuôi.

=== CHIẾN DỊCH TRUY QUÉT AI (RĂN ĐE CAO) ===
- AI Check: Phát hiện bài làm dùng ChatGPT để tóm tắt ý một cách trơn tru nhưng rỗng tuếch, liệt kê ý khô khan như mục lục.
- 'human_score' < 50% nếu câu trả lời quá "tròn trịa" một cách máy móc.

YÊU CẦU TRẢ VỀ JSON DUY NHẤT:
{
    "human_score": (int 0-100),
    "ai_comment": "Nhận xét đanh thép về tính trung thực.",
    "score": (float quy đổi thang 10 để đồng bộ hệ thống),
    "reading_score": "Tổng điểm trên 4.0 (Ghi rõ: Q1:..., Q2:..., Q3:..., Q4:..., Q5:...)",
    "general_comment": "Lời phê sắc sảo về tư duy giải mã văn bản.",
    "strengths": ["Điểm cộng kiến thức 1", "..."],
    "weaknesses": ["Lỗi hời hợt/sai thuật ngữ 1", "..."],
    "correction_html": "HTML bài sửa. Ép font Merriweather. Dùng <span class='text-bad'>[Sai]</span>, <span class='text-good'>[Đúng]</span>, <span class='text-fix'>[Đáp án chuẩn]</span>.",
    "orientation": "Định hướng phương pháp đọc hiểu chuyên sâu."
}

VĂN BẢN: ${q.text}
CÂU HỎI: ${JSON.stringify(q.questions)}
BÀI LÀM: ${content}
`;
        try {
            const res = await fetch(API_URL, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] }) 
            });
            const data = await res.json();
            const rawText = data.candidates[0].content.parts[0].text;
            
            // Dùng Regex lấy JSON để tránh lỗi ký tự dư thừa
            const jsonMatch = rawText.match(/\{[\s\S]*\}/);
            if (!jsonMatch) {
                // Nếu AI trả về HTML (Lỗi 504) thay vì JSON
                showPopup("Máy chủ bận", "Bài làm đang được xử lý quá lâu. Nhân hãy thử bấm 'Nộp bài' lại một lần nữa nhé!", "error");
                loading.style.display = 'none';
                return;
            }

            try {
                const result = JSON.parse(jsonMatch[0]);
                // Tiếp tục phần render kết quả như cũ...
            } catch (e) {
                console.error("Lỗi Parse JSON:", e);
                showPopup("Lỗi AI", "Dữ liệu trả về bị lỗi, vui lòng thử lại.", "error");
            }

            document.getElementById('input-section').classList.add('hidden');
            const out = document.getElementById('output-section');
            out.style.display = 'flex';
            out.classList.remove('hidden');
            out.classList.add('flex-col', 'h-full'); // Ép lấy toàn bộ chiều cao của card

            const barColor = result.human_score > 75 ? '#22c55e' : (result.human_score > 50 ? '#f59e0b' : '#ef4444');

            // Render kết quả với Font Merriweather mảnh
            document.getElementById('ai-correction-box').innerHTML = `
                <div class="max-w-2xl mx-auto pb-10 custom-scrollbar" 
                    style="font-family: 'Merriweather', serif; font-weight: 300; font-size: 1rem; line-height: 1.8;">
                    </div>
                    
                    <div class="text-center mb-8">
                        <div class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Kết quả đọc hiểu</div>
                        <div class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-600 mb-2">${result.reading_score}</div>
                        <p class="text-gray-600 italic px-4 font-light">"${result.general_comment}"</p>
                    </div>

                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Độ chân thực (AI Check)</span>
                            <span class="font-bold text-sm" style="color:${barColor}">${result.human_score}%</span>
                        </div>
                        <div class="h-1.5 bg-gray-100 rounded-full overflow-hidden">
                            <div style="width:${result.human_score}%; background:${barColor}" class="h-full"></div>
                        </div>
                        <p class="text-[11px] text-gray-400 mt-2 italic font-light">${result.ai_comment}</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        <div class="bg-green-50/50 p-5 rounded-2xl border border-green-100">
                            <h4 class="text-green-700 font-bold text-[10px] uppercase mb-3"><i class="fas fa-check-circle mr-1"></i> Điểm tốt</h4>
                            <ul class="text-xs text-green-800 space-y-2 font-medium">
                                ${result.strengths.map(s => `<li>• ${s}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="bg-red-50/50 p-5 rounded-2xl border border-red-100">
                            <h4 class="text-red-700 font-bold text-[10px] uppercase mb-3"><i class="fas fa-exclamation-triangle mr-1"></i> Cần cải thiện</h4>
                            <ul class="text-xs text-red-800 space-y-2 font-medium">
                                ${result.weaknesses.map(w => `<li>• ${w}</li>`).join('')}
                            </ul>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-3xl border border-gray-100 shadow-sm mb-8">
                        <h4 class="font-black text-gray-800 border-b pb-4 mb-6 text-xs uppercase tracking-widest">Gợi ý sửa chi tiết</h4>
                        <div class="leading-loose text-gray-700 font-light text-lg space-y-4 text-justify">
                            ${result.correction_html}
                        </div>
                    </div>

                    <div class="bg-gray-900 text-white p-6 rounded-2xl shadow-xl">
                        <div class="flex items-center gap-2 mb-2 text-orange-400">
                            <i class="fas fa-lightbulb"></i>
                            <span class="text-[10px] font-black uppercase tracking-widest">Định hướng kĩ năng</span>
                        </div>
                        <p class="text-sm text-gray-300 leading-relaxed font-light italic">${result.orientation}</p>
                    </div>
                </div>
            `;

            // Lưu Firebase (sử dụng score thang 10 để đồng bộ Dashboard)
            if (auth.currentUser) { 
                await addDoc(collection(db, "activities"), { 
                    uid: auth.currentUser.uid, 
                    type: "reading", 
                    score: result.score, 
                    timestamp: serverTimestamp(), 
                    examId: q.id 
                }); 
            }

        } catch(e) { 
            console.error(e); 
            showPopup("Lỗi AI", "Hệ thống đang bận xử lý dữ liệu, Nhân vui lòng thử nộp lại sau giây lát nhe!", "error"); 
        } finally { 
            loading.style.display = 'none'; 
        }
    };

    window.resetExam = () => { document.getElementById('input-section').classList.remove('hidden'); document.getElementById('output-section').classList.add('hidden'); document.getElementById('output-section').style.display = 'none'; };

    // --- TIMER ---
    let timeLeft = 1200; 
    function startTimer() {
        setInterval(() => {
            if(timeLeft > 0) {
                timeLeft--;
                const m = Math.floor(timeLeft / 60);
                const s = timeLeft % 60;
                const txt = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                if(document.getElementById('timer')) document.getElementById('timer').innerText = txt;
                if(document.getElementById('timer-mobile')) document.getElementById('timer-mobile').innerText = txt;
            } else if (timeLeft === 0) { timeLeft = -1; showPopup("Hết Giờ", "Đã hết thời gian làm bài Đọc Hiểu!", "warning"); }
        }, 1000);
    }

    onAuthStateChanged(auth, u => { if(u) { startTimer(); loadQuestions(); } else window.location.href="../log.html"; });

    document.getElementById('file-upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        if(file.name.endsWith('.docx')) {
            reader.onload = (ev) => mammoth.extractRawText({arrayBuffer: ev.target.result}).then(r => document.getElementById('student-essay').value = r.value);
            reader.readAsArrayBuffer(file);
        } else { showPopup("Lỗi", "Chỉ nhận file .docx", "error"); }
    });

    document.getElementById('student-essay').oninput = function() {
        const c = this.value.trim().split(/\s+/).filter(x => x).length;
        document.getElementById('word-count').innerText = `${c} TỪ`;
    };
</script>
</body>
</html>