<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level 3: Nghị Luận Xã Hội</title>
    <link rel="icon" type="image/webp" href="../LOGO.WEBP" />
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root { --primary: #FF8F50; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            min-height: 100vh; 
            display: block; 
            color: #334155;
            background: radial-gradient(at 0% 0%, hsla(25,100%,95%,1) 0, transparent 50%), 
                        radial-gradient(at 100% 100%, hsla(15,100%,96%,1) 0, transparent 50%), 
                        #fff9f5;
        }

        /* --- BACKGROUND --- */
        .bg-blob { position: fixed; filter: blur(80px); z-index: -1; opacity: 0.6; animation: float 25s infinite alternate ease-in-out; }
        .blob-1 { top: -5%; left: -5%; width: 500px; height: 500px; background: #ffe4d3; animation-delay: -5s; }
        .blob-2 { bottom: 5%; right: -5%; width: 400px; height: 400px; background: #ffdec2; }
        @keyframes float { 0% { transform: translate(0, 0) rotate(0deg); } 100% { transform: translate(40px, 40px) rotate(15deg); } }

        .main-content { 
            width: 100%; 
            padding: 20px; 
            min-height: 100vh; 
            position: relative; 
            max-width: 850px; /* Nội dung gọn gàng ở giữa */
            margin: 0 auto;
        }

        /* --- GLASS UI --- */
        .glass-header {
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 4px 30px rgba(0,0,0,0.05);
            border-radius: 9999px; transition: all 0.3s;
        }
        .liquid-glass {
            background: rgba(255, 255, 255, 0.7);
            box-shadow: 0 10px 40px -10px rgba(255, 130, 60, 0.1), inset 0 0 0 1px rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 24px; transition: transform 0.3s; margin-bottom: 2rem;
        }

        /* --- CONTENT STYLES --- */
        .quote-box {
            font-family: 'Merriweather', serif; 
            color: #374151;
            background: #fffaf5; 
            padding: 25px; 
            border-radius: 16px;
            font-size: 1.05rem; 
            line-height: 1.8; 
            position: relative;
            border: 1px solid #fed7aa;
            margin-bottom: 24px;
            text-align: justify; /* Căn đều ngữ liệu */
        }
        .quote-box p { margin-bottom: 0.5rem; }
        .quote-box strong { font-weight: 700; color: #1f2937; }

        /* Đề bài: Font thường, căn đều */
        #display-topic {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 500; /* Vừa phải, không đậm */
            color: #1e293b;
            font-size: 1.1rem;
            line-height: 1.6;
            text-align: justify; /* Căn đều đề bài */
        }
        #display-topic strong { font-weight: 600; }

        .glass-textarea {
            width: 100%; height: 450px;
            background: #FFFFFF !important;
            border: 1px solid #cbd5e1;
            border-radius: 20px; padding: 25px;
            font-size: 1rem; line-height: 1.7; color: #334155;
            resize: none; outline: none; transition: 0.3s;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.02);
            text-align: justify;
        }
        .glass-textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 143, 80, 0.15);
        }

        /* --- AI RESULT --- */
        .ai-result { display: none; margin-top: 40px; animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        .score-circle {
            width: 120px; height: 120px; border-radius: 50%;
            background: conic-gradient(var(--primary) 0%, rgba(255,255,255,0.5) 0%);
            display: flex; align-items: center; justify-content: center;
            position: relative; margin: 0 auto;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }
        .score-inner {
            width: 90px; height: 90px; background: white; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        #ai-correction { white-space: pre-wrap; font-family: 'Merriweather', serif; font-size: 1rem; line-height: 1.8; text-align: justify; }
        .text-good { background: #dcfce7; color: #166534; padding: 1px 4px; border-radius: 4px; font-weight: 600; }
        .text-bad { background: #fee2e2; color: #991b1b; text-decoration: line-through; padding: 1px 4px; border-radius: 4px; opacity: 0.8; }
        .text-fix { color: #2563eb; font-weight: 600; font-style: normal; margin-left: 4px; background: #eff6ff; padding: 1px 4px; border-radius: 4px; font-size: 0.9em; }

        /* --- POPUP & LOADING --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(6px);
            z-index: 9999; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal-box {
            background: white; width: 90%; max-width: 450px; border-radius: 24px;
            padding: 32px; text-align: center; position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-overlay.open .modal-box { transform: scale(1); }

        .icon-box {
            width: 64px; height: 64px; border-radius: 50%; margin: 0 auto 16px;
            display: flex; align-items: center; justify-content: center; font-size: 2rem;
        }
        .icon-warning { background: #ffedd5; color: #f97316; }
        .icon-error { background: #fee2e2; color: #ef4444; }
        .icon-info { background: #dbeafe; color: #3b82f6; }

        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); z-index: 20000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .loader-robot { font-size: 4rem; color: var(--primary); animation: robotBounce 1s infinite alternate; }
        @keyframes robotBounce { from { transform: translateY(0); } to { transform: translateY(-15px); } }
        .fa-circle-notch { animation: spin 1s linear infinite; margin-right: 8px; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        @media (max-width: 1024px) { .main-content { padding: 16px; } }


/* --- GLOBAL SCROLLBAR STYLE --- */

/* 1. Thiết lập độ rộng/cao của thanh trượt */
::-webkit-scrollbar {
    width: 10px;  /* Độ rộng cho thanh dọc */
    height: 10px; /* Độ cao cho thanh ngang */
}

/* 2. Thiết lập rãnh trượt (Track) - Nền chìm */
::-webkit-scrollbar-track {
    background: rgba(255, 143, 80, 0.05); /* Màu cam cực nhạt, gần như trong suốt */
    border-radius: 10px;
}

/* 3. Thiết lập tay nắm (Thumb) - Phần di chuyển */
::-webkit-scrollbar-thumb {
    background-color: rgba(255, 143, 80, 0.3); /* Mặc định là cam nhạt */
    border-radius: 10px; /* Bo tròn mềm mại */
    
    /* Mẹo: Tạo viền trong suốt để thanh trượt trông nhỏ hơn và "lơ lửng" */
    border: 2px solid transparent;
    background-clip: content-box;
    transition: background-color 0.3s ease;
}

/* 4. Hiệu ứng khi di chuột vào (Hover) */
::-webkit-scrollbar-thumb:hover {
    background-color: #FF8F50; /* Đổi sang màu cam chính thương hiệu */
    border: 1px solid transparent; /* Làm thanh trượt to ra một chút khi hover */
}

/* 5. (Tùy chọn) Ẩn nút mũi tên 2 đầu (nếu trình duyệt hiển thị) */
::-webkit-scrollbar-button {
    display: none;
}

/* --- FULLSCREEN POPUP NEON SYNC --- */
        .fs-modal-box {
            background: white; 
            padding: 45px 35px; 
            border-radius: 32px; 
            width: 90%; 
            max-width: 420px; 
            text-align: center;
            position: relative;
            border: 2px solid rgba(255, 143, 80, 0.2);
            box-shadow: 0 20px 60px rgba(255, 107, 107, 0.15), 0 0 30px rgba(255, 143, 80, 0.1);
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .fs-icon-wrap {
            width: 80px; height: 80px;
            margin: 0 auto 25px;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem;
            background: linear-gradient(135deg, #FF8F50 0%, #FF6B6B 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 8px 15px rgba(255, 107, 107, 0.3));
        }

        .btn-neon-fs {
            width: 100%;
            padding: 16px;
            border-radius: 18px;
            background: linear-gradient(135deg, #FF8F50 0%, #FF6B6B 100%);
            color: white;
            font-weight: 800;
            font-size: 1.1rem;
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.3);
            transition: 0.3s;
            border: none;
            cursor: pointer;
        }

        .btn-neon-fs:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(255, 107, 107, 0.5);
            filter: brightness(1.1);
        }
    </style>
</head>
<body>

    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>

    <div id="alert-modal" class="modal-overlay">
        <div class="modal-box">
            <div id="alert-icon-box" class="icon-box icon-warning">
                <i id="alert-icon" class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 id="alert-title" class="text-xl font-bold text-gray-800 mb-2">Thông báo</h3>
            <p id="alert-msg" class="text-gray-500 text-sm mb-6">Nội dung thông báo...</p>
            <div id="alert-actions" class="flex gap-3 justify-center"></div>
        </div>
    </div>

    <div id="fullscreen-popup" class="modal-overlay" style="display: none; z-index: 50000; background: rgba(255, 245, 236, 0.7); backdrop-filter: blur(8px);">
        <div class="fs-modal-box">
            <div class="fs-icon-wrap">
                <i class="fas fa-expand-arrows-alt"></i>
            </div>
            <h3 class="text-2xl font-black text-gray-800 mb-2">Chế độ Làm bài thi</h3>
            <p class="text-gray-500 leading-relaxed mb-8 px-4">Để đảm bảo sự tập trung cao nhất, hệ thống sẽ chuyển sang <b>Toàn màn hình</b>.</p>
            <div class="modal-actions">
                <button onclick="enableFullscreen()" class="btn-neon-fs">Tiếp tục</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="loading-overlay">
        <div class="loader-robot"><i class="fas fa-robot"></i></div>
    </div>

    <main class="main-content">
        <div class="sticky top-4 z-50 mb-8 px-2">
            <div class="max-w-6xl mx-auto glass-header px-6 py-3 flex justify-between items-center bg-white/80">
                <a href="../dashboard/nhatkyhoctap.html" class="flex items-center gap-3 text-gray-600 font-bold hover:text-orange-500 transition group">
                    <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm text-orange-400 group-hover:scale-110 transition-transform">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <span class="hidden sm:inline">Quay lại lộ trình</span>
                </a>
                
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Thời gian còn lại</p>
                        <p class="text-base font-black text-gray-800" id="timer-text">60:00</p>
                    </div>
                    <div class="w-12 h-12 rounded-full flex items-center justify-center shadow-lg relative overflow-hidden bg-white">
                        <svg class="w-10 h-10 absolute" viewBox="0 0 36 36">
                            <path class="text-gray-200" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="4" />
                            <path class="text-orange-500 transition-all duration-1000 ease-linear" stroke-dasharray="100, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="4" id="timer-circle" />
                        </svg>
                        <span class="text-xs font-black relative z-10 text-gray-700" id="timer-mini">60</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-3xl mx-auto pb-20">
            <div class="liquid-glass p-8 mb-8 relative overflow-hidden bg-gradient-to-br from-white/90 to-white/60">
                <div class="relative z-10">
                    <span class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-4 py-1.5 rounded-xl text-[11px] font-black uppercase tracking-widest shadow-lg shadow-orange-500/30">Level 3</span>
                    <h1 class="text-3xl font-bold text-gray-800 mt-3 mb-2">Nghị Luận Xã Hội</h1>
                    <p class="text-gray-500 font-medium text-sm">Viết đoạn văn 200 chữ. Đạt tối thiểu <span class="text-orange-600 font-bold">6.0 điểm</span> để qua màn.</p>
                </div>
                <i class="fas fa-pen-nib absolute -right-6 -bottom-8 text-8xl text-orange-500/10 rotate-12"></i>
            </div>

            <div class="liquid-glass p-8 md:p-10 mb-8 bg-white border border-orange-100">
                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Đề bài:</label>
                    <div id="display-topic">Đang tải chủ đề...</div>
                </div>
                
                <div id="display-quote-container" class="quote-box hidden">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="fas fa-feather-alt text-orange-400"></i>
                        <span class="text-xs font-bold text-orange-400 uppercase">Ngữ liệu tham khảo</span>
                    </div>
                    <div id="display-quote"></div>
                </div>

                <p class="text-gray-600 mb-6 text-sm flex items-center gap-2">
                    <i class="fas fa-info-circle text-blue-400"></i>
                    <span>Yêu cầu: Viết một đoạn văn (khoảng 200 chữ) trình bày suy nghĩ của anh/chị về vấn đề trên.</span>
                </p>

                <div class="relative">
                    <textarea id="student-essay" class="glass-textarea" placeholder="Bắt đầu viết đoạn văn của bạn tại đây... (Tối thiểu 50 từ)"></textarea>
                    <div class="absolute bottom-4 right-6 text-xs font-bold text-gray-400 bg-white/90 px-3 py-1 rounded-full border border-gray-200 backdrop-blur-sm">
                        <span id="word-count" class="text-orange-500">0</span> từ
                    </div>
                </div>

                <div class="mt-8 text-center" id="submit-area">
                    <button onclick="confirmSubmission()" class="group relative inline-flex items-center justify-center px-10 py-4 font-bold text-white transition-all duration-300 bg-gray-800 rounded-2xl hover:shadow-xl hover:shadow-orange-500/20 hover:-translate-y-1 active:scale-95 overflow-hidden">
                        <span class="relative z-10 flex items-center gap-2">NỘP BÀI & CHẤM ĐIỂM <i class="fas fa-paper-plane"></i></span>
                        <div class="absolute inset-0 bg-gradient-to-r from-orange-500 to-red-500 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    </button>
                </div>
            </div>

            <div id="result-box" class="liquid-glass p-8 md:p-10 ai-result bg-white/95 border-2 border-white">
                <div class="flex flex-col md:flex-row items-center mb-10 border-b border-gray-100 pb-8">
                    <div class="score-circle" id="score-ring">
                        <div class="score-inner">
                            <span class="text-4xl font-bold text-gray-800" id="score-text">0</span>
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Điểm</span>
                        </div>
                    </div>
                    <div class="text-center md:text-left mt-6 md:mt-0 md:ml-8 flex-1">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2" id="result-title">Đang chấm...</h3>
                        <p class="text-gray-500 text-sm italic" id="result-desc">AI đang đọc bài của bạn...</p>
                    </div>
                </div>

                <div class="space-y-8">
                    <div>
                        <h4 class="font-bold text-gray-700 uppercase text-xs tracking-widest mb-4 flex items-center gap-2">
                            <i class="fas fa-highlighter text-orange-500"></i> Nhận xét chi tiết từ AI
                        </h4>
                        <div id="ai-correction" class="bg-gray-50/80 p-6 rounded-2xl border border-gray-200 text-gray-700 text-base shadow-inner leading-relaxed font-serif"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-green-50/50 p-6 rounded-2xl border border-green-100/50">
                            <h4 class="font-bold text-green-700 mb-3 flex items-center gap-2 uppercase text-xs tracking-wider"><i class="fas fa-check-circle"></i> Ưu điểm</h4>
                            <ul id="pros-list" class="text-sm text-green-800 space-y-2 list-disc pl-4 font-medium"></ul>
                        </div>
                        <div class="bg-red-50/50 p-6 rounded-2xl border border-red-100/50">
                            <h4 class="font-bold text-red-700 mb-3 flex items-center gap-2 uppercase text-xs tracking-wider"><i class="fas fa-exclamation-circle"></i> Hạn chế</h4>
                            <ul id="cons-list" class="text-sm text-red-800 space-y-2 list-disc pl-4 font-medium"></ul>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="nextLevel()" id="next-btn" class="hidden w-full sm:w-auto bg-green-500 text-white px-8 py-3 rounded-xl font-bold hover:bg-green-600 transition shadow-lg shadow-green-200">Mở Khóa Level 4 <i class="fas fa-lock-open ml-2"></i></button>
                    <button onclick="location.reload()" id="retry-btn" class="hidden w-full sm:w-auto bg-gray-100 text-gray-600 px-8 py-3 rounded-xl font-bold hover:bg-gray-200 transition">Làm Lại Bài <i class="fas fa-redo ml-2"></i></button>
                </div>
            </div>
        </div>
    </main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, addDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAJ9C2biYeiLPmhakzLZ4mEqfO9_VgPSZE", authDomain: "hopvan-9a648.firebaseapp.com", projectId: "hopvan-9a648", storageBucket: "hopvan-9a648.appspot.com", messagingSenderId: "429347196227", appId: "1:429347196227:web:917b8d019f0efd0f7833f6", measurementId: "G-1BG8PSRG0R" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const API_URL = `/.netlify/functions/gemini-proxy`; // Logic Groq
    let userUid = null;
    let levelData = null; 

    // --- POPUP FUNCTION ---
    window.showPopup = (type, title, msg, confirmCallback = null) => {
        const modal = document.getElementById('alert-modal');
        const actions = document.getElementById('alert-actions');
        const iconBox = document.getElementById('alert-icon-box');
        const icon = document.getElementById('alert-icon');

        document.getElementById('alert-title').innerText = title;
        document.getElementById('alert-msg').innerText = msg;
        
        iconBox.className = "icon-box";
        if (type === 'warning') { iconBox.classList.add('icon-warning'); icon.className = "fas fa-exclamation-triangle"; }
        else if (type === 'error') { iconBox.classList.add('icon-error'); icon.className = "fas fa-times-circle"; }
        else { iconBox.classList.add('icon-info'); icon.className = "fas fa-info-circle"; }

        actions.innerHTML = "";
        if (confirmCallback) {
            const b1 = document.createElement('button'); b1.className = "px-6 py-3 rounded-xl font-bold bg-gray-100 text-gray-600 hover:bg-gray-200 transition text-sm";
            b1.innerText = "Kiểm tra lại"; b1.onclick = () => modal.classList.remove('open');
            const b2 = document.createElement('button'); b2.className = "px-6 py-3 rounded-xl font-bold bg-orange-500 text-white shadow-lg hover:bg-orange-600 transition text-sm";
            b2.innerText = "Nộp bài ngay"; b2.onclick = () => { modal.classList.remove('open'); confirmCallback(); };
            actions.append(b1, b2);
        } else {
            const b = document.createElement('button'); b.className = "px-8 py-3 rounded-xl font-bold bg-gray-900 text-white hover:bg-gray-800 transition text-sm";
            b.innerText = "Đã hiểu"; b.onclick = () => modal.classList.remove('open');
            actions.appendChild(b);
        }
        modal.classList.add('open');
    };

    onAuthStateChanged(auth, (u) => {
        if (u) { userUid = u.uid; initLevel3(); }
        else { showPopup('info', 'Yêu cầu đăng nhập', 'Bạn cần đăng nhập để thực hiện thử thách.', () => window.location.href = "../log.html"); }
    });

    // --- 1. TẢI ĐỀ LEVEL 3 ---
    async function initLevel3() {
        try {
            const q = query(collection(db, "study_levels"), where("level", "==", 3));
            const snap = await getDocs(q);
            if (snap.empty) {
                document.getElementById('display-topic').innerText = "Chưa tạo nội dung cho Level 3";
                return;
            }
            
            const docData = snap.docs[0].data();
            levelData = docData.content; 

            document.getElementById('display-topic').innerHTML = levelData.topic;
            
            if (levelData.text && levelData.text.trim() !== "") {
                const quoteBox = document.getElementById('display-quote');
                quoteBox.innerHTML = levelData.text;
                document.getElementById('display-quote-container').classList.remove('hidden');
            }
        } catch (e) { console.error(e); }
    }

    // --- 2. XỬ LÝ NỘP BÀI ---
    window.confirmSubmission = () => {
        if (!levelData) return;
        const content = document.getElementById('student-essay').value.trim();
        const words = content.split(/\s+/).filter(x => x).length;

        if (words < 50) return showPopup('warning', 'Bài viết quá ngắn', 'Bạn cần viết ít nhất 50 từ để AI có thể phân tích nội dung.');
        showPopup('warning', 'Xác nhận nộp bài', 'Bài làm sẽ được AI chấm điểm chi tiết.', handleRealSubmit);
    };

    const handleRealSubmit = async () => {
        const content = document.getElementById('student-essay').value.trim();
        document.getElementById('loading-overlay').style.display = 'flex';

        // PROMPT CHUYÊN DỤNG CHO NLXH (GROQ/LLAMA-3)
        const systemPrompt = `
        BẠN LÀ: Giám khảo chấm thi THPT Quốc Gia môn Ngữ Văn (Phần Nghị Luận Xã Hội).
        NHIỆM VỤ: Chấm điểm đoạn văn 200 chữ của học sinh.
        
        ĐỀ BÀI: "${document.getElementById('display-topic').innerText}"
        NGỮ LIỆU GỢI Ý: "${document.getElementById('display-quote').innerText}"
        GỢI Ý CHẤM (HINT): "${levelData.hint || ''}"

        TIÊU CHÍ CHẤM (Thang 10):
        1. Đúng vấn đề, đúng hình thức đoạn văn (không xuống dòng).
        2. Lập luận chặt chẽ, dẫn chứng thuyết phục.
        3. Phản biện sắc sảo, liên hệ bản thân tốt.

        YÊU CẦU OUTPUT JSON DUY NHẤT (KHÔNG MARKDOWN):
        {
            "score": (số thực 0-10, lẻ 0.5),
            "title": "Nhận xét ngắn gọn",
            "desc": "Lời khuyên tổng quát",
            "correction_html": "Trích đoạn bài làm gốc và chèn thêm thẻ: <span class='text-bad'>[Lỗi]</span>, <span class='text-fix'>(Sửa)</span> và <span class='text-good'>[Hay]</span> vào những chỗ cần thiết.",
            "pros": ["Điểm mạnh 1", "Điểm mạnh 2"],
            "cons": ["Điểm yếu 1", "Điểm yếu 2"]
        }
        `;

        try {
            // GỬI SANG PROXY (Chuẩn Messages + Tách System Prompt)
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    systemPrompt: systemPrompt,  // Gửi riêng
                    messages: `BÀI LÀM CỦA HỌC SINH:\n${content}`
                })
            });

            if (!response.ok) throw new Error("SERVER_ERROR");

            const data = await response.json();
            
            // Xử lý kết quả từ Groq
            if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                throw new Error("NO_CONTENT");
            }

            let rawText = data.choices[0].message.content;
            // Làm sạch JSON
            rawText = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
            const firstBrace = rawText.indexOf('{');
            const lastBrace = rawText.lastIndexOf('}');
            if (firstBrace !== -1 && lastBrace !== -1) {
                rawText = rawText.substring(firstBrace, lastBrace + 1);
            }

            let res;
            try {
                res = JSON.parse(rawText);
            } catch (e) {
                console.error("JSON Error:", rawText);
                throw new Error("INVALID_JSON");
            }

            // --- DATA SANITIZATION (AN TOÀN CHO FIREBASE) ---
            let safeScore = parseFloat(res.score);
            if (isNaN(safeScore)) safeScore = 0;
            if (safeScore > 10) safeScore = 10;
            res.score = safeScore; // Gán lại giá trị chuẩn

            // Hiển thị kết quả
            renderResult(res);

            // Lưu Firebase
            if(userUid) {
                await addDoc(collection(db, "activities"), { 
                    uid: userUid, 
                    userName: auth.currentUser.displayName || "User",
                    examTitle: levelData.title, 
                    action: `Đọc hiểu Level 2: ${safeScore}đ`, 
                    type: "journal", 
                    score: safeScore,
                    timestamp: serverTimestamp() 
                });
                
                // --- LOGIC MỚI: MỞ KHÓA & THƯỞNG KEYS ---
                if(safeScore >= 6) {
                    const progressRef = doc(db, "users_progress", userUid);
                    const userRef = doc(db, "users", userUid);
                    
                    // 1. Mở khóa Level 3 (Nếu chưa mở)
                    const progSnap = await getDoc(progressRef);
                    const currentLvl = progSnap.exists() ? (progSnap.data().currentLevel || 1) : 1;
                    
                    if (currentLvl < 3) {
                        await setDoc(progressRef, { currentLevel: 3, lastPassed: serverTimestamp() }, { merge: true });
                    }

                    // 2. Thưởng 10 Keys
                    await updateDoc(userRef, { keys: increment(10) });
                    console.log("Đã thưởng 10 keys!");
                }
            }
        } catch (e) { 
            console.error(e);
            let msg = "Có lỗi xảy ra, vui lòng thử lại!";
            if (e.message === "SERVER_ERROR") msg = "Server AI đang bận hoặc quá tải.";
            if (e.message === "INVALID_JSON") msg = "AI trả về dữ liệu lỗi. Vui lòng nộp lại!";
            showPopup('error', 'Lỗi kết nối', msg); 
        }
        finally { document.getElementById('loading-overlay').style.display = 'none'; }
    };

    function renderResult(res) {
        document.getElementById('result-box').style.display = 'block';
        document.getElementById('submit-area').style.display = 'none';
        document.getElementById('result-box').scrollIntoView({ behavior: 'smooth' });

        document.getElementById('score-text').innerText = res.score;
        document.getElementById('result-title').innerText = res.title;
        document.getElementById('result-desc').innerText = res.desc;
        document.getElementById('ai-correction').innerHTML = res.correction_html;
        document.getElementById('pros-list').innerHTML = res.pros.map(i => `<li>${i}</li>`).join('');
        document.getElementById('cons-list').innerHTML = res.cons.map(i => `<li>${i}</li>`).join('');

        const ring = document.getElementById('score-ring');
        if (res.score >= 6) {
            ring.style.background = `conic-gradient(#10B981 ${res.score*10}%, rgba(255,255,255,0.5) 0%)`;
            document.getElementById('next-btn').classList.remove('hidden');
        } else {
            ring.style.background = `conic-gradient(#EF4444 ${res.score*10}%, rgba(255,255,255,0.5) 0%)`;
            document.getElementById('retry-btn').classList.remove('hidden');
        }
    }

    document.getElementById('student-essay').oninput = function() {
        const words = this.value.trim().split(/\s+/).filter(x => x).length;
        document.getElementById('word-count').innerText = words;
    };

    window.nextLevel = () => window.location.href = "../dashboard/nhatkyhoctap.html";

    // Timer (60 mins)
    let totalSeconds = 3600; 
    const timerText = document.getElementById('timer-text');
    const timerMini = document.getElementById('timer-mini');
    const timerCircle = document.getElementById('timer-circle');

    const interval = setInterval(() => {
        if(totalSeconds > 0) {
            totalSeconds--;
            const m = Math.floor(totalSeconds / 60);
            const s = totalSeconds % 60;
            timerText.innerText = `${m}:${s<10?'0'+s:s}`;
            timerMini.innerText = m;
            const pct = (totalSeconds / 3600) * 100;
            timerCircle.setAttribute('stroke-dasharray', `${pct}, 100`);
        } else {
            clearInterval(interval);
            showPopup('warning', 'Hết giờ!', 'Hệ thống tự động nộp bài.', handleRealSubmit);
        }
    }, 1000);

    fetch('menu.html').then(r=>r.text()).then(h=>{
        const p = document.getElementById('menu-placeholder'); if(p) p.innerHTML=h;
    });

// --- FULLSCREEN LOGIC ---
    window.enableFullscreen = () => {
        const elem = document.documentElement;
        if (elem.requestFullscreen) {
            elem.requestFullscreen();
        } else if (elem.webkitRequestFullscreen) { /* Safari */
            elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) { /* IE11 */
            elem.msRequestFullscreen();
        }
        // Đóng popup
        const popup = document.getElementById('fullscreen-popup');
        popup.classList.remove('open');
        setTimeout(() => { popup.style.display = 'none'; }, 300);
    };

    // Tự động hiện popup sau khi trang đã load và user đã đăng nhập
    window.addEventListener('load', () => {
        if (!document.fullscreenElement) {
            setTimeout(() => {
                const fsPopup = document.getElementById('fullscreen-popup');
                fsPopup.style.display = 'flex';
                setTimeout(() => fsPopup.classList.add('open'), 10);
            }, 800); 
        }
    });

    // --- CHỐNG COPY PASTE (ANTI CHEAT) ---
    const essayArea = document.getElementById('student-essay');

    if (essayArea) {
        // 1. Chặn hành động Dán (Paste)
        essayArea.addEventListener('paste', (e) => {
            e.preventDefault(); // Ngăn chặn hành động dán
            showPopup("Chế độ Luyện Tập", "Vui lòng tự gõ bài để rèn luyện tư duy.\nHệ thống không cho phép Copy-Paste.", "warning");
        });

        // 2. Chặn hành động Sao chép & Cắt (Copy & Cut) - Để tránh copy đề hoặc bài ra ngoài
        essayArea.addEventListener('copy', (e) => e.preventDefault());
        essayArea.addEventListener('cut', (e) => e.preventDefault());

        // 3. Chặn Kéo thả text vào ô (Drop)
        essayArea.addEventListener('drop', (e) => e.preventDefault());

        // 4. (Tuỳ chọn) Chặn Menu chuột phải trong ô nhập liệu
        essayArea.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });
    }
</script>

</body>
</html>