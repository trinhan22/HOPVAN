<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level 3: Nghị Luận Xã Hội</title>
    <link rel="icon" type="image/webp" href="../LOGO.WEBP" />
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root { --primary: #FF8F50; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; min-height: 100vh; display: flex; color: #2d3436;
            background: radial-gradient(at 0% 0%, hsla(25,100%,95%,1) 0, transparent 50%), 
                        radial-gradient(at 100% 100%, hsla(15,100%,96%,1) 0, transparent 50%), 
                        #fff9f5;
        }

        /* --- BACKGROUND BLOBS --- */
        .bg-blob { position: fixed; filter: blur(80px); z-index: -1; opacity: 0.6; animation: float 25s infinite alternate ease-in-out; }
        .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: #ffe4d3; animation-delay: -5s; }
        .blob-2 { bottom: 0%; right: -5%; width: 450px; height: 450px; background: #ffdec2; }
        @keyframes float { 0% { transform: translate(0, 0) rotate(0deg); } 100% { transform: translate(40px, 40px) rotate(15deg); } }

        #menu-placeholder { width: 280px; flex-shrink: 0; }
        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; height: 100vh; position: relative; scroll-behavior: smooth; }

        /* --- LIQUID GLASS STYLES --- */
        .glass-header {
            background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 10px 30px rgba(255, 143, 80, 0.15);
            border-radius: 9999px; transition: all 0.3s;
        }
        .glass-header:hover { transform: translateY(-2px); background: rgba(255, 255, 255, 0.9); }

        .liquid-glass {
            background: rgba(255, 255, 255, 0.45);
            box-shadow: 0 15px 40px -5px rgba(255, 130, 60, 0.1), inset 0 0 0 1px rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 24px; transition: transform 0.3s;
        }

        /* --- CONTENT STYLES --- */
        .quote-box {
            font-family: 'Merriweather', serif; font-style: italic; color: #4b5563;
            border-left: 4px solid var(--primary); padding-left: 20px; margin: 20px 0;
            font-size: 1.1rem; line-height: 1.8;
        }

        .glass-textarea {
            width: 100%; height: 400px;
            background: rgba(255, 255, 255, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 20px; padding: 25px;
            font-size: 1.05rem; line-height: 1.8; color: #2d3436;
            resize: none; outline: none; transition: 0.3s;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.02);
        }
        .glass-textarea:focus {
            background: rgba(255, 255, 255, 0.9);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(255, 143, 80, 0.15);
        }

        /* --- AI RESULT --- */
        .ai-result { display: none; margin-top: 40px; animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        .score-circle {
            width: 120px; height: 120px; border-radius: 50%;
            background: conic-gradient(var(--primary) 0%, rgba(255,255,255,0.5) 0%);
            display: flex; align-items: center; justify-content: center;
            position: relative; margin: 0 auto;
            box-shadow: 0 15px 30px rgba(255, 143, 80, 0.25);
        }
        .score-inner {
            width: 90px; height: 90px; background: rgba(255,255,255,0.9); border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* Highlight text from AI */
        .text-good { background: #dcfce7; color: #166534; padding: 2px 4px; border-radius: 4px; font-weight: 600; }
        .text-bad { background: #fee2e2; color: #991b1b; text-decoration: line-through; padding: 2px 4px; border-radius: 4px; }
        .text-fix { color: #2563eb; font-weight: 700; font-style: italic; margin-left: 4px; }

        @media (max-width: 1024px) { #menu-placeholder { display: none; } .main-content { padding: 20px; } }
    </style>
</head>
<body>

    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>

    <div id="menu-placeholder"></div>

    <main class="main-content">
        <div class="sticky top-6 z-50 mb-12 px-2">
            <div class="max-w-5xl mx-auto glass-header px-6 py-3 flex justify-between items-center">
                <a href="../dashboard/nhatkyhoctap.html" class="flex items-center gap-3 text-gray-600 font-bold hover:text-orange-500 transition group">
                    <div class="w-10 h-10 rounded-full bg-white/80 flex items-center justify-center shadow-sm text-orange-400 group-hover:scale-110 transition-transform">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <span class="hidden sm:inline">Quay lại lộ trình</span>
                </a>
                
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Thời gian còn lại</p>
                        <p class="text-base font-black text-gray-800" id="timer-text">45 phút 00 giây</p>
                    </div>
                    <div class="w-12 h-12 rounded-full flex items-center justify-center shadow-lg relative overflow-hidden bg-white">
                        <svg class="w-10 h-10 absolute" viewBox="0 0 36 36">
                            <path class="text-gray-200" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="4" />
                            <path class="text-orange-500 transition-all duration-1000 ease-linear" stroke-dasharray="100, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="4" id="timer-circle" />
                        </svg>
                        <span class="text-xs font-black relative z-10 text-gray-700" id="timer-mini">45</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-4xl mx-auto pb-20">
            
            <div class="liquid-glass p-8 mb-10 relative overflow-hidden bg-gradient-to-br from-white/60 to-white/20">
                <div class="relative z-10">
                    <span class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-4 py-1.5 rounded-xl text-[11px] font-black uppercase tracking-widest shadow-lg shadow-orange-500/30">Level 3</span>
                    <h1 class="text-4xl font-black text-gray-800 mt-4 mb-2">Nghị Luận Xã Hội</h1>
                    <p class="text-gray-500 font-medium">Viết đoạn văn 200 chữ. Đạt <span class="text-orange-600 font-bold">6.0/10 điểm</span> để qua màn.</p>
                </div>
                <i class="fas fa-pen-nib absolute -right-6 -bottom-8 text-9xl text-orange-500/10 rotate-12"></i>
            </div>

            <div class="liquid-glass p-10 mb-8">
                <h2 class="text-2xl font-black text-gray-800 mb-6">Chủ đề: Sức Mạnh Của Lòng Thấu Cảm</h2>
                
                <div class="quote-box">
                    "Thấu cảm là khả năng nhìn thế giới bằng con mắt của người khác, lắng nghe bằng đôi tai của người khác và cảm nhận bằng trái tim của người khác."
                </div>

                <p class="text-gray-700 mb-6 leading-relaxed font-medium">
                    <span class="text-orange-500 font-bold uppercase text-xs tracking-wider mr-2">Yêu cầu:</span> 
                    Hãy viết một đoạn văn (khoảng 200 chữ) trình bày suy nghĩ của anh/chị về ý nghĩa của sự thấu cảm trong cuộc sống hiện đại.
                </p>

                <div class="relative">
                    <textarea id="student-essay" class="glass-textarea" placeholder="Bắt đầu viết bài làm của bạn tại đây... (Tối thiểu 100 từ)"></textarea>
                    <div class="absolute bottom-4 right-6 text-xs font-bold text-gray-400 bg-white/50 px-2 py-1 rounded-lg backdrop-blur-sm">
                        <span id="word-count">0</span> TỪ
                    </div>
                </div>

                <div class="mt-8 text-center" id="submit-area">
                    <button onclick="submitEssay()" class="group relative inline-flex items-center justify-center px-12 py-5 font-black text-white transition-all duration-300 bg-gray-900 rounded-3xl hover:shadow-2xl hover:shadow-orange-500/30 hover:scale-105 active:scale-95 overflow-hidden">
                        <span class="text-xl relative z-10">NỘP BÀI & CHẤM ĐIỂM</span>
                        <div class="absolute inset-0 bg-gradient-to-r from-orange-500 to-red-500 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    </button>
                </div>
            </div>

            <div id="result-box" class="liquid-glass p-10 ai-result">
                <div class="flex flex-col md:flex-row items-center mb-10 border-b border-white/50 pb-8">
                    <div class="score-circle" id="score-ring">
                        <div class="score-inner">
                            <span class="text-4xl font-black text-gray-800" id="score-text">0</span>
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Điểm</span>
                        </div>
                    </div>
                    <div class="text-center md:text-left mt-6 md:mt-0 md:ml-8 flex-1">
                        <h3 class="text-3xl font-black text-gray-800 mb-2" id="result-title">Đang chấm...</h3>
                        <p class="text-gray-500 font-medium italic" id="result-desc">Giáo viên AI đang đọc bài của bạn...</p>
                    </div>
                </div>

                <div class="space-y-8">
                    <div>
                        <h4 class="font-black text-gray-700 uppercase text-xs tracking-widest mb-4 flex items-center gap-2">
                            <i class="fas fa-edit text-orange-500"></i> Sửa lỗi chi tiết
                        </h4>
                        <div id="ai-correction" class="bg-white/50 p-6 rounded-2xl border border-white leading-loose text-gray-700 text-lg shadow-inner"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-green-50/50 p-6 rounded-2xl border border-green-100/50">
                            <h4 class="font-bold text-green-700 mb-3 flex items-center gap-2"><i class="fas fa-check-circle"></i> Điểm mạnh</h4>
                            <ul id="pros-list" class="text-sm text-green-800 space-y-2 list-disc pl-4"></ul>
                        </div>
                        <div class="bg-red-50/50 p-6 rounded-2xl border border-red-100/50">
                            <h4 class="font-bold text-red-700 mb-3 flex items-center gap-2"><i class="fas fa-exclamation-circle"></i> Cần cải thiện</h4>
                            <ul id="cons-list" class="text-sm text-red-800 space-y-2 list-disc pl-4"></ul>
                        </div>
                    </div>
                </div>

                <div class="mt-10 flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="nextLevel()" id="next-btn" class="hidden w-full sm:w-auto bg-green-500 text-white px-8 py-4 rounded-2xl font-black hover:bg-green-600 transition shadow-lg shadow-green-500/30 hover:-translate-y-1">
                        MỞ KHÓA LEVEL 4 <i class="fas fa-lock-open ml-2"></i>
                    </button>
                    <button onclick="location.reload()" id="retry-btn" class="hidden w-full sm:w-auto bg-white/70 text-gray-600 px-8 py-4 rounded-2xl font-black hover:bg-white transition shadow-sm border border-gray-200">
                        LÀM LẠI BÀI <i class="fas fa-redo ml-2"></i>
                    </button>
                </div>
            </div>

        </div>
    </main>

    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-md z-[2000] hidden flex-col items-center justify-center transition-all">
        <div class="relative w-24 h-24">
            <div class="absolute inset-0 border-4 border-gray-200 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-orange-500 rounded-full border-t-transparent animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center text-3xl"></div>
        </div>
        <h3 class="font-black text-2xl mt-6 text-gray-800">AI ĐANG CHẤM BÀI...</h3>
        <p class="text-gray-500 mt-2 font-medium">Đang phân tích ý tưởng và diễn đạt</p>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAJ9C2biYeiLPmhakzLZ4mEqfO9_VgPSZE", authDomain: "hopvan-9a648.firebaseapp.com", projectId: "hopvan-9a648", storageBucket: "hopvan-9a648.appspot.com", messagingSenderId: "429347196227", appId: "1:429347196227:web:917b8d019f0efd0f7833f6", measurementId: "G-1BG8PSRG0R" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const API_URL = `../.netlify/functions/gemini-proxy`;
    let userUid = null;

    onAuthStateChanged(auth, (u) => {
        if (u) userUid = u.uid;
        else window.location.href = "../log.html";
    });

    // Fetch Menu
    fetch('menu.html').then(r=>r.text()).then(h=>{
        const p = document.getElementById('menu-placeholder'); p.innerHTML=h;
        p.querySelectorAll('script').forEach(s=>{const n=document.createElement('script');n.text=s.text;document.body.appendChild(n)});
    });

    window.submitEssay = async () => {
        const content = document.getElementById('student-essay').value.trim();
        const wordCount = content.split(/\s+/).filter(x => x).length;

        if (wordCount < 50) return alert("Bài viết quá ngắn! Hãy viết ít nhất 50 từ.");

        document.getElementById('loading-overlay').style.display = 'flex';

        // Prompt chấm NLXH
        const systemPrompt = `
            VAI TRÒ: Giáo viên Ngữ Văn chấm bài Nghị Luận Xã Hội (Đoạn văn 200 chữ).
            ĐỀ BÀI: "Sức mạnh của lòng thấu cảm".
            
            TIÊU CHÍ CHẤM (Thang 10):
            1. Bố cục (2.0): Mở đoạn, Thân đoạn, Kết đoạn rõ ràng.
            2. Nội dung (4.0): Giải thích, Bàn luận, Dẫn chứng, Phản đề/Bài học.
            3. Diễn đạt (2.0): Trôi chảy, không sai chính tả/ngữ pháp.
            4. Sáng tạo (2.0): Có giọng văn riêng, dẫn chứng mới mẻ.

            BÀI LÀM CỦA HỌC SINH:
            "${content}"

            YÊU CẦU JSON DUY NHẤT (Không Markdown):
            {
                "score": (Số thực, max 10.0),
                "title": "Nhận xét ngắn (VD: Tốt, Khá, Cần cố gắng)",
                "desc": "Lời khuyên tổng quát (1 câu)",
                "correction_html": "Bài làm gốc nhưng thêm thẻ <span class='text-bad'>lỗi</span> <span class='text-fix'>sửa</span> và <span class='text-good'>ý hay</span>.",
                "pros": ["Điểm mạnh 1", "Điểm mạnh 2"],
                "cons": ["Điểm yếu 1", "Điểm yếu 2"]
            }
        `;

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] })
            });

            const data = await response.json();
            
            if (data.error) throw new Error(data.error.message);
            if (!data.candidates || data.candidates.length === 0) throw new Error("AI không trả lời.");

            const rawText = data.candidates[0].content.parts[0].text;
            const res = JSON.parse(rawText.replace(/```json|```/g, "").trim());

            // Render Kết quả
            document.getElementById('result-box').style.display = 'block';
            document.getElementById('submit-area').style.display = 'none';
            document.getElementById('result-box').scrollIntoView({ behavior: 'smooth' });

            const score = res.score;
            document.getElementById('score-text').innerText = score;
            document.getElementById('result-title').innerText = res.title;
            document.getElementById('result-desc').innerText = res.desc;
            document.getElementById('ai-correction').innerHTML = res.correction_html;

            document.getElementById('pros-list').innerHTML = res.pros.map(i => `<li>${i}</li>`).join('');
            document.getElementById('cons-list').innerHTML = res.cons.map(i => `<li>${i}</li>`).join('');

            // Màu sắc & Unlock
            const titleEl = document.getElementById('result-title');
            const ringEl = document.getElementById('score-ring');

            if (score >= 6.0) {
                titleEl.className = "text-3xl font-black text-green-600 mb-2";
                ringEl.style.background = `conic-gradient(#10B981 ${score*10}%, rgba(255,255,255,0.5) 0%)`;
                document.getElementById('next-btn').classList.remove('hidden');
                document.getElementById('next-btn').classList.add('flex');
            } else {
                titleEl.className = "text-3xl font-black text-red-500 mb-2";
                ringEl.style.background = `conic-gradient(#EF4444 ${score*10}%, rgba(255,255,255,0.5) 0%)`;
                document.getElementById('retry-btn').classList.remove('hidden');
                document.getElementById('retry-btn').classList.add('flex');
            }

            // Lưu Database
            if(userUid) {
                await addDoc(collection(db, "activities"), {
                    uid: userUid,
                    action: `NLXH Level 3: ${score}/10 điểm`,
                    score: score,
                    timestamp: serverTimestamp()
                });

                if (score >= 6.0) {
                    const userRef = doc(db, "users_progress", userUid);
                    const snap = await getDoc(userRef);
                    if(!snap.exists() || snap.data().currentLevel < 4) {
                        await setDoc(userRef, { currentLevel: 4, lastPassed: serverTimestamp() }, { merge: true });
                    }
                }
            }

        } catch (e) {
            console.error(e);
            alert("Lỗi: " + e.message);
        } finally {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    };

    window.nextLevel = () => window.location.href = "../dashboard/nhatkyhoctap.html";

    // Word Count
    document.getElementById('student-essay').oninput = function() {
        const words = this.value.trim().split(/\s+/).filter(x => x).length;
        document.getElementById('word-count').innerText = words;
    };

    // Timer Logic (45 mins)
    let totalSeconds = 2700; 
    const timerCircle = document.getElementById('timer-circle');
    const timerText = document.getElementById('timer-text');
    const timerMini = document.getElementById('timer-mini');

    setInterval(() => {
        if(totalSeconds > 0) {
            totalSeconds--;
            const m = Math.floor(totalSeconds / 60);
            const s = totalSeconds % 60;
            
            timerText.innerText = `${m} phút ${s < 10 ? '0'+s : s} giây`;
            timerMini.innerText = m;

            const percent = (totalSeconds / 2700) * 100;
            timerCircle.setAttribute('stroke-dasharray', `${percent}, 100`);
            
            if(totalSeconds < 300) timerCircle.classList.replace('text-orange-500', 'text-red-500');
        } else {
            submitEssay();
        }
    }, 1000);
</script>

</body>
</html>