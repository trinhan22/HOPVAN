<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level 10: ƒê·ªçc Hi·ªÉu VƒÉn B·∫£n</title>
    <link rel="icon" type="image/webp" href="../LOGO.WEBP" />
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root { --primary: #FF8F50; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            min-height: 100vh; 
            display: block; 
            color: #334155;
            background: radial-gradient(at 0% 0%, hsla(25,100%,95%,1) 0, transparent 50%), 
                        radial-gradient(at 100% 100%, hsla(15,100%,96%,1) 0, transparent 50%), 
                        #fff9f5;
        }

        /* --- BACKGROUND --- */
        .bg-blob { position: fixed; filter: blur(80px); z-index: -1; opacity: 0.6; animation: float 25s infinite alternate ease-in-out; }
        .blob-1 { top: -5%; left: -5%; width: 500px; height: 500px; background: #ffe4d3; animation-delay: -5s; }
        .blob-2 { bottom: 5%; right: -5%; width: 400px; height: 400px; background: #ffdec2; }
        @keyframes float { 0% { transform: translate(0, 0) rotate(0deg); } 100% { transform: translate(40px, 40px) rotate(15deg); } }

        .main-content { 
            width: 100%; 
            padding: 20px; 
            min-height: 100vh; 
            position: relative; 
            max-width: 850px; /* G·ªçn g√†ng nh∆∞ Level 4 */
            margin: 0 auto;
        }

        /* --- GLASS UI --- */
        .glass-header {
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 4px 30px rgba(0,0,0,0.05);
            border-radius: 9999px; transition: all 0.3s;
        }
        .liquid-glass {
            background: rgba(255, 255, 255, 0.7);
            box-shadow: 0 10px 40px -10px rgba(255, 130, 60, 0.1), inset 0 0 0 1px rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 24px; transition: transform 0.3s; margin-bottom: 2rem;
        }

        /* --- CONTENT STYLES --- */
        /* Ng·ªØ li·ªáu: Font Merriweather, CƒÉn ƒë·ªÅu */
        .passage-content {
            font-family: 'Merriweather', serif; 
            line-height: 1.8; 
            color: #374151; 
            font-size: 1.05rem;
            text-align: justify; /* CƒÉn ƒë·ªÅu */
        }
        .passage-content p { margin-bottom: 0.8rem; }
        .passage-content strong { font-weight: 700; color: #1f2937; }
        .passage-content em { font-style: italic; }
        .passage-content blockquote { border-left: 4px solid var(--primary); padding-left: 1rem; margin: 1rem 0; font-style: italic; background: #fff7ed; padding: 10px; }

        .glass-input {
            width: 100%; 
            background: #FFFFFF !important; 
            border: 1px solid #e2e8f0; 
            border-radius: 16px; 
            padding: 16px; 
            font-size: 1rem; 
            transition: 0.2s ease-in-out; 
            color: #1E293B;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.01);
            resize: none;
            text-align: justify; /* B√†i l√†m c≈©ng cƒÉn ƒë·ªÅu cho ƒë·∫πp */
        }
        .glass-input:focus { 
            border-color: var(--primary); 
            outline: none; 
            box-shadow: 0 0 0 4px rgba(255, 143, 80, 0.15); 
        }

        /* C√¢u h·ªèi: Font th∆∞·ªùng, cƒÉn ƒë·ªÅu */
        .q-label { 
            color: #334155; 
            font-weight: 500; /* Font th∆∞·ªùng */
            margin-bottom: 8px; 
            display: block; 
            font-size: 1rem; 
            text-align: justify; /* CƒÉn ƒë·ªÅu */
            line-height: 1.6;
        }

        /* --- AI RESULT --- */
        .ai-result { display: none; margin-top: 30px; animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        .score-circle {
            width: 100px; height: 100px; border-radius: 50%;
            background: conic-gradient(var(--primary) 0%, rgba(255,255,255,0.5) 0%);
            display: flex; align-items: center; justify-content: center;
            position: relative; margin-right: 20px; flex-shrink: 0;
            box-shadow: 0 10px 30px rgba(255, 143, 80, 0.2);
        }
        .score-inner {
            width: 80px; height: 80px; background: white; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .badge-correct { background: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 800; }
        .badge-partial { background: #fefce8; color: #ca8a04; border: 1px solid #fde047; padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 800; }
        .badge-wrong { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 800; }

        /* --- POPUP & LOADING --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(6px);
            z-index: 9999; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal-box {
            background: white; width: 90%; max-width: 450px; border-radius: 24px;
            padding: 32px; text-align: center; position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-overlay.open .modal-box { transform: scale(1); }

        .icon-box {
            width: 64px; height: 64px; border-radius: 50%; margin: 0 auto 16px;
            display: flex; align-items: center; justify-content: center; font-size: 2rem;
        }
        .icon-warning { background: #ffedd5; color: #f97316; }
        .icon-error { background: #fee2e2; color: #ef4444; }
        .icon-info { background: #dbeafe; color: #3b82f6; }

        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); z-index: 20000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .loader-robot { font-size: 5rem; color: var(--primary); animation: robotBounce 1s infinite alternate; }
        @keyframes robotBounce { from { transform: translateY(0); } to { transform: translateY(-15px); } }

        @media (max-width: 640px) { .main-content { padding: 16px; } }


/* --- GLOBAL SCROLLBAR STYLE --- */

/* 1. Thi·∫øt l·∫≠p ƒë·ªô r·ªông/cao c·ªßa thanh tr∆∞·ª£t */
::-webkit-scrollbar {
    width: 10px;  /* ƒê·ªô r·ªông cho thanh d·ªçc */
    height: 10px; /* ƒê·ªô cao cho thanh ngang */
}

/* 2. Thi·∫øt l·∫≠p r√£nh tr∆∞·ª£t (Track) - N·ªÅn ch√¨m */
::-webkit-scrollbar-track {
    background: rgba(255, 143, 80, 0.05); /* M√†u cam c·ª±c nh·∫°t, g·∫ßn nh∆∞ trong su·ªët */
    border-radius: 10px;
}

/* 3. Thi·∫øt l·∫≠p tay n·∫Øm (Thumb) - Ph·∫ßn di chuy·ªÉn */
::-webkit-scrollbar-thumb {
    background-color: rgba(255, 143, 80, 0.3); /* M·∫∑c ƒë·ªãnh l√† cam nh·∫°t */
    border-radius: 10px; /* Bo tr√≤n m·ªÅm m·∫°i */
    
    /* M·∫πo: T·∫°o vi·ªÅn trong su·ªët ƒë·ªÉ thanh tr∆∞·ª£t tr√¥ng nh·ªè h∆°n v√† "l∆° l·ª≠ng" */
    border: 2px solid transparent;
    background-clip: content-box;
    transition: background-color 0.3s ease;
}

/* 4. Hi·ªáu ·ª©ng khi di chu·ªôt v√†o (Hover) */
::-webkit-scrollbar-thumb:hover {
    background-color: #FF8F50; /* ƒê·ªïi sang m√†u cam ch√≠nh th∆∞∆°ng hi·ªáu */
    border: 1px solid transparent; /* L√†m thanh tr∆∞·ª£t to ra m·ªôt ch√∫t khi hover */
}

/* 5. (T√πy ch·ªçn) ·∫®n n√∫t m≈©i t√™n 2 ƒë·∫ßu (n·∫øu tr√¨nh duy·ªát hi·ªÉn th·ªã) */
::-webkit-scrollbar-button {
    display: none;
}

/* --- FULLSCREEN POPUP NEON SYNC --- */
        .fs-modal-box {
            background: white; 
            padding: 45px 35px; 
            border-radius: 32px; 
            width: 90%; 
            max-width: 420px; 
            text-align: center;
            position: relative;
            border: 2px solid rgba(255, 143, 80, 0.2);
            box-shadow: 0 20px 60px rgba(255, 107, 107, 0.15), 0 0 30px rgba(255, 143, 80, 0.1);
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .fs-icon-wrap {
            width: 80px; height: 80px;
            margin: 0 auto 25px;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem;
            background: linear-gradient(135deg, #FF8F50 0%, #FF6B6B 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 8px 15px rgba(255, 107, 107, 0.3));
        }

        .btn-neon-fs {
            width: 100%;
            padding: 16px;
            border-radius: 18px;
            background: linear-gradient(135deg, #FF8F50 0%, #FF6B6B 100%);
            color: white;
            font-weight: 800;
            font-size: 1.1rem;
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.3);
            transition: 0.3s;
            border: none;
            cursor: pointer;
        }

        .btn-neon-fs:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(255, 107, 107, 0.5);
            filter: brightness(1.1);
        }
    </style>
</head>
<body>

    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>

    <div id="alert-modal" class="modal-overlay">
        <div class="modal-box">
            <div id="alert-icon-box" class="icon-box icon-warning">
                <i id="alert-icon" class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 id="alert-title" class="text-xl font-bold text-gray-800 mb-2">Th√¥ng b√°o</h3>
            <p id="alert-msg" class="text-gray-500 text-sm mb-6">N·ªôi dung th√¥ng b√°o...</p>
            <div id="alert-actions" class="flex gap-3 justify-center"></div>
        </div>
    </div>

    <div id="fullscreen-popup" class="modal-overlay" style="display: none; z-index: 50000; background: rgba(255, 245, 236, 0.7); backdrop-filter: blur(8px);">
        <div class="fs-modal-box">
            <div class="fs-icon-wrap">
                <i class="fas fa-expand-arrows-alt"></i>
            </div>
            <h3 class="text-2xl font-black text-gray-800 mb-2">Ch·∫ø ƒë·ªô L√†m b√†i thi</h3>
            <p class="text-gray-500 leading-relaxed mb-8 px-4">ƒê·ªÉ ƒë·∫£m b·∫£o s·ª± t·∫≠p trung cao nh·∫•t, h·ªá th·ªëng s·∫Ω chuy·ªÉn sang <b>To√†n m√†n h√¨nh</b>.</p>
            <div class="modal-actions">
                <button onclick="enableFullscreen()" class="btn-neon-fs">Ti·∫øp t·ª•c</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="loading-overlay">
        <div class="loader-robot"><i class="fas fa-robot"></i></div>
    </div>

    <main class="main-content">
        <div class="sticky top-4 z-50 mb-8 px-2">
            <div class="max-w-6xl mx-auto glass-header px-6 py-3 flex justify-between items-center bg-white/80">
                <a href="../dashboard/nhatkyhoctap.html" class="flex items-center gap-3 text-gray-600 font-bold hover:text-orange-500 transition group">
                    <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center shadow-sm text-orange-400 group-hover:scale-110 transition-transform">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <span class="hidden sm:inline text-sm">Quay l·∫°i l·ªô tr√¨nh</span>
                </a>
                
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Th·ªùi gian c√≤n l·∫°i</p>
                        <p class="text-base font-black text-gray-800" id="timer-text">30:00</p>
                    </div>
                    <div class="w-12 h-12 rounded-full flex items-center justify-center shadow-lg relative overflow-hidden bg-white">
                        <svg class="w-10 h-10 absolute" viewBox="0 0 36 36">
                            <path class="text-gray-200" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="4" />
                            <path class="text-orange-500 transition-all duration-1000 ease-linear" stroke-dasharray="100, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="4" id="timer-circle" />
                        </svg>
                        <span class="text-xs font-black relative z-10 text-gray-700" id="timer-mini">30</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-3xl mx-auto pb-20">
            <div class="liquid-glass p-8 mb-10 relative overflow-hidden bg-gradient-to-br from-white/90 to-white/60">
                <div class="relative z-10">
                    <span class="bg-orange-100 text-orange-600 px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-widest">Level 10</span>
                    <h1 id="lvl-title-display" class="text-3xl font-bold text-gray-800 mt-3 mb-2">ƒêang t·∫£i th·ª≠ th√°ch...</h1>
                    <p class="text-gray-500 font-medium text-sm">Y√™u c·∫ßu: ƒê·∫°t t·ªëi thi·ªÉu <span class="text-orange-600 font-bold">6.0 ƒëi·ªÉm</span> ƒë·ªÉ qua m√†n.</p>
                </div>
                <i class="fas fa-book-open absolute -right-6 -bottom-8 text-8xl text-orange-500/10 rotate-12"></i>
            </div>

            <div class="liquid-glass p-8 md:p-10 mb-8 bg-white border border-orange-100">
                <div class="relative z-10">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-8 h-8 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-sm"><i class="fas fa-quote-left"></i></div>
                        <h3 class="font-bold text-gray-500 uppercase text-xs tracking-widest">VƒÉn b·∫£n ƒë·ªçc hi·ªÉu</h3>
                    </div>
                    <div id="prompt-passage" class="passage-content"></div> 
                </div>
            </div>

            <div id="questions-form" class="space-y-6"></div>

            <div class="mt-10 text-center" id="submit-area">
                <button onclick="confirmSubmission()" class="group relative inline-flex items-center justify-center px-10 py-4 font-bold text-white transition-all duration-300 bg-gray-800 rounded-2xl hover:shadow-xl hover:shadow-orange-500/20 hover:-translate-y-1 active:scale-95 overflow-hidden">
                    <span class="relative z-10 flex items-center gap-2">N·ªòP B√ÄI & CH·∫§M ƒêI·ªÇM <i class="fas fa-paper-plane"></i></span>
                    <div class="absolute inset-0 bg-gradient-to-r from-orange-500 to-red-500 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                </button>
            </div>

            <div id="result-box" class="liquid-glass p-8 ai-result bg-white/90">
                <div class="flex flex-col md:flex-row items-center mb-8 border-b border-gray-100 pb-8">
                    <div class="score-circle" id="score-ring">
                        <div class="score-inner">
                            <span class="text-4xl font-bold text-gray-800" id="score-text">0</span>
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">ƒêi·ªÉm</span>
                        </div>
                    </div>
                    <div class="text-center md:text-left mt-4 md:mt-0 flex-1">
                        <h3 class="text-2xl font-bold text-gray-800 mb-1" id="result-title">K·∫øt qu·∫£</h3>
                        <p class="text-gray-500 font-medium text-sm">Nh·∫≠n x√©t chi ti·∫øt t·ª´ AI</p>
                    </div>
                </div>
                
                <div id="feedback-content" class="space-y-4"></div>
                
                <div class="mt-8 flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="nextLevel()" id="next-btn" class="hidden w-full sm:w-auto bg-green-500 text-white px-8 py-3 rounded-xl font-bold hover:bg-green-600 transition shadow-lg shadow-green-200">M·ªü Kh√≥a Level 11 <i class="fas fa-lock-open ml-2"></i></button>
                    <button onclick="location.reload()" id="retry-btn" class="hidden w-full sm:w-auto bg-gray-100 text-gray-600 px-8 py-3 rounded-xl font-bold hover:bg-gray-200 transition">L√†m L·∫°i B√†i <i class="fas fa-redo ml-2"></i></button>
                </div>
            </div>
        </div>
    </main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAJ9C2biYeiLPmhakzLZ4mEqfO9_VgPSZE", authDomain: "hopvan-9a648.firebaseapp.com", projectId: "hopvan-9a648", storageBucket: "hopvan-9a648.appspot.com", messagingSenderId: "429347196227", appId: "1:429347196227:web:917b8d019f0efd0f7833f6", measurementId: "G-1BG8PSRG0R" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const API_URL = `/.netlify/functions/gemini-proxy`;
    let userUid = null;
    let levelData = null; 

    // --- POPUP FUNCTION ---
    window.showPopup = (type, title, msg, confirmCallback = null) => {
        const modal = document.getElementById('alert-modal');
        const actions = document.getElementById('alert-actions');
        const iconBox = document.getElementById('alert-icon-box');
        const icon = document.getElementById('alert-icon');

        document.getElementById('alert-title').innerText = title;
        document.getElementById('alert-msg').innerText = msg;
        
        iconBox.className = "icon-box";
        if (type === 'warning') { iconBox.classList.add('icon-warning'); icon.className = "fas fa-exclamation-triangle"; }
        else if (type === 'error') { iconBox.classList.add('icon-error'); icon.className = "fas fa-times-circle"; }
        else { iconBox.classList.add('icon-info'); icon.className = "fas fa-info-circle"; }

        actions.innerHTML = "";
        if (confirmCallback) {
            const b1 = document.createElement('button'); b1.className = "px-6 py-3 rounded-xl font-bold bg-gray-100 text-gray-600 hover:bg-gray-200 transition text-sm";
            b1.innerText = "Ki·ªÉm tra l·∫°i"; b1.onclick = () => modal.classList.remove('open');
            const b2 = document.createElement('button'); b2.className = "px-6 py-3 rounded-xl font-bold bg-orange-500 text-white shadow-lg hover:bg-orange-600 transition text-sm";
            b2.innerText = "N·ªôp b√†i"; b2.onclick = () => { modal.classList.remove('open'); confirmCallback(); };
            actions.append(b1, b2);
        } else {
            const b = document.createElement('button'); b.className = "px-8 py-3 rounded-xl font-bold bg-gray-800 text-white hover:bg-gray-700 transition text-sm";
            b.innerText = "ƒê√£ hi·ªÉu"; b.onclick = () => modal.classList.remove('open');
            actions.appendChild(b);
        }
        modal.classList.add('open');
    };

    onAuthStateChanged(auth, (u) => {
        if (u) { userUid = u.uid; initLevelData(); }
        else { showPopup('info', 'Y√™u c·∫ßu ƒëƒÉng nh·∫≠p', 'B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u k·∫øt qu·∫£.', () => window.location.href = "../log.html"); }
    });

    // --- 1. T·∫¢I D·ªÆ LI·ªÜU ---
    async function initLevelData() {
        try {
            const q = query(collection(db, "study_levels"), where("level", "==", 10));
            const snap = await getDocs(q);
            
            if (snap.empty) {
                document.getElementById('lvl-title-display').innerText = "Ch∆∞a c√≥ d·ªØ li·ªáu";
                document.getElementById('prompt-passage').innerHTML = "<p class='text-center text-red-500'>Ch∆∞a t·∫°o n·ªôi dung cho Level 10.</p>";
                return;
            }
            
            const docSnap = snap.docs[0].data();
            levelData = docSnap.content; 

            document.getElementById('lvl-title-display').innerText = levelData.title || "B√†i t·∫≠p ƒê·ªçc Hi·ªÉu";
            document.getElementById('prompt-passage').innerHTML = levelData.text || "";

            const form = document.getElementById('questions-form');
            form.innerHTML = "";
            if (levelData.questions && Array.isArray(levelData.questions)) {
                levelData.questions.forEach((qItem, i) => {
                    const div = document.createElement('div');
                    div.className = "liquid-glass p-6 md:p-8 bg-white border border-gray-100";
                    div.innerHTML = `
                        <label class="q-label flex gap-3 items-start">
                            <span class="bg-orange-100 text-orange-600 px-3 py-1 rounded-lg text-sm font-bold h-fit whitespace-nowrap flex-shrink-0">C√¢u ${i+1}</span>
                            <span class="text-gray-800 font-medium pt-0.5">${qItem.q}</span>
                        </label>
                        <textarea class="glass-input h-32 w-full mt-2" id="ans-${i}" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n v√†o ƒë√¢y..."></textarea>
                    `;
                    form.appendChild(div);
                });
            }
        } catch (e) { console.error(e); }
    }

    // --- 2. CH·∫§M ƒêI·ªÇM AI (ƒê√É FIX PROXY GROQ & SANITIZATION) ---
    window.confirmSubmission = () => {
        if(!levelData) return;
        let filledCount = 0;
        const total = levelData.questions.length;
        levelData.questions.forEach((_, i) => { if (document.getElementById(`ans-${i}`).value.trim()) filledCount++; });

        if (filledCount < total) {
            showPopup('warning', 'Ch∆∞a ho√†n th√†nh', `B·∫°n m·ªõi tr·∫£ l·ªùi ${filledCount}/${total} c√¢u. B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i kh√¥ng?`, handleRealSubmit);
        } else {
            showPopup('warning', 'X√°c nh·∫≠n n·ªôp b√†i', 'H·ªá th·ªëng AI s·∫Ω ch·∫•m ƒëi·ªÉm b√†i l√†m c·ªßa b·∫°n.', handleRealSubmit);
        }
    };

    const handleRealSubmit = async () => {
        document.getElementById('loading-overlay').style.display = 'flex';
        
        // Gom c√¢u tr·∫£ l·ªùi t·ª´ c√°c √¥ textarea
        const studentAnswers = levelData.questions.map((q, i) => 
            `C√¢u ${i+1} (ƒê·ªÅ: ${q.q}):\nTr·∫£ l·ªùi: ${document.getElementById(`ans-${i}`).value}`
        ).join('\n\n');

        // PROMPT CHU·∫®N JSON
        const systemPrompt = `
        B·∫†N L√Ä: Gi√°o vi√™n Ng·ªØ VƒÉn ch·∫•m thi nghi√™m t√∫c.
        NHI·ªÜM V·ª§: Ch·∫•m ƒëi·ªÉm b√†i ƒë·ªçc hi·ªÉu (Thang 10).
        
        NG·ªÆ LI·ªÜU G·ªêC: """${(levelData.text || '').replace(/"/g, "'")}"""
        
        Y√™u c·∫ßu Output JSON (DUY NH·∫§T, KH√îNG MARKDOWN):
        {
            "score": (s·ªë ƒëi·ªÉm th·ª±c tr√™n thang 10, l√†m tr√≤n 0.5),
            "feedback": [
                { "q": "C√¢u 1", "status": "correct" (ƒë√∫ng) | "partial" (thi·∫øu √Ω) | "wrong" (sai), "comment": "Nh·∫≠n x√©t ng·∫Øn g·ªçn l·ªói sai ho·∫∑c √Ω hay" }
            ],
            "advice": "L·ªùi khuy√™n chung ng·∫Øn g·ªçn (t·ªëi ƒëa 2 c√¢u)"
        }
        `;

        try {
            // G·ª≠i API v·ªõi c·∫•u tr√∫c Messages (Kh·ªõp v·ªõi Proxy)
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    systemPrompt: systemPrompt,
                    messages: `B√ÄI L√ÄM H·ªåC SINH:\n${studentAnswers}`
                })
            });
            
            if (!response.ok) throw new Error("SERVER_ERROR");

            const data = await response.json();
            
            if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                throw new Error("NO_CONTENT");
            }

            let rawText = data.choices[0].message.content;
            rawText = rawText.replace(/```json/g, "").replace(/```/g, "").trim();
            
            const res = JSON.parse(rawText);

            // --- V·ªÜ SINH D·ªÆ LI·ªÜU (QUAN TR·ªåNG ƒê·ªÇ KH√îNG B·ªä L·ªñI FIREBASE) ---
            // √âp ki·ªÉu score v·ªÅ s·ªë
            let safeScore = parseFloat(res.score);
            if (isNaN(safeScore)) safeScore = 0;
            if (safeScore > 10) safeScore = 10;
            res.score = safeScore; // G√°n l·∫°i gi√° tr·ªã chu·∫©n v√†o object

            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            showResultUI(res);
            
            // L∆∞u v√†o Firebase
            if(userUid) {
                await addDoc(collection(db, "activities"), { 
                    uid: userUid, 
                    userName: auth.currentUser.displayName || "User",
                    examTitle: levelData.title, 
                    action: `ƒê·ªçc hi·ªÉu Level 10: ${safeScore}ƒë`, 
                    type: "journal", 
                    score: safeScore, // Ch·∫Øc ch·∫Øn l√† s·ªë
                    timestamp: serverTimestamp() 
                });
                
                // Logic m·ªü kh√≥a Level 3
                if(safeScore >= 6) {
                    await setDoc(doc(db, "users_progress", userUid), { currentLevel: 11, lastPassed: serverTimestamp() }, { merge: true });
                }
            }
        } catch (e) { 
            console.error(e);
            let msg = "C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!";
            if (e.message === "SERVER_ERROR") msg = "Server AI ƒëang b·∫≠n.";
            if (e.name === "SyntaxError") msg = "D·ªØ li·ªáu tr·∫£ v·ªÅ b·ªã l·ªói. H√£y b·∫•m n·ªôp l·∫°i.";
            showPopup('error', 'L·ªói ch·∫•m b√†i', msg); 
        } finally { 
            document.getElementById('loading-overlay').style.display = 'none'; 
        }
    };

    function showResultUI(res) {
        document.getElementById('result-box').style.display = 'block';
        document.getElementById('submit-area').style.display = 'none';
        document.getElementById('result-box').scrollIntoView({ behavior: 'smooth' });

        document.getElementById('score-text').innerText = res.score;
        const title = document.getElementById('result-title');
        const ring = document.getElementById('score-ring');
        
        if (res.score >= 6) {
            title.innerText = "ƒê·∫†T Y√äU C·∫¶U"; title.className = "text-2xl font-bold text-green-600 mb-1";
            ring.style.background = `conic-gradient(#10B981 ${res.score*10}%, #eee 0%)`;
            document.getElementById('next-btn').classList.remove('hidden');
        } else {
            title.innerText = "CH∆ØA ƒê·∫†T"; title.className = "text-2xl font-bold text-red-500 mb-1";
            ring.style.background = `conic-gradient(#EF4444 ${res.score*10}%, #eee 0%)`;
            document.getElementById('retry-btn').classList.remove('hidden');
        }

        const mapStatus = { "correct": "badge-correct", "partial": "badge-partial", "wrong": "badge-wrong" };
        const mapText = { "correct": "ƒê√öNG", "partial": "THI·∫æU √ù", "wrong": "SAI" };

        document.getElementById('feedback-content').innerHTML = (res.feedback || []).map(f => `
            <div class="bg-white/60 rounded-2xl p-5 border border-white shadow-sm mb-3">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-gray-800 text-sm">${f.q || "C√¢u h·ªèi"}</span>
                    <span class="${mapStatus[f.status] || ''}">${mapText[f.status] || "Xem x√©t"}</span>
                </div>
                <p class="text-sm text-gray-600 italic">${f.comment}</p>
            </div>
        `).join('') + `<div class="bg-orange-50 p-4 rounded-xl text-sm italic mt-4 text-gray-600 border border-orange-100">üí° ${res.advice || "C·ªë g·∫Øng l√™n nh√©!"}</div>`;
    }

    window.nextLevel = () => window.location.href = "../dashboard/nhatkyhoctap.html";

    // Timer
    let totalSeconds = 1800; 
    const timerText = document.getElementById('timer-text');
    const timerMini = document.getElementById('timer-mini');
    const timerCircle = document.getElementById('timer-circle');
    const interval = setInterval(() => {
        if(totalSeconds > 0) {
            totalSeconds--;
            const m = Math.floor(totalSeconds / 60);
            const s = totalSeconds % 60;
            timerText.innerText = `${m}:${s<10?'0'+s:s}`;
            timerMini.innerText = m;
            timerCircle.setAttribute('stroke-dasharray', `${(totalSeconds / 1800) * 100}, 100`);
        } else {
            clearInterval(interval);
            showPopup('warning', 'H·∫øt gi·ªù!', 'H·ªá th·ªëng t·ª± ƒë·ªông n·ªôp b√†i.', handleRealSubmit);
        }
    }, 1000);

// --- FULLSCREEN LOGIC ---
    window.enableFullscreen = () => {
        const elem = document.documentElement;
        if (elem.requestFullscreen) {
            elem.requestFullscreen();
        } else if (elem.webkitRequestFullscreen) { /* Safari */
            elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) { /* IE11 */
            elem.msRequestFullscreen();
        }
        // ƒê√≥ng popup
        const popup = document.getElementById('fullscreen-popup');
        popup.classList.remove('open');
        setTimeout(() => { popup.style.display = 'none'; }, 300);
    };

    // T·ª± ƒë·ªông hi·ªán popup sau khi trang ƒë√£ load v√† user ƒë√£ ƒëƒÉng nh·∫≠p
    window.addEventListener('load', () => {
        if (!document.fullscreenElement) {
            setTimeout(() => {
                const fsPopup = document.getElementById('fullscreen-popup');
                fsPopup.style.display = 'flex';
                setTimeout(() => fsPopup.classList.add('open'), 10);
            }, 800); 
        }
    });
</script>
</body>
</html>