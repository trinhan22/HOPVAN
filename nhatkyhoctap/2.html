<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Level 2: Giá trị thời gian</title>
    <meta property="og:title" content="HOPVAN - Nền Tảng Học & Luyện Thi Ngữ Văn" />
    <meta property="og:description" content="Nền tảng học tập Ngữ Văn tích hợp AI – hỗ trợ tự học thông minh, phân tích tác phẩm, luyện viết hiệu quả." />
    <meta property="og:image" content="https://hopvan.netlify.app/panel.webp" />
    <meta property="og:url" content="https://hopvan.netlify.app" />
    <meta property="og:type" content="article" />
    <link rel="icon" type="image/webp" href="../LOGO.WEBP" />

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root { --primary: #FF8F50; --primary-gradient: linear-gradient(135deg, #FF8F50, #FF5E62); --sidebar-width: 280px; }
        * { font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background-color: #FFF5EC; min-height: 100vh; display: flex; }

        #menu-placeholder { width: var(--sidebar-width); flex-shrink: 0; }
        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; }

        .exam-card { background: white; border-radius: 35px; padding: 40px; border: 1px solid rgba(255, 143, 80, 0.2); box-shadow: 0 15px 35px rgba(255, 143, 80, 0.05); }
        .editor-container { background: white; border-radius: 30px; border: 2px solid #f0f0f0; overflow: hidden; transition: 0.3s; }
        .editor-container:focus-within { border-color: var(--primary); box-shadow: 0 10px 30px rgba(255, 143, 80, 0.1); }
        
        .writing-area { width: 100%; height: 450px; padding: 30px; border: none; outline: none; resize: none; font-size: 1.15rem; line-height: 2; color: #2d3436; background: #fafafa; }

        /* AI Feedback Styles */
        .text-good { color: #10B981; background: #ECFDF5; font-weight: 600; padding: 2px 4px; border-radius: 6px; }
        .text-bad { color: #EF4444; background: #FEF2F2; text-decoration: line-through; padding: 2px 4px; border-radius: 6px; }
        .text-fix { color: #3B82F6; font-weight: 700; font-style: italic; }

        .score-circle { width: 100px; height: 100px; border-radius: 50%; border: 8px solid #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 900; }

        @media (max-width: 1024px) { #menu-placeholder { display: none; } .main-content { padding: 20px; } }
    </style>
</head>
<body>

    <div id="menu-placeholder"></div>

    <main class="main-content">
        <div class="flex justify-between items-center mb-8">
            <a href="../dashboard/nhatkyhoctap.html" class="bg-white px-5 py-2.5 rounded-2xl font-bold text-gray-500 hover:text-orange-500 shadow-sm transition-all flex items-center gap-2">
                <i class="fas fa-arrow-left"></i> Quay lại lộ trình
            </a>
            <div class="flex items-center gap-4">
                <div class="bg-black text-white px-6 py-2.5 rounded-2xl font-black flex items-center gap-3">
                    <i class="fas fa-clock text-orange-400"></i> <span id="timer">45:00</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            <div class="space-y-6">
                <div class="exam-card">
                    <span class="bg-orange-500 text-white px-4 py-1.5 rounded-xl font-black text-xs uppercase tracking-widest">Level 2: Nghị luận xã hội</span>
                    <h2 class="text-3xl font-black text-gray-800 mt-4 mb-6 leading-tight">Chủ đề: Giá trị của thời gian</h2>
                    
                    <div class="p-6 bg-orange-50 rounded-3xl border-2 border-orange-100 italic text-gray-700 leading-relaxed mb-6">
                        "Thời gian là thứ tài sản quý giá nhất mà bạn không bao giờ có thể lấy lại được một khi đã đánh mất. Đừng lãng phí nó vào những việc vô bổ."
                    </div>

                    <div class="space-y-4 text-gray-800">
                        <p class="font-bold text-lg"><i class="fas fa-pen-nib text-orange-500 mr-2"></i> Yêu cầu đề bài:</p>
                        <p class="text-lg leading-relaxed">Hãy viết một đoạn văn (khoảng 200 chữ) trình bày suy nghĩ của anh/chị về <strong>tầm quan trọng của việc trân trọng thời gian</strong> đối với thế hệ trẻ ngày nay.</p>
                    </div>

                    <div class="mt-8 pt-6 border-t border-dashed border-gray-200">
                        <p class="text-sm font-bold text-gray-400 uppercase tracking-tighter mb-3">Gợi ý từ giáo viên AI:</p>
                        <ul class="text-gray-500 text-sm space-y-2">
                            <li>• Giải thích: Thời gian là gì? Tại sao nó không thể lấy lại?</li>
                            <li>• Phân tích: Trân trọng thời gian mang lại cơ hội, kiến thức và thành công.</li>
                            <li>• Thực trạng: Một bộ phận thanh niên đang sa đà vào sống ảo, lãng phí thời gian.</li>
                            <li>• Bài học: Lập kế hoạch, sống trọn vẹn từng khoảnh khắc.</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="editor-container" id="editor-box">
                    <div class="px-8 py-4 bg-gray-50 border-b flex justify-between items-center">
                        <span class="font-black text-xs text-gray-400 uppercase">Bài làm của bạn</span>
                        <span id="word-count" class="text-xs font-black bg-gray-200 text-gray-600 px-3 py-1 rounded-lg text-uppercase">0 TỪ</span>
                    </div>
                    <textarea id="student-essay" class="writing-area" placeholder="Hãy bắt đầu viết tại đây..."></textarea>
                    <div class="p-4 bg-white border-t">
                        <button id="submit-btn" class="w-full bg-gradient-to-r from-orange-500 to-red-600 text-white py-4 rounded-2xl font-black text-lg shadow-lg hover:scale-[1.02] active:scale-95 transition-all">
                            NỘP BÀI CHẤM ĐIỂM
                        </button>
                    </div>
                </div>

                <div id="result-box" class="hidden exam-card">
                    <div class="flex items-center gap-6 mb-8">
                        <div id="score-display" class="score-circle">0</div>
                        <div>
                            <h3 id="grade-title" class="text-2xl font-black">Kết quả chấm bài</h3>
                            <p id="grade-desc" class="text-gray-500">Giáo viên AI đã phân tích xong bài của bạn.</p>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div>
                            <p class="font-black text-gray-800 mb-3 uppercase text-xs tracking-widest">Chi tiết nhận xét:</p>
                            <div id="ai-correction" class="p-6 bg-gray-50 rounded-3xl leading-relaxed text-lg"></div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-5 bg-green-50 rounded-2xl border border-green-100">
                                <p class="font-bold text-green-700 text-sm mb-2">Ưu điểm:</p>
                                <ul id="pros-list" class="text-green-800 text-xs space-y-1"></ul>
                            </div>
                            <div class="p-5 bg-red-50 rounded-2xl border border-red-100">
                                <p class="font-bold text-red-700 text-sm mb-2">Hạn chế:</p>
                                <ul id="cons-list" class="text-red-800 text-xs space-y-1"></ul>
                            </div>
                        </div>

                        <button onclick="location.reload()" class="w-full py-3 rounded-xl font-bold text-gray-400 hover:bg-gray-100 transition-all">THỬ LẠI</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="loading-overlay" class="fixed inset-0 bg-white/90 backdrop-blur-md z-[2000] hidden flex-col items-center justify-center">
        <div class="text-6xl animate-bounce text-orange-500"><i class="fas fa-robot"></i></div>
        <h3 class="font-black text-2xl mt-4">GIÁO VIÊN AI ĐANG CHẤM BÀI...</h3>
        <p class="text-gray-400 mt-2">Vui lòng đợi giây lát</p>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAJ9C2biYeiLPmhakzLZ4mEqfO9_VgPSZE", authDomain: "hopvan-9a648.firebaseapp.com", projectId: "hopvan-9a648", storageBucket: "hopvan-9a648.appspot.com", messagingSenderId: "429347196227", appId: "1:429347196227:web:917b8d019f0efd0f7833f6", measurementId: "G-1BG8PSRG0R" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // SỬA ĐƯỜNG DẪN API (ĐI RA NGOÀI THƯ MỤC NHATKYHOCTAP)
    const API_URL = `../.netlify/functions/gemini-proxy`;
    let userUid = null;

onAuthStateChanged(auth, (u) => {
    if (u) { 
        userUid = u.uid; 
        console.log("Đã xác thực user:", userUid);
    } else { 
        window.location.href = "../log.html"; 
    }
});

    // --- SỬA LẠI ĐƯỜNG DẪN FETCH MENU ---
fetch('menu.html')
    .then(res => res.text())
    .then(html => {
        const placeholder = document.getElementById('menu-placeholder');
        placeholder.innerHTML = html;
        
        // --- QUAN TRỌNG NHẤT: Ép trình duyệt chạy lại Script bên trong menu ---
        const scripts = placeholder.querySelectorAll('script');
        scripts.forEach(oldScript => {
            const newScript = document.createElement('script');
            newScript.text = oldScript.text; // Copy nội dung script
            document.body.appendChild(newScript); // Chèn vào body để thực thi
        });
    })
    .catch(err => console.error("Lỗi tải menu:", err));

    document.getElementById('submit-btn').onclick = async () => {
        const content = document.getElementById('student-essay').value.trim();
        if (content.split(/\s+/).length < 50) return alert("Bài viết quá ngắn!");

        document.getElementById('loading-overlay').style.display = 'flex';

        // Prompt đã oke, AI sẽ trả về nhận xét cho grade_title và grade_desc
        const systemPrompt = `Bạn là chuyên gia Ngữ Văn chấm bài Nghị luận xã hội. 
        Đề bài: Suy nghĩ về giá trị và tầm quan trọng của thời gian. 
        Chấm điểm thang 100. TRẢ VỀ JSON:
        {
            "score": 80,
            "grade_title": "Hoàn thành xuất sắc / Đạt / Cần cố gắng",
            "grade_desc": "Lời nhắn tổng quan cho học sinh",
            "correction_html": "Bài làm bọc trong các thẻ span text-good, text-bad, text-fix",
            "pros": ["Điểm tốt 1"], "cons": ["Điểm cần sửa 1"]
        }`;

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt + "\n\nBÀI LÀM:\n" + content }] }] })
            });

            if (!response.ok) throw new Error("Server AI lỗi. Hãy kiểm tra lại Netlify Function!");

            const data = await response.json();
            const rawText = data.candidates[0].content.parts[0].text;
            
            const jsonStart = rawText.indexOf('{');
            const jsonEnd = rawText.lastIndexOf('}') + 1;
            const result = JSON.parse(rawText.substring(jsonStart, jsonEnd));

            // Hiển thị kết quả (Bao gồm title và desc không còn bị missing)
            document.getElementById('result-box').classList.remove('hidden');
            document.getElementById('score-display').innerText = result.score;
            document.getElementById('grade-title').innerText = result.grade_title;
            document.getElementById('grade-desc').innerText = result.grade_desc;
            document.getElementById('ai-correction').innerHTML = result.correction_html;
            document.getElementById('pros-list').innerHTML = result.pros.map(i => `<li>• ${i}</li>`).join('');
            document.getElementById('cons-list').innerHTML = result.cons.map(i => `<li>• ${i}</li>`).join('');
            document.getElementById('editor-box').style.display = 'none';

            // LOGIC MỞ LEVEL 3 TRÊN FIREBASE - CHUẨN OKE
            if (result.score >= 60) {
                const userRef = doc(db, "users_progress", userUid);
                const userSnap = await getDoc(userRef);
                let currentDbLevel = (userSnap.exists()) ? userSnap.data().currentLevel : 1;

                if (currentDbLevel <= 2) {
                    await setDoc(userRef, { currentLevel: 3 }, { merge: true });
                }
                alert("Chúc mừng! Bạn đã mở khóa Level 3 thành công.");
            }

            await addDoc(collection(db, "activities"), {
                uid: userUid,
                action: "Hoàn thành Level 2: Giá trị thời gian (" + result.score + "đ)",
                timestamp: serverTimestamp()
            });

        } catch (e) {
            console.error(e);
            alert("Lỗi chấm văn. Bạn hãy thử lại sau nhé!");
        } finally {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    };

    // Word count
    document.getElementById('student-essay').oninput = function() {
        const words = this.value.trim().split(/\s+/).filter(x => x).length;
        document.getElementById('word-count').innerText = words + " TỪ";
    };

    // Timer
    let timeLeft = 2700;
    setInterval(() => {
        if(timeLeft > 0) {
            timeLeft--;
            const m = Math.floor(timeLeft/60), s = timeLeft%60;
            document.getElementById('timer').innerText = `${m}:${s<10?'0'+s:s}`;
        }
    }, 1000);
</script>

</body>
</html>