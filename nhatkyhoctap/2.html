<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level 2: Đọc Hiểu - Giá Trị Thời Gian</title>
    <link rel="icon" type="image/webp" href="../LOGO.WEBP" />
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root { --primary: #FF8F50; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; min-height: 100vh; display: flex; color: #2d3436;
            background: radial-gradient(at 0% 0%, hsla(25,100%,95%,1) 0, transparent 50%), 
                        radial-gradient(at 100% 100%, hsla(15,100%,96%,1) 0, transparent 50%), 
                        #fff9f5;
        }

        /* --- BACKGROUND --- */
        .bg-blob { position: fixed; filter: blur(80px); z-index: -1; opacity: 0.6; animation: float 25s infinite alternate ease-in-out; }
        .blob-1 { top: -5%; left: -5%; width: 500px; height: 500px; background: #ffe4d3; animation-delay: -5s; }
        .blob-2 { bottom: 5%; right: -5%; width: 400px; height: 400px; background: #ffdec2; }
        @keyframes float { 0% { transform: translate(0, 0) rotate(0deg); } 100% { transform: translate(40px, 40px) rotate(15deg); } }

        #menu-placeholder { width: 280px; flex-shrink: 0; }
        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; height: 100vh; position: relative; scroll-behavior: smooth; }

        /* --- GLASS STYLES --- */
        .glass-header {
            background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8); box-shadow: 0 10px 30px rgba(255, 143, 80, 0.15);
            border-radius: 9999px; transition: all 0.3s;
        }
        .liquid-glass {
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(255, 130, 60, 0.1), inset 0 0 0 1px rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 24px; transition: transform 0.3s;
        }

        /* --- INPUT STYLES --- */
        .passage-content {
            font-family: 'Merriweather', serif; line-height: 1.9; color: #4b5563; font-size: 1.05rem;
        }

        .glass-input {
            width: 100%; 
            background: rgba(255, 255, 255, 0.5); 
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 16px; padding: 16px; font-size: 1rem; transition: 0.2s; 
            backdrop-filter: blur(10px); color: #2d3436;
        }
        .glass-input:focus { background: rgba(255, 255, 255, 0.9); border-color: var(--primary); outline: none; box-shadow: 0 5px 15px rgba(255, 143, 80, 0.15); }

        .q-label { font-weight: 800; color: #ea580c; margin-bottom: 10px; display: block; }

        /* --- AI FEEDBACK --- */
        .ai-result { display: none; animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); margin-top: 30px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        .score-circle {
            width: 100px; height: 100px; border-radius: 50%;
            background: conic-gradient(var(--primary) 0%, rgba(255,255,255,0.5) 0%);
            display: flex; align-items: center; justify-content: center;
            position: relative; margin-right: 20px;
            box-shadow: 0 10px 30px rgba(255, 143, 80, 0.2);
        }
        .score-inner {
            width: 80px; height: 80px; background: rgba(255,255,255,0.9); border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .badge-correct { background: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 800; }
        .badge-partial { background: #fefce8; color: #ca8a04; border: 1px solid #fde047; padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 800; }
        .badge-wrong { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 800; }

        /* --- POPUP MODAL (NEW) --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.2); backdrop-filter: blur(8px);
            z-index: 9999; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        
        .modal-box {
            background: white; width: 90%; max-width: 480px; border-radius: 35px;
            padding: 40px; text-align: center; position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid rgba(255,255,255,0.8);
        }
        .modal-overlay.open .modal-box { transform: scale(1); }

        .icon-box {
            width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 20px;
            display: flex; align-items: center; justify-content: center; font-size: 2.5rem;
        }
        .icon-warning { background: #FFF7ED; color: #EA580C; }
        .icon-error { background: #FEF2F2; color: #EF4444; }
        .icon-info { background: #EFF6FF; color: #3B82F6; }

        /* --- LOADING OVERLAY --- */
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); z-index: 20000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .loader-robot { font-size: 4rem; color: var(--primary); animation: robotBounce 1s infinite alternate; }
        @keyframes robotBounce { from { transform: translateY(0); } to { transform: translateY(-20px); } }

        @media (max-width: 1024px) { #menu-placeholder { display: none; } .main-content { padding: 20px; } }
    </style>
</head>
<body>

    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>

    <div id="alert-modal" class="modal-overlay">
        <div class="modal-box">
            <div id="alert-icon-box" class="icon-box icon-warning">
                <i id="alert-icon" class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 id="alert-title" class="text-2xl font-black text-gray-800 mb-2">Thông báo</h3>
            <p id="alert-msg" class="text-gray-500 mb-8">Nội dung thông báo...</p>
            
            <div id="alert-actions" class="flex gap-3 justify-center">
                </div>
        </div>
    </div>

    <div id="loading-overlay" class="loading-overlay">
        <div class="loader-robot"><i class="fas fa-robot"></i></div>
        <h3 class="font-black text-2xl mt-6 text-gray-800">AI ĐANG CHẤM BÀI...</h3>
        <p class="text-gray-500 mt-2 font-medium">Đang phân tích ý tưởng và diễn đạt</p>
    </div>

    <div id="menu-placeholder"></div>

    <main class="main-content">
        <div class="sticky top-6 z-50 mb-12 px-2">
            <div class="max-w-5xl mx-auto glass-header px-6 py-3 flex justify-between items-center">
                <a href="../dashboard/nhatkyhoctap.html" class="flex items-center gap-3 text-gray-600 font-bold hover:text-orange-500 transition group">
                    <div class="w-10 h-10 rounded-full bg-white/80 flex items-center justify-center shadow-sm text-orange-400 group-hover:scale-110 transition-transform">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <span class="hidden sm:inline">Quay lại lộ trình</span>
                </a>
                
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Thời gian còn lại</p>
                        <p class="text-base font-black text-gray-800" id="timer-text">30 phút 00 giây</p>
                    </div>
                    <div class="w-12 h-12 rounded-full flex items-center justify-center shadow-lg relative overflow-hidden bg-white">
                        <svg class="w-10 h-10 absolute" viewBox="0 0 36 36">
                            <path class="text-gray-200" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="4" />
                            <path class="text-orange-500 transition-all duration-1000 ease-linear" stroke-dasharray="100, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="4" id="timer-circle" />
                        </svg>
                        <span class="text-xs font-black relative z-10 text-gray-700" id="timer-mini">30</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-4xl mx-auto pb-20">
            
            <div class="liquid-glass p-8 mb-10 relative overflow-hidden bg-gradient-to-br from-white/60 to-white/20">
                <div class="relative z-10">
                    <span class="bg-gradient-to-r from-orange-500 to-red-500 text-white px-4 py-1.5 rounded-xl text-[11px] font-black uppercase tracking-widest shadow-lg shadow-orange-500/30">Level 2</span>
                    <h1 class="text-4xl font-black text-gray-800 mt-4 mb-2">Đọc Hiểu: Giá Trị Thời Gian</h1>
                    <p class="text-gray-500 font-medium">Hoàn thành bài tập đạt tối thiểu <span class="text-orange-600 font-bold">6.0/10 điểm</span> để qua màn.</p>
                </div>
                <i class="fas fa-hourglass-half absolute -right-6 -bottom-8 text-9xl text-orange-500/10 rotate-12"></i>
            </div>

            <div class="liquid-glass p-8 mb-8">
                <div class="passage-content relative z-10">
                    <i class="fas fa-quote-left text-4xl text-orange-200 mb-2 block"></i>
                    <p class="mb-4 italic">
                        "Thời gian là một dòng chảy không bao giờ ngừng lại. Nó lặng lẽ trôi qua, mang theo tuổi trẻ, cơ hội và cả những nuối tiếc. Người ta thường nói: 'Thời gian là vàng', nhưng vàng mất đi còn có thể tìm lại được, còn thời gian một khi đã đi qua thì vĩnh viễn không quay trở lại.<br><br>
                        Mỗi sáng thức dậy, bạn được tặng 24 giờ. Đó là món quà công bằng nhất mà cuộc sống dành cho tất cả mọi người. Sự khác biệt nằm ở chỗ bạn sử dụng món quà đó như thế nào. Có người dùng nó để xây dựng ước mơ, trau dồi kiến thức; nhưng cũng có người để nó trôi qua trong vô vị, ngủ vùi hoặc đắm chìm vào những thú vui nhất thời."
                    </p>
                    <div class="text-right text-sm font-bold text-gray-500 mt-4 border-t border-orange-100 pt-2 inline-block float-right">— Trích <i>Quà tặng cuộc sống</i></div>
                </div>
            </div>

            <div id="questions-form" class="space-y-6">
                <div class="liquid-glass p-6">
                    <label class="q-label">Câu 1 (0.5 điểm): Xác định phương thức biểu đạt chính của đoạn trích.</label>
                    <input type="text" class="glass-input" id="ans-1" placeholder="Nhập câu trả lời...">
                </div>
                
                <div class="liquid-glass p-6">
                    <label class="q-label">Câu 2 (0.75 điểm): Theo tác giả, sự khác biệt giữa mọi người nằm ở đâu?</label>
                    <input type="text" class="glass-input" id="ans-2" placeholder="Nhập câu trả lời...">
                </div>

                <div class="liquid-glass p-6">
                    <label class="q-label">Câu 3 (0.75 điểm): Tại sao tác giả lại cho rằng 'thời gian quý hơn vàng'?</label>
                    <textarea class="glass-input h-24 resize-none" id="ans-3" placeholder="Nhập câu trả lời..."></textarea>
                </div>

                <div class="liquid-glass p-6">
                    <label class="q-label">Câu 4 (1.0 điểm): Bài học rút ra cho bản thân về việc quản lý thời gian?</label>
                    <textarea class="glass-input h-28 resize-none" id="ans-4" placeholder="Nhập câu trả lời..."></textarea>
                </div>
            </div>

            <div class="mt-10 text-center" id="submit-area">
                <button onclick="confirmSubmission()" class="group relative inline-flex items-center justify-center px-12 py-5 font-black text-white transition-all duration-300 bg-gray-900 rounded-3xl hover:shadow-2xl hover:shadow-orange-500/20 hover:scale-105 active:scale-95 overflow-hidden">
                    <span class="text-xl relative z-10">NỘP BÀI & CHẤM ĐIỂM</span>
                    <div class="absolute inset-0 bg-gradient-to-r from-orange-500 to-red-500 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                </button>
            </div>

            <div id="result-box" class="liquid-glass p-8 ai-result">
                <div class="flex flex-col md:flex-row items-center mb-8 border-b border-white/50 pb-8">
                    <div class="score-circle" id="score-ring">
                        <div class="score-inner">
                            <span class="text-3xl font-black text-gray-800" id="score-text">0</span>
                            <span class="text-[10px] font-bold text-gray-400 uppercase">Điểm</span>
                        </div>
                    </div>
                    <div class="text-center md:text-left mt-4 md:mt-0">
                        <h3 class="text-2xl font-black text-gray-800" id="result-title">Đang chấm...</h3>
                        <p class="text-gray-500 font-medium">Kết quả chi tiết từ giáo viên AI</p>
                    </div>
                </div>
                
                <div id="feedback-content" class="space-y-4"></div>

                <div class="mt-8 flex flex-col sm:flex-row gap-4 justify-center">
                    <button onclick="nextLevel()" id="next-btn" class="hidden w-full sm:w-auto bg-green-500 text-white px-8 py-4 rounded-2xl font-black hover:bg-green-600 transition shadow-lg shadow-green-500/30 hover:-translate-y-1">
                        Mở Khóa Level 3 <i class="fas fa-lock-open ml-2"></i>
                    </button>
                    <button onclick="location.reload()" id="retry-btn" class="hidden w-full sm:w-auto bg-white/70 text-gray-600 px-8 py-4 rounded-2xl font-black hover:bg-white transition shadow-sm border border-gray-200">
                        Làm Lại Bài <i class="fas fa-redo ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAJ9C2biYeiLPmhakzLZ4mEqfO9_VgPSZE", authDomain: "hopvan-9a648.firebaseapp.com", projectId: "hopvan-9a648", storageBucket: "hopvan-9a648.appspot.com", messagingSenderId: "429347196227", appId: "1:429347196227:web:917b8d019f0efd0f7833f6", measurementId: "G-1BG8PSRG0R" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const API_URL = `../.netlify/functions/gemini-proxy`;
    let userUid = null;

    // --- HÀM POPUP (Giống Level 1) ---
    window.showPopup = (type, title, msg, confirmCallback = null) => {
        const modal = document.getElementById('alert-modal');
        const iconBox = document.getElementById('alert-icon-box');
        const icon = document.getElementById('alert-icon');
        const titleEl = document.getElementById('alert-title');
        const msgEl = document.getElementById('alert-msg');
        const actions = document.getElementById('alert-actions');

        titleEl.innerText = title;
        msgEl.innerText = msg;

        // Reset Styles
        iconBox.className = "icon-box";
        actions.innerHTML = "";

        if (type === 'warning') {
            iconBox.classList.add('icon-warning');
            icon.className = "fas fa-exclamation-triangle";
            
            if (confirmCallback) { // Loại xác nhận (Confirm)
                const cancelBtn = document.createElement('button');
                cancelBtn.className = "px-6 py-3 rounded-xl font-bold bg-gray-100 text-gray-600 hover:bg-gray-200 transition";
                cancelBtn.innerText = "Kiểm tra lại";
                cancelBtn.onclick = () => modal.classList.remove('open');

                const confirmBtn = document.createElement('button');
                confirmBtn.className = "px-6 py-3 rounded-xl font-bold bg-orange-500 text-white hover:bg-orange-600 shadow-lg shadow-orange-200 transition";
                confirmBtn.innerText = "Nộp bài ngay";
                confirmBtn.onclick = () => { modal.classList.remove('open'); confirmCallback(); };

                actions.appendChild(cancelBtn);
                actions.appendChild(confirmBtn);
            } else { // Loại cảnh báo thường (Alert)
                const closeBtn = document.createElement('button');
                closeBtn.className = "px-8 py-3 rounded-xl font-bold bg-orange-500 text-white hover:bg-orange-600 transition";
                closeBtn.innerText = "Đã hiểu";
                closeBtn.onclick = () => modal.classList.remove('open');
                actions.appendChild(closeBtn);
            }
        } else if (type === 'error') {
            iconBox.classList.add('icon-error');
            icon.className = "fas fa-times-circle";
            const closeBtn = document.createElement('button');
            closeBtn.className = "px-8 py-3 rounded-xl font-bold bg-red-500 text-white hover:bg-red-600 transition";
            closeBtn.innerText = "Thử lại";
            closeBtn.onclick = () => { modal.classList.remove('open'); if(confirmCallback) confirmCallback(); };
            actions.appendChild(closeBtn);
        } else if (type === 'info') {
            iconBox.classList.add('icon-info');
            icon.className = "fas fa-info-circle";
            const closeBtn = document.createElement('button');
            closeBtn.className = "px-8 py-3 rounded-xl font-bold bg-blue-500 text-white hover:bg-blue-600 transition";
            closeBtn.innerText = "Đăng nhập ngay";
            closeBtn.onclick = () => { window.location.href = "../log.html"; };
            actions.appendChild(closeBtn);
        }

        modal.classList.add('open');
    };

    onAuthStateChanged(auth, (u) => {
        if (u) userUid = u.uid;
        else showPopup('info', 'Yêu cầu đăng nhập', 'Bạn cần đăng nhập để lưu kết quả và mở khóa màn tiếp theo.');
    });

    // Fetch Menu
    fetch('menu.html').then(r=>r.text()).then(h=>{
        const p = document.getElementById('menu-placeholder'); p.innerHTML=h;
        p.querySelectorAll('script').forEach(s=>{const n=document.createElement('script');n.text=s.text;document.body.appendChild(n)});
    });

    // Hàm gọi khi bấm nút Nộp bài
    window.confirmSubmission = () => {
        const ans1 = document.getElementById('ans-1').value.trim();
        const ans2 = document.getElementById('ans-2').value.trim();
        const ans3 = document.getElementById('ans-3').value.trim();
        const ans4 = document.getElementById('ans-4').value.trim();

        if(!ans1 || !ans2 || !ans3 || !ans4) {
            showPopup('warning', 'Chưa hoàn thành', 'Vui lòng trả lời đầy đủ 4 câu hỏi trước khi nộp bài.');
            return;
        }

        showPopup('warning', 'Xác nhận nộp bài', 'Bạn có chắc chắn muốn nộp bài? Hệ thống sẽ chấm điểm ngay lập tức.', handleRealSubmit);
    };

    // Hàm xử lý nộp bài thật (gọi sau khi confirm)
    const handleRealSubmit = async () => {
        const ans1 = document.getElementById('ans-1').value;
        const ans2 = document.getElementById('ans-2').value;
        const ans3 = document.getElementById('ans-3').value;
        const ans4 = document.getElementById('ans-4').value;

        document.getElementById('loading-overlay').style.display = 'flex';

        // PROMPT CHI TIẾT
        const systemPrompt = `
            VAI TRÒ: Giáo viên Ngữ Văn chấm bài Đọc Hiểu THPT.
            VĂN BẢN: "Thời gian là một dòng chảy..."
            
            BAREM CHẤM (Thang 10):
            1. (2.0đ) PTBĐ: Nghị luận.
            2. (2.0đ) Sự khác biệt: Cách sử dụng thời gian (xây dựng ước mơ vs lãng phí/ngủ vùi).
            3. (3.0đ) Vì: Vàng mất tìm lại được, thời gian đi qua là vĩnh viễn.
            4. (3.0đ) Bài học: Trân trọng thời gian, sống có ích. (Chấm ý nghĩa và diễn đạt).

            BÀI LÀM:
            1. ${ans1}
            2. ${ans2}
            3. ${ans3}
            4. ${ans4}

            YÊU CẦU JSON DUY NHẤT:
            {
                "score": (Số thực, max 10.0),
                "feedback": [
                    { "q": "Câu 1", "status": "correct|partial|wrong", "comment": "Nhận xét ngắn" },
                    { "q": "Câu 2", "status": "...", "comment": "..." },
                    { "q": "Câu 3", "status": "...", "comment": "..." },
                    { "q": "Câu 4", "status": "...", "comment": "..." }
                ],
                "advice": "Lời khuyên chung"
            }
        `;

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] })
            });

            const data = await response.json();
            
            if (data.error) throw new Error(data.error.message);
            if (!data.candidates || data.candidates.length === 0) throw new Error("AI không trả lời.");

            const rawText = data.candidates[0].content.parts[0].text;
            const res = JSON.parse(rawText.replace(/```json|```/g, "").trim());

            // 1. Hiển thị kết quả
            document.getElementById('result-box').style.display = 'block';
            document.getElementById('submit-area').style.display = 'none';
            document.getElementById('result-box').scrollIntoView({ behavior: 'smooth' });

            const score = res.score;
            document.getElementById('score-text').innerText = score;
            
            // Màu sắc tiêu đề
            const titleEl = document.getElementById('result-title');
            const ringEl = document.getElementById('score-ring');
            
            if (score >= 6) {
                titleEl.innerText = "ĐẠT YÊU CẦU";
                titleEl.className = "text-2xl font-black text-green-600";
                ringEl.style.background = `conic-gradient(#10B981 ${score*10}%, rgba(255,255,255,0.5) 0%)`;
                document.getElementById('next-btn').classList.remove('hidden');
                document.getElementById('next-btn').classList.add('flex');
            } else {
                titleEl.innerText = "CẦN CỐ GẮNG";
                titleEl.className = "text-2xl font-black text-red-500";
                ringEl.style.background = `conic-gradient(#EF4444 ${score*10}%, rgba(255,255,255,0.5) 0%)`;
                document.getElementById('retry-btn').classList.remove('hidden');
                document.getElementById('retry-btn').classList.add('flex');
            }

            // 2. Render Chi tiết
            const statusStyle = {
                "correct": { class: "badge-correct", text: "ĐÚNG" },
                "partial": { class: "badge-partial", text: "THIẾU Ý" },
                "wrong": { class: "badge-wrong", text: "SAI" }
            };

            const html = res.feedback.map(f => `
                <div class="bg-white/60 rounded-xl p-4 border border-white shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-gray-700">${f.q}</span>
                        <span class="${statusStyle[f.status].class}">${statusStyle[f.status].text}</span>
                    </div>
                    <p class="text-sm text-gray-600 italic"><i class="fas fa-comment-dots text-orange-400 mr-2"></i>${f.comment}</p>
                </div>
            `).join('');
            
            document.getElementById('feedback-content').innerHTML = html + 
                `<div class="bg-blue-50/80 text-blue-900 p-4 rounded-xl text-sm font-bold mt-4 border border-blue-100 flex gap-3 backdrop-blur-sm">
                    <i class="fas fa-lightbulb text-lg mt-0.5"></i>
                    <div>${res.advice}</div>
                </div>`;

            // 3. Logic Mở Khóa & Lưu Database
            if(userUid) {
                await addDoc(collection(db, "activities"), {
                    uid: userUid,
                    action: `Đọc hiểu Level 2: ${score}/10 điểm`,
                    score: score,
                    timestamp: serverTimestamp()
                });

                if (score >= 6) {
                    const userRef = doc(db, "users_progress", userUid);
                    const snap = await getDoc(userRef);
                    if(!snap.exists() || snap.data().currentLevel < 3) {
                        await setDoc(userRef, { currentLevel: 3, lastPassed: serverTimestamp() }, { merge: true });
                    }
                }
            }

        } catch (e) {
            console.error(e);
            showPopup('error', 'Lỗi hệ thống', 'Không thể kết nối với giáo viên AI. Vui lòng thử lại!', handleRealSubmit);
        } finally {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    };

    window.submitExam = confirmSubmission; // Gán lại để tương thích nếu gọi từ console
    window.nextLevel = () => window.location.href = "../dashboard/nhatkyhoctap.html";


    // Timer
    let totalSeconds = 1800; 
    const timerCircle = document.getElementById('timer-circle');
    const timerText = document.getElementById('timer-text');
    const timerMini = document.getElementById('timer-mini');

    setInterval(() => {
        if(totalSeconds > 0) {
            totalSeconds--;
            const m = Math.floor(totalSeconds / 60);
            const s = totalSeconds % 60;
            
            timerText.innerText = `${m} phút ${s < 10 ? '0'+s : s} giây`;
            timerMini.innerText = m;
            const percent = (totalSeconds / 1800) * 100;
            timerCircle.setAttribute('stroke-dasharray', `${percent}, 100`);
            if(totalSeconds < 300) timerCircle.classList.replace('text-orange-500', 'text-red-500');
        } else {
            // Hết giờ thì tự nộp (không cần xác nhận)
            handleRealSubmit();
        }
    }, 1000);
</script>

</body>
</html>