<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trợ Lý AI Văn Học</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải thư viện Lucide Icons (sử dụng icon bút, sách, tải lên) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Tải font Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Gradient tùy chỉnh theo yêu cầu */
        .literary-gradient {
            background: linear-gradient(135deg, #fcd5b5 0%, #fca96a 100%);
        }

        /* Hiệu ứng xuất hiện (Fade In) */
        .fade-in {
            animation: fadeIn 1s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Ẩn thanh cuộn mặc định cho đẹp hơn */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #fca96a;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #fcd5b5;
        }
        
        /* Con trỏ gõ chữ */
        .typewriter::after {
            content: '|';
            display: inline-block;
            animation: blink 0.7s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
    </style>
</head>
<body class="literary-gradient h-screen overflow-hidden flex items-center justify-center p-4">

    <!-- Khung Ứng Dụng Chính -->
    <div id="app-container" class="bg-white/80 backdrop-blur-sm w-full max-w-7xl h-full max-h-[90vh] rounded-2xl shadow-2xl p-6 flex flex-col fade-in">

        <h1 class="text-3xl font-extrabold text-[#fca96a] mb-4 flex items-center">
            HOPVAN AI
        </h1>

        <!-- Khu vực chia 2 phần (Input & Output) -->
        <div class="flex flex-1 flex-col lg:flex-row gap-6 overflow-hidden">

            <!-- 1. Cột Trái: Nhập Câu Hỏi (Input) -->
            <div class="lg:w-1/3 flex flex-col space-y-4 fade-in" style="animation-delay: 0.2s;">
                <h2 class="text-xl font-bold text-gray-700">Nhập Câu Hỏi Của Bạn</h2>
                
                <!-- Vùng nhập liệu -->
                <textarea id="prompt-input" 
                    rows="8" 
                    placeholder="Bạn muốn hỏi gì về tác phẩm, tác giả, hay phong trào văn học?"
                    class="w-full p-4 border border-[#fcd5b5] rounded-lg focus:ring-[#fca96a] focus:border-[#fca96a] transition duration-200 resize-none shadow-inner bg-white/90"
                ></textarea>

                <!-- Vùng tải file (Chấp nhận văn bản hoặc hình ảnh) -->
                <div class="flex flex-col space-y-2">
                    <label for="file-upload" class="flex items-center space-x-2 text-sm font-medium text-gray-700 cursor-pointer hover:text-[#fca96a] transition duration-150">
                        <i data-lucide="upload" class="w-4 h-4"></i>
                        <span>Gửi kèm Tài liệu/Ảnh (Tùy chọn)</span>
                    </label>
                    <input type="file" id="file-upload" class="hidden" accept=".txt, .pdf, .docx, image/*">
                    <span id="file-name" class="text-sm text-gray-500 truncate">Chưa có file nào được chọn.</span>
                </div>

                <!-- Nút Gửi -->
                <button id="send-button"
                    class="bg-gray-400 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition duration-300 ease-in-out flex items-center justify-center focus:outline-none focus:ring-4 focus:ring-[#fcd5b5]"
                    disabled>
                    <span id="send-text">Gửi Yêu Cầu</span>
                    <i data-lucide="wand-2" class="w-5 h-5 ml-2"></i>
                </button>
                
                <!-- Khung báo lỗi/tin nhắn -->
                <div id="message-box" class="min-h-[30px] p-2 text-center text-sm rounded-lg transition-all duration-300"></div>

                <!-- Vùng Loading -->
                <div id="loading-indicator" class="hidden text-center text-sm font-medium text-[#fca96a] flex items-center justify-center space-x-2">
                    <svg class="animate-spin h-5 w-5 text-[#fca96a]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>AI đang phân tích...</span>
                </div>
            </div>

            <!-- 2. Cột Phải: Hiển Thị Kết Quả (Output) -->
            <div class="lg:w-2/3 flex flex-col space-y-4 p-4 bg-white rounded-xl shadow-inner border border-[#fcd5b5] fade-in" style="animation-delay: 0.4s;">
                <h2 class="text-xl font-bold text-gray-700 border-b pb-2 border-gray-200 flex items-center">
                    <i data-lucide="book-check" class="w-5 h-5 mr-2 text-[#fca96a]"></i>
                    Giải Đáp & Phân Tích
                </h2>
                
                <!-- Khu vực hiển thị nội dung AI -->
                <!-- Thêm container cho nội dung gõ chữ -->
                <div id="response-output-container" class="flex-1 overflow-y-auto custom-scrollbar text-gray-800 leading-relaxed space-y-4">
                    <div id="response-output" class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-gray-500 italic">
                            Chào mừng đến với HOPVAN AI! Hãy nhập câu hỏi của bạn vào khung bên trái để nhận được phân tích chuyên sâu và giải đáp chi tiết.
                        </p>
                    </div>
                    <div id="source-output" class="hidden"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- Khối JavaScript -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Cấu hình Firebase và API (MANDATORY SETUP) ---
        const apiKey = "AIzaSyC7sfecGLeyCQ-3jLElwgalZ1D0ILQB83k"; // API Key sẽ được cung cấp tự động bởi môi trường Canvas
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        // Biến toàn cục từ môi trường Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = 'anonymous';
        let selectedFile = null;

        // --- DOM Elements ---
        const promptInput = document.getElementById('prompt-input');
        const sendButton = document.getElementById('send-button');
        const sendText = document.getElementById('send-text');
        const responseOutputContainer = document.getElementById('response-output-container');
        const responseOutput = document.getElementById('response-output');
        const sourceOutput = document.getElementById('source-output');
        const loadingIndicator = document.getElementById('loading-indicator');
        const messageBox = document.getElementById('message-box');
        const fileUpload = document.getElementById('file-upload');
        const fileNameDisplay = document.getElementById('file-name');

        // --- Hàm cho Hiệu ứng Gõ chữ (Typewriter Effect) ---

        /**
         * Chuyển đổi Markdown sang HTML đơn giản, chỉ xử lý cơ bản để hiển thị.
         * Thư viện Markdown to HTML không được phép dùng bên ngoài.
         * @param {string} markdownText - Chuỗi Markdown.
         * @returns {string} Chuỗi HTML đã được xử lý.
         */
        function simpleMarkdownToHtml(markdownText) {
            let htmlText = markdownText
                .replace(/^(#+)\s*(.*$)/gim, (match, hashes, content) => {
                    const level = hashes.length > 6 ? 6 : hashes.length;
                    return `<h${level} class="text-xl font-bold mt-4 mb-2">${content}</h${level}>`;
                }) // Headings
                .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>') // Bold
                .replace(/\*(.*?)\*/gim, '<em>$1</em>') // Italic
                .replace(/^- (.*$)/gim, '<li>$1</li>'); // Simple list items

            // Thay thế tất cả \n không phải là <li> hoặc <h2>/<h3>/<h4> bằng <br> để tạo dòng mới
            htmlText = htmlText.split('\n').map(line => {
                if (line.trim().startsWith('<li>') || line.trim().startsWith('<h')) {
                    return line;
                }
                return line + '<br>';
            }).join('');
            
            // Bọc list items bằng <ul> nếu có
            if (htmlText.includes('<li>')) {
                 htmlText = `<ul>${htmlText}</ul>`;
            }

            return `<div class="p-4 bg-white rounded-lg shadow-sm">${htmlText}</div>`;
        }

        /**
         * Hiển thị nội dung bằng hiệu ứng gõ chữ.
         * @param {HTMLElement} element - Phần tử DOM để hiển thị text.
         * @param {string} rawText - Nội dung AI trả về (dạng Markdown).
         * @param {Array} sources - Danh sách nguồn tham khảo.
         * @param {function} callback - Hàm được gọi sau khi hoàn thành.
         */
        function typeWriter(element, rawText, sources, callback) {
            // Chuyển đổi toàn bộ text sang HTML trước, sau đó lấy nội dung text để gõ
            const fullHtml = simpleMarkdownToHtml(rawText);
            
            // Tạm thời hiển thị nội dung vào một div ẩn để lấy text thuần
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = fullHtml;
            const fullText = tempDiv.textContent.trim();
            
            element.innerHTML = '<span class="typewriter"></span>';
            const typewriterSpan = element.querySelector('.typewriter');
            let i = 0;
            const speed = 15; // Tốc độ gõ chữ (ms)

            function type() {
                if (i < fullText.length) {
                    typewriterSpan.textContent += fullText.charAt(i);
                    i++;
                    // Cuộn xuống khi gõ
                    responseOutputContainer.scrollTop = responseOutputContainer.scrollHeight;
                    setTimeout(type, speed);
                } else {
                    // Khi hoàn thành, thay thế nội dung gõ bằng nội dung HTML đã được format
                    element.classList.remove('typewriter');
                    element.innerHTML = fullHtml;

                    // Hiển thị nguồn tham khảo (nếu có)
                    if (sources.length > 0) {
                        displaySources(sources);
                    } else {
                        sourceOutput.classList.add('hidden');
                    }
                    
                    if (callback) callback();
                }
            }
            type();
        }

        // --- Helper Functions ---

        /**
         * Chuyển đổi file thành Base64 để gửi qua API
         * @param {File} file - Đối tượng File được chọn
         * @returns {Promise<string>} Chuỗi base64 của file
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]); // Lấy phần data base64
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /**
         * Hiển thị thông báo trong messageBox
         * @param {string} message - Nội dung thông báo
         * @param {string} type - 'success' hoặc 'error'
         */
        function displayMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = 'min-h-[30px] p-2 text-center text-sm rounded-lg transition-all duration-300'; // Reset classes
            
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            } else {
                 messageBox.classList.add('bg-gray-100', 'text-gray-700');
            }
        }
        
        /**
         * Hiển thị nguồn tham khảo
         */
        function displaySources(sources) {
             sourceOutput.innerHTML = `<div class="mt-4 pt-4 border-t border-gray-200">
                <h4 class="text-sm font-semibold text-gray-600 mb-2">Nguồn tham khảo:</h4>
                <ul class="text-xs space-y-1 list-disc pl-5">
                    ${sources.map(s => `<li><a href="${s.uri}" target="_blank" class="text-blue-600 hover:text-[#fca96a] transition">${s.title}</a></li>`).join('')}
                </ul>
            </div>`;
            sourceOutput.classList.remove('hidden');
            responseOutputContainer.scrollTop = responseOutputContainer.scrollHeight; // Cuộn xuống cuối
        }

        
        // --- Firebase & Auth Initialization ---

        async function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.warn("Firebase config not found. Skipping initialization.");
                    return;
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase initialized. User ID:", userId);
            } catch (error) {
                console.error("Lỗi khi khởi tạo Firebase:", error);
                displayMessage("Lỗi kết nối dịch vụ. Vui lòng thử lại.", 'error');
            }
        }

        // --- Core Logic ---

        async function fetchWithRetry(url, options) {
            const MAX_RETRIES = 3;
            let delay = 1000;
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i < MAX_RETRIES - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        throw error;
                    }
                }
            }
        }

        function resetUI() {
            loadingIndicator.classList.add('hidden');
            sendButton.disabled = false;
            sendButton.classList.add('hover:-translate-y-0.5', 'bg-[#fca96a]', 'hover:bg-[#e09158]');
            sendButton.classList.remove('bg-gray-400');
            sendText.textContent = 'Gửi Yêu Cầu';
        }

        async function sendMessage() {
            const prompt = promptInput.value.trim();
            if (!prompt && !selectedFile) {
                displayMessage("Vui lòng nhập câu hỏi hoặc chọn file.", 'error');
                return;
            }

            // UI feedback: Start loading
            loadingIndicator.classList.remove('hidden');
            sendButton.disabled = true;
            sendButton.classList.remove('hover:-translate-y-0.5', 'bg-[#fca96a]', 'hover:bg-[#e09158]');
            sendButton.classList.add('bg-gray-400');
            sendText.textContent = 'Đang xử lý...';
            displayMessage(''); 
            
            // Xóa nội dung cũ, chuẩn bị cho hiệu ứng gõ chữ
            responseOutput.innerHTML = `<p class="text-gray-500 italic">Đang chờ AI trả lời...</p>`;
            sourceOutput.classList.add('hidden');


            try {
                let parts = [{ text: prompt }];

                if (selectedFile) {
                    // Xử lý file nếu có
                    const base64Data = await fileToBase64(selectedFile);
                    const mimeType = selectedFile.type || 'application/octet-stream';

                    // Thêm dữ liệu inlineData vào parts
                    parts.push({
                        inlineData: {
                            mimeType: mimeType,
                            data: base64Data
                        }
                    });
                }
                
                // System instruction để định hướng AI trong lĩnh vực văn học
                const systemPrompt = "Bạn là Trợ Lý AI Văn Học chuyên sâu. Hãy phân tích các câu hỏi, tài liệu, hoặc hình ảnh liên quan đến văn học. Cung cấp câu trả lời chi tiết, dễ hiểu, bám sát ngữ cảnh và có cấu trúc rõ ràng (sử dụng Markdown để định dạng câu trả lời).";

                const payload = {
                    contents: [{ role: "user", parts: parts }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    tools: [{ "google_search": {} }],
                };

                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];

                    // Trích xuất nguồn tham khảo nếu có
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                    
                    // Bắt đầu hiệu ứng gõ chữ và hiển thị kết quả
                    typeWriter(responseOutput, text, sources, resetUI);

                } else {
                    displayMessage("AI không thể tạo ra phản hồi. Vui lòng thử lại với câu hỏi khác.", 'error');
                    responseOutput.innerHTML = `<p class="text-gray-500 italic p-4 bg-red-50 rounded-lg">Không có phản hồi.</p>`;
                    resetUI();
                }

            } catch (error) {
                console.error("Lỗi gọi API:", error);
                displayMessage(`Lỗi: Không thể kết nối với dịch vụ AI. ${error.message}`, 'error');
                responseOutput.innerHTML = `<p class="text-gray-500 italic p-4 bg-red-50 rounded-lg">Đã xảy ra lỗi khi xử lý yêu cầu.</p>`;
                resetUI();

            }
        }


        // --- Event Listeners ---

        // Kiểm tra để bật/tắt nút Gửi
        function checkInput() {
            const hasPrompt = promptInput.value.trim().length > 0;
            if (hasPrompt || selectedFile) {
                sendButton.disabled = false;
                sendButton.classList.add('bg-[#fca96a]', 'hover:bg-[#e09158]', 'hover:-translate-y-0.5');
                sendButton.classList.remove('bg-gray-400');
            } else {
                sendButton.disabled = true;
                sendButton.classList.remove('bg-[#fca96a]', 'hover:bg-[#e09158]', 'hover:-translate-y-0.5');
                sendButton.classList.add('bg-gray-400');
            }
        }
        
        promptInput.addEventListener('input', checkInput);
        sendButton.addEventListener('click', sendMessage);
        
        fileUpload.addEventListener('change', (event) => {
            selectedFile = event.target.files[0];
            if (selectedFile) {
                // Thêm logic kiểm tra kích thước file (<= 4MB) và kiểu file
                const MAX_SIZE_MB = 4;
                if (selectedFile.size > MAX_SIZE_MB * 1024 * 1024) {
                    displayMessage(`Lỗi: Kích thước file không được vượt quá ${MAX_SIZE_MB} MB.`, 'error');
                    event.target.value = ''; // Reset input
                    selectedFile = null;
                    fileNameDisplay.textContent = "Chưa có file nào được chọn.";
                    checkInput();
                    return;
                }
                
                fileNameDisplay.textContent = `Đã chọn: ${selectedFile.name} (${(selectedFile.size / 1024 / 1024).toFixed(2)} MB)`;
                displayMessage('File đã sẵn sàng để gửi.');
            } else {
                fileNameDisplay.textContent = "Chưa có file nào được chọn.";
                displayMessage('');
            }
            checkInput();
        });


        // --- Khởi động ứng dụng ---
        window.onload = () => {
            initFirebase();
            lucide.createIcons(); // Khởi tạo icon Lucide
            checkInput(); // Kiểm tra trạng thái nút ban đầu
        };
    </script>
</body>
</html>
